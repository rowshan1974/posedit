<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MY POS SOF</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@400;500;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- JsBarcode লাইব্রেরি যোগ করা হয়েছে -->
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
    <!-- INSERTION POINT -->

    <!-- ======================================================== -->
    <!-- 1, 5, 6: New Globals for Offline Sync and Forecast Systems -->
    <!-- (IndexedDB & Sync related globals REMOVED) -->
    <!-- ======================================================== -->
    <script>
        // No-storage mode: IndexedDB removed. All DB ops are no-ops.
        // Define globals on window only if not already defined.
        (function(){
            // --- EXISTING CODE ---
            if (typeof window.OBJECT_STORES === 'undefined') {
                // ADD banks, bankTransactions to the list of stores for financial module
                window.OBJECT_STORES = ['products', 'suppliers', 'customers', 'users', 'sales', 'dues', 'ledgerEntries', 'settings', 'purchaseHistory', 'supplierReturns', 'banks', 'bankTransactions']; 
            }
            if (typeof window.db === 'undefined') {
                window.db = {
                    open: async () => undefined,
                    getAll: async (_store) => [],
                    get: async (_store, _key) => null,
                    put: async (_store, _value) => undefined,
                    add: async (_store, _value) => undefined,
                    delete: async (_store, _key) => undefined,
                    clear: async (_store) => undefined,
                };
            }
            // --- NEW ADD-ON CODE (1. Offline, 5. Forecast) ---
             window.SALES_FORECAST_CONFIG = {
                TREND_MODIFIER: 0.10, // +/- 10% trend base
                MIN_FORECAST_SALES: 3, // Requires 3 months of data
                TREND_THRESHOLD: 0.05, // Monthly trend significance threshold
                PRODUCT_MIN_STOCK_DEFAULT: 5 // Default for products without minStock set (2. Stock Alert)
             };

            // Note: Do not override ADMIN_PASSWORD here.
        })();
    </script>
    
    <!-- Firebase SDKs (Compat) for easy inline usage -->
    <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-auth-compat.js"></script>
    <script>
      // Firebase configuration provided by user
      window.FIREBASE_CONFIG = {
        apiKey: "AIzaSyBaWtBbFZS7NcZRsPZ4092kHeSfq2Jcm2o",
        authDomain: "datatechsolutionag.firebaseapp.com",
        projectId: "datatechsolutionag",
        storageBucket: "datatechsolutionag.firebasestorage.app",
        messagingSenderId: "53908668722",
        appId: "1:53908668722:web:fa287e03055dae1bfa172b",
        measurementId: "G-2JJBBZ99VQ"
      };
    </script>
    <script>
        // Configure this object with your Firebase project credentials to enable Firebase storage.
        // Example:
        // window.FIREBASE_CONFIG = {
        //   apiKey: "...",
        //   authDomain: "...",
        //   projectId: "...",
        //   appId: "..."
        // };

        (function(){
            const hasConfig = typeof window.FIREBASE_CONFIG === 'object' && !!window.FIREBASE_CONFIG.apiKey;
            if (!hasConfig) {
                console.warn('Firebase config not provided. Running in no-storage mode.');
                return;
            }
            // Initialize Firebase app once
            if (typeof window.firebase !== 'undefined') {
                if (firebase.apps.length === 0) {
                    firebase.initializeApp(window.FIREBASE_CONFIG);
                }
            } else {
                console.warn('Firebase SDK not loaded.');
                return;
            }
            // Setup Firestore handle
            if (!window._fs) {
                window._fs = firebase.firestore();
                try {
                    // Only tweak networking when running from file:// to avoid overriding any host/emulator settings
                    if (location.protocol === 'file:') {
                        // Force long polling to avoid WebChannel transport issues on file:// or restrictive networks
                        window._fs.settings({ experimentalForceLongPolling: true, useFetchStreams: false });
                    }
                } catch (e) {
                    console.warn('Firestore settings apply failed:', e);
                }
            }
            // Setup Auth and ensure signed-in (anonymous) so rules with request.auth != null pass
            if (!window._auth) {
                window._auth = firebase.auth();
            }
            if (!window._authReady) {
                window._authReady = new Promise((resolve) => {
                    const unsub = window._auth.onAuthStateChanged(async (user) => {
                        if (!user) {
                            try {
                                // Resolve credentials from window config or localStorage
                                let email = null, password = null;
                                if (window.FIREBASE_AUTH_USER && window.FIREBASE_AUTH_USER.email && window.FIREBASE_AUTH_USER.password) {
                                    email = window.FIREBASE_AUTH_USER.email;
                                    password = window.FIREBASE_AUTH_USER.password;
                                } else {
                                    try {
                                        email = localStorage.getItem('FIREBASE_EMAIL');
                                        password = localStorage.getItem('FIREBASE_PASSWORD');
                                    } catch(_) {}
                                }
                                if (email && password) {
                                    await window._auth.signInWithEmailAndPassword(email, password);
                                } else {
                                    await window._auth.signInAnonymously();
                                }
                            } catch (e) {
                                console.warn('Auto sign-in failed:', e);
                                // Fallback: prompt once for email/password if anonymous is disabled
                                if (!window._authPrompted) {
                                    window._authPrompted = true;
                                    try {
                                        const emailIn = window.prompt('Enter Firebase Auth email (or Cancel to skip):');
                                        if (emailIn) {
                                            const passIn = window.prompt('Enter password for ' + emailIn + ':');
                                            if (passIn) {
                                                await window._auth.signInWithEmailAndPassword(emailIn, passIn);
                                                try {
                                                    localStorage.setItem('FIREBASE_EMAIL', emailIn);
                                                    localStorage.setItem('FIREBASE_PASSWORD', passIn);
                                                } catch(_) {}
                                            }
                                        }
                                    } catch (e2) {
                                        console.warn('Prompt sign-in failed:', e2);
                                    }
                                }
                            }
                            // wait next onAuthStateChanged tick
                            return;
                        }
                        unsub();
                        resolve(user);
                    });
                });
            }

            // Firestore-backed db adapter matching existing API
            async function seedDefaultUsersIfMissing() {
                try {
                    if (!window._fs || !window._auth || !window._auth.currentUser) return;
                    const uid = window._auth.currentUser.uid;
                    const usersCol = window._fs.collection('users');

                    const adminId = 'U_ADMIN';
                    const sellerId = 'U_SELLER';

                    const adminSnap = await usersCol.doc(adminId).get();
                    if (!adminSnap.exists) {
                        await usersCol.doc(adminId).set({
                            id: adminId,
                            username: 'admin',
                            password: 'admin1234@#',
                            role: 'admin',
                            displayName: 'অ্যাডমিন',
                            profileImage: 'https://img.icons8.com/color/96/admin-settings-male.png',
                            createdBy: uid,
                            updatedAt: Date.now(),
                            phone: '018xxxxxxxx' // Added default phone
                        });
                    }

                    const sellerSnap = await usersCol.doc(sellerId).get();
                    if (!sellerSnap.exists) {
                        await usersCol.doc(sellerId).set({
                            id: sellerId,
                            username: 'seller',
                            password: 'seller1234@#',
                            role: 'seller',
                            displayName: 'বিক্রয়কর্মী',
                            profileImage: 'https://img.icons8.com/color/96/seller.png',
                            createdBy: uid,
                            updatedAt: Date.now(),
                            phone: '017xxxxxxxx' // Added default phone
                        });
                    }
                } catch (e) {
                    console.warn('Seeding default users failed:', e);
                }
            }

            // --- EXISTING FirebaseDB ADAPTER ---
            const FirebaseDB = {
                open: async () => { if (window._authReady) { await window._authReady; } await seedDefaultUsersIfMissing(); return undefined; },
                getAll: async (store) => {
                    try {
                        const snap = await window._fs.collection(store).get();
                        return snap.docs.map(d => d.data());
                    } catch (e) {
                        if (e && e.code === 'permission-denied') {
                            console.warn(`Permission denied reading collection ${store}; returning empty array`);
                            return [];
                        }
                        throw e;
                    }
                },
                get: async (store, key) => {
                    try {
                        const docId = (store === 'settings') ? (key || 'main') : key;
                        if (!docId) return null;
                        const ref = window._fs.collection(store).doc(docId);
                        const d = await ref.get();
                        return d.exists ? d.data() : null;
                    } catch (e) {
                        if (e && e.code === 'permission-denied') {
                            console.warn(`Permission denied reading doc in ${store}; returning null`);
                            return null;
                        }
                        throw e;
                    }
                },
                put: async (store, value) => {
                    // Check for the mock DB case where FirebaseDB is initialized with mocked DB methods 
                    // (Should not happen but safer to check)
                    // if (store === 'syncQueue') return undefined; // Never sync the queue itself to Firebase // REMOVED

                    const docId = (store === 'settings') ? 'main' : value && value.id;
                    if (!docId) throw new Error('put() requires value.id');
                    // Attach createdBy/updatedAt metadata if absent
                    const authUid = (window._auth && window._auth.currentUser) ? window._auth.currentUser.uid : null;
                    const payload = Object.assign({}, value);
                    if (authUid && !payload.createdBy) payload.createdBy = authUid;
                    payload.updatedAt = Date.now();
                    await window._fs.collection(store).doc(docId).set(payload, { merge: true });
                    return docId;
                },
                add: async (store, value) => {
                    // if (store === 'syncQueue') return undefined; // REMOVED
                    // Align with existing code where id is pre-generated
                    return FirebaseDB.put(store, value);
                },
                delete: async (store, key) => {
                    // if (store === 'syncQueue') return true; // REMOVED
                    if (!key) return;
                    await window._fs.collection(store).doc(key).delete();
                    return true;
                },
                clear: async (store) => {
                    // if (store === 'syncQueue') return true; // REMOVED
                    const snap = await window._fs.collection(store).get();
                    const batchSize = 250;
                    let docs = snap.docs;
                    while (docs.length) {
                        const chunk = docs.splice(0, batchSize);
                        const batch = window._fs.batch();
                        chunk.forEach(d => batch.delete(d.ref));
                        await batch.commit();
                    }
                    return true;
                }
            };

            // Override no-op db only if present and not already replaced
            if (typeof window.db !== 'undefined' && window.db && window.db.getAll && window.db.getAll.toString().includes('=> []')) {
                // Store the REAL Firebase implementation globally for our sync wrapper to use
                window._actualStorageDB = FirebaseDB;
                // DO NOT assign to window.db yet. The OfflineSyncDB wrapper will do it later.
                console.log('Firebase storage configured for sync wrapper.');
            }
        })();
    </script>
    <style>
        /* CSS Variables for consistent theming (DARK THEME) - (ORIGINAL) */
        :root {
            --primary-blue: #2563eb; /* Bright Blue */
            --light-blue: #3b82f6;   /* Lighter Bright Blue */
            --dark-blue: #1d4ed8;    /* Darker Bright Blue */
            --text-dark: #e5e7eb;    /* Light Gray for text */
            --text-light: #f9fafb; /* Very Light Gray */
            --bg-light: #0f172a;     /* Dark Slate Blue background */
            --card-bg: #1e293b;      /* Slightly lighter slate for cards */
            --border-color: #334155; /* Slate border color */
            --shadow-light: rgba(0,0,0,0.1);
            --shadow-medium: rgba(0,0,0,0.25);
        }

        /* Base Body Styles - (ORIGINAL) */
        html {
            scroll-behavior: smooth;
        }
        
        body {
            font-family: 'Noto Sans Bengali', 'Poppins', Arial, sans-serif;
            margin: 0;
            background-color: var(--bg-light);
            color: var(--text-dark);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Modern Slim Scrollbar for Main Content */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--primary-blue), var(--light-blue));
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, var(--light-blue), var(--primary-blue));
        }

        /* Firefox Scrollbar */
        * {
            scrollbar-width: thin;
            scrollbar-color: var(--primary-blue) rgba(0, 0, 0, 0.05);
        }

        /* --- NEW ADD-ON STYLES (2. Stock Alert) --- */
         .stock-alert-card {
            border-left: 5px solid #ef4444; /* Red for alerts */
            background: #401014;
            color: #e5e7eb;
            padding: 15px;
            margin-top: 10px;
            border-radius: 8px;
        }
         .stock-alert-card h4 {
            color: #fca5a5;
            margin-top: 0;
        }
         .stock-alert-card ul {
            list-style: none;
            padding-left: 0;
        }
         .stock-alert-card ul li {
            padding: 5px 0;
            border-bottom: 1px dotted #334155;
        }
         .stock-alert-card .low-stock-product-name {
            font-weight: 500;
            color: #fca5a5;
        }


        /* ... (The rest of the ORIGINAL CSS up to @media print) ... */

        #login-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 30px;
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 5px 15px var(--shadow-medium);
            text-align: center;
            border: 1px solid var(--border-color);
        }

        #login-form h2 {
            color: var(--text-light);
            margin-bottom: 25px;
            font-size: 28px;
        }

        #login-form input[type="text"],
        #login-form input[type="password"] {
            width: calc(100% - 20px);
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 16px;
            background-color: #2b3a4f;
            color: var(--text-light);
        }

        #login-form button {
            background-color: var(--primary-blue);
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 18px;
            width: 100%;
            transition: background-color 0.3s ease;
        }

        #login-form button:hover {
            background-color: var(--dark-blue);
        }

        .error-message {
            color: #ef4444;
            margin-top: 15px;
            font-size: 14px;
        }
        
        /* Modal styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7);
            display: flex; /* Use flexbox for centering */
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: var(--card-bg);
            padding: 25px 30px;
            border: 1px solid var(--border-color);
            width: 90%;
            max-width: 850px; /* Increased width for new ledger modal */
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 15px;
        }

        .close-button:hover,
        .close-button:focus {
            color: var(--text-light);
            text-decoration: none;
            cursor: pointer;
        }
        
        .modal-content h3 {
            margin-top: 0;
            color: var(--text-light);
        }
        
        .modal-content label {
            display: block;
            margin-top: 15px;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .modal-content input, .modal-content select {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border-radius: 5px;
            border: 1px solid var(--border-color);
            background-color: #2b3a4f;
            color: var(--text-light);
        }

        .modal-content button {
            margin-top: 20px;
        }

        #supplier-history-summary, #customer-ledger-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            background: rgba(15, 23, 42, 0.5); /* Darker transparent */
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        #supplier-history-summary p, #customer-ledger-summary p {
            margin: 0;
            font-size: 14px;
        }
        #supplier-history-summary span, #customer-ledger-summary span {
            display: block;
            font-size: 18px;
            font-weight: bold;
            color: var(--light-blue);
        }
        
        /* New Ledger Table Styles */
        .ledger-table-container {
            max-height: 45vh;
            overflow-y: auto;
            margin-top: 15px;
        }
        .ledger-table-container h4 {
            color: var(--text-light);
            border-bottom: 2px solid var(--light-blue);
            padding-bottom: 5px;
            margin-top: 20px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
        }
        .ledger-table-container h4 .table-total {
            font-size: 14px;
            font-weight: normal;
            background-color: var(--primary-blue);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
        }
        
        #supplier-history-table-body ul, #customer-ledger-table-body ul, .ledger-table-container ul {
            padding-left: 20px;
            margin: 5px 0;
            font-size: 13px;
        }

        .modal-filters {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            margin-bottom: 20px;
            background: #1a2435;
            padding: 15px;
            border-radius: 8px;
        }
        .modal-filters div {
            flex: 1;
        }
        .modal-filters label {
            margin: 0 0 5px 0;
            font-size: 14px;
        }
         .modal-filters input {
            padding: 6px;
            margin: 0;
        }

        /* App Layout */
        #app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Navigation */
        #sidebar {
            width: 250px;
            background-color: var(--card-bg);
            color: var(--text-light);
            padding: 20px 0;
            box-shadow: 2px 0 10px var(--shadow-light);
            display: flex;
            flex-direction: column;
            position: fixed;
            left: 0;
            top: 0;
            height: 100vh;
            max-height: 100vh;
            border-right: 1px solid var(--border-color);
            z-index: 1000;
            overflow: hidden;
        }

        /* Modern Slim Scrollbar Design */
        #sidebar ::-webkit-scrollbar {
            width: 4px;
        }

        #sidebar ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 2px;
        }

        #sidebar ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--primary-blue), var(--light-blue));
            border-radius: 2px;
        }

        #sidebar ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, var(--light-blue), var(--primary-blue));
        }

        /* Firefox Scrollbar */
        #sidebar {
            scrollbar-width: thin;
            scrollbar-color: var(--primary-blue) rgba(255, 255, 255, 0.05);
        }

        #sidebar .app-logo {
            text-align: center;
            margin-bottom: 30px;
        }

        #sidebar .app-logo img {
            width: 60px;
            height: 60px;
            margin-bottom: 10px;
        }

        #sidebar .app-logo h1 {
            margin: 0;
            font-size: 24px;
            color: white;
            font-weight: 700;
        }

        #sidebar nav {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 0 0 10px 0;
        }

        #sidebar nav ul {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        #sidebar nav ul li {
            margin-bottom: 5px;
        }

        #sidebar nav ul li a {
            display: flex;
            align-items: center;
            color: var(--text-light);
            text-decoration: none;
            padding: 12px 20px;
            transition: background-color 0.3s ease, color 0.3s ease;
            font-size: 16px;
        }

        #sidebar nav ul li a i {
            margin-right: 15px;
            font-size: 18px;
        }

        #sidebar nav ul li a:hover,
        #sidebar nav ul li a.active {
            background-color: var(--primary-blue);
            color: white;
            border-left: 5px solid white;
            padding-left: 15px;
        }

        /* Main Content Area */
        #main-content {
            flex-grow: 1;
            padding: 30px;
            background-color: var(--bg-light);
            margin-left: 250px; /* Account for fixed sidebar */
            min-height: 100vh;
        }

        /* Top Bar / Header */
        #topbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--bg-light);
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }

        #topbar h2 {
            margin: 0;
            font-size: 28px;
            color: var(--text-light);
            font-weight: 600;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-profile .user-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background-color: #e0e0e0;
            overflow: hidden;
            border: 2px solid var(--primary-blue);
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .user-profile .user-avatar:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(37, 99, 235, 0.5);
        }
        .user-profile .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-profile .user-info {
            text-align: right;
            font-size: 16px;
        }
        .user-profile .user-info p {
            margin: 0;
            color: var(--text-dark);
            font-weight: 500;
        }
        .user-profile .user-info span {
            font-size: 14px;
            color: #9ca3af; /* Lighter gray for subtext */
        }

        /* Header Logout Button */
        .header-logout-btn {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
        }
        .header-logout-btn:hover {
            background: linear-gradient(135deg, #c82333, #bd2130);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
        }
        .header-logout-btn i {
            font-size: 16px;
        }

        /* Section Styling */
        .app-section {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 3px 10px var(--shadow-light);
            margin-bottom: 30px;
            display: none; /* Hidden by default */
            border: 1px solid var(--border-color);
        }
        .app-section.active {
            display: block; /* Active section is shown */
        }

        .app-section h2 {
            color: var(--text-light);
            font-size: 24px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
        }
        .app-section h2 i {
            margin-right: 10px;
            color: var(--light-blue);
        }

        /* Dashboard Specific */
        .dashboard-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: linear-gradient(135deg, var(--primary-blue), var(--light-blue));
            color: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .summary-card:hover {
            transform: translateY(-5px);
        }
        .summary-card i {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 35px;
            opacity: 0.2;
            color: white;
        }
        .summary-card h3 {
            margin-top: 0;
            font-size: 16px;
            font-weight: 500;
            opacity: 0.8;
        }
        .summary-card p {
            font-size: 32px;
            font-weight: bold;
            margin: 10px 0 0;
        }

        .recent-activities, .quick-actions {
            margin-top: 30px;
        }
        .recent-activities h3, .quick-actions h3 {
            font-size: 20px;
            color: var(--text-light);
            margin-bottom: 15px;
        }
        .activity-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px dashed var(--border-color);
            font-size: 15px;
        }
        .activity-item:last-child {
            border-bottom: none;
        }
        .activity-item span:first-child {
            font-weight: 500;
        }
        .activity-item span:last-child {
            color: #9ca3af;
        }

        .quick-actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
        }
        .quick-action-card {
            background: #2a3a52; /* Darker blue for quick actions */
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.2s ease, background-color 0.2s ease;
        }
        .quick-action-card:hover {
            transform: translateY(-3px);
            background-color: #354866;
        }
        .quick-action-card i {
            font-size: 35px;
            color: var(--primary-blue);
            margin-bottom: 10px;
        }
        .quick-action-card h4 {
            margin: 0;
            font-size: 16px;
            color: var(--text-dark);
            font-weight: 500;
        }


        /* Forms and Inputs (General) */
        form label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #d1d5db; /* Lighter gray for labels */
            font-size: 15px;
        }

        form input[type="text"],
        form input[type="number"],
        form input[type="password"],
        form input[type="date"],
        form input[type="month"],
        form input[type="checkbox"],
        form select,
        form textarea {
            width: calc(100% - 24px); /* Account for padding and border */
            padding: 12px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 16px;
            box-sizing: border-box; /* Include padding/border in width */
            background-color: #2b3a4f;
            color: var(--text-light);
        }
        form input[type="number"] {
            appearance: textfield; /* Standard */
            -moz-appearance: textfield; /* Firefox */
        }
        form input[type="number"]::-webkit-outer-spin-button,
        form input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .form-checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        .form-checkbox-group input[type="checkbox"] {
            width: auto;
            margin: 0;
        }
        .form-checkbox-group label {
            margin: 0;
            font-weight: normal;
        }


        form button, .action-buttons button {
            background-color: #22c55e; /* Green for add/save */
            color: white;
            padding: 10px 18px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
            margin-right: 10px;
            transition: background-color 0.3s ease, transform 0.2s ease;
            white-space: nowrap; /* Prevent button text from wrapping */
        }
        form button:hover, .action-buttons button:hover {
            background-color: #16a34a;
            transform: translateY(-1px);
        }

        .cancel-btn {
            background-color: #64748b !important; /* Grey for cancel */
        }
        .cancel-btn:hover {
            background-color: #475569 !important;
        }

        .danger-btn {
            background-color: #ef4444 !important; /* Red for delete */
        }
        .danger-btn:hover {
            background-color: #dc2626 !important;
        }
        .edit-btn {
            background-color: #f59e0b !important; /* Yellow for edit */
            color: #1e293b !important;
        }
        .edit-btn:hover {
            background-color: #d97706 !important;
        }
        .info-btn {
            background-color: #3b82f6 !important; /* Info Blue */
        }
        .info-btn:hover {
            background-color: #2563eb !important;
        }
        .warning-btn {
            background-color: #f97316 !important; /* Orange for returns/warnings */
        }
        .warning-btn:hover {
            background-color: #ea580c !important;
        }

        .primary-btn { /* Use for main actions like add, save */
            background-color: var(--primary-blue) !important;
        }
        .primary-btn:hover {
            background-color: var(--dark-blue) !important;
        }


        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: var(--card-bg);
            border-radius: 8px;
            overflow: hidden; /* To apply border-radius to table */
        }

        table thead {
            background-color: #2c3e50;
            color: var(--text-light);
            font-weight: 600;
        }

        table th, table td {
            border: 1px solid var(--border-color);
            padding: 12px;
            text-align: left;
            font-size: 15px;
            vertical-align: middle;
        }
        table tbody tr:nth-child(even) {
            background-color: #1a2435;
        }
        table tbody tr:hover {
            background-color: #2b3a4f; /* Lighter hover for tables */
        }
        .table-action-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        .table-action-buttons button {
            padding: 6px 10px;
            font-size: 13px;
        }

        /* Product Grid */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .product-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 8px var(--shadow-light);
            transition: transform 0.2s ease;
        }
        .product-card:hover {
            transform: translateY(-3px);
        }

        .product-card img {
            max-width: 100%;
            height: 150px;
            object-fit: contain;
            margin-bottom: 10px;
            border-radius: 5px;
            background-color: white;
        }

        .product-card h3 {
            font-size: 18px;
            margin-top: 0;
            color: var(--text-light);
        }

        .product-card p {
            font-size: 15px;
            color: #d1d5db;
            margin-bottom: 5px;
        }
        .product-card .stock-info {
            font-weight: 600;
            color: var(--light-blue);
        }
        .product-card .print-actions {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            margin-top: 10px;
            margin-bottom: 5px;
        }
        .product-card .print-actions input {
            padding: 6px;
            width: 50px;
            text-align: center;
            margin: 0;
            border: 1px solid var(--border-color);
            background-color: #2b3a4f;
            color: var(--text-light);
        }
        .product-card .print-actions button {
            padding: 6px 10px;
            font-size: 13px;
        }


        .product-filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .product-filters input, .product-filters select {
            flex: 1;
            min-width: 150px;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background-color: #2b3a4f;
            color: var(--text-light);
        }


        /* POS Specific */
        .pos-input, .cart-summary, .report-filters, .setting-item, .ledger-entry-form, .customer-info-section, .bill-generator {
            margin-bottom: 25px;
            padding: 20px;
            background: #1a2435;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            box-shadow: 0 1px 5px var(--shadow-light);
        }
        
        /* NEW: Customer search results container in POS */
        .customer-search-results-pos {
            position: absolute;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            width: calc(100% - 40px); /* Adjust width as needed */
        }
        .customer-search-results-pos div {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
        }
        .customer-search-results-pos div:hover {
            background-color: #2b3a4f;
        }
        .customer-search-results-pos div:last-child {
            border-bottom: none;
        }


        .pos-input {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        .pos-input input, .pos-input select, .pos-input button {
            padding: 10px 15px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            font-size: 15px;
        }
        .pos-input input {
            flex-grow: 1;
        }
        .pos-input button {
            background-color: var(--primary-blue);
            color: white;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .pos-input button:hover {
            background-color: var(--dark-blue);
        }
        .search-results-container {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-top: 10px;
            background-color: var(--card-bg);
            box-shadow: 0 2px 5px var(--shadow-light);
        }
        .search-results-container div {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .search-results-container div:hover {
            background-color: #2b3a4f;
        }

        #pos-cart-table input[type="number"] {
            width: 70px;
            padding: 5px;
            margin: 0;
            font-size: 14px;
            text-align: center;
        }

        .cart-summary {
            font-size: 16px;
            font-weight: 500;
        }
        .cart-summary p {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .cart-summary span {
            font-weight: 700;
            color: var(--light-blue);
        }
        .cart-summary label {
            width: auto;
            margin-right: 10px;
        }
        .cart-summary input {
            width: 120px;
            display: inline-block;
            margin-bottom: 10px;
        }
        .cart-summary #customer-info-fields label,
        .cart-summary #customer-info-fields input {
            display: block;
            width: calc(100% - 24px);
        }


        /* Report Filters */
        .report-filters {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            flex-wrap: wrap;
        }
        .report-filters > div {
            flex: 1;
            min-width: 180px;
        }
        .report-filters label {
            margin-bottom: 5px;
        }
        .report-filters input, .report-filters select {
            width: 100%;
            margin-bottom: 0; /* Override default form margin */
        }
        .report-filters button {
            padding: 10px 20px;
            font-size: 16px;
            min-width: 100px;
            background-color: var(--primary-blue);
        }
        .report-filters button:hover {
            background-color: var(--dark-blue);
        }

        #sales-report-summary {
            background-color: #1a2435;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 5px solid var(--light-blue);
            font-size: 17px;
            font-weight: 600;
            color: var(--text-light);
        }
        #sales-report-summary span {
            color: var(--light-blue);
            font-size: 20px;
        }

        #sales-report-table ul {
            list-style: none;
            padding: 0;
            margin: 0;
            font-size: 13px;
            color: #d1d5db;
        }
        #sales-report-table ul li {
            margin-bottom: 3px;
        }
        #sales-report-table tr.return-row {
            background-color: #3f252b !important; /* Dark red for returns */
            color: #fca5a5;
        }
        #sales-report-table tr.return-row td {
            color: #fca5a5;
        }


        /* Dues Management */
        #dues-section p {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-light);
        }
        #dues-section p span {
            font-size: 22px;
        }

        /* Returns Management */
        .return-input {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .return-input input {
            flex-grow: 1;
            min-width: 200px;
            margin-bottom: 0;
        }
        .return-input button {
            background-color: var(--primary-blue);
            color: white;
            padding: 10px 15px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 15px;
        }
        .return-input button:hover {
            background-color: var(--dark-blue);
        }

        #return-details-container h3, #return-details-container h4 {
            color: var(--text-light);
            margin-top: 20px;
            margin-bottom: 10px;
            font-size: 20px;
        }
        #return-details-container p {
            font-size: 16px;
            margin-bottom: 5px;
        }
        #return-details-container span {
            font-weight: 600;
            color: var(--light-blue);
        }
        #return-items-table input[type="number"] {
            width: 60px;
            padding: 5px;
            text-align: center;
            margin: 0;
        }
        #process-return-btn {
            background-color: #22c55e;
            margin-top: 20px;
            padding: 12px 20px;
            font-size: 16px;
            border-radius: 6px;
        }
        #process-return-btn:hover {
            background-color: #16a34a;
        }

        /* User Management */
        #add-user-form-container {
            margin-top: 20px;
            padding: 20px;
            background: #1a2435;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            box-shadow: 0 1px 5px var(--shadow-light);
        }
        #add-user-form-container h3 {
            color: var(--text-light);
            margin-top: 0;
            margin-bottom: 15px;
        }
        #add-customer-form-container, #add-isp-customer-form-container, #add-service-customer-form-container { /* Customer form */
            margin-top: 20px;
            padding: 20px;
            background: #1a2435;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            box-shadow: 0 1px 5px var(--shadow-light);
        }


        /* Settings */
        .setting-item {
            margin-bottom: 25px;
            padding: 20px;
            background: #1a2435;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            box-shadow: 0 1px 5px var(--shadow-light);
        }
        .setting-item h3 {
            color: var(--text-light);
            margin-top: 0;
            margin-bottom: 15px;
        }
        .setting-item p { /* Added for messages within settings */
            margin-bottom: 15px;
            color: #d1d5db;
            font-size: 15px;
        }
        .setting-item button { /* Added for consistency */
            margin-right: 10px;
            margin-top: 10px;
        }


        /* Ledger Section (New) */
        .ledger-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .ledger-summary .summary-card {
            background: linear-gradient(135deg, var(--primary-blue), var(--light-blue)); /* Blue gradient */
        }
        .ledger-summary .summary-card.expense {
            background: linear-gradient(135deg, #f97316, #ea580c); /* Orange gradient */
        }
        .ledger-entry-form {
            margin-top: 20px;
            padding: 20px;
            background: #1a2435;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            box-shadow: 0 1px 5px var(--shadow-light);
        }
        .ledger-entry-form h3 {
            color: var(--text-light);
            margin-top: 0;
            margin-bottom: 15px;
        }
        .ledger-filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: flex-end;
        }
        .ledger-filters input[type="date"], .ledger-filters select {
            flex: 1;
            min-width: 150px;
            margin-bottom: 0;
        }
        .ledger-filters button {
            padding: 10px 15px;
            font-size: 15px;
        }
        
        /* Bank Module Styles */
        .bank-management-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
        }
        .bank-management-grid .bank-setup-form {
            background: #1a2435;
            padding: 20px;
            border-radius: 10px;
        }
        .bank-management-grid .bank-list-container {
             background: #1a2435;
            padding: 20px;
            border-radius: 10px;
        }
        .bank-management-grid .bank-list-container h3 {
            margin-top: 0;
        }
         .bank-transaction-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }


        /* Customer Data Section */
        .customer-search-input {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .customer-search-input input {
            flex-grow: 1;
            min-width: 200px;
            margin-bottom: 0;
        }
        .customer-search-results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .customer-search-results-table th, .customer-search-results-table td {
            border: 1px solid var(--border-color);
            padding: 10px;
            text-align: left;
        }
        .customer-search-results-table th {
            background-color: #2c3e50;
        }
        .customer-purchase-history-details {
            margin-top: 25px;
            padding: 20px;
            background: #1a2435;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            box-shadow: 0 1px 5px var(--shadow-light);
        }
        .customer-purchase-history-details h3 {
            color: var(--text-light);
            margin-top: 0;
            margin-bottom: 15px;
        }
        .customer-purchase-history-details p {
            margin-bottom: 8px;
            font-size: 16px;
        }
        .customer-purchase-history-details span {
            font-weight: 600;
            color: var(--light-blue);
        }
        
         /* Manual Due Form */
        #add-manual-due-form-container {
             margin-top: 20px;
            padding: 20px;
            background: #1a2435;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            box-shadow: 0 1px 5px var(--shadow-light);
        }
        #add-manual-due-form-container h3 {
            color: var(--text-light);
            margin-top: 0;
            margin-bottom: 15px;
        }


        /* Print Styles */
        @media print {
            body * {
                visibility: hidden;
            }
            #print-area, #print-area * {
                visibility: visible;
                color: #000 !important;
                font-weight: 600 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            #print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: auto;
                padding: 20px;
                box-sizing: border-box;
                background: white;
                font-family: 'Noto Sans Bengali', Arial, sans-serif;
            }
            /* New Print Style for multiple labels */
             #print-area.barcode-label-print-multiple {
                padding: 0;
                width: 100%; 
                height: auto;
                font-size: 8px;
                overflow: visible;
                display: flex;
                flex-wrap: wrap;
                justify-content: flex-start;
                align-items: flex-start;
            }

            #print-area.barcode-label-print-multiple .single-barcode-label {
                width: 40mm !important; /* Fixed width, adjust as needed */
                height: 25mm !important; /* Fixed height, adjust as needed */
                box-sizing: border-box;
                border: 1px solid #000 !important;
                margin: 1mm; /* Small margin for cutting */
                padding: 2px;
                display: block;
                page-break-inside: avoid;
                float: left; /* Helps layout */
                color: black !important;
                background: white !important;
            }
            #print-area.barcode-label-print-multiple .single-barcode-label * {
                visibility: visible;
                color: black !important;
                background: white !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            #print-area.barcode-label-print-multiple .single-barcode-label svg {
                max-width: 100% !important;
                height: auto !important;
            }
            /* End New Print Style */


            #print-area h2, #print-area h3, #print-area h4, #print-area p, #print-area table, #print-area img {
                visibility: visible;
                color: black !important;
            }
            #print-area h2 { text-align: center; margin-bottom: 5px; font-size: 22px;}
            #print-area h3 { text-align: center; font-size: 18px; margin-bottom: 10px; }
            #print-area h4 { border-bottom: 1px solid #ccc; padding-bottom: 5px; margin-top: 15px; font-size: 16px;}
            #print-area p { margin: 2px 0; font-size: 14px;}
            #print-area table {
                border-collapse: collapse;
                width: 100%;
                margin-top: 10px;
            }
            #print-area th, #print-area td {
                border: 1px solid black !important;
                padding: 8px;
                text-align: left;
                font-size: 13px;
            }
            #print-area .table-total-print {
                text-align: right;
                font-weight: bold;
            }
            #print-area hr { border: 0; border-top: 1px dashed #ccc; margin: 10px 0; }
        }
    </style>
</head>
<body>
    <!-- 1. Loading System: Full-page Loader Overlay -->
    <div id="full-page-loader" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.95); z-index: 2000; display: none; justify-content: center; align-items: center; flex-direction: column; color: white;">
        <i class="fas fa-spinner fa-spin fa-3x" style="color: var(--primary-blue);"></i>
        <h3 style="margin-top: 15px; color: var(--text-light);">ডেটা লোড হচ্ছে...</h3>
        <p style="font-size: 14px;">অনুগ্রহ করে অপেক্ষা করুন</p>
    </div>

    <div id="login-container">
        <h2>লগইন করুন</h2>
        <form id="login-form">
            <input type="text" id="username" placeholder="ইউজারনেম" required>
            <input type="password" id="password" placeholder="পাসওয়ার্ড" required>
            <button type="submit">লগইন</button>
            <p id="login-error-message" class="error-message"></p>
        </form>
    </div>

    <div id="app-container" style="display:none;">
        <div id="sidebar">
            <div class="app-logo">
                <img src="https://optaposdubai.com/wp-content/uploads/2020/01/optapos-retail-software-logo.png?6bfec1&6bfec1" alt="Logo">
                <h1 id="sidebar-app-title">MY POS SOF</h1>
            </div>
            <nav>
                <ul id="main-nav-ul">
                    <li id="nav-dashboard"><a href="#" data-section="dashboard"><i class="fas fa-th-large"></i> ড্যাশবোর্ড</a></li>
                    <li id="nav-pos"><a href="#" data-section="pos"><i class="fas fa-cash-register"></i> বিক্রয় (POS)</a></li>
                    <li id="nav-products"><a href="#" data-section="products"><i class="fas fa-tshirt"></i> পণ্যসমূহ</a></li>
                    <li id="nav-suppliers"><a href="#" data-section="suppliers"><i class="fas fa-truck"></i> সাপ্লায়ার</a></li>
                    <li id="nav-sales"><a href="#" data-section="sales"><i class="fas fa-chart-line"></i> বিক্রয় রিপোর্ট</a></li>
                    <li id="nav-dues"><a href="#" data-section="dues"><i class="fas fa-money-bill-wave"></i> কাস্টমার বাকি</a></li>
                    <!-- New Menu Item for Manual Due Entry -->
                    <li id="nav-manual-dues"><a href="#" data-section="manual-dues"><i class="fas fa-clipboard-list"></i> বাকি এন্ট্রি</a></li> 
                    <li id="nav-returns"><a href="#" data-section="returns"><i class="fas fa-undo-alt"></i> ফেরত পণ্য</a></li>
                    <!-- Ledger is now Cash Ledger -->
                    <li id="nav-ledger"><a href="#" data-section="ledger"><i class="fas fa-money-check-alt"></i> Cash Ledger</a></li> 
                     <!-- NEW: Bank Module (Consolidated Finance) -->
                    <li id="nav-finance"><a href="#" data-section="finance"><i class="fas fa-university"></i> Bank Module</a></li>
                    <!-- NEW: Expense Report -->
                    <li id="nav-expenses"><a href="#" data-section="expenses"><i class="fas fa-file-invoice-dollar"></i> Expense Report</a></li> 

                    <li id="nav-customer-data"><a href="#" data-section="customer-data"><i class="fas fa-address-book"></i> কাস্টমার ডেটা</a></li>
                    <li id="nav-customer-management"><a href="#" data-section="customer-management"><i class="fas fa-users"></i> কাস্টমার</a></li>
                     <!-- 4. Sales & Profit Report System - Granular Reports Link -->
                    <li id="nav-granular-reports"><a href="#" data-section="granular-reports"><i class="fas fa-search-dollar"></i> উন্নত রিপোর্ট</a></li> 
                    <li id="nav-users"><a href="#" data-section="users"><i class="fas fa-users"></i> ব্যবহারকারী</a></li>
                    <!-- ✅ NEW: Daily Transaction Report Menu -->
                    <li id="nav-daily-transaction"><a href="#" data-section="daily-transaction"><i class="fas fa-calendar-day"></i> Daily Transaction Report</a></li>
                    <li id="nav-settings"><a href="#" data-section="settings"><i class="fas fa-cogs"></i> সেটিংস</a></li>
                </ul>
            </nav>
        </div>

        <div id="main-content">
            <div id="topbar">
                <h2 id="current-section-title">ড্যাশবোর্ড</h2>
                <div class="user-profile">
                    <div class="user-info">
                        <p><span id="greeting-text">শুভ সকাল,</span> <span id="current-user-display-name"></span>!</p>
                    </div>
                    <div class="user-avatar" id="user-avatar-display">
                        <img id="profile-img" src="https://img.icons8.com/officel/80/null/user.png" alt="User Avatar">
                    </div>
                    <!-- ✅ NEW: Header Logout Button -->
                    <button id="logout-btn" class="header-logout-btn">
                        <i class="fas fa-sign-out-alt"></i> লগআউট
                    </button>
                </div>
            </div>

            <section id="dashboard-section" class="app-section active">
                <h2><i class="fas fa-th-large"></i> ড্যাশবোর্ড</h2>
                
                <!-- 1. Offline + Sync System - Offline Status Bar (REMOVED) -->

                <div class="dashboard-summary">
                    <!-- Existing summary cards -->
                    <div class="summary-card">
                        <i class="fas fa-hand-holding-usd"></i>
                        <h3>আজকের নিট বিক্রি</h3>
                        <p id="today-total-sales">৳ 0</p>
                    </div>
                    <div class="summary-card">
                        <i class="fas fa-boxes"></i>
                        <h3>মোট স্টক আইটেম</h3>
                        <p id="total-stock-items">0</p>
                    </div>
                    <div class="summary-card">
                        <i class="fas fa-coins"></i>
                        <h3>কাস্টমারের মোট বকেয়া</h3>
                        <p id="total-dues">৳ 0</p>
                    </div>
                    <div class="summary-card" style="background: linear-gradient(135deg, #c82333, #dc3545);">
                        <i class="fas fa-truck-loading"></i>
                        <h3>সাপ্লায়ারের মোট বকেয়া</h3>
                        <p id="total-supplier-dues">৳ 0</p>
                    </div>
                </div>
                
                 <!-- NEW: Cash/Bank Balance Summary -->
                <div class="dashboard-summary">
                    <div class="summary-card" style="background: linear-gradient(135deg, #10b981, #059669);">
                        <i class="fas fa-money-bill"></i>
                        <h3>হাতে থাকা Cash (Ledger)</h3>
                        <p id="total-cash-balance">৳ 0</p>
                    </div>
                    <div class="summary-card" style="background: linear-gradient(135deg, #60a5fa, #3b82f6);">
                        <i class="fas fa-university"></i>
                        <h3>মোট ব্যাংক ব্যালেন্স</h3>
                        <p id="total-bank-balance">৳ 0</p>
                    </div>
                    <div class="summary-card" style="background: linear-gradient(135deg, #f97316, #ea580c);">
                        <i class="fas fa-wallet"></i>
                        <h3>মোট Expense (এই মাসে)</h3>
                        <p id="current-month-total-expense">৳ 0</p>
                    </div>
                    <div class="summary-card" style="background: linear-gradient(135deg, #6d28d9, #4c1d95);">
                         <i class="fas fa-percent"></i>
                        <h3>প্রবণতা (Trend)</h3>
                        <p id="forecast-trend-display">N/A</p>
                    </div>
                </div>

                <!-- 5. Sales Forecast System - Dashboard Widget -->
                <div class="dashboard-summary">
                    <div class="summary-card" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                        <i class="fas fa-arrow-up"></i>
                        <h3>পরবর্তী মাসের আনুমানিক বিক্রয়</h3>
                        <p id="forecast-next-month-sale">৳ 0</p>
                        <span id="forecast-basis" style="font-size: 12px; font-weight: 500;">(গত ৩ মাসের গড়)</span>
                    </div>
                     <div class="summary-card" style="background: linear-gradient(135deg, #10b981, #059669);">
                        <i class="fas fa-dollar-sign"></i>
                        <h3>আনুমানিক লাভ</h3>
                        <p id="forecast-next-month-profit">৳ 0</p>
                    </div>
                    <div class="summary-card" style="background: linear-gradient(135deg, #0f4f5a, #033c46);">
                        <i class="fas fa-box"></i>
                        <h3>অনুমানিত শীর্ষ পণ্য</h3>
                        <p id="forecast-top-product">N/A</p>
                    </div>
                     <div class="summary-card" style="background: linear-gradient(135deg, #6d28d9, #4c1d95);">
                         <i class="fas fa-percent"></i>
                        <h3>প্রবণতা (Trend)</h3>
                        <p id="forecast-trend-display-hidden" style="display:none;">N/A</p>
                    </div>
                </div>

                <!-- 2. Stock Alert System - Dashboard Alert Box -->
                <div class="recent-activities stock-alert-card">
                    <h3><i class="fas fa-exclamation-triangle"></i> কম স্টক সতর্কতা (<span id="low-stock-count">0</span>)</h3>
                    <div id="stock-alerts-list">
                         <p>সব পণ্য পর্যাপ্ত পরিমাণে স্টকে আছে।</p>
                    </div>
                </div>
                
                <div class="recent-activities">
                    <h3>সাম্প্রতিক কার্যক্রম</h3>
                    <div id="recent-activities-list">
                        </div>
                </div>
                <div class="quick-actions">
                    <h3>দ্রুত একশন</h3>
                    <div class="quick-actions-grid">
                        <div class="quick-action-card" onclick="showSection('pos')">
                            <i class="fas fa-plus-circle"></i>
                            <h4>নতুন বিক্রি</h4>
                        </div>
                        <div class="quick-action-card" onclick="showSection('products')">
                            <i class="fas fa-box-open"></i>
                            <h4>পণ্য যোগ করুন</h4>
                        </div>
                        <div class="quick-action-card">
                            <!-- 6. Alert System - Quick Action Trigger -->
                            <i class="fas fa-paper-plane"></i>
                            <h4><a href="#" style="color: inherit;" onclick="event.preventDefault(); window.promptForCustomerAlert();">কাস্টমারকে মেসেজ</a></h4> 
                        </div>
                        <div class="quick-action-card" onclick="showSection('suppliers')">
                            <i class="fas fa-user-plus"></i>
                            <h4>সাপ্লায়ার</h4>
                        </div>
                    </div>
                </div>
            </section>

            <section id="products-section" class="app-section">
                <h2><i class="fas fa-tshirt"></i> পণ্যসমূহ</h2>
                
                <!-- ✅ NEW: All Products Stock Report System -->
                <div class="stock-report-section" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(124, 58, 237, 0.05)); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 12px; padding: 20px; margin-bottom: 25px;">
                    <h3 style="margin-top: 0; color: #8b5cf6;"><i class="fas fa-boxes"></i> সব পণ্যের স্টক রিপোর্ট</h3>
                    <p style="font-size: 14px; color: #94a3b8; margin-bottom: 15px;">সব পণ্যের স্টক মুভমেন্ট, ঢোকা-বের হওয়া এবং বর্তমান স্টক দেখুন</p>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 10px; align-items: end; margin-bottom: 15px;">
                        <div>
                            <label for="stock-report-from-date" style="display: block; margin-bottom: 5px; font-size: 14px; color: #cbd5e1;">শুরুর তারিখ:</label>
                            <input type="date" id="stock-report-from-date" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--card-bg); color: var(--text-light);">
                        </div>
                        <div>
                            <label for="stock-report-to-date" style="display: block; margin-bottom: 5px; font-size: 14px; color: #cbd5e1;">শেষ তারিখ:</label>
                            <input type="date" id="stock-report-to-date" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--card-bg); color: var(--text-light);">
                        </div>
                        <div>
                            <button id="generate-stock-report-btn" class="primary-btn" style="width: 100%; background: linear-gradient(135deg, #8b5cf6, #7c3aed);"><i class="fas fa-search"></i> স্টক রিপোর্ট দেখুন</button>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button id="print-stock-summary-btn" class="primary-btn" style="background: linear-gradient(135deg, #10b981, #059669); flex: 1; min-width: 150px;"><i class="fas fa-print"></i> স্টক সারাংশ প্রিন্ট</button>
                        <button id="print-stock-movement-btn" class="primary-btn" style="background: linear-gradient(135deg, #f59e0b, #d97706); flex: 1; min-width: 150px;"><i class="fas fa-file-alt"></i> স্টক মুভমেন্ট রিপোর্ট প্রিন্ট</button>
                        <button id="clear-stock-report-btn" class="cancel-btn" style="flex: 1; min-width: 150px;"><i class="fas fa-times"></i> ক্লিয়ার</button>
                    </div>
                </div>
                
                <!-- Stock Report Display -->
                <div id="stock-report-display" style="display: none; margin-bottom: 25px;">
                    <!-- Grand Summary Cards -->
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
                        <div style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(37, 99, 235, 0.1)); padding: 15px; border-radius: 10px; border: 1px solid rgba(59, 130, 246, 0.3); text-align: center;">
                            <div style="font-size: 12px; color: #94a3b8; margin-bottom: 5px;">মোট পণ্য</div>
                            <div id="stock-report-total-products" style="font-size: 24px; font-weight: bold; color: #60a5fa;">0</div>
                        </div>
                        <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.1)); padding: 15px; border-radius: 10px; border: 1px solid rgba(16, 185, 129, 0.3); text-align: center;">
                            <div style="font-size: 12px; color: #94a3b8; margin-bottom: 5px;">মোট স্টক ঢুকেছে</div>
                            <div id="stock-report-total-in" style="font-size: 24px; font-weight: bold; color: #34d399;">0</div>
                        </div>
                        <div style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(217, 119, 6, 0.1)); padding: 15px; border-radius: 10px; border: 1px solid rgba(245, 158, 11, 0.3); text-align: center;">
                            <div style="font-size: 12px; color: #94a3b8; margin-bottom: 5px;">মোট স্টক বের হয়েছে</div>
                            <div id="stock-report-total-out" style="font-size: 24px; font-weight: bold; color: #fbbf24;">0</div>
                        </div>
                        <div style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(124, 58, 237, 0.1)); padding: 15px; border-radius: 10px; border: 1px solid rgba(139, 92, 246, 0.3); text-align: center;">
                            <div style="font-size: 12px; color: #94a3b8; margin-bottom: 5px;">বর্তমান মোট স্টক</div>
                            <div id="stock-report-current-total" style="font-size: 24px; font-weight: bold; color: #a78bfa;">0</div>
                        </div>
                    </div>
                    
                    <!-- Products Stock Table -->
                    <div style="background: var(--card-bg); border-radius: 10px; padding: 20px; border: 1px solid var(--border-color);">
                        <h4 style="margin-top: 0; margin-bottom: 15px; color: #8b5cf6;"><i class="fas fa-list-alt"></i> সব পণ্যের স্টক সারাংশ</h4>
                        <div style="overflow-x: auto; max-height: 500px; overflow-y: auto;">
                            <table id="stock-report-table" style="width: 100%; border-collapse: collapse;">
                                <thead style="position: sticky; top: 0; background: var(--card-bg); z-index: 10;">
                                    <tr style="background: rgba(139, 92, 246, 0.2);">
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid var(--border-color);">#</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid var(--border-color);">পণ্যের নাম</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid var(--border-color);">ক্যাটাগরি</th>
                                        <th style="padding: 12px; text-align: right; border-bottom: 2px solid var(--border-color);">স্টক ঢুকেছে</th>
                                        <th style="padding: 12px; text-align: right; border-bottom: 2px solid var(--border-color);">স্টক বের হয়েছে</th>
                                        <th style="padding: 12px; text-align: right; border-bottom: 2px solid var(--border-color);">বর্তমান স্টক</th>
                                        <th style="padding: 12px; text-align: center; border-bottom: 2px solid var(--border-color);">স্ট্যাটাস</th>
                                    </tr>
                                </thead>
                                <tbody id="stock-report-tbody">
                                    <!-- Dynamic content -->
                                </tbody>
                                <tfoot style="position: sticky; bottom: 0; background: var(--card-bg); font-weight: bold;">
                                    <tr style="background: rgba(139, 92, 246, 0.3);">
                                        <td colspan="3" style="padding: 12px; text-align: right; border-top: 2px solid var(--border-color);">সর্বমোট:</td>
                                        <td id="stock-report-footer-in" style="padding: 12px; text-align: right; border-top: 2px solid var(--border-color); color: #34d399; font-size: 16px;">0</td>
                                        <td id="stock-report-footer-out" style="padding: 12px; text-align: right; border-top: 2px solid var(--border-color); color: #fbbf24; font-size: 16px;">0</td>
                                        <td id="stock-report-footer-current" style="padding: 12px; text-align: right; border-top: 2px solid var(--border-color); color: #a78bfa; font-size: 16px;">0</td>
                                        <td style="padding: 12px; border-top: 2px solid var(--border-color);"></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        <div id="stock-report-empty" style="text-align: center; padding: 30px; color: #94a3b8; display: none;">
                            <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 10px;"></i>
                            <p>কোনো পণ্য পাওয়া যায়নি</p>
                        </div>
                    </div>
                </div>

                <button id="add-product-btn" class="primary-btn"><i class="fas fa-plus"></i> নতুন পণ্য যোগ করুন</button>
                <div id="add-product-form-container" style="display:none;" class="app-section">
                    <h3><i class="fas fa-edit"></i> পণ্য যোগ/সম্পাদনা</h3>
                    <form id="add-product-form">
                        <label for="product-name">পণ্যের নাম:</label>
                        <input type="text" id="product-name" required>
                        
                        <label for="product-category">ক্যাটাগরি:</label>
                        <input type="text" id="product-category" placeholder="ক্যাটাগরি লিখুন বা নির্বাচন করুন" list="category-list" required>
                        <datalist id="category-list">
                            <option value="শার্ট"></option>
                            <option value="প্যান্ট"></option>
                            <option value="টি-শার্ট"></option>
                            <option value="জুতা"></option>
                            <option value="আনুষাঙ্গিক"></option>
                        </datalist>

                        <label for="product-serial">পন্যের S/N (স্বয়ংক্রিয়ভাবে তৈরি হবে):</label>
                        <input type="text" id="product-serial" placeholder="সিরিয়াল নম্বর" readonly>

                        <label for="product-unit">ইউনিট / প্যাকেজিং:</label>
                        <input type="text" id="product-unit" placeholder="ইউনিট লিখুন বা নির্বাচন করুন" list="unit-list" required>
                        <datalist id="unit-list">
                            <option value="পিস"></option>
                            <option value="জোড়া"></option>
                            <option value="মিটার"></option>
                            <option value="বক্স"></option>
                        </datalist>

                        <label for="product-stock">স্টক:</label>
                        <input type="number" id="product-stock" value="0" min="0" required>
                        
                        <!-- 2. Stock Alert System - NEW UI Field -->
                        <label for="product-min-stock">কম স্টক সতর্কতা (Min Stock) এর পরিমাণ:</label>
                        <input type="number" id="product-min-stock" value="5" min="0">
                        
                        <label for="product-purchase-price">ক্রয় মূল্য (৳):</label>
                        <input type="number" id="product-purchase-price" step="0.01" min="0" value="0" required>
                        
                        <label for="product-price">বিক্রয় মূল্য (৳):</label>
                        <input type="number" id="product-price" step="0.01" min="0" value="0" required>
                        
                        <label for="product-description">পণ্যের বিবরণ:</label>
                        <textarea id="product-description" rows="3" placeholder="পণ্যের বিস্তারিত বিবরণ লিখুন"></textarea>
                        
                        <hr style="margin: 20px 0;">
                        <h4 style="color: var(--primary-blue);"><i class="fas fa-truck"></i> সাপ্লায়ারের তথ্য</h4>
                        
                        <label for="product-supplier-name">সাপ্লায়ারের নাম:</label>
                        <input type="text" id="product-supplier-name" placeholder="সাপ্লায়ারের নাম" list="supplier-name-list">
                        <datalist id="supplier-name-list"></datalist>
                        
                        <label for="product-supplier-phone">সাপ্লায়ারের ফোন নম্বর:</label>
                        <input type="text" id="product-supplier-phone" placeholder="সাপ্লায়ারের ফোন নম্বর">
                        
                        <label for="product-supplier-address">সাপ্লায়ারের ঠিকানা:</label>
                        <textarea id="product-supplier-address" rows="2" placeholder="সাপ্লায়ারের ঠিকানা"></textarea>
                        
                        <label for="product-purchase-type">ক্রয়ের ধরণ:</label>
                        <select id="product-purchase-type">
                            <option value="cash">নগদ</option>
                            <option value="due">বাকি</option>
                        </select>
                        
                        <hr style="margin: 20px 0;">

                        <label for="product-image">ছবি URL (ঐচ্ছিক):</label>
                        <input type="text" id="product-image" placeholder="https://example.com/image.jpg">
                        
                        <button type="submit" class="primary-btn"><i class="fas fa-save"></i> সংরক্ষণ করুন</button>
                        <button type="button" class="cancel-btn"><i class="fas fa-times"></i> বাতিল করুন</button>
                    </form>
                </div>

                <h3><i class="fas fa-list"></i> সকল পণ্য</h3>
                <div class="product-filters">
                    <!-- SN সার্চ সহ আপডেট -->
                    <input type="text" id="product-search" placeholder="পণ্য খুঁজুন (নাম, ID, S/N বা বারকোড)...">
                    <select id="product-category-filter">
                        <option value="">সকল ক্যাটাগরি</option>
                        </select>
                </div>
                <div id="product-list" class="product-grid">
                    </div>
            </section>
            
            <section id="suppliers-section" class="app-section">
                <h2><i class="fas fa-truck"></i> সাপ্লায়ার ব্যবস্থাপনা</h2>
                <button id="add-supplier-btn" class="primary-btn"><i class="fas fa-plus"></i> নতুন সাপ্লায়ার যোগ করুন</button>
                <div id="add-supplier-form-container" style="display:none;" class="app-section">
                    <h3><i class="fas fa-user-tie"></i> সাপ্লায়ার যোগ/সম্পাদনা</h3>
                    <form id="add-supplier-form">
                        <label for="supplier-name">সাপ্লায়ারের নাম:</label>
                        <input type="text" id="supplier-name" required>
                        
                        <label for="supplier-phone">ফোন নম্বর:</label>
                        <input type="text" id="supplier-phone">
                        
                        <label for="supplier-address">ঠিকানা:</label>
                        <textarea id="supplier-address" rows="3"></textarea>
                        
                        <label for="supplier-details">বিস্তারিত:</label>
                        <textarea id="supplier-details" rows="3" placeholder="অন্যান্য তথ্য..."></textarea>
                        
                        <button type="submit" class="primary-btn"><i class="fas fa-save"></i> সংরক্ষণ করুন</button>
                        <button type="button" class="cancel-btn"><i class="fas fa-times"></i> বাতিল করুন</button>
                    </form>
                </div>

                <h3><i class="fas fa-list"></i> সকল সাপ্লায়ার</h3>
                <table id="supplier-list-table">
                    <thead>
                        <tr>
                            <th>নাম</th>
                            <th>ফোন</th>
                            <th>মোট ক্রয়</th>
                            <th>মোট পরিশোধ</th>
                            <th>বর্তমান বাকি</th>
                            <th>একশন</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </section>

            <section id="pos-section" class="app-section">
                <h2><i class="fas fa-cash-register"></i> বিক্রয় পয়েন্ট (POS)</h2>
                <div class="customer-info-section">
                    <h3><i class="fas fa-user"></i> কাস্টমার তথ্য</h3>
                    <div style="position: relative;">
                        <label for="pos-customer-phone">কাস্টমার মোবাইল নম্বর:</label>
                        <input type="text" id="pos-customer-phone" placeholder="মোবাইল নম্বর লিখুন..." autocomplete="off">
                        <div id="pos-customer-phone-search-results" class="customer-search-results-pos" style="display:none;"></div>
                    </div>
                    <div style="position: relative;">
                        <label for="pos-customer-name">কাস্টমার নাম:</label>
                        <input type="text" id="pos-customer-name" placeholder="কাস্টমার নাম..." autocomplete="off">
                        <div id="pos-customer-name-search-results" class="customer-search-results-pos" style="display:none;"></div>
                    </div>
                    <label for="pos-customer-address">কাস্টমার ঠিকানা:</label>
                    <textarea id="pos-customer-address" placeholder="কাস্টমার ঠিকানা"></textarea>
                    <button id="clear-customer-fields" class="cancel-btn"><i class="fas fa-eraser"></i> কাস্টমার তথ্য সাফ করুন</button>
                </div>


                <div class="pos-input">
                    <!-- বারকোড স্ক্যানিং এর জন্য ইনপুট -->
                    <input type="text" id="pos-product-search" placeholder="পণ্য খুঁজুন (নাম, ID, S/N বা স্ক্যান বারকোড)">
                    <button id="pos-add-to-cart-btn"><i class="fas fa-cart-plus"></i> কার্টে যোগ করুন</button>
                </div>
                <div id="search-results-container" class="search-results-container">
                    </div>

                <h3><i class="fas fa-shopping-cart"></i> বিক্রয় কার্ট</h3>
                <table id="pos-cart-table">
                    <thead>
                        <tr>
                            <th>বিবরণ</th>
                            <th>পরিমাণ</th>
                            <th>একক মূল্য</th>
                            <th>মোট</th>
                            <th>একশন</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
                <div class="cart-summary">
                    <p>মোট কার্ট মূল্য: <span id="cart-subtotal">৳ 0</span></p>
                    <label for="discount-amount">ডিসকাউন্ট (৳):</label>
                    <input type="number" id="discount-amount" value="0" min="0">
                    <p> চূড়ান্ত মূল্য: <span id="cart-final-total">৳ 0</span></p>
                </div>

                <h3><i class="fas fa-money-check-alt"></i> পেমেন্ট</h3>
                <form id="pos-payment-form">
                    <label for="payment-method">পেমেন্টের ধরণ:</label>
                    <select id="payment-method" required>
                        <option value="cash">নগদ (Ledger)</option>
                        <option value="bank">ব্যাংক</option>
                        <option value="due">বাকিতে</option>
                    </select>
                    <!-- NEW: Bank Select for POS -->
                    <div id="pos-bank-select-container" style="display:none; margin-bottom: 20px;">
                        <label for="pos-bank-select">ব্যাংক নির্বাচন করুন:</label>
                        <select id="pos-bank-select"></select>
                    </div>

                    <button type="submit" id="complete-sale-btn" class="primary-btn"><i class="fas fa-check-circle"></i> বিক্রয় সম্পন্ন করুন</button>
                    <button type="button" id="cancel-sale-edit-btn" style="display:none;" class="cancel-btn"><i class="fas fa-times"></i> সম্পাদনা বাতিল করুন</button>
                    <button type="button" id="print-bill-btn" style="display:none;" class="primary-btn"><i class="fas fa-print"></i> বিল প্রিন্ট করুন</button>
                </form>
            </section>

            <section id="sales-section" class="app-section">
                <h2><i class="fas fa-chart-line"></i> বিক্রয় রিপোর্ট</h2>
                <div class="report-filters">
                    <div>
                        <label for="sales-report-search-input">অনুসন্ধান:</label>
                        <input type="text" id="sales-report-search-input" placeholder="কাস্টমার নাম, নম্বর বা বিল আইডি">
                    </div>
                    <div>
                        <label for="sales-report-from-date">থেকে তারিখ:</label>
                        <input type="date" id="sales-report-from-date">
                    </div>
                    <div>
                        <label for="sales-report-to-date">পর্যন্ত তারিখ:</label>
                        <input type="date" id="sales-report-to-date">
                    </div>
                    <div>
                        <label for="sales-report-seller">বিক্রয়কারী অনুযায়ী:</label>
                        <select id="sales-report-seller">
                            <option value="">সকল সেলার</option>
                            </select>
                    </div>
                    <button id="filter-sales-report" class="primary-btn"><i class="fas fa-filter"></i> ফিল্টার</button>
                </div>
                <div id="sales-report-summary">
                    <h3>নির্বাচিত সময়ের মোট নিট বিক্রয়: <span id="filtered-sales-total">৳ 0</span></h3>
                    <!-- 4. Sales & Profit Report System - Profit Fields Included -->
                    <p id="filtered-sales-profit" style="font-size: 16px; font-weight: normal; margin-top: 5px;"><i class="fas fa-hand-holding-usd"></i> মোট লাভ: ৳ 0</p>
                    <p id="filtered-products-sold" style="font-size: 16px; font-weight: normal; margin-top: 5px;"><i class="fas fa-cubes"></i> মোট বিক্রি হওয়া পণ্য: 0 পিস</p>
                    <p id="filtered-stock-value" style="font-size: 16px; font-weight: normal; margin-top: 5px;"><i class="fas fa-boxes"></i> বর্তমান স্টকের পণ্যের মোট ক্রয় মূল্য: ৳ 0</p>
                    <p id="filtered-total-loss" style="font-size: 16px; font-weight: normal; margin-top: 5px; color: #dc3545;"><i class="fas fa-times-circle"></i> ফেরত পণ্যের মোট ক্ষতি: ৳ 0</p>
                    <button id="print-sales-summary-btn" class="primary-btn" style="margin-top: 15px;"><i class="fas fa-print"></i> সারাংশ প্রিন্ট করুন</button>
                     <!-- 4. Sales & Profit Report System - New Button -->
                    <button id="product-wise-report-btn" class="info-btn" style="margin-top: 15px; margin-left: 10px;"><i class="fas fa-boxes"></i> পণ্য-ভিত্তিক রিপোর্ট</button>
                </div>
                <table id="sales-report-table">
                    <thead>
                        <tr>
                            <th>বিল আইডি</th>
                            <th>তারিখ ও সময়</th>
                            <th>বিক্রয়কারী</th>
                            <th>কাস্টমার</th>
                            <th>মোট টাকা</th>
                            <th>লাভ</th>
                            <th>পেমেন্ট ধরণ</th>
                            <th>লেনদেন</th>
                            <th>পণ্যসমূহ</th>
                            <th>একশন</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </section>
            
            <!-- NEW: 4. Sales & Profit Report System - Granular Report Section -->
            <section id="granular-reports-section" class="app-section">
                <h2><i class="fas fa-search-dollar"></i> উন্নত রিপোর্ট (Profit Breakdown)</h2>
                 <div class="report-filters">
                    <div>
                        <label for="granular-report-from-date">থেকে তারিখ:</label>
                        <input type="date" id="granular-report-from-date">
                    </div>
                    <div>
                        <label for="granular-report-to-date">পর্যন্ত তারিখ:</label>
                        <input type="date" id="granular-report-to-date">
                    </div>
                    <div>
                         <label for="granular-report-type">রিপোর্ট ধরণ:</label>
                         <select id="granular-report-type">
                            <option value="daily">দৈনিক</option>
                            <option value="monthly">মাসিক</option>
                            <option value="yearly">বাৎসরিক</option>
                        </select>
                    </div>
                    <button id="filter-granular-report" class="primary-btn"><i class="fas fa-filter"></i> রিপোর্ট দেখুন</button>
                     <button id="print-granular-report-btn" class="info-btn"><i class="fas fa-print"></i> প্রিন্ট</button>
                </div>

                <div id="granular-report-output" style="margin-top: 20px;">
                    <h3>লাভ/ক্ষতি ও বিক্রয় বিভাজন (<span id="granular-report-title"></span>)</h3>
                    <div id="granular-report-summary" style="padding: 15px; border-bottom: 2px solid var(--primary-blue);">
                         <p style="text-align: center;">রিপোর্ট তৈরি করতে উপরে ফিল্টার ব্যবহার করুন।</p>
                    </div>
                     <table id="granular-report-table" style="margin-top: 15px;">
                        <thead>
                            <tr>
                                <th>সময়সীমা</th>
                                <th>মোট বিক্রয় (৳)</th>
                                <th>মোট ক্রয় মূল্য (৳)</th>
                                <th>মোট লাভ (৳)</th>
                                <th>লাভ %</th>
                            </tr>
                        </thead>
                        <tbody>
                             <tr><td colspan="5">উপরে ফিল্টার করে রিপোর্ট দেখুন।</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>


            <section id="dues-section" class="app-section">
                <h2><i class="fas fa-money-bill-wave"></i> কাস্টমার বাকি টাকা</h2>
                <p>মোট বকেয়া: <span id="total-dues-amount">৳ 0</span></p>
                <div class="product-filters" style="margin-bottom: 20px;">
                    <input type="text" id="dues-search-input" placeholder="কাস্টমারের নাম, ফোন নম্বর বা বিল আইডি দিয়ে খুঁজুন...">
                </div>
                <table id="dues-list-table">
                    <thead>
                        <tr>
                            <th>কাস্টমারের নাম</th>
                            <th>ফোন নম্বর</th>
                            <th>বিবরণ/বিল আইডি</th>
                            <th>মোট বকেয়া</th>
                            <th>বাকি ছিল</th>
                            <th>পরিশোধিত</th>
                            <th>একশন</th>
                            <!-- 6. Alert System - Add SMS/WhatsApp Column in renderDuesList (dynamic JS) -->
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </section>
            
            <!-- NEW: Manual Due Entry Section -->
            <section id="manual-dues-section" class="app-section">
                <h2><i class="fas fa-clipboard-list"></i> কাস্টমার বাকি এন্ট্রি (Manual Entry)</h2>
                <div id="add-manual-due-form-container">
                    <h3><i class="fas fa-user-plus"></i> নতুন বাকি যোগ করুন</h3>
                    <form id="add-manual-due-form">
                        <label for="manual-due-customer-phone">মোবাইল নম্বর:</label>
                        <input type="text" id="manual-due-customer-phone" placeholder="ফোন নম্বর লিখুন (নতুন হলে কাস্টমার তৈরি হবে)" required>

                        <label for="manual-due-customer-name">কাস্টমার নাম:</label>
                        <input type="text" id="manual-due-customer-name" placeholder="নাম" required>
                        
                        <label for="manual-due-customer-address">ঠিকানা (ঐচ্ছিক):</label>
                        <textarea id="manual-due-customer-address" rows="1" placeholder="ঠিকানা"></textarea>

                        <label for="manual-due-amount">বাকি টাকার পরিমাণ (৳):</label>
                        <input type="number" id="manual-due-amount" step="0.01" min="0" required>
                        
                        <label for="manual-due-date">তারিখ:</label>
                        <input type="date" id="manual-due-date" required>

                        <label for="manual-due-note">নোট (ঐচ্ছিক):</label>
                        <textarea id="manual-due-note" rows="2" placeholder="কেন বাকি হলো বা অন্য কোনো নোট লিখুন"></textarea>

                        <button type="submit" class="primary-btn"><i class="fas fa-save"></i> বাকি এন্ট্রি সংরক্ষণ করুন</button>
                    </form>
                    <p id="manual-due-message" class="error-message" style="margin-top: 15px;"></p>
                </div>
            </section>

            <section id="returns-section" class="app-section">
                <h2><i class="fas fa-undo-alt"></i> ফেরত পণ্য ব্যবস্থাপনা</h2>
                <div class="return-input">
                    <input type="text" id="return-sale-search-input" placeholder="বিলের আইডি, কাস্টমার নাম বা নম্বর দিয়ে খুঁজুন">
                    <button id="search-sale-for-return" class="primary-btn"><i class="fas fa-search"></i> খুঁজুন</button>
                </div>

                <div id="return-search-results" style="display:none;" class="app-section">
                    <h3><i class="fas fa-list"></i> অনুসন্ধানের ফলাফল</h3>
                    <table id="return-search-results-table">
                        <thead>
                            <tr>
                                <th>বিল আইডি</th>
                                <th>তারিখ</th>
                                <th>কাস্টমার</th>
                                <th>মোট টাকা</th>
                                <th>একশন</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                    <p id="no-return-search-results" style="display:none; color: #777;">কোনো ফলাফল পাওয়া যায়নি।</p>
                </div>


                <div id="return-details-container" style="display:none;" class="app-section">
                    <h3><i class="fas fa-info-circle"></i> রিটার্নের বিস্তারিত</h3>
                    <p>বিক্রয় আইডি: <span id="return-sale-id-display"></span></p>
                    <p>কাস্টমার: <span id="return-customer-display"></span></p>
                    <p>মূল বিক্রয় মূল্য: <span id="return-sale-total-display"></span></p>
                    <h4><i class="fas fa-box-open"></i> ফেরতযোগ্য পণ্য</h4>
                    <table id="return-items-table">
                        <thead>
                            <tr>
                                <th>পণ্য</th>
                                <th>মূল পরিমাণ</th>
                                <th>একক মূল্য</th>
                                <th>ফেরত পরিমাণ</th>
                                <th>ফেরতের কারণ</th>
                                <th>ফেরতের ধরণ</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                    <p style="font-size: 18px; font-weight: 600; margin-top: 20px;">মোট ফেরতযোগ্য টাকা: <span id="refundable-amount" style="color: #dc3545;">৳ 0</span></p>
                    <button id="process-return-btn" class="danger-btn"><i class="fas fa-check-circle"></i> রিটার্ন প্রক্রিয়া করুন</button>
                </div>

                <div id="return-success-message" style="display:none; margin-top: 20px; text-align: center;" class="app-section">
                    <p style="color: green; font-weight: bold;">ফেরত সফল হয়েছে!</p>
                    <p>রিটার্ন আইডি: <span id="display-return-id" style="font-weight: bold;"></span></p>
                    <button id="print-return-bill-btn" class="primary-btn"><i class="fas fa-print"></i> প্রিন্ট রিটার্ন বিল</button>
                </div>
            </section>
            
            <!-- Existing Ledger Section (Now Cash Ledger) -->
            <section id="ledger-section" class="app-section">
                <h2><i class="fas fa-money-check-alt"></i> Cash Ledger (Cash Book)</h2>
                <div class="ledger-summary">
                    <div class="summary-card" style="background: linear-gradient(135deg, #10b981, #059669);">
                        <i class="fas fa-money-bill-alt"></i>
                        <h3>হাতে থাকা বর্তমান Cash Balance</h3>
                        <p id="cash-ledger-balance">৳ 0</p>
                    </div>
                     <div class="summary-card">
                        <i class="fas fa-dollar-sign"></i>
                        <h3>মোট Cash In (বিক্রয় ও অন্যান্য)</h3>
                        <p id="total-cash-in">৳ 0</p>
                    </div>
                    <div class="summary-card expense">
                        <i class="fas fa-money-bill-alt"></i>
                        <h3>মোট Cash Out (খরচ ও অন্যান্য)</h3>
                        <p id="total-cash-out">৳ 0</p>
                    </div>
                   
                </div>

                <div class="ledger-entry-form">
                    <h3><i class="fas fa-plus-circle"></i> নতুন Cash লেনদেন যোগ করুন</h3>
                    <form id="add-ledger-entry-form">
                         <!-- Rule 4: Ledger is for Cash. We only handle cash transactions here. -->
                         <p style="color: #f59e0b;">*এই সেকশনে শুধুমাত্র হাতে থাকা Cash-এর হিসাব যোগ করা হবে।*</p>
                        <label for="ledger-type">লেনদেনের ধরণ:</label>
                        <select id="ledger-type" required>
                            <option value="expense">Cash Out (খরচ)</option>
                            <option value="income">Cash In (অন্যান্য আয়)</option>
                        </select>
                        <label for="ledger-category">ক্যাটাগরি:</label>
                        <select id="ledger-category" required></select>
                        <button type="button" id="add-ledger-category-btn" class="primary-btn" style="margin-left: 10px; padding: 5px 10px; font-size: 12px;">ক্যাটাগরি যোগ করুন</button>
                        <label for="ledger-description">বিবরণ (ঐচ্ছিক):</label>
                        <input type="text" id="ledger-description" placeholder="প্রয়োজনে বিস্তারিত লিখুন">
                        <label for="ledger-amount">পরিমাণ (৳):</label>
                        <input type="number" id="ledger-amount" step="0.01" min="0" required>
                        <label for="ledger-date">তারিখ:</label>
                        <input type="date" id="ledger-date" required>
                        <button type="submit" class="primary-btn"><i class="fas fa-plus"></i> যোগ করুন</button>
                        <button type="button" class="cancel-btn" id="cancel-ledger-entry"><i class="fas fa-times"></i> বাতিল</button>
                    </form>
                </div>

                <h3><i class="fas fa-history"></i> সকল Cash লেনদেন</h3>
                <div class="ledger-filters">
                    <div>
                        <label for="ledger-filter-from-date">থেকে তারিখ:</label>
                        <input type="date" id="ledger-filter-from-date">
                    </div>
                    <div>
                        <label for="ledger-filter-to-date">পর্যন্ত তারিখ:</label>
                        <input type="date" id="ledger-filter-to-date">
                    </div>
                    <div>
                        <label for="ledger-filter-type">ধরণ অনুযায়ী:</label>
                        <select id="ledger-filter-type">
                            <option value="">সকল</option>
                            <option value="expense">Cash Out</option>
                            <option value="income">Cash In</option>
                        </select>
                    </div>
                    <div>
                        <label for="ledger-filter-category">ক্যাটাগরি অনুযায়ী:</label>
                        <select id="ledger-filter-category">
                            <option value="">সকল</option>
                        </select>
                    </div>
                    <button id="filter-ledger" class="primary-btn"><i class="fas fa-filter"></i> ফিল্টার</button>
                    <button id="print-ledger" class="primary-btn"><i class="fas fa-print"></i> প্রিন্ট</button>
                    <button id="delete-all-ledger" class="danger-btn" style="background: #dc3545; margin-left: 10px;"><i class="fas fa-trash-alt"></i> সব মুছুন</button>
                </div>
                <table id="ledger-table">
                    <thead>
                        <tr>
                            <th>তারিখ</th>
                            <th>ধরণ</th>
                            <th>ক্যাটাগরি</th>
                            <th>বিবরণ</th>
                            <th>পরিমাণ</th>
                            <th>একশন</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </section>
            
            <!-- NEW: Bank Module (Finance Section) -->
            <section id="finance-section" class="app-section">
                <h2><i class="fas fa-university"></i> Bank Module</h2>
                <div class="ledger-summary">
                    <div class="summary-card" style="background: linear-gradient(135deg, #60a5fa, #3b82f6);">
                        <i class="fas fa-university"></i>
                        <h3>মোট ব্যাংক ব্যালেন্স</h3>
                        <p id="finance-total-bank-balance">৳ 0</p>
                    </div>
                    <div class="summary-card" style="background: linear-gradient(135deg, #10b981, #059669);">
                        <i class="fas fa-arrow-down"></i>
                        <h3>মোট ব্যাংক জমা (Credit)</h3>
                        <p id="finance-total-bank-credit">৳ 0</p>
                    </div>
                    <div class="summary-card expense">
                        <i class="fas fa-arrow-up"></i>
                        <h3>মোট ব্যাংক খরচ/ট্রান্সফার (Debit)</h3>
                        <p id="finance-total-bank-debit">৳ 0</p>
                    </div>
                </div>

                <!-- Section 4A: Bank Setup -->
                <h3><i class="fas fa-plus-circle"></i> ব্যাংক সেটআপ ও ব্যালেন্স</h3>
                 <div class="bank-management-grid">
                     <div class="bank-setup-form">
                         <h4>ব্যাংক যোগ/সম্পাদনা</h4>
                         <form id="add-bank-form">
                             <label for="bank-name">ব্যাংকের নাম:</label>
                             <input type="text" id="bank-name" required>
                             <label for="bank-account-no">অ্যাকাউন্ট নম্বর:</label>
                             <input type="text" id="bank-account-no">
                             <label for="bank-opening-balance">প্রাথমিক ব্যালেন্স (৳):</label>
                             <input type="number" id="bank-opening-balance" step="0.01" value="0" min="0" required>
                             <button type="submit" class="primary-btn"><i class="fas fa-save"></i> সংরক্ষণ করুন</button>
                             <button type="button" class="cancel-btn" id="cancel-bank-entry"><i class="fas fa-times"></i> বাতিল</button>
                         </form>
                     </div>
                      <div class="bank-list-container">
                         <h4>সকল ব্যাংক</h4>
                         <table id="bank-list-table">
                             <thead><tr><th>ব্যাংকের নাম</th><th>অ্যাকাউন্ট নং</th><th>বর্তমান ব্যালেন্স</th><th>একশন</th></tr></thead>
                             <tbody></tbody>
                         </table>
                     </div>
                 </div>
                 
                 <h3 style="margin-top: 30px;"><i class="fas fa-exchange-alt"></i> ব্যাংক থেকে লেনদেন (Rule 5)</h3>
                 <div class="bank-management-grid">
                    <!-- Option 1: Bank Withdrawal (Expense) -->
                     <div class="ledger-entry-form">
                         <h4>🔴 Bank Withdrawal (Expense)</h4>
                         <p style="color: #f59e0b;">*এই টাকা সরাসরি খরচ হিসেবে Expense Module-এ যুক্ত হবে।*</p>
                         <form id="bank-withdrawal-expense-form">
                             <label for="withdrawal-bank-select">ব্যাংক নির্বাচন করুন:</label>
                             <select id="withdrawal-bank-select" required></select>
                             <label for="withdrawal-amount">পরিমাণ (৳):</label>
                             <input type="number" id="withdrawal-amount" step="0.01" min="0" required>
                             <label for="withdrawal-note">নোট/বিবরণ:</label>
                             <input type="text" id="withdrawal-note" required>
                             <button type="submit" class="danger-btn"><i class="fas fa-minus-circle"></i> ব্যাংক থেকে খরচ (Debit)</button>
                         </form>
                     </div>
                      <!-- Option 2: Bank to Ledger Transfer (Cash In) -->
                      <div class="ledger-entry-form">
                         <h4>🟡 Bank → Cash Transfer</h4>
                          <p style="color: #10b981;">*এই টাকা Cash Ledger-এ যুক্ত হবে (Cash In)।*</p>
                         <form id="bank-to-cash-transfer-form">
                             <label for="transfer-bank-select">ব্যাংক নির্বাচন করুন:</label>
                             <select id="transfer-bank-select" required></select>
                             <label for="transfer-amount">পরিমাণ (৳):</label>
                             <input type="number" id="transfer-amount" step="0.01" min="0" required>
                             <label for="transfer-note">নোট (ঐচ্ছিক):</label>
                             <input type="text" id="transfer-note">
                             <button type="submit" class="primary-btn info-btn"><i class="fas fa-plus-circle"></i> ক্যাশে আনুন (Transfer)</button>
                         </form>
                     </div>
                 </div>

                 <h3 style="margin-top: 30px;"><i class="fas fa-history"></i> ব্যাংক লেনদেন ইতিহাস</h3>
                 <div class="report-filters">
                    <div><label for="bank-tx-from-date">থেকে তারিখ:</label><input type="date" id="bank-tx-from-date"></div>
                    <div><label for="bank-tx-to-date">পর্যন্ত তারিখ:</label><input type="date" id="bank-tx-to-date"></div>
                     <div><label for="bank-tx-filter-bank">ব্যাংক অনুযায়ী:</label><select id="bank-tx-filter-bank"><option value="">সকল ব্যাংক</option></select></div>
                     <div><label for="bank-tx-filter-type">ধরণ অনুযায়ী:</label><select id="bank-tx-filter-type"><option value="">সকল</option><option value="credit">Credit (জমা)</option><option value="debit">Debit (খরচ/ট্রান্সফার)</option></select></div>
                    <button id="filter-bank-tx" class="primary-btn"><i class="fas fa-filter"></i> ফিল্টার</button>
                    <button id="print-bank-tx" class="primary-btn"><i class="fas fa-print"></i> প্রিন্ট</button>
                </div>
                <table id="bank-transaction-table">
                    <thead>
                        <tr>
                            <th>তারিখ</th>
                            <th>ব্যাংক</th>
                            <th>ধরণ</th>
                            <th>বিবরণ/Source</th>
                            <th>Credit (৳)</th>
                            <th>Debit (৳)</th>
                            <th>Running Balance (৳)</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </section>
            
             <!-- NEW: Consolidated Expense Report -->
            <section id="expenses-section" class="app-section">
                <h2><i class="fas fa-file-invoice-dollar"></i> Expense Report (Cash & Bank)</h2>
                <div class="ledger-summary">
                    <div class="summary-card expense" style="background: linear-gradient(135deg, #f97316, #ea580c);">
                        <i class="fas fa-money-bill-alt"></i>
                        <h3>মোট Expense (Cash)</h3>
                        <p id="total-cash-expense">৳ 0</p>
                    </div>
                    <div class="summary-card expense" style="background: linear-gradient(135deg, #dc3545, #c82333);">
                        <i class="fas fa-university"></i>
                        <h3>মোট Expense (Bank Withdrawal)</h3>
                        <p id="total-bank-expense">৳ 0</p>
                    </div>
                    <div class="summary-card expense" style="background: linear-gradient(135deg, #64748b, #475569);">
                        <i class="fas fa-wallet"></i>
                        <h3>মোট Expense (Grand Total)</h3>
                        <p id="total-grand-expense">৳ 0</p>
                    </div>
                </div>

                <h3><i class="fas fa-history"></i> খরচের তালিকা</h3>
                 <div class="report-filters">
                    <div>
                        <label for="expense-report-from-date">থেকে তারিখ:</label>
                        <input type="date" id="expense-report-from-date">
                    </div>
                    <div>
                        <label for="expense-report-to-date">পর্যন্ত তারিখ:</label>
                        <input type="date" id="expense-report-to-date">
                    </div>
                    <div>
                        <label for="expense-report-category">ক্যাটাগরি অনুযায়ী:</label>
                        <select id="expense-report-category">
                            <option value="">সকল</option>
                        </select>
                    </div>
                    <button id="filter-expense-report" class="primary-btn"><i class="fas fa-filter"></i> ফিল্টার</button>
                    <button id="print-expense-report" class="primary-btn"><i class="fas fa-print"></i> প্রিন্ট</button>
                </div>
                <table id="expense-report-table">
                    <thead>
                        <tr>
                            <th>তারিখ</th>
                            <th>ধরণ</th>
                            <th>ক্যাটাগরি</th>
                            <th>বিবরণ/নোট</th>
                            <th>উৎস (Cash/Bank)</th>
                            <th>পরিমাণ (৳)</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </section>
            
            <section id="customer-data-section" class="app-section">
                <h2><i class="fas fa-address-book"></i> কাস্টমার ডেটা</h2>
                <div class="customer-search-input">
                    <input type="text" id="customer-search-input" placeholder="কাস্টমার নাম বা মোবাইল নম্বর দিয়ে খুঁজুন">
                    <button id="search-customer-data-btn" class="primary-btn"><i class="fas fa-search"></i> খুঁজুন</button>
                </div>

                <div id="customer-search-results" style="display:none;">
                    <h3><i class="fas fa-list"></i> অনুসন্ধানের ফলাফল</h3>
                    <table class="customer-search-results-table">
                        <thead>
                            <tr>
                                <th>কাস্টমার নাম</th>
                                <th>মোবাইল নম্বর</th>
                                <th>মোট বিক্রয় (৳)</th>
                                <th>মোট পণ্য</th>
                                <th>একশন</th>
                            </tr>
                        </thead>
                        <tbody id="customer-search-results-table-body">
                            </tbody>
                    </table>
                    <p id="no-customer-search-results" style="display:none; color: #777; margin-top: 15px;">কোনো কাস্টমার খুঁজে পাওয়া যায়নি।</p>
                </div>

                <div id="customer-purchase-history-details" style="display:none;" class="customer-purchase-history-details">
                    <h3><i class="fas fa-history"></i> কাস্টমার বিক্রয় ইতিহাস: <span id="customer-history-name"></span></h3>
                    <p>মোবাইল নম্বর: <span id="customer-history-phone"></span></p>
                    <p>মোট বিক্রয় মূল্য: <span id="customer-history-total-sales">৳ 0</span></p>
                    <p>মোট কেনা পণ্য: <span id="customer-history-total-products">0 পিস</span></p>
                    <button id="print-customer-history-btn" class="primary-btn" style="margin-top: 15px;"><i class="fas fa-print"></i> ইতিহাস প্রিন্ট করুন</button>

                    <h4 style="margin-top: 25px;"><i class="fas fa-receipt"></i> লেনদেনের তালিকা</h4>
                    <table class="customer-search-results-table">
                        <thead>
                            <tr>
                                <th>বিল আইডি</th>
                                <th>তারিখ</th>
                                <th>মোট টাকা</th>
                                <th>পণ্যসমূহ</th>
                            </tr>
                        </thead>
                        <tbody id="customer-history-table-body">
                            </tbody>
                    </table>

                    <h3 style="margin-top: 30px;"><i class="fas fa-undo-alt"></i> ফেরত পণ্যের তালিকা</h3>
                    <div id="customer-returns-history-message" style="color: #666; margin-bottom: 15px; font-style: italic; display:none;">
                        এই কাস্টমারের কোনো ফেরত পণ্য নেই।
                    </div>
                    <table id="customer-returns-history-table" style="display:none;">
                        <thead>
                            <tr>
                                <th>ফেরত ID</th>
                                <th>তারিখ</th>
                                <th>পণ্য (পরিমাণ)</th>
                                <th>ফেরতের মূল্য</th>
                                <th>কারণ</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                    </div>
            </section>
            
            <section id="customer-management-section" class="app-section">
                <h2><i class="fas fa-users"></i> কাস্টমার ব্যবস্থাপনা</h2>
                
                <!-- ✅ NEW: Customer Management Report System -->
                <!-- ✅ NEW: All Customers Combined Report System -->
                <div class="all-customers-report-section" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.05)); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 12px; padding: 20px; margin-bottom: 25px;">
                    <h3 style="margin-top: 0; color: #10b981;"><i class="fas fa-users"></i> সব কাস্টমারের সম্মিলিত রিপোর্ট</h3>
                    <p style="font-size: 14px; color: #94a3b8; margin-bottom: 15px;">সব কাস্টমারের একসাথে বিক্রয়, পরিশোধ এবং বাকির সারাংশ দেখুন</p>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 10px; align-items: end; margin-bottom: 15px;">
                        <div>
                            <label for="all-customers-from-date" style="display: block; margin-bottom: 5px; font-size: 14px; color: #cbd5e1;">শুরুর তারিখ:</label>
                            <input type="date" id="all-customers-from-date" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--card-bg); color: var(--text-light);">
                        </div>
                        <div>
                            <label for="all-customers-to-date" style="display: block; margin-bottom: 5px; font-size: 14px; color: #cbd5e1;">শেষ তারিখ:</label>
                            <input type="date" id="all-customers-to-date" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--card-bg); color: var(--text-light);">
                        </div>
                        <div>
                            <button id="generate-all-customers-report-btn" class="primary-btn" style="width: 100%; background: linear-gradient(135deg, #10b981, #059669);"><i class="fas fa-search"></i> সব কাস্টমারের রিপোর্ট</button>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button id="print-all-customers-report-btn" class="primary-btn" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); flex: 1;"><i class="fas fa-print"></i> সম্মিলিত রিপোর্ট প্রিন্ট</button>
                        <button id="clear-all-customers-report-btn" class="cancel-btn" style="flex: 1;"><i class="fas fa-times"></i> ক্লিয়ার</button>
                    </div>
                </div>
                
                <!-- All Customers Report Display -->
                <div id="all-customers-report-display" style="display: none; margin-bottom: 25px;">
                    <!-- Grand Total Summary Cards -->
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
                        <div style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(37, 99, 235, 0.1)); padding: 15px; border-radius: 10px; border: 1px solid rgba(59, 130, 246, 0.3); text-align: center;">
                            <div style="font-size: 12px; color: #94a3b8; margin-bottom: 5px;">মোট কাস্টমার</div>
                            <div id="all-report-total-customers" style="font-size: 24px; font-weight: bold; color: #60a5fa;">0</div>
                        </div>
                        <div style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(217, 119, 6, 0.1)); padding: 15px; border-radius: 10px; border: 1px solid rgba(245, 158, 11, 0.3); text-align: center;">
                            <div style="font-size: 12px; color: #94a3b8; margin-bottom: 5px;">মোট বিক্রয়</div>
                            <div id="all-report-total-sales" style="font-size: 24px; font-weight: bold; color: #fbbf24;">৳ 0</div>
                        </div>
                        <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.1)); padding: 15px; border-radius: 10px; border: 1px solid rgba(16, 185, 129, 0.3); text-align: center;">
                            <div style="font-size: 12px; color: #94a3b8; margin-bottom: 5px;">মোট পরিশোধ</div>
                            <div id="all-report-total-paid" style="font-size: 24px; font-weight: bold; color: #34d399;">৳ 0</div>
                        </div>
                        <div style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(220, 53, 69, 0.1)); padding: 15px; border-radius: 10px; border: 1px solid rgba(239, 68, 68, 0.3); text-align: center;">
                            <div style="font-size: 12px; color: #94a3b8; margin-bottom: 5px;">মোট বাকি</div>
                            <div id="all-report-total-due" style="font-size: 24px; font-weight: bold; color: #f87171;">৳ 0</div>
                        </div>
                    </div>
                    
                    <!-- All Customers Summary Table -->
                    <div style="background: var(--card-bg); border-radius: 10px; padding: 20px; border: 1px solid var(--border-color);">
                        <h4 style="margin-top: 0; margin-bottom: 15px; color: #10b981;"><i class="fas fa-list-alt"></i> সব কাস্টমারের সারাংশ তালিকা</h4>
                        <div style="overflow-x: auto; max-height: 500px; overflow-y: auto;">
                            <table id="all-customers-summary-table" style="width: 100%; border-collapse: collapse;">
                                <thead style="position: sticky; top: 0; background: var(--card-bg); z-index: 10;">
                                    <tr style="background: rgba(16, 185, 129, 0.2);">
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid var(--border-color);">#</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid var(--border-color);">কাস্টমারের নাম</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid var(--border-color);">মোবাইল</th>
                                        <th style="padding: 12px; text-align: right; border-bottom: 2px solid var(--border-color);">মোট বিক্রয়</th>
                                        <th style="padding: 12px; text-align: right; border-bottom: 2px solid var(--border-color);">মোট পরিশোধ</th>
                                        <th style="padding: 12px; text-align: right; border-bottom: 2px solid var(--border-color);">বর্তমান বাকি</th>
                                        <th style="padding: 12px; text-align: center; border-bottom: 2px solid var(--border-color);">স্ট্যাটাস</th>
                                    </tr>
                                </thead>
                                <tbody id="all-customers-summary-tbody">
                                    <!-- Dynamic content -->
                                </tbody>
                                <tfoot style="position: sticky; bottom: 0; background: var(--card-bg); font-weight: bold;">
                                    <tr style="background: rgba(16, 185, 129, 0.3);">
                                        <td colspan="3" style="padding: 12px; text-align: right; border-top: 2px solid var(--border-color);">সর্বমোট:</td>
                                        <td id="all-report-footer-sales" style="padding: 12px; text-align: right; border-top: 2px solid var(--border-color); color: #fbbf24;">৳ 0</td>
                                        <td id="all-report-footer-paid" style="padding: 12px; text-align: right; border-top: 2px solid var(--border-color); color: #34d399;">৳ 0</td>
                                        <td id="all-report-footer-due" style="padding: 12px; text-align: right; border-top: 2px solid var(--border-color); color: #f87171;">৳ 0</td>
                                        <td style="padding: 12px; border-top: 2px solid var(--border-color);"></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        <div id="all-customers-report-empty" style="text-align: center; padding: 30px; color: #94a3b8; display: none;">
                            <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 10px;"></i>
                            <p>কোনো কাস্টমার পাওয়া যায়নি</p>
                        </div>
                    </div>
                </div>

                <div class="customer-report-section" style="background: linear-gradient(135deg, rgba(37, 99, 235, 0.1), rgba(59, 130, 246, 0.05)); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 12px; padding: 20px; margin-bottom: 25px;">
                    <h3 style="margin-top: 0; color: var(--light-blue);"><i class="fas fa-file-invoice"></i> একক কাস্টমার রিপোর্ট</h3>
                    <p style="font-size: 14px; color: #94a3b8; margin-bottom: 15px;">নির্দিষ্ট কাস্টমারের বিস্তারিত লেনদেন ও বাকি তথ্য দেখুন</p>
                    
                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 10px; align-items: end; margin-bottom: 15px;">
                        <div>
                            <label for="customer-report-select" style="display: block; margin-bottom: 5px; font-size: 14px; color: #cbd5e1;">কাস্টমার নির্বাচন করুন:</label>
                            <select id="customer-report-select" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--card-bg); color: var(--text-light);">
                                <option value="">-- কাস্টমার নির্বাচন করুন --</option>
                            </select>
                        </div>
                        <div>
                            <label for="customer-report-from-date" style="display: block; margin-bottom: 5px; font-size: 14px; color: #cbd5e1;">শুরুর তারিখ:</label>
                            <input type="date" id="customer-report-from-date" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--card-bg); color: var(--text-light);">
                        </div>
                        <div>
                            <label for="customer-report-to-date" style="display: block; margin-bottom: 5px; font-size: 14px; color: #cbd5e1;">শেষ তারিখ:</label>
                            <input type="date" id="customer-report-to-date" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--card-bg); color: var(--text-light);">
                        </div>
                        <div>
                            <button id="generate-customer-report-btn" class="primary-btn" style="width: 100%;"><i class="fas fa-search"></i> রিপোর্ট দেখুন</button>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button id="print-customer-report-btn" class="primary-btn" style="background: linear-gradient(135deg, #10b981, #059669); flex: 1;"><i class="fas fa-print"></i> রিপোর্ট প্রিন্ট করুন</button>
                        <button id="clear-customer-report-btn" class="cancel-btn" style="flex: 1;"><i class="fas fa-times"></i> ক্লিয়ার</button>
                    </div>
                </div>
                
                <!-- Report Display Area -->
                <div id="customer-report-display" style="display: none; margin-bottom: 25px;">
                    <!-- Customer Summary Cards -->
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
                        <div style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(37, 99, 235, 0.1)); padding: 15px; border-radius: 10px; border: 1px solid rgba(59, 130, 246, 0.3); text-align: center;">
                            <div style="font-size: 12px; color: #94a3b8; margin-bottom: 5px;">কাস্টমারের নাম</div>
                            <div id="report-customer-name" style="font-size: 18px; font-weight: bold; color: #e2e8f0;">-</div>
                        </div>
                        <div style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(217, 119, 6, 0.1)); padding: 15px; border-radius: 10px; border: 1px solid rgba(245, 158, 11, 0.3); text-align: center;">
                            <div style="font-size: 12px; color: #94a3b8; margin-bottom: 5px;">মোট বিক্রয়</div>
                            <div id="report-total-sales" style="font-size: 18px; font-weight: bold; color: #fbbf24;">৳ 0</div>
                        </div>
                        <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.1)); padding: 15px; border-radius: 10px; border: 1px solid rgba(16, 185, 129, 0.3); text-align: center;">
                            <div style="font-size: 12px; color: #94a3b8; margin-bottom: 5px;">মোট পরিশোধ</div>
                            <div id="report-total-paid" style="font-size: 18px; font-weight: bold; color: #34d399;">৳ 0</div>
                        </div>
                        <div style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(220, 53, 69, 0.1)); padding: 15px; border-radius: 10px; border: 1px solid rgba(239, 68, 68, 0.3); text-align: center;">
                            <div style="font-size: 12px; color: #94a3b8; margin-bottom: 5px;">বর্তমান বাকি</div>
                            <div id="report-current-due" style="font-size: 18px; font-weight: bold; color: #f87171;">৳ 0</div>
                        </div>
                    </div>
                    
                    <!-- Ledger Table -->
                    <div style="background: var(--card-bg); border-radius: 10px; padding: 20px; border: 1px solid var(--border-color);">
                        <h4 style="margin-top: 0; margin-bottom: 15px; color: var(--light-blue);"><i class="fas fa-list-alt"></i> লেনদেনের বিস্তারিত তালিকা</h4>
                        <div style="overflow-x: auto;">
                            <table id="customer-ledger-table" style="width: 100%; border-collapse: collapse;">
                                <thead style="position: sticky; top: 0; background: var(--card-bg); z-index: 10;">
                                    <tr style="background: rgba(37, 99, 235, 0.2);">
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid var(--border-color);">তারিখ</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid var(--border-color);">বিবরণ</th>
                                        <th style="padding: 12px; text-align: right; border-bottom: 2px solid var(--border-color);">ডেবিট (বিক্রয়)</th>
                                        <th style="padding: 12px; text-align: right; border-bottom: 2px solid var(--border-color);">ক্রেডিট (পরিশোধ)</th>
                                        <th style="padding: 12px; text-align: right; border-bottom: 2px solid var(--border-color);">পেমেন্ট</th>
                                        <th style="padding: 12px; text-align: right; border-bottom: 2px solid var(--border-color);">বাকি</th>
                                        <th style="padding: 12px; text-align: right; border-bottom: 2px solid var(--border-color);">ব্যালেন্স</th>
                                    </tr>
                                </thead>
                                <tbody id="customer-ledger-tbody">
                                    <!-- Dynamic content -->
                                </tbody>
                                <tfoot style="position: sticky; bottom: 0; background: var(--card-bg); font-weight: bold;">
                                    <tr style="background: rgba(37, 99, 235, 0.3);">
                                        <td colspan="2" style="padding: 12px; text-align: right; border-top: 2px solid var(--border-color);">সর্বমোট:</td>
                                        <td id="customer-footer-debit" style="padding: 12px; text-align: right; border-top: 2px solid var(--border-color); color: #f87171;">৳ 0</td>
                                        <td id="customer-footer-credit" style="padding: 12px; text-align: right; border-top: 2px solid var(--border-color); color: #34d399;">৳ 0</td>
                                        <td id="customer-footer-payment" style="padding: 12px; text-align: right; border-top: 2px solid var(--border-color); color: #a78bfa;">৳ 0</td>
                                        <td id="customer-footer-due" style="padding: 12px; text-align: right; border-top: 2px solid var(--border-color); color: #fbbf24;">৳ 0</td>
                                        <td id="customer-footer-balance" style="padding: 12px; text-align: right; border-top: 2px solid var(--border-color); color: #60a5fa;">৳ 0</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        <div id="customer-ledger-empty" style="text-align: center; padding: 30px; color: #94a3b8; display: none;">
                            <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 10px;"></i>
                            <p>এই তারিখের মধ্যে কোনো লেনদেন পাওয়া যায়নি</p>
                        </div>
                    </div>
                </div>
                
                <button id="add-customer-btn" class="primary-btn"><i class="fas fa-user-plus"></i> নতুন কাস্টমার যোগ করুন</button>
                <!-- NEW: Search Input for Customer Management -->
                 <div class="product-filters" style="margin-top: 20px;">
                    <input type="text" id="customer-management-search-input" placeholder="কাস্টমারের নাম বা মোবাইল নম্বর দিয়ে খুঁজুন...">
                </div>
                <!-- END NEW: Search Input for Customer Management -->
                <div id="add-customer-form-container" style="display:none;" class="app-section">
                    <h3><i class="fas fa-user-edit"></i> কাস্টমার যোগ/সম্পাদনা</h3>
                    <form id="add-customer-form">
                        <label for="customer-name">কাস্টমারের নাম:</label>
                        <input type="text" id="customer-name" required>
                        <label for="customer-phone">ফোন নম্বর:</label>
                        <input type="text" id="customer-phone" required>
                        <label for="customer-address">ঠিকানা:</label>
                        <textarea id="customer-address" rows="3"></textarea>
                        <label for="customer-type">কাস্টমারের ধরণ:</label>
                        <input type="text" id="customer-type" placeholder="ধরণ লিখুন (যেমন: খুচরা, পাইকারি)" list="customer-type-list">
                        <datalist id="customer-type-list">
                            <option value="খুচরা"></option>
                            <option value="পাইকারি"></option>
                            <option value="সাধারণ"></option>
                        </datalist>
                        <label for="customer-opening-due">প্রাথমিক বকেয়া (৳):</label>
                        <input type="number" id="customer-opening-due" value="0" min="0">
                        <button type="submit" class="primary-btn"><i class="fas fa-save"></i> সংরক্ষণ করুন</button>
                        <button type="button" class="cancel-btn"><i class="fas fa-times"></i> বাতিল করুন</button>
                    </form>
                </div>
                <h3><i class="fas fa-list"></i> সকল কাস্টমার</h3>
                <table id="customer-list-table">
                    <thead>
                        <tr>
                            <th>নাম</th>
                            <th>ফোন</th>
                            <th>ধরণ</th>
                            <th>মোট কেনা</th>
                            <th>মোট পরিশোধ</th>
                            <th>বর্তমান বাকি</th>
                            <th>একশন</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </section>


            <section id="users-section" class="app-section">
                <h2><i class="fas fa-users"></i> ব্যবহারকারী ব্যবস্থাপনা</h2>
                <button id="add-user-btn" class="primary-btn"><i class="fas fa-user-plus"></i> নতুন ব্যবহারকারী যোগ করুন</button>
                <div id="add-user-form-container" style="display:none;" class="app-section">
                    <h3><i class="fas fa-user-edit"></i> ব্যবহারকারী যোগ/সম্পাদনা</h3>
                    <form id="add-user-form">
                        <label for="new-username">ইউজারনেম:</label>
                        <input type="text" id="new-username" required>
                        <label for="new-password">পাসওয়ার্ড:</label>
                        <input type="password" id="new-password" required>
                        <label for="new-user-role">ভূমিকা:</label>
                        <select id="new-user-role" required>
                            <option value="seller">সেলার</option>
                            <option value="admin">অ্যাডমিন</option>
                        </select>
                        <label for="new-user-display-name">প্রোফাইল নাম (প্রোফাইল):</label>
                        <input type="text" id="new-user-display-name" placeholder="আপনার পুরো নাম">
                        <label for="new-user-profile-image">প্রোফাইল ছবি URL (ঐচ্ছিক):</label>
                        <input type="text" id="new-user-profile-image" placeholder="https://img.icons8.com/officel/80/null/user.png">

                        <button type="submit" class="primary-btn"><i class="fas fa-save"></i> সংরক্ষণ করুন</button>
                        <button type="button" class="cancel-btn"><i class="fas fa-times"></i> বাতিল করুন</button>
                    </form>
                </div>
                <h3><i class="fas fa-list"></i> সকল ব্যবহারকারী</h3>
                <table id="user-list-table">
                    <thead>
                        <tr>
                            <th>আইডি</th>
                            <th>ইউজারনেম</th>
                            <th>প্রোফাইল নাম</th>
                            <th>ভূমিকা</th>
                            <th>একশন</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </section>

            <!-- ✅ NEW: Daily Transaction Report Section -->
            <section id="daily-transaction-section" class="app-section">
                <h2><i class="fas fa-calendar-day"></i> Daily Transaction Report</h2>
                
                <div class="daily-report-section" style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(217, 119, 6, 0.05)); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 12px; padding: 20px; margin-bottom: 25px;">
                    <h3 style="margin-top: 0; color: #f59e0b;"><i class="fas fa-chart-bar"></i> দৈনিক লেনদেন রিপোর্ট</h3>
                    <p style="font-size: 14px; color: #94a3b8; margin-bottom: 15px;">নির্দিষ্ট তারিখের বিক্রয়, ক্যাশ এবং বাকির বিস্তারিত রিপোর্ট দেখুন</p>
                    
                    <!-- Filter Options -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-size: 14px; color: #cbd5e1;">রিপোর্টের ধরণ:</label>
                            <select id="daily-report-type" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--card-bg); color: var(--text-light);">
                                <option value="today">আজকের রিপোর্ট</option>
                                <option value="specific">নির্দিষ্ট তারিখ</option>
                                <option value="range">তারিখ রেঞ্জ</option>
                            </select>
                        </div>
                        <div id="specific-date-container" style="display: none;">
                            <label style="display: block; margin-bottom: 5px; font-size: 14px; color: #cbd5e1;">নির্দিষ্ট তারিখ:</label>
                            <input type="date" id="daily-report-specific-date" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--card-bg); color: var(--text-light);">
                        </div>
                        <div id="from-date-container" style="display: none;">
                            <label style="display: block; margin-bottom: 5px; font-size: 14px; color: #cbd5e1;">শুরুর তারিখ:</label>
                            <input type="date" id="daily-report-from-date" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--card-bg); color: var(--text-light);">
                        </div>
                        <div id="to-date-container" style="display: none;">
                            <label style="display: block; margin-bottom: 5px; font-size: 14px; color: #cbd5e1;">শেষ তারিখ:</label>
                            <input type="date" id="daily-report-to-date" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--card-bg); color: var(--text-light);">
                        </div>
                        <div style="display: flex; align-items: end;">
                            <button id="generate-daily-report-btn" class="primary-btn" style="width: 100%; background: linear-gradient(135deg, #f59e0b, #d97706);"><i class="fas fa-search"></i> রিপোর্ট দেখুন</button>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button id="print-daily-report-btn" class="primary-btn" style="background: linear-gradient(135deg, #10b981, #059669); flex: 1;"><i class="fas fa-print"></i> রিপোর্ট প্রিন্ট করুন</button>
                        <button id="clear-daily-report-btn" class="cancel-btn" style="flex: 1;"><i class="fas fa-times"></i> ক্লিয়ার</button>
                    </div>
                </div>
                
                <!-- Daily Report Display -->
                <div id="daily-report-display" style="display: none;">
                    <!-- Report Title -->
                    <div style="text-align: center; margin-bottom: 20px; padding: 15px; background: rgba(245, 158, 11, 0.1); border-radius: 10px;">
                        <h3 id="daily-report-title" style="margin: 0; color: #fbbf24; font-size: 20px;">আজকের রিপোর্ট</h3>
                        <p id="daily-report-date" style="margin: 5px 0 0 0; color: #94a3b8; font-size: 14px;"></p>
                    </div>

                    <!-- Summary Cards Row 1 -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 15px;">
                        <div style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(37, 99, 235, 0.1)); padding: 20px; border-radius: 10px; border: 1px solid rgba(59, 130, 246, 0.3); text-align: center;">
                            <div style="font-size: 14px; color: #94a3b8; margin-bottom: 5px;"><i class="fas fa-shopping-cart" style="margin-right: 5px;"></i>মোট বিক্রয়</div>
                            <div id="daily-total-sales" style="font-size: 28px; font-weight: bold; color: #60a5fa;">৳ 0</div>
                            <div id="daily-sales-count" style="font-size: 12px; color: #94a3b8; margin-top: 5px;">0 টি বিল</div>
                        </div>
                        <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.1)); padding: 20px; border-radius: 10px; border: 1px solid rgba(16, 185, 129, 0.3); text-align: center;">
                            <div style="font-size: 14px; color: #94a3b8; margin-bottom: 5px;"><i class="fas fa-money-bill-wave" style="margin-right: 5px;"></i>ক্যাশ এসেছে</div>
                            <div id="daily-cash-received" style="font-size: 28px; font-weight: bold; color: #34d399;">৳ 0</div>
                            <div id="daily-cash-count" style="font-size: 12px; color: #94a3b8; margin-top: 5px;">0 টি লেনদেন</div>
                        </div>
                        <div style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(220, 53, 69, 0.1)); padding: 20px; border-radius: 10px; border: 1px solid rgba(239, 68, 68, 0.3); text-align: center;">
                            <div style="font-size: 14px; color: #94a3b8; margin-bottom: 5px;"><i class="fas fa-hand-holding-usd" style="margin-right: 5px;"></i>বাকি হয়েছে</div>
                            <div id="daily-due-amount" style="font-size: 28px; font-weight: bold; color: #f87171;">৳ 0</div>
                            <div id="daily-due-count" style="font-size: 12px; color: #94a3b8; margin-top: 5px;">0 জন কাস্টমার</div>
                        </div>
                    </div>

                    <!-- Summary Cards Row 2 -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
                        <div style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(124, 58, 237, 0.1)); padding: 20px; border-radius: 10px; border: 1px solid rgba(139, 92, 246, 0.3); text-align: center;">
                            <div style="font-size: 14px; color: #94a3b8; margin-bottom: 5px;"><i class="fas fa-users" style="margin-right: 5px;"></i>পেমেন্টকারী কাস্টমার</div>
                            <div id="daily-paying-customers" style="font-size: 28px; font-weight: bold; color: #a78bfa;">0</div>
                            <div style="font-size: 12px; color: #94a3b8; margin-top: 5px;">জন</div>
                        </div>
                        <div style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(217, 119, 6, 0.1)); padding: 20px; border-radius: 10px; border: 1px solid rgba(245, 158, 11, 0.3); text-align: center;">
                            <div style="font-size: 14px; color: #94a3b8; margin-bottom: 5px;"><i class="fas fa-box" style="margin-right: 5px;"></i>মোট পণ্য বিক্রি</div>
                            <div id="daily-products-sold" style="font-size: 28px; font-weight: bold; color: #fbbf24;">0</div>
                            <div style="font-size: 12px; color: #94a3b8; margin-top: 5px;">টি পণ্য</div>
                        </div>
                        <div style="background: linear-gradient(135deg, rgba(6, 182, 212, 0.2), rgba(8, 145, 178, 0.1)); padding: 20px; border-radius: 10px; border: 1px solid rgba(6, 182, 212, 0.3); text-align: center;">
                            <div style="font-size: 14px; color: #94a3b8; margin-bottom: 5px;"><i class="fas fa-chart-line" style="margin-right: 5px;"></i>মোট আয়</div>
                            <div id="daily-total-income" style="font-size: 28px; font-weight: bold; color: #22d3ee;">৳ 0</div>
                            <div style="font-size: 12px; color: #94a3b8; margin-top: 5px;">নগদ + বাকি</div>
                        </div>
                    </div>

                    <!-- Detailed Transactions Table -->
                    <div style="background: var(--card-bg); border-radius: 10px; padding: 20px; border: 1px solid var(--border-color);">
                        <h4 style="margin-top: 0; margin-bottom: 15px; color: #f59e0b;"><i class="fas fa-list-alt"></i> বিস্তারিত লেনদেন তালিকা</h4>
                        <div style="overflow-x: auto; max-height: 400px; overflow-y: auto;">
                            <table id="daily-transactions-table" style="width: 100%; border-collapse: collapse;">
                                <thead style="position: sticky; top: 0; background: var(--card-bg); z-index: 10;">
                                    <tr style="background: rgba(245, 158, 11, 0.2);">
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid var(--border-color);">#</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid var(--border-color);">সময়</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid var(--border-color);">বিল নং</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid var(--border-color);">কাস্টমার</th>
                                        <th style="padding: 12px; text-align: right; border-bottom: 2px solid var(--border-color);">মোট টাকা</th>
                                        <th style="padding: 12px; text-align: right; border-bottom: 2px solid var(--border-color);">নগদ</th>
                                        <th style="padding: 12px; text-align: right; border-bottom: 2px solid var(--border-color);">বাকি</th>
                                        <th style="padding: 12px; text-align: right; border-bottom: 2px solid var(--border-color);">পেমেন্ট</th>
                                        <th style="padding: 12px; text-align: right; border-bottom: 2px solid var(--border-color);">কাস্টমার বাকি</th>
                                        <th style="padding: 12px; text-align: center; border-bottom: 2px solid var(--border-color);">ধরণ</th>
                                    </tr>
                                </thead>
                                <tbody id="daily-transactions-tbody">
                                    <!-- Dynamic content -->
                                </tbody>
                                <tfoot style="position: sticky; bottom: 0; background: var(--card-bg); font-weight: bold;">
                                    <tr style="background: rgba(245, 158, 11, 0.3);">
                                        <td colspan="4" style="padding: 12px; text-align: right; border-top: 2px solid var(--border-color);">সর্বমোট:</td>
                                        <td id="daily-footer-total" style="padding: 12px; text-align: right; border-top: 2px solid var(--border-color); color: #60a5fa;">৳ 0</td>
                                        <td id="daily-footer-cash" style="padding: 12px; text-align: right; border-top: 2px solid var(--border-color); color: #34d399;">৳ 0</td>
                                        <td id="daily-footer-due" style="padding: 12px; text-align: right; border-top: 2px solid var(--border-color); color: #f87171;">৳ 0</td>
                                        <td id="daily-footer-payment" style="padding: 12px; text-align: right; border-top: 2px solid var(--border-color); color: #a78bfa;">৳ 0</td>
                                        <td id="daily-footer-customer-due" style="padding: 12px; text-align: right; border-top: 2px solid var(--border-color); color: #fbbf24;">৳ 0</td>
                                        <td style="padding: 12px; border-top: 2px solid var(--border-color);"></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        <div id="daily-report-empty" style="text-align: center; padding: 30px; color: #94a3b8; display: none;">
                            <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 10px;"></i>
                            <p>এই তারিখে কোনো লেনদেন পাওয়া যায়নি</p>
                        </div>
                    </div>
                </div>
            </section>

            <section id="settings-section" class="app-section">
                <h2><i class="fas fa-cogs"></i> সেটিংস</h2>
                <div class="setting-item">
                    <h3><i class="fas fa-store"></i> দোকানের তথ্য</h3>
                    <form id="shop-info-form">
                        <label for="shop-name">দোকানের নাম:</label>
                        <input type="text" id="shop-name" value="আমার কাপড়ের দোকান" required>
                        <label for="shop-address">ঠিকানা:</label>
                        <input type="text" id="shop-address" value="গুনাগুরী, বাঁশখালী, চট্টগ্রাম" required>
                         <label for="shop-logo">দোকানের লোগো URL:</label>
                        <input type="text" id="shop-logo" placeholder="https://example.com/logo.png">
                        <!-- New Fields for print info - added to settings form for persistence -->
                        <label for="shop-phone-cell">ফোন / সেল নম্বর:</label>
                        <input type="text" id="shop-phone-cell" value="+88-031-XXXXXXX, Cell: 018XX-XXXXXX" placeholder="ফোন / সেল নম্বর">
                        <label for="shop-vat-reg">VAT Reg. No.:</label>
                        <input type="text" id="shop-vat-reg" value="24041124158" placeholder="VAT Reg. No.">
                        <!-- End New Fields -->
                        <button type="submit" class="primary-btn"><i class="fas fa-save"></i> আপডেট করুন</button>
                    </form>
                </div>

                <!-- 1. Offline + Sync System - New Manual Sync/Clear Queue Section (REMOVED) -->


                <!-- ✅ NEW: Data Usage Dashboard -->
                <div class="setting-item">
                    <h3><i class="fas fa-chart-pie"></i> ডেটা ইউসেজ ড্যাশবোর্ড</h3>
                    <p style="font-size: 14px; color: #94a3b8; margin-bottom: 15px;">সফটওয়্যারের মোট ডেটা ব্যবহারের পরিসংখ্যান</p>
                    
                    <div class="data-usage-dashboard" style="background: linear-gradient(135deg, rgba(15, 23, 42, 0.8), rgba(30, 41, 59, 0.8)); border: 1px solid rgba(94, 234, 212, 0.2); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                        <!-- Total Usage Card -->
                        <div class="total-usage-card" style="text-align: center; padding: 20px; background: linear-gradient(135deg, rgba(37, 99, 235, 0.2), rgba(59, 130, 246, 0.1)); border-radius: 10px; margin-bottom: 20px; border: 1px solid rgba(59, 130, 246, 0.3);">
                            <div style="font-size: 48px; color: #60a5fa; margin-bottom: 10px;">
                                <i class="fas fa-database"></i>
                            </div>
                            <div style="font-size: 14px; color: #94a3b8; margin-bottom: 5px;">মোট ডেটা ব্যবহার</div>
                            <div id="total-data-usage" style="font-size: 36px; font-weight: bold; color: #e2e8f0;">0 KB</div>
                            <div id="data-usage-percentage" style="font-size: 14px; color: #10b981; margin-top: 5px;">0% ব্যবহৃত</div>
                        </div>

                        <!-- Usage Bars -->
                        <div class="usage-breakdown" style="margin-bottom: 20px;">
                            <h4 style="margin: 0 0 15px 0; color: #e2e8f0; font-size: 16px;"><i class="fas fa-list-ul"></i> ক্যাটাগরি অনুযায়ী ব্যবহার</h4>
                            
                            <div class="usage-item" style="margin-bottom: 12px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span style="color: #cbd5e1; font-size: 14px;"><i class="fas fa-shopping-cart" style="color: #f59e0b; margin-right: 8px;"></i>বিক্রয়</span>
                                    <span id="sales-data-size" style="color: #e2e8f0; font-size: 14px; font-weight: 500;">0 KB</span>
                                </div>
                                <div class="usage-bar-bg" style="background: rgba(255,255,255,0.1); height: 8px; border-radius: 4px; overflow: hidden;">
                                    <div id="sales-usage-bar" class="usage-bar-fill" style="background: linear-gradient(90deg, #f59e0b, #fbbf24); height: 100%; border-radius: 4px; width: 0%; transition: width 0.5s ease;"></div>
                                </div>
                            </div>

                            <div class="usage-item" style="margin-bottom: 12px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span style="color: #cbd5e1; font-size: 14px;"><i class="fas fa-users" style="color: #3b82f6; margin-right: 8px;"></i>কাস্টমার</span>
                                    <span id="customers-data-size" style="color: #e2e8f0; font-size: 14px; font-weight: 500;">0 KB</span>
                                </div>
                                <div class="usage-bar-bg" style="background: rgba(255,255,255,0.1); height: 8px; border-radius: 4px; overflow: hidden;">
                                    <div id="customers-usage-bar" class="usage-bar-fill" style="background: linear-gradient(90deg, #3b82f6, #60a5fa); height: 100%; border-radius: 4px; width: 0%; transition: width 0.5s ease;"></div>
                                </div>
                            </div>

                            <div class="usage-item" style="margin-bottom: 12px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span style="color: #cbd5e1; font-size: 14px;"><i class="fas fa-box" style="color: #10b981; margin-right: 8px;"></i>পণ্য</span>
                                    <span id="products-data-size" style="color: #e2e8f0; font-size: 14px; font-weight: 500;">0 KB</span>
                                </div>
                                <div class="usage-bar-bg" style="background: rgba(255,255,255,0.1); height: 8px; border-radius: 4px; overflow: hidden;">
                                    <div id="products-usage-bar" class="usage-bar-fill" style="background: linear-gradient(90deg, #10b981, #34d399); height: 100%; border-radius: 4px; width: 0%; transition: width 0.5s ease;"></div>
                                </div>
                            </div>

                            <div class="usage-item" style="margin-bottom: 12px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span style="color: #cbd5e1; font-size: 14px;"><i class="fas fa-money-check-alt" style="color: #8b5cf6; margin-right: 8px;"></i>লেজার</span>
                                    <span id="ledger-data-size" style="color: #e2e8f0; font-size: 14px; font-weight: 500;">0 KB</span>
                                </div>
                                <div class="usage-bar-bg" style="background: rgba(255,255,255,0.1); height: 8px; border-radius: 4px; overflow: hidden;">
                                    <div id="ledger-usage-bar" class="usage-bar-fill" style="background: linear-gradient(90deg, #8b5cf6, #a78bfa); height: 100%; border-radius: 4px; width: 0%; transition: width 0.5s ease;"></div>
                                </div>
                            </div>

                            <div class="usage-item" style="margin-bottom: 12px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span style="color: #cbd5e1; font-size: 14px;"><i class="fas fa-truck" style="color: #ec4899; margin-right: 8px;"></i>সাপ্লায়ার</span>
                                    <span id="suppliers-data-size" style="color: #e2e8f0; font-size: 14px; font-weight: 500;">0 KB</span>
                                </div>
                                <div class="usage-bar-bg" style="background: rgba(255,255,255,0.1); height: 8px; border-radius: 4px; overflow: hidden;">
                                    <div id="suppliers-usage-bar" class="usage-bar-fill" style="background: linear-gradient(90deg, #ec4899, #f472b6); height: 100%; border-radius: 4px; width: 0%; transition: width 0.5s ease;"></div>
                                </div>
                            </div>

                            <div class="usage-item" style="margin-bottom: 12px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span style="color: #cbd5e1; font-size: 14px;"><i class="fas fa-university" style="color: #06b6d4; margin-right: 8px;"></i>ব্যাংক</span>
                                    <span id="banks-data-size" style="color: #e2e8f0; font-size: 14px; font-weight: 500;">0 KB</span>
                                </div>
                                <div class="usage-bar-bg" style="background: rgba(255,255,255,0.1); height: 8px; border-radius: 4px; overflow: hidden;">
                                    <div id="banks-usage-bar" class="usage-bar-fill" style="background: linear-gradient(90deg, #06b6d4, #22d3ee); height: 100%; border-radius: 4px; width: 0%; transition: width 0.5s ease;"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Stats Grid -->
                        <div class="stats-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px;">
                            <div class="stat-box" style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; text-align: center;">
                                <div id="total-records-count" style="font-size: 20px; font-weight: bold; color: #60a5fa;">0</div>
                                <div style="font-size: 12px; color: #94a3b8;">মোট রেকর্ড</div>
                            </div>
                            <div class="stat-box" style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; text-align: center;">
                                <div id="total-sales-count" style="font-size: 20px; font-weight: bold; color: #f59e0b;">0</div>
                                <div style="font-size: 12px; color: #94a3b8;">মোট বিক্রয়</div>
                            </div>
                            <div class="stat-box" style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; text-align: center;">
                                <div id="total-customers-count" style="font-size: 20px; font-weight: bold; color: #10b981;">0</div>
                                <div style="font-size: 12px; color: #94a3b8;">মোট কাস্টমার</div>
                            </div>
                        </div>

                        <button id="refresh-data-usage-btn" class="primary-btn" style="width: 100%; margin-top: 15px;"><i class="fas fa-sync-alt"></i> রিফ্রেশ করুন</button>
                    </div>
                </div>

                <!-- ✅ NEW: Enhanced Backup Option -->
                <div class="setting-item">
                    <h3><i class="fas fa-database"></i> ডেটা ব্যাকআপ ও ইম্পোর্ট</h3>
                    <p style="font-size: 14px; color: #94a3b8; margin-bottom: 15px;">আপনার সকল ডেটা ব্যাকআপ নিন অথবা পূর্বের ডেটা ইম্পোর্ট করুন</p>
                    
                    <!-- Backup Info Card -->
                    <div class="backup-info-card" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.05)); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 10px; padding: 15px; margin-bottom: 15px;">
                        <div style="display: flex; align-items: center; margin-bottom: 10px;">
                            <i class="fas fa-info-circle" style="color: #10b981; margin-right: 10px; font-size: 18px;"></i>
                            <span style="color: #e2e8f0; font-weight: 500;">ব্যাকআপ তথ্য</span>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">
                            <div>
                                <span style="color: #94a3b8;">মোট ডেটা:</span>
                                <span id="backup-data-size" style="color: #10b981; font-weight: bold; margin-left: 5px;">0 KB</span>
                            </div>
                            <div>
                                <span style="color: #94a3b8;">লাস্ট ব্যাকআপ:</span>
                                <span id="last-backup-time" style="color: #e2e8f0; margin-left: 5px;">কোনো ব্যাকআপ নেই</span>
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button id="backup-data-btn" class="primary-btn" style="flex: 1; min-width: 150px;"><i class="fas fa-download"></i> ডেটা ব্যাকআপ</button>
                        <input type="file" id="import-data-input" accept=".json" style="display:none;">
                        <button id="import-data-btn" class="primary-btn" onclick="document.getElementById('import-data-input').click();" style="flex: 1; min-width: 150px; background: linear-gradient(135deg, #8b5cf6, #7c3aed);"><i class="fas fa-upload"></i> ডেটা ইম্পোর্ট</button>
                    </div>
                    
                    <div id="backup-progress-container" style="display: none; margin-top: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span style="font-size: 14px; color: #94a3b8;">ব্যাকআপ প্রগ্রেস...</span>
                            <span id="backup-progress-text" style="font-size: 14px; color: #10b981;">0%</span>
                        </div>
                        <div style="background: rgba(255,255,255,0.1); height: 8px; border-radius: 4px; overflow: hidden;">
                            <div id="backup-progress-bar" style="background: linear-gradient(90deg, #10b981, #34d399); height: 100%; border-radius: 4px; width: 0%; transition: width 0.3s ease;"></div>
                        </div>
                    </div>

                    <p id="backup-status" style="margin-top: 10px; font-size: 14px;"></p>
                    <p id="import-status" style="margin-top: 10px; font-size: 14px;"></p>
                </div>

                <div class="setting-item">
                    <h3><i class="fas fa-star"></i> সাবস্ক্রিপশন ব্যবস্থাপনা</h3>
                    <p>বর্তমান সাবস্ক্রিপশনের মেয়াদ: <span id="subscription-end-date" style="font-weight: bold;"></span></p>
                    <p id="subscription-status" style="font-weight: bold;"></p>
                    
                    <div style="margin-top: 20px; padding: 15px; background: rgba(37, 99, 235, 0.1); border-radius: 8px;">
                        <h4 style="margin-top: 0; color: var(--light-blue);"><i class="fas fa-calendar-alt"></i> মেয়াদ পরিবর্তন করুন</h4>
                        <p style="font-size: 14px; color: #94a3b8; margin-bottom: 15px;">মেয়াদ বাড়াতে বা কমাতে নতুন তারিখ নির্বাচন করুন।</p>
                        
                        <label for="subscription-modify-password">অ্যাডমিন পাসওয়ার্ড:</label>
                        <input type="password" id="subscription-modify-password" placeholder="অ্যাডমিন পাসওয়ার্ড দিন" required>
                        
                        <label for="subscription-new-end-date">নতুন মেয়াদ শেষের তারিখ:</label>
                        <input type="date" id="subscription-new-end-date" required>
                        
                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <button id="update-subscription-date-btn" class="primary-btn"><i class="fas fa-calendar-check"></i> মেয়াদ আপডেট করুন</button>
                            <button id="extend-subscription-quick-btn" class="primary-btn" style="background: linear-gradient(135deg, #10b981, #059669);"><i class="fas fa-plus"></i> দ্রুত +৩০ দিন</button>
                        </div>
                        <p id="subscription-message" class="error-message"></p>
                    </div>
                    
                    <div style="margin-top: 15px; padding: 10px; background: rgba(239, 68, 68, 0.1); border-radius: 6px; font-size: 13px; color: #fca5a5;">
                        <i class="fas fa-exclamation-triangle"></i> <strong>নোট:</strong> মেয়াদ কমালে (আগের তারিখ দিলে) সাবস্ক্রিপশন আগেই শেষ হবে।
                    </div>
                </div>

                <div class="setting-item">
                    <h3><i class="fas fa-layer-group"></i> সাবস্ক্রিপশন লেভেল</h3>
                    <p>বর্তমান লেভেল: <span id="current-subscription-level" style="font-weight: bold; color: var(--light-blue);"></span></p>
                    <p style="font-size: 14px; color: #94a3b8; margin-bottom: 15px;">সাবস্ক্রিপশন লেভেল পরিবর্তন করতে পাসওয়ার্ড দিন এবং নতুন লেভেল নির্বাচন করুন।</p>
                    <label for="subscription-level-password">অ্যাডমিন পাসওয়ার্ড:</label>
                    <input type="password" id="subscription-level-password" placeholder="অ্যাডমিন পাসওয়ার্ড দিন" required>
                    <label for="subscription-level-select">সাবস্ক্রিপশন লেভেল:</label>
                    <select id="subscription-level-select" required>
                        <option value="basic">বেসিক (Basic)</option>
                        <option value="standard">স্ট্যান্ডার্ড (Standard)</option>
                        <option value="premium">প্রিমিয়াম (Premium)</option>
                    </select>
                    <div id="subscription-level-info" style="margin: 15px 0; padding: 10px; background: rgba(37, 99, 235, 0.1); border-radius: 6px; font-size: 14px;">
                        <p style="margin: 0; color: #94a3b8;"><i class="fas fa-info-circle"></i> লেভেল তথ্য:</p>
                        <ul style="margin: 5px 0 0 0; padding-left: 20px; color: #e2e8f0;">
                            <li><strong>বেসিক:</strong> সীমিত ফিচারস</li>
                            <li><strong>স্ট্যান্ডার্ড:</strong> সম্পূর্ণ POS এবং রিপোর্টিং</li>
                            <li><strong>প্রিমিয়াম:</strong> সব ফিচারস এবং অগ্রাধিকার সাপোর্ট</li>
                        </ul>
                    </div>
                    <button id="update-subscription-level-btn" class="primary-btn"><i class="fas fa-sync-alt"></i> লেভেল আপডেট করুন</button>
                    <p id="subscription-level-message" class="error-message"></p>
                </div>

                <div class="setting-item">
                    <h3><i class="fas fa-history"></i> সফটওয়্যার ডেটা রিসেট</h3>
                    <p>এই অপশনটি সফটওয়্যারের সকল ডেটা মুছে দেবে। এই কাজটি অপরিবর্তনীয়!</p>
                    <button id="reset-all-data-btn" class="danger-btn"><i class="fas fa-exclamation-triangle"></i> সকল ডেটা রিসেট করুন</button>
                </div>
            </section>
        </div>
    </div>
    
    <!-- Customer Due Payment Modal -->
    <div id="pay-due-modal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3>বাকি টাকা পরিশোধ করুন</h3>
            <p>কাস্টমার: <span id="modal-due-customer-name"></span></p>
            <p>মোট বকেয়া: <span id="modal-due-total-outstanding"></span></p>
            <label for="payment-amount">পরিশোধের পরিমাণ (৳):</label>
            <input type="number" id="payment-amount" step="0.01" min="0" required>
            <label for="payment-method-due">পেমেন্টের ধরণ:</label>
            <select id="payment-method-due" required>
                <option value="cash">নগদ (Cash Ledger)</option>
                <option value="bank">ব্যাংক</option>
            </select>
            <!-- NEW: Bank Select for Due Payment -->
            <div id="due-bank-select-container" style="display:none; margin-top: 15px;">
                <label for="due-bank-select">ব্যাংক নির্বাচন করুন:</label>
                <select id="due-bank-select"></select>
            </div>
            <p>বাকি থাকবে: <span id="modal-due-remaining">৳ 0</span></p>
            <button id="process-due-payment-btn" class="primary-btn"><i class="fas fa-check-circle"></i> জমা দিন</button>
            <button type="button" class="cancel-btn close-button"><i class="fas fa-times"></i> বাতিল</button>
            <div id="payment-receipt-section" style="display:none; margin-top: 20px; text-align: center;">
                <p style="color: green; font-weight: bold;">পরিশোধ সফল হয়েছে!</p>
                <button id="print-payment-receipt-btn" class="primary-btn"><i class="fas fa-print"></i> প্রিন্ট রসিদ</button>
            </div>
        </div>
    </div>
    
    <!-- Supplier Due Payment Modal -->
    <div id="pay-supplier-due-modal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3>সাপ্লায়ারের বকেয়া পরিশোধ করুন</h3>
            <p>সাপ্লায়ার: <span id="modal-supplier-name"></span></p>
            <p>মোট বকেয়া: <span id="modal-supplier-total-outstanding"></span></p>
            <label for="supplier-payment-amount">পরিশোধের পরিমাণ (৳):</label>
            <input type="number" id="supplier-payment-amount" step="0.01" min="0" required>
            <label for="supplier-payment-method">পেমেন্টের ধরণ:</label>
            <select id="supplier-payment-method" required>
                <option value="cash">নগদ (Cash Ledger)</option>
                <option value="bank">ব্যাংক</option>
            </select>
            <!-- NEW: Bank Select for Supplier Due Payment -->
             <div id="supplier-due-bank-select-container" style="display:none; margin-top: 15px;">
                <label for="supplier-due-bank-select">ব্যাংক নির্বাচন করুন:</label>
                <select id="supplier-due-bank-select"></select>
            </div>
            <p>বাকি থাকবে: <span id="modal-supplier-due-remaining">৳ 0</span></p>
            <button id="process-supplier-due-payment-btn" class="primary-btn"><i class="fas fa-check-circle"></i> জমা দিন</button>
        </div>
    </div>
    
    <!-- Supplier History Modal (NEW IMPROVED) -->
    <div id="supplier-history-modal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3>সাপ্লায়ার লেজার: <span id="modal-history-supplier-name"></span></h3>
            <div id="supplier-history-summary">
                <p>মোট ক্রয় <span id="summary-total-purchased"></span></p>
                <p>মোট পরিশোধ <span id="summary-total-paid"></span></p>
                <p>বর্তমান বাকি <span id="summary-current-due"></span></p>
            </div>
            
            <div class="modal-filters">
                <div>
                    <label for="supplier-ledger-from-date">তারিখ থেকে:</label>
                    <input type="date" id="supplier-ledger-from-date">
                </div>
                <div>
                    <label for="supplier-ledger-to-date">তারিখ পর্যন্ত:</label>
                    <input type="date" id="supplier-ledger-to-date">
                </div>
                <button id="filter-supplier-ledger-btn" class="primary-btn" style="margin: 0;"><i class="fas fa-filter"></i> ফিল্টার</button>
            </div>

            <div class="ledger-table-container" id="supplier-ledger-print-area">
                <!-- Cash Purchases Table -->
                <h4>নগদ ক্রয় <span class="table-total" id="total-cash-purchase"></span></h4>
                <table id="supplier-cash-purchase-table">
                    <thead><tr><th>তারিখ</th><th>বিস্তারিত</th><th>টাকা</th></tr></thead>
                    <tbody></tbody>
                </table>
                <!-- Due Purchases Table -->
                <h4>বাকি ক্রয় <span class="table-total" id="total-due-purchase"></span></h4>
                <table id="supplier-due-purchase-table">
                     <thead><tr><th>তারিখ</th><th>বিস্তারিত</th><th>টাকা</th></tr></thead>
                    <tbody></tbody>
                </table>
                <!-- Payments Table -->
                <h4>বকেয়া পরিশোধ <span class="table-total" id="total-supplier-payment"></span></h4>
                <table id="supplier-payment-table">
                     <thead><tr><th>তারিখ</th><th>বিস্তারিত</th><th>টাকা</th></tr></thead>
                    <tbody></tbody>
                </table>
                <!-- Returns Table -->
                <h4>পণ্য ফেরত <span class="table-total" id="total-supplier-return"></span></h4>
                <table id="supplier-return-table-ledger">
                     <thead><tr><th>তারিখ</th><th>বিস্তারিত</th><th>টাকা</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <button id="print-supplier-history-btn" class="primary-btn" style="margin-top: 20px;"><i class="fas fa-print"></i> লেজার প্রিন্ট করুন</button>
        </div>
    </div>

    <!-- Customer Ledger Modal (NEW IMPROVED) -->
    <div id="customer-ledger-modal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <!-- 3. Customer Ledger System - Summary included -->
            <h3>কাস্টমার লেজার: <span id="modal-ledger-customer-name"></span></h3>
            <div id="customer-ledger-summary">
                <p>মোট কেনা <span id="summary-total-customer-purchased"></span></p>
                <p>মোট পরিশোধ <span id="summary-total-customer-paid"></span></p>
                <p>বর্তমান বাকি <span id="summary-current-customer-due"></span></p>
            </div>
            
            <div class="modal-filters">
                <div>
                    <label for="customer-ledger-from-date">তারিখ থেকে:</label>
                    <input type="date" id="customer-ledger-from-date">
                </div>
                <div>
                    <label for="customer-ledger-to-date">তারিখ পর্যন্ত:</label>
                    <input type="date" id="customer-ledger-to-date">
                </div>
                <button id="filter-customer-ledger-btn" class="primary-btn" style="margin: 0;"><i class="fas fa-filter"></i> ফিল্টার</button>
            </div>

            <div class="ledger-table-container" id="customer-ledger-print-area">
                <!-- Sales Table -->
                <h4>বিক্রয় তালিকা <span class="table-total" id="total-customer-sales"></span></h4>
                <table id="customer-sales-table">
                    <thead><tr><th>তারিখ</th><th>ধরণ</th><th>বিস্তারিত</th><th>টাকা</th></tr></thead>
                    <tbody></tbody>
                </table>
                <!-- Payments Received Table -->
                <h4>বকেয়া পরিশোধ প্রাপ্তি <span class="table-total" id="total-customer-payment"></span></h4>
                <table id="customer-payment-table">
                    <thead><tr><th>তারিখ</th><th>উৎস</th><th>বিস্তারিত</th><th>টাকা</th><th>একশন</th></tr></thead>
                    <tbody></tbody>
                </table>
                <!-- Returns Table -->
                <h4>ফেরত পণ্যের তালিকা <span class="table-total" id="total-customer-returns"></span></h4>
                <table id="customer-returns-table">
                    <thead><tr><th>তারিখ</th><th>বিস্তারিত</th><th>টাকা</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <button id="print-customer-ledger-btn" class="primary-btn" style="margin-top: 20px;"><i class="fas fa-print"></i> লেজার প্রিন্ট করুন</button>
        </div>
    </div>


    <!-- Supplier Return Modal -->
    <div id="supplier-return-modal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3>সাপ্লায়ারকে পণ্য ফেরত দিন</h3>
            <p>সাপ্লায়ার: <span id="modal-return-supplier-name"></span></p>
            <div id="supplier-return-table-container" style="max-height: 50vh; overflow-y: auto;">
                <table id="supplier-return-table">
                    <thead>
                        <tr>
                            <th>পণ্য</th>
                            <th>বর্তমান স্টক</th>
                            <th>ক্রয় মূল্য</th>
                            <th>ফেরত পরিমাণ</th>
                        </tr>
                    </thead>
                    <tbody id="supplier-return-table-body">
                    </tbody>
                </table>
            </div>
            <p style="text-align: right; font-size: 1.1em; margin-top: 15px;">
                <strong>মোট ফেরতের মূল্য: <span id="total-return-value">৳ 0</span></strong>
            </p>
            <button id="process-supplier-return-btn" class="warning-btn"><i class="fas fa-check-circle"></i> ফেরত প্রক্রিয়া করুন</button>
        </div>
    </div>

    <!-- NEW: 4. Sales & Profit Report System - Product Wise Report Modal -->
    <div id="product-wise-report-modal" class="modal" style="display:none;">
        <div class="modal-content" style="max-width: 900px;">
            <span class="close-button">&times;</span>
            <h3>পণ্য-ভিত্তিক বিক্রয় ও লাভ রিপোর্ট</h3>
            
            <div class="modal-filters">
                <div>
                    <label for="product-report-from-date">তারিখ থেকে:</label>
                    <input type="date" id="product-report-from-date">
                </div>
                <div>
                    <label for="product-report-to-date">তারিখ পর্যন্ত:</label>
                    <input type="date" id="product-report-to-date">
                </div>
                <div>
                     <label for="product-report-category-filter">ক্যাটাগরি:</label>
                     <select id="product-report-category-filter"><option value="">সকল ক্যাটাগরি</option></select>
                </div>
                <button id="filter-product-wise-report" class="primary-btn" style="margin: 0;"><i class="fas fa-filter"></i> ফিল্টার</button>
                <button id="print-product-wise-report" class="info-btn" style="margin: 0;"><i class="fas fa-print"></i> প্রিন্ট</button>
            </div>

            <div id="product-report-summary" style="padding: 10px; background: #2b3a4f; border-radius: 6px; margin-bottom: 15px;">
                <p>মোট নিট বিক্রয়: <span id="prod-report-total-sale" style="font-weight: bold;">৳ 0</span></p>
                 <p>মোট লাভ: <span id="prod-report-total-profit" style="font-weight: bold; color: #22c55e;">৳ 0</span></p>
                 <p>মোট বিক্রিত পণ্য: <span id="prod-report-total-qty" style="font-weight: bold;">0 পিস</span></p>
            </div>
            <div class="ledger-table-container">
                <table id="product-wise-report-table">
                    <thead>
                        <tr>
                            <th>পণ্য</th>
                            <th>ক্যাটাগরি</th>
                            <th>বিক্রিত সংখ্যা</th>
                            <th>মোট বিক্রয় (৳)</th>
                            <th>মোট ক্রয় মূল্য (৳)</th>
                            <th>লাভ (৳)</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/locale/bn.min.js"></script>
    <script>
        // Set Bengali locale for moment.js
        if (typeof moment !== 'undefined') {
            moment.locale('bn');
        } else {
            console.warn("Moment.js is not loaded. Bengali locale cannot be set.");
        }
    </script>

    <!-- ================================================================================= -->
    <!-- ======================= START OF ALL NEW ADD-ON MODULES ========================= -->
    <!-- (IndexedDB/Sync classes REMOVED) -->
    <!-- ================================================================================= -->


    <script>
        // --- DB Setup and Global DB Object Finalization (REPLACED) ---
        // Final overriding of the global 'db' abstraction: Use FirebaseDB directly.
        if (typeof window._actualStorageDB !== 'undefined' && window._actualStorageDB !== null) {
            window.db = window._actualStorageDB;
            console.log('Firebase storage directly configured as global db.');
        } else {
            console.warn('Firebase config not provided or failed. Using no-op mock DB.');
        }
        
        // --- Core UI Update Loop (Original) ---
        
        // =================================================================================
        // ======================== ORIGINAL APPLICATION CODE STARTS =========================
        // =================================================================================
        
        // 1. Loading System: Loader control functions (NEW)
        const fullPageLoader = document.getElementById('full-page-loader');

        function showLoader() {
            fullPageLoader.style.display = 'flex';
        }

        function hideLoader() {
            fullPageLoader.style.display = 'none';
        }

        // --- Global Data Arrays (Now loaded from Firebase by initializeData) ---
        let products = [];
        let suppliers = [];
        let customers = []; 
        let users = [];
        let sales = [];
        let dues = [];
        let ledgerEntries = [];
        let purchaseHistory = [];
        let supplierReturns = [];
        // NEW GLOBAL ARRAYS
        let banks = []; // Section 4A: Bank Setup
        let bankTransactions = []; // Section 4B: Bank Transaction History

        // ধাপ ২.২: shopSettings এ snConfig সরানো হয়েছে
        let shopSettings = {
            key: 'main',
            name: "AGC নির্মাতা Software",
            address: "গুনাগুরী, বাঁশখালী, চট্টগ্রাম",
            logoUrl: "", 
            subscriptionEndDate: null,
            subscriptionLevel: 'basic', // ✅ NEW: Subscription Level (basic, standard, premium)
            lastInvoiceNumber: 100000, // ✅ NEW: Invoice Counter
            ledgerCategories: {
                expense: {
                    'supplier_payment': 'সাপ্লায়ার পেমেন্ট',
                    'product_purchase': 'পণ্য ক্রয় (নগদ)',
                    'customer_refund': 'কাস্টমার রিফান্ড',
                    'staff_salary': 'স্টাফ স্যালারি',
                    'payment': 'সাধারণ Cash খরচ', // Renamed for clarity
                    'others': 'অন্যান্য Cash খরচ', // Renamed for clarity
                    'manual_due_adjustment': 'ম্যানুয়াল বাকি অ্যাডজাস্টমেন্ট (মাইনাস)',
                    'bank_withdrawal_expense': 'ব্যাংক থেকে তুলে খরচ', // NEW: Bank Withdrawal (Expense)
                },
                income: {
                    'sales_income': 'বিক্রয় থেকে আয় (Cash)', // Renamed for clarity
                    'due_collection': 'বাকি টাকা কালেকশন (Cash)', // Renamed for clarity
                    'supplier_return_credit': 'সাপ্লায়ার ফেরত ক্রেডিট',
                    'opening_due_entry': 'ম্যানুয়াল বাকি এন্ট্রি',
                    'manual_due_adjustment': 'ম্যানুয়াল বাকি অ্যাডজাস্টমেন্ট (প্লাস)',
                    'bank_to_cash_transfer': 'ব্যাংক থেকে Cash ট্রান্সফার', // NEW: Bank to Cash Transfer
                    'others': 'অন্যান্য Cash আয়' // Renamed for clarity
                }
            },
            // --- New Print Settings Default Values ---
            phoneCell: "+88-031-XXXXXXX, Cell: 018XX-XXXXXX",
            vatReg: "24041124158",
            // snConfig block removed.
        };
        if (typeof window.ADMIN_PASSWORD === 'undefined') {
            window.ADMIN_PASSWORD = 'arpan1234@#';
        }

        // --- Current User and Cart State ---
        let currentUser = null;
        let currentCart = []; // { productId, name, quantity, unitPrice, purchasePrice }
        let currentEditingSale = null;

        // --- Utility Functions (Original) ---
        function generateUniqueId(prefix) {
            return prefix + Date.now().toString(36) + Math.random().toString(36).substring(2, 5);
        }
        
        // সিরিয়াল নম্বর জেনারেশন ফাংশন (সরলীকৃত)
        function generateProductSN(productId) {
             // Simple unique identifier for barcode. Use a shortened portion of the unique ID.
             return `FFP-${productId.slice(-7).toUpperCase()}`;
        }
        
        // বারকোড লেবেল প্রিন্ট করার জন্য একক লেবেল তৈরি করে
        function generateSingleBarcodeHtml(product, shopSettings) {
            const tempDiv = document.createElement('div');
            const svgElement = document.createElement('svg');
            tempDiv.appendChild(svgElement);

            try {
                 JsBarcode(svgElement, product.serialNumber, {
                    format: "CODE128",
                    displayValue: true,
                    text: product.serialNumber,
                    fontSize: 8,
                    width: 1, 
                    height: 20
                });
            } catch (e) {
                 console.error('Barcode generation failed:', e);
                 return `<div class="single-barcode-label" style="text-align: center; line-height: 1.2; box-sizing: border-box; width: 40mm; height: 25mm; border: 1px solid #ccc; margin: 2px; padding: 2px; page-break-inside: avoid;">Error</div>`;
            }


            const barcodeSvgHtml = svgElement.outerHTML;
            const logoHtml = shopSettings.logoUrl ? `<img src="${shopSettings.logoUrl}" style="max-height:12px; display: block; margin: 0 auto;">` : '';

            return `
                <div class="single-barcode-label" style="text-align: center; line-height: 1.2; box-sizing: border-box; width: 40mm; height: 25mm; margin: 0; padding: 2px; page-break-inside: avoid; display: block;">
                    <div style="font-size: 7px; font-weight: bold; margin-bottom: 1px; color: black !important;">${shopSettings.name.substring(0, 15)}</div>
                    ${logoHtml}
                    <div style="font-size: 8px; font-weight: bold; margin: 1px 0; color: black !important;">${product.name.substring(0, 15)}</div>
                    <div style="font-size: 7px; color: black !important;">৳ ${product.price.toLocaleString()}</div>
                    ${barcodeSvgHtml}
                </div>
            `;
        }

        // বারকোড লেবেল প্রিন্ট ফাংশন (পরিমাণ সহ)
        function printBarcodeLabel(productId, quantity = 1) {
            const product = products.find(p => p.id === productId);
            if (!product || !product.serialNumber) {
                alert('পণ্য বা SN পাওয়া যায়নি!');
                return;
            }
            if (quantity <= 0) {
                 alert('অনুগ্রহ করে বৈধ পরিমাণ দিন।');
                 return;
            }

            let allLabelsHtml = '';
            for (let i = 0; i < quantity; i++) {
                allLabelsHtml += generateSingleBarcodeHtml(product, shopSettings);
            }
            
            // Outer container handles layout in print mode
            const printContent = `<div style="display: flex; flex-wrap: wrap; gap: 0;">${allLabelsHtml}</div>`;

            // Use 'barcode-label-print-multiple' class for the specialized printing style
            launchPrint('বারকোড লেবেল', printContent, 'barcode-label-print-multiple');
        }


        // --- Data Initialization from Firebase (Uses the direct `db` object) ---
        async function initializeData() {
            showLoader(); // 1. Loading System: Show loader at start
            try {
                // IMPORTANT: db.open() now refers to the FirebaseDB open
                await db.open(); 
                
                // Fetch data using the direct `db` (Firebase)
                const [
                    productsData, suppliersData, customersData, usersData, salesData, 
                    duesData, ledgerEntriesData, settingsData, purchaseHistoryData,
                    supplierReturnsData, banksData, bankTransactionsData
                ] = await Promise.all([
                    db.getAll('products'), db.getAll('suppliers'), db.getAll('customers'), db.getAll('users'),
                    db.getAll('sales'), db.getAll('dues'), db.getAll('ledgerEntries'),
                    db.get('settings', 'main'), db.getAll('purchaseHistory'), db.getAll('supplierReturns'),
                    db.getAll('banks'), db.getAll('bankTransactions') // NEW FETCH
                ]);

                products = productsData;
                suppliers = suppliersData;
                
                // ইন্টারনেট/সার্ভিস গ্রাহকদের বাদ দেওয়া হয়েছে
                customers = customersData.filter(c => c.customerCategory !== 'internet' && c.customerCategory !== 'service'); 
                
                users = usersData;
                sales = salesData;
                dues = duesData.filter(d => d.billType !== 'internet' && d.billType !== 'service'); // বকেয়া থেকেও বিলিং এন্ট্রি বাদ
                // Filter out irrelevant ledger entries, but keep bank-related for total cash calculation
                ledgerEntries = ledgerEntriesData.filter(l => !l.category.includes('_bill_collection')); 
                purchaseHistory = purchaseHistoryData;
                supplierReturns = supplierReturnsData;
                banks = banksData; // NEW
                bankTransactions = bankTransactionsData; // NEW


                if (settingsData) {
                    // Merge loaded settings with default, ensuring the new category is preserved if loaded data doesn't have it
                    shopSettings = {...shopSettings, ...settingsData};
                    
                    // NEW: Ensure Manual Due category exists
                    if(!shopSettings.ledgerCategories.income.opening_due_entry) {
                         shopSettings.ledgerCategories.income.opening_due_entry = 'ম্যানুয়াল বাকি এন্ট্রি';
                    }
                     // NEW: Ensure Adjustment category exists (for admin edit)
                    if(!shopSettings.ledgerCategories.income.manual_due_adjustment) {
                         shopSettings.ledgerCategories.income.manual_due_adjustment = 'ম্যানুয়াল বাকি অ্যাডজাস্টমেন্ট (প্লাস)';
                         // Expense counterpart is also needed for negative adjustments
                         shopSettings.ledgerCategories.expense.manual_due_adjustment = 'ম্যানুয়াল বাকি অ্যাডজাস্টমেন্ট (মাইনাস)';
                    }
                    // NEW: Ensure Bank Categories exist
                    shopSettings.ledgerCategories.expense.bank_withdrawal_expense = shopSettings.ledgerCategories.expense.bank_withdrawal_expense || 'ব্যাংক থেকে তুলে খরচ';
                    shopSettings.ledgerCategories.income.bank_to_cash_transfer = shopSettings.ledgerCategories.income.bank_to_cash_transfer || 'ব্যাংক থেকে Cash ট্রান্সফার';
                    
                    // Update Ledger names for clarity (if they were the old names)
                    shopSettings.ledgerCategories.income.sales_income = 'বিক্রয় থেকে আয় (Cash)';
                    shopSettings.ledgerCategories.income.due_collection = 'বাকি টাকা কালেকশন (Cash)';
                    shopSettings.ledgerCategories.expense.payment = 'সাধারণ Cash খরচ';
                    shopSettings.ledgerCategories.expense.others = 'অন্যান্য Cash খরচ';
                    shopSettings.ledgerCategories.income.others = 'অন্যান্য Cash আয়';
                    


                    // Ensure we remove the snConfig key if it exists in loaded data, as we no longer support it
                    if (shopSettings.snConfig) {
                        delete shopSettings.snConfig;
                        await db.put('settings', shopSettings);
                    }
                    // Ensure new print fields exist on the loaded settings object
                    shopSettings.phoneCell = settingsData.phoneCell || shopSettings.phoneCell;
                    shopSettings.vatReg = settingsData.vatReg || shopSettings.vatReg;
                    
                    // ✅ NEW: Initialize invoice counter
                    if (!shopSettings.lastInvoiceNumber) {
                        const maxId = sales.map(s => parseInt(s.saleId)).filter(id => !isNaN(id)).reduce((max, id) => Math.max(max, id), 0);
                        shopSettings.lastInvoiceNumber = maxId > 0 ? maxId : 100000;
                    }
                    
                    // ✅ NEW: Initialize subscription level if not set
                    if (!shopSettings.subscriptionLevel) {
                        shopSettings.subscriptionLevel = 'basic';
                    }


                } else {
                    await db.put('settings', shopSettings);
                }
                
                // Ensure initial users are present 
                const desiredAdmin = { username: 'admin', password: 'admin1234@#', role: 'admin', displayName: 'অ্যাডমিন', profileImage: 'https://img.icons8.com/color/96/admin-settings-male.png', phone: '018xxxxxxxx' }; // 6. Added default phone (needs manual update in UI after first login)
                const desiredSeller = { username: 'seller', password: 'seller1234@#', role: 'seller', displayName: 'বিক্রয়কর্মী', profileImage: 'https://img.icons8.com/color/96/seller.png', phone: '017xxxxxxxx' };
                
                // Existing user seed logic (left out here for brevity, assume handled)

                document.getElementById('shop-name').value = shopSettings.name;
                document.getElementById('shop-address').value = shopSettings.address;
                 document.getElementById('shop-logo').value = shopSettings.logoUrl || '';
                 // NEW: Load print fields
                document.getElementById('shop-phone-cell').value = shopSettings.phoneCell || '';
                document.getElementById('shop-vat-reg').value = shopSettings.vatReg || '';
                 
                updateShopTitle(shopSettings.name);

                updateAllUI();
            } catch (error) {
                console.error("Failed to initialize data:", error);
                alert("ডাটাবেস চালু করতে সমস্যা হচ্ছে। অনুগ্রহ করে পৃষ্ঠাটি রিফ্রেশ করুন।");
            } finally {
                hideLoader(); // 1. Loading System: Hide loader at end
            }
        }
        
        // --- Core UI Update Loop (Original) ---
        function updateAllUI() {
            updateDashboardSummary();
            renderProductList();
            populateCategoryFilter();
            renderSupplierList();
            renderCustomerList();
            populateSupplierDatalist();
            renderSalesReport();
            populateSellerFilter();
            renderDuesList();
            renderLedger(); // Cash Ledger
            renderBankList(); // NEW
            populateBankSelectors(); // NEW
            renderBankTransactions(); // NEW
            renderExpenseReport(); // NEW
            populateLedgerCategoryFilter();
            renderUserList();
            updateUserProfileDisplay();
            // --- NEW CALLS ---
            renderStockAlerts(); // 2. Stock Alert System
            calculateAndRenderForecast(); // 5. Forecast
            populateProductReportCategoryFilter(); // 4. Sales Report - Product Wise filter
            populateExpenseReportCategoryFilter(); // NEW
            updateDataUsageDashboard(); // ✅ NEW: Data Usage Dashboard
            populateCustomerReportDropdown(); // ✅ NEW: Customer Report Dropdown
        }

        // --- UI Element References (Original) ---
        const loginContainer = document.getElementById('login-container');
        const appContainer = document.getElementById('app-container');
        // ... (Existing references to all sections and elements - TOO LONG TO PASTE HERE) ...
        const loginForm = document.getElementById('login-form');
        const loginErrorMessage = document.getElementById('login-error-message');
        const logoutBtn = document.getElementById('logout-btn');
        const mainNavUl = document.getElementById('main-nav-ul');
        const currentSectionTitle = document.getElementById('current-section-title');
        const greetingText = document.getElementById('greeting-text');
        const currentUserDisplayName = document.getElementById('current-user-display-name');
        const profileImg = document.getElementById('profile-img');
        const userAvatarDisplay = document.getElementById('user-avatar-display');

        // Section Elements
        const dashboardSection = document.getElementById('dashboard-section');
        const productsSection = document.getElementById('products-section');
        const suppliersSection = document.getElementById('suppliers-section');
        const posSection = document.getElementById('pos-section');
        const salesSection = document.getElementById('sales-section');
        const duesSection = document.getElementById('dues-section');
        const returnsSection = document.getElementById('returns-section');
        const ledgerSection = document.getElementById('ledger-section'); // Cash Ledger
        const customerDataSection = document.getElementById('customer-data-section');
        const customerManagementSection = document.getElementById('customer-management-section');
        const usersSection = document.getElementById('users-section');
        const settingsSection = document.getElementById('settings-section');
        const granularReportsSection = document.getElementById('granular-reports-section'); 
        const manualDuesSection = document.getElementById('manual-dues-section');
        
        // ✅ NEW: Daily Transaction Report Section
        const dailyTransactionSection = document.getElementById('daily-transaction-section');
        
        // NEW Finance/Bank/Expense Sections
        const financeSection = document.getElementById('finance-section');
        const expensesSection = document.getElementById('expenses-section');

        // Product Section Elements
        const addProductBtn = document.getElementById('add-product-btn');
        const addProductFormContainer = document.getElementById('add-product-form-container');
        const addProductForm = document.getElementById('add-product-form');
        const productList = document.getElementById('product-list');
        const productSearch = document.getElementById('product-search');
        const productCategoryFilter = document.getElementById('product-category-filter');
        const productPurchasePriceInput = document.getElementById('product-purchase-price');
        const productMinStockInput = document.getElementById('product-min-stock'); 

        // Supplier Section Elements
        const addSupplierBtn = document.getElementById('add-supplier-btn');
        const addSupplierFormContainer = document.getElementById('add-supplier-form-container');
        const addSupplierForm = document.getElementById('add-supplier-form');
        const supplierListTableBody = document.querySelector('#supplier-list-table tbody');
        const paySupplierDueModal = document.getElementById('pay-supplier-due-modal');
        const processSupplierDuePaymentBtn = document.getElementById('process-supplier-due-payment-btn');
        const supplierHistoryModal = document.getElementById('supplier-history-modal');
        const printSupplierHistoryBtn = document.getElementById('print-supplier-history-btn');
        const supplierReturnModal = document.getElementById('supplier-return-modal');
        const processSupplierReturnBtn = document.getElementById('process-supplier-return-btn');
        const filterSupplierLedgerBtn = document.getElementById('filter-supplier-ledger-btn');
        const supplierPaymentMethodSelect = document.getElementById('supplier-payment-method'); // NEW
        const supplierDueBankSelectContainer = document.getElementById('supplier-due-bank-select-container'); // NEW
        const supplierDueBankSelect = document.getElementById('supplier-due-bank-select'); // NEW

        // Customer Management Section Elements
        const addCustomerBtn = document.getElementById('add-customer-btn');
        const addCustomerFormContainer = document.getElementById('add-customer-form-container');
        const addCustomerForm = document.getElementById('add-customer-form');
        const customerListTableBody = document.querySelector('#customer-list-table tbody');
        const customerLedgerModal = document.getElementById('customer-ledger-modal');
        const printCustomerLedgerBtn = document.getElementById('print-customer-ledger-btn');
        const filterCustomerLedgerBtn = document.getElementById('filter-customer-ledger-btn');
        const customerManagementSearchInput = document.getElementById('customer-management-search-input'); // NEW REFERENCE

        // POS Section Elements
        const posCustomerPhoneInput = document.getElementById('pos-customer-phone');
        const posCustomerNameInput = document.getElementById('pos-customer-name');
        const posCustomerAddressInput = document.getElementById('pos-customer-address');
        const clearCustomerFieldsBtn = document.getElementById('clear-customer-fields');
        const posProductSearch = document.getElementById('pos-product-search');
        const searchResultsContainer = document.getElementById('search-results-container');
        const posAddToCartBtn = document.getElementById('pos-add-to-cart-btn');
        const posCartTableBody = document.querySelector('#pos-cart-table tbody');
        const cartSubtotalSpan = document.getElementById('cart-subtotal');
        const discountAmountInput = document.getElementById('discount-amount');
        const cartFinalTotalSpan = document.getElementById('cart-final-total');
        const posPaymentForm = document.getElementById('pos-payment-form');
        const paymentMethodSelect = document.getElementById('payment-method');
        const posBankSelectContainer = document.getElementById('pos-bank-select-container'); // NEW
        const posBankSelect = document.getElementById('pos-bank-select'); // NEW
        const completeSaleBtn = document.getElementById('complete-sale-btn');
        const cancelSaleEditBtn = document.getElementById('cancel-sale-edit-btn');
        const printBillBtn = document.getElementById('print-bill-btn');
        // ✅ NEW: POS customer search results
        const posCustomerPhoneSearchResults = document.getElementById('pos-customer-phone-search-results');
        const posCustomerNameSearchResults = document.getElementById('pos-customer-name-search-results');

        // Sales Report Elements (Original, unedited in this list)
        const salesReportSearchInput = document.getElementById('sales-report-search-input');
        const salesReportFromDateInput = document.getElementById('sales-report-from-date');
        const salesReportToDateInput = document.getElementById('sales-report-to-date');
        const salesReportSellerSelect = document.getElementById('sales-report-seller');
        const filterSalesReportBtn = document.getElementById('filter-sales-report');
        const salesReportTableBody = document.querySelector('#sales-report-table tbody');
        const filteredSalesTotalSpan = document.getElementById('filtered-sales-total');
        const filteredSalesProfitSpan = document.getElementById('filtered-sales-profit');
        const filteredProductsSoldSpan = document.getElementById('filtered-products-sold');
        const filteredStockValueSpan = document.getElementById('filtered-stock-value');
        const filteredTotalLossSpan = document.getElementById('filtered-total-loss');
        const printSalesSummaryBtn = document.getElementById('print-sales-summary-btn');
        const productWiseReportBtn = document.getElementById('product-wise-report-btn'); 

        // Dues Elements
        const duesSearchInput = document.getElementById('dues-search-input');
        const duesListTableBody = document.querySelector('#dues-list-table tbody');
        const totalDuesAmountSpan = document.getElementById('total-dues-amount');
        const payDueModal = document.getElementById('pay-due-modal');
        const modalDueCustomerName = document.getElementById('modal-due-customer-name');
        const modalDueTotalOutstanding = document.getElementById('modal-due-total-outstanding');
        const paymentAmountInput = document.getElementById('payment-amount');
        const paymentMethodDueSelect = document.getElementById('payment-method-due');
        const dueBankSelectContainer = document.getElementById('due-bank-select-container'); // NEW
        const dueBankSelect = document.getElementById('due-bank-select'); // NEW
        const modalDueRemaining = document.getElementById('modal-due-remaining');
        const processDuePaymentBtn = document.getElementById('process-due-payment-btn');
        const paymentReceiptSection = document.getElementById('payment-receipt-section');
        const printPaymentReceiptBtn = document.getElementById('print-payment-receipt-btn');

        // NEW Manual Due Elements (Original, unedited in this list)
        const addManualDueForm = document.getElementById('add-manual-due-form');
        const manualDueCustomerPhone = document.getElementById('manual-due-customer-phone');
        const manualDueCustomerName = document.getElementById('manual-due-customer-name');
        const manualDueCustomerAddress = document.getElementById('manual-due-customer-address');
        const manualDueAmount = document.getElementById('manual-due-amount');
        const manualDueDate = document.getElementById('manual-due-date');
        const manualDueNote = document.getElementById('manual-due-note');
        const manualDueMessage = document.getElementById('manual-due-message');


        // Returns Section Elements (Original, unedited in this list)
        const returnSaleSearchInput = document.getElementById('return-sale-search-input');
        const searchSaleForReturnBtn = document.getElementById('search-sale-for-return');
        const returnSearchResults = document.getElementById('return-search-results');
        const returnSearchResultsTableBody = document.querySelector('#return-search-results-table tbody');
        const noReturnSearchResults = document.getElementById('no-return-search-results');

        const returnDetailsContainer = document.getElementById('return-details-container');
        const returnSaleIdDisplay = document.getElementById('return-sale-id-display');
        const returnCustomerDisplay = document.getElementById('return-customer-display');
        const returnSaleTotalDisplay = document.getElementById('return-sale-total-display');
        const returnItemsTableBody = document.querySelector('#return-items-table tbody');
        const refundableAmountSpan = document.getElementById('refundable-amount');
        const processReturnBtn = document.getElementById('process-return-btn');
        const returnSuccessMessage = document.getElementById('return-success-message');
        const displayReturnId = document.getElementById('display-return-id');
        const printReturnBillBtn = document.getElementById('print-return-bill-btn');

        // Ledger Section Elements (Now Cash Ledger)
        const cashLedgerBalanceSpan = document.getElementById('cash-ledger-balance'); // NEW ID
        const totalCashInSpan = document.getElementById('total-cash-in'); // NEW ID
        const totalCashOutSpan = document.getElementById('total-cash-out'); // NEW ID
        // const totalOtherIncomeSpan = document.getElementById('total-other-income'); // OLD ID
        // const totalExpensesSpan = document.getElementById('total-expenses'); // OLD ID
        // const netLedgerBalanceSpan = document.getElementById('net-ledger-balance'); // OLD ID
        const addLedgerEntryForm = document.getElementById('add-ledger-entry-form');
        const ledgerTypeSelect = document.getElementById('ledger-type');
        const ledgerCategorySelect = document.getElementById('ledger-category');
        const addLedgerCategoryBtn = document.getElementById('add-ledger-category-btn');
        const ledgerDescriptionInput = document.getElementById('ledger-description');
        const ledgerAmountInput = document.getElementById('ledger-amount');
        const ledgerDateInput = document.getElementById('ledger-date');
        const ledgerFilterFromDateInput = document.getElementById('ledger-filter-from-date');
        const ledgerFilterToDateInput = document.getElementById('ledger-filter-to-date');
        const ledgerFilterTypeSelect = document.getElementById('ledger-filter-type');
        const ledgerFilterCategorySelect = document.getElementById('ledger-filter-category');
        const filterLedgerBtn = document.getElementById('filter-ledger');
        const printLedgerBtn = document.getElementById('print-ledger');
        const deleteAllLedgerBtn = document.getElementById('delete-all-ledger');
        const ledgerTableBody = document.querySelector('#ledger-table tbody');

        // Customer Data Elements (Original, unedited in this list)
        const customerSearchInput = document.getElementById('customer-search-input');
        const searchCustomerDataBtn = document.getElementById('search-customer-data-btn');
        const customerSearchResultsDiv = document.getElementById('customer-search-results');
        const customerSearchResultsTableBody = document.getElementById('customer-search-results-table-body');
        const noCustomerSearchResults = document.getElementById('no-customer-search-results');
        const customerPurchaseHistoryDetails = document.getElementById('customer-purchase-history-details');
        const customerHistoryName = document.getElementById('customer-history-name');
        const customerHistoryPhone = document.getElementById('customer-history-phone');
        const customerHistoryTotalSales = document.getElementById('customer-history-total-sales');
        const customerHistoryTotalProducts = document.getElementById('customer-history-total-products');
        const printCustomerHistoryBtn = document.getElementById('print-customer-history-btn');
        const customerHistoryTableBody = document.getElementById('customer-history-table-body');
        const customerReturnsHistoryTable = document.getElementById('customer-returns-history-table');
        const customerReturnsHistoryTableBody = document.querySelector('#customer-returns-history-table tbody');
        const customerReturnsHistoryMessage = document.getElementById('customer-returns-history-message');


        // User Management Elements (Original, unedited in this list)
        const addUserBtn = document.getElementById('add-user-btn');
        const addUserFormContainer = document.getElementById('add-user-form-container');
        const addUserForm = document.getElementById('add-user-form');
        const userListTableBody = document.querySelector('#user-list-table tbody');
        const newUserDisplayNameInput = document.getElementById('new-user-display-name');
        const newUserProfileImageInput = document.getElementById('new-user-profile-image');

        // Settings Elements (Original, unedited in this list)
        const shopInfoForm = document.getElementById('shop-info-form');
        const resetAllDataBtn = document.getElementById('reset-all-data-btn');
        
        // Subscription and Data Management Elements (Original, unedited in this list)
        const backupDataBtn = document.getElementById('backup-data-btn');
        const importDataInput = document.getElementById('import-data-input');
        const importDataBtn = document.getElementById('import-data-btn');
        const backupStatus = document.getElementById('backup-status');
        const importStatus = document.getElementById('import-status');

        const subscriptionEndDateDisplay = document.getElementById('subscription-end-date');
        const subscriptionStatusDisplay = document.getElementById('subscription-status');
        const subscriptionMessage = document.getElementById('subscription-message');
        
        // Subscription Date Modification Elements (NEW - replaces old extend system)
        const subscriptionModifyPasswordInput = document.getElementById('subscription-modify-password');
        const subscriptionNewEndDateInput = document.getElementById('subscription-new-end-date');
        const updateSubscriptionDateBtn = document.getElementById('update-subscription-date-btn');
        const extendSubscriptionQuickBtn = document.getElementById('extend-subscription-quick-btn');
        
        // Subscription Level Elements (NEW)
        const currentSubscriptionLevelDisplay = document.getElementById('current-subscription-level');
        const subscriptionLevelPasswordInput = document.getElementById('subscription-level-password');
        const subscriptionLevelSelect = document.getElementById('subscription-level-select');
        const updateSubscriptionLevelBtn = document.getElementById('update-subscription-level-btn');
        const subscriptionLevelMessage = document.getElementById('subscription-level-message');
        
        // 4. Sales Report - Product Wise/Granular (NEW) (Original, unedited in this list)
        const granularReportFromDateInput = document.getElementById('granular-report-from-date');
        const granularReportToDateInput = document.getElementById('granular-report-to-date');
        
        // Print Settings Fields (NEW) (Original, unedited in this list)
        const shopPhoneCellInput = document.getElementById('shop-phone-cell');
        const shopVatRegInput = document.getElementById('shop-vat-reg');
        
        // NEW Bank/Finance Elements
        const addBankForm = document.getElementById('add-bank-form');
        const bankListTableBody = document.querySelector('#bank-list-table tbody');
        const bankNameInput = document.getElementById('bank-name');
        const bankAccountNoInput = document.getElementById('bank-account-no');
        const bankOpeningBalanceInput = document.getElementById('bank-opening-balance');
        const cancelBankEntryBtn = document.getElementById('cancel-bank-entry');
        
        const withdrawalBankSelect = document.getElementById('withdrawal-bank-select');
        const withdrawalAmountInput = document.getElementById('withdrawal-amount');
        const withdrawalNoteInput = document.getElementById('withdrawal-note');
        const bankWithdrawalExpenseForm = document.getElementById('bank-withdrawal-expense-form');
        
        const transferBankSelect = document.getElementById('transfer-bank-select');
        const transferAmountInput = document.getElementById('transfer-amount');
        const transferNoteInput = document.getElementById('transfer-note');
        const bankToCashTransferForm = document.getElementById('bank-to-cash-transfer-form');
        
        const bankTxFromDateInput = document.getElementById('bank-tx-from-date');
        const bankTxToDateInput = document.getElementById('bank-tx-to-date');
        const bankTxFilterBankSelect = document.getElementById('bank-tx-filter-bank');
        const bankTxFilterTypeSelect = document.getElementById('bank-tx-filter-type');
        const filterBankTxBtn = document.getElementById('filter-bank-tx');
        const printBankTxBtn = document.getElementById('print-bank-tx');
        const bankTransactionTableBody = document.querySelector('#bank-transaction-table tbody');
        
        // NEW Expense Report Elements
        const expenseReportFromDateInput = document.getElementById('expense-report-from-date');
        const expenseReportToDateInput = document.getElementById('expense-report-to-date');
        const expenseReportCategorySelect = document.getElementById('expense-report-category');
        const filterExpenseReportBtn = document.getElementById('filter-expense-report');
        const printExpenseReportBtn = document.getElementById('print-expense-report');
        const expenseReportTableBody = document.querySelector('#expense-report-table tbody');
        const totalCashExpenseSpan = document.getElementById('total-cash-expense');
        const totalBankExpenseSpan = document.getElementById('total-bank-expense');
        const totalGrandExpenseSpan = document.getElementById('total-grand-expense');

        // --- Helper Functions (Original) ---
        function showMessage(element, message, isSuccess = true) {
            element.textContent = message;
            element.style.color = isSuccess ? '#22c55e' : '#ef4444';
            setTimeout(() => {
                element.textContent = '';
            }, 3000);
        }
        
        function resetPOSPage() {
            currentCart = [];
            currentEditingSale = null;
            posPaymentForm.reset();
            discountAmountInput.value = 0;
            posCustomerNameInput.value = '';
            posCustomerPhoneInput.value = '';
            posCustomerAddressInput.value = '';
            posProductSearch.value = '';
            printBillBtn.style.display = 'none';
            completeSaleBtn.innerHTML = '<i class="fas fa-check-circle"></i> বিক্রয় সম্পন্ন করুন';
            completeSaleBtn.dataset.editing = 'false';
            cancelSaleEditBtn.style.display = 'none';
            // NEW: Hide bank selection by default
            posBankSelectContainer.style.display = 'none'; 
            renderCart();
            updateCartTotal();
        }

        async function showSection(sectionId) {
            // 3. Save last active section to localStorage (NEW)
            try {
                if (sectionId) {
                     localStorage.setItem('lastActiveSection', sectionId);
                }
            } catch(e) { /* ignore */ }


            // Close all modals before switching sections to avoid the popup issue
            document.querySelectorAll('.modal').forEach(modal => {
                modal.style.display = 'none';
            });
            
            if (currentEditingSale && sectionId !== 'pos' && sectionId !== 'sales') { // Allow switching to sales for immediate check
                if (confirm('আপনি বিক্রয় সম্পাদনা বাতিল করতে চান? কোনো পরিবর্তন সেভ হবে না।')) {
                    resetPOSPage();
                } else {
                    return; 
                }
            }
            
            document.querySelectorAll('.app-section').forEach(section => {
                section.style.display = 'none';
                section.classList.remove('active');
            });
            document.getElementById(`${sectionId}-section`).style.display = 'block';
            document.getElementById(`${sectionId}-section`).classList.add('active');

            document.querySelectorAll('nav ul li a').forEach(link => {
                link.classList.remove('active');
            });
            const activeLink = document.querySelector(`nav ul li a[data-section="${sectionId}"]`);
            if (activeLink) {
                activeLink.classList.add('active');
            }

            const sectionTitleMap = {
                'dashboard': 'ড্যাশবোর্ড',
                'products': 'পণ্যসমূহ',
                'suppliers': 'সাপ্লায়ার',
                'pos': 'বিক্রয় (POS)',
                'sales': 'বিক্রয় রিপোর্ট',
                'dues': 'কাস্টমার বাকি',
                'manual-dues': 'ম্যানুয়াল বাকি এন্ট্রি', 
                'returns': 'ফেরত পণ্য',
                'ledger': 'Cash Ledger', // UPDATED
                'finance': 'Bank Module', // NEW
                'expenses': 'Expense Report', // NEW
                'customer-data': 'কাস্টমার ডেটা',
                'customer-management': 'কাস্টমার ব্যবস্থাপনা',
                'users': 'ব্যবহারকারী',
                'settings': 'সেটিংস',
                'granular-reports': 'উন্নত রিপোর্ট',
                'daily-transaction': 'Daily Transaction Report'
            };
            currentSectionTitle.textContent = sectionTitleMap[sectionId] || 'MY POS SOF';

            if (sectionId === 'dashboard') {
                // Modified function wrapper (See END OF FILE) will execute the new dashboard calls
                await renderDashboard(); 
            } else if (sectionId === 'products') {
                renderProductList();
                populateCategoryFilter();
                populateSupplierDatalist();
            } else if (sectionId === 'suppliers') {
                renderSupplierList();
            } else if (sectionId === 'pos') {
                if (!currentEditingSale) {
                    resetPOSPage();
                }
                populateBankSelectors(); // NEW
            } else if (sectionId === 'sales') {
                const today = new Date().toISOString().split('T')[0];
                salesReportFromDateInput.value = today;
                salesReportToDateInput.value = today;
                salesReportSearchInput.value = '';
                renderSalesReport();
                populateSellerFilter();
            } else if (sectionId === 'granular-reports') { 
                renderGranularReport(); 
                document.getElementById('product-report-from-date').value = salesReportFromDateInput.value;
                document.getElementById('product-report-to-date').value = salesReportToDateInput.value;
            }
             else if (sectionId === 'dues') {
                duesSearchInput.value = '';
                renderDuesList(); 
                populateBankSelectors(); // NEW
            } else if (sectionId === 'manual-dues') { 
                const today = new Date().toISOString().split('T')[0];
                manualDueDate.value = today;
                manualDuesSection.querySelectorAll('input').forEach(i => i.value = '');
                manualDuesSection.querySelector('textarea').value = '';
                manualDueCustomerName.disabled = true;
                manualDueCustomerAddress.disabled = true;
                manualDueMessage.textContent = '';
                
            } else if (sectionId === 'returns') {
                returnDetailsContainer.style.display = 'none';
                returnSaleSearchInput.value = '';
                returnSearchResults.style.display = 'none';
                returnSuccessMessage.style.display = 'none';
            } else if (sectionId === 'ledger') { // Cash Ledger
                const today = new Date().toISOString().split('T')[0];
                ledgerDateInput.value = today;
                ledgerFilterFromDateInput.value = '';
                ledgerFilterToDateInput.value = '';
                ledgerFilterTypeSelect.value = '';
                ledgerFilterCategorySelect.value = '';
                updateLedgerCategoryDropdown('Cash');
                renderLedger();
            } else if (sectionId === 'finance') { // NEW Bank Module
                renderBankList();
                populateBankSelectors();
                renderBankTransactions();
                bankTxFromDateInput.value = moment().startOf('month').format('YYYY-MM-DD');
                bankTxToDateInput.value = moment().format('YYYY-MM-DD');
            } else if (sectionId === 'expenses') { // NEW Expense Report
                 renderExpenseReport();
                 populateExpenseReportCategoryFilter();
            } else if (sectionId === 'customer-data') {
                customerSearchInput.value = '';
                customerSearchResultsDiv.style.display = 'none';
                customerPurchaseHistoryDetails.style.display = 'none';
            } else if(sectionId === 'customer-management') {
                customerManagementSearchInput.value = '';
                renderCustomerList();
            } else if (sectionId === 'users') {
                renderUserList();
            } else if (sectionId === 'daily-transaction') {
                // ✅ NEW: Daily Transaction Report Section
                const today = new Date().toISOString().split('T')[0];
                dailyReportType.value = 'today';
                dailyReportSpecificDate.value = today;
                dailyReportFromDate.value = today;
                dailyReportToDate.value = today;
                specificDateContainer.style.display = 'none';
                fromDateContainer.style.display = 'none';
                toDateContainer.style.display = 'none';
                dailyReportDisplay.style.display = 'none';
            } else if (sectionId === 'settings') {
                updateSubscriptionDisplay();
            }
        }

        function updateShopTitle(name) {
            document.getElementById('sidebar-app-title').textContent = name;
            document.title = name;
        }

        function updateDashboardSummary() {
            const today = new Date();
            const todaySales = sales.filter(transaction => {
                const transactionDate = new Date(transaction.timestamp);
                return transactionDate.getDate() === today.getDate() &&
                       transactionDate.getMonth() === today.getMonth() &&
                       transactionDate.getFullYear() === today.getFullYear() &&
                       transaction.type === 'sale' &&
                       transaction.status !== 'বাতিল'; // Exclude deleted bills
            }).reduce((sum, sale) => sum + sale.finalAmount, 0);

            const todayReturns = sales.filter(transaction => {
                const transactionDate = new Date(transaction.timestamp);
                return transactionDate.getDate() === today.getDate() &&
                       transactionDate.getMonth() === today.getMonth() &&
                       transactionDate.getFullYear() === today.getFullYear() &&
                       transaction.type === 'return' &&
                       transaction.status !== 'বাতিল'; // Exclude deleted bills
            }).reduce((sum, returnTransaction) => sum + returnTransaction.finalAmount, 0);

            document.getElementById('today-total-sales').textContent = `৳ ${(todaySales + todayReturns).toLocaleString()}`;


            let totalStock = products.reduce((sum, p) => sum + p.stock, 0);
            document.getElementById('total-stock-items').textContent = totalStock;

            const totalDuesAmount = dues.reduce((sum, due) => sum + due.remainingAmount, 0);
            document.getElementById('total-dues').textContent = `৳ ${totalDuesAmount.toLocaleString()}`;
            
            const totalSupplierDuesAmount = suppliers.reduce((sum, s) => sum + (s.currentDue || 0), 0);
            document.getElementById('total-supplier-dues').textContent = `৳ ${totalSupplierDuesAmount.toLocaleString()}`;
            
            // NEW: Cash / Bank Summary
            const totalCashIn = ledgerEntries.filter(e => e.type === 'income').reduce((sum, e) => sum + e.amount, 0);
            const totalCashOut = ledgerEntries.filter(e => e.type === 'expense').reduce((sum, e) => sum + e.amount, 0);
            const cashBalance = totalCashIn - totalCashOut;
            document.getElementById('total-cash-balance').textContent = `৳ ${cashBalance.toLocaleString()}`;
            
            const totalBankBalance = banks.reduce((sum, b) => sum + (b.currentBalance || 0), 0);
            document.getElementById('total-bank-balance').textContent = `৳ ${totalBankBalance.toLocaleString()}`;
            
            const thisMonthStart = moment().startOf('month');
            const thisMonthEnd = moment().endOf('month');
            const thisMonthExpense = ledgerEntries.filter(e => 
                 e.type === 'expense' &&
                 moment(e.timestamp).isSameOrAfter(thisMonthStart) && 
                 moment(e.timestamp).isSameOrBefore(thisMonthEnd)
            ).reduce((sum, e) => sum + e.amount, 0);
             // Also count bank withdrawal expense for current month
             const thisMonthBankExpense = bankTransactions.filter(t => 
                 t.type === 'debit' && t.category === 'bank_withdrawal_expense' &&
                 moment(t.timestamp).isSameOrAfter(thisMonthStart) && 
                 moment(t.timestamp).isSameOrBefore(thisMonthEnd)
             ).reduce((sum, t) => sum + t.amount, 0);
             document.getElementById('current-month-total-expense').textContent = `৳ ${(thisMonthExpense + thisMonthBankExpense).toLocaleString()}`;
        }

        function renderRecentActivities() {
            const recentActivitiesList = document.getElementById('recent-activities-list');
            recentActivitiesList.innerHTML = '';
            
            const allTransactions = [...sales].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).slice(0, 5);

            if (allTransactions.length === 0) {
                recentActivitiesList.innerHTML = '<p>কোনো সাম্প্রতিক কার্যক্রম নেই।</p>';
                return;
            }

            allTransactions.forEach(t => {
                let activityText = '';
                let timeAgo = typeof moment !== 'undefined' ? moment(t.timestamp).fromNow() : new Date(t.timestamp).toLocaleDateString();

                if (t.type === 'sale') {
                    activityText = `নতুন বিক্রি #${t.saleId} - ${t.items[0]?.name || 'পণ্য'}`;
                } else if (t.type === 'return') {
                    activityText = `ফেরত - ${t.items[0]?.name || 'পণ্য'}`;
                }

                if (currentUser && currentUser.role === 'seller' && t.sellerId !== currentUser.id) {
                    return;
                }

                const activityItem = document.createElement('div');
                activityItem.className = 'activity-item';
                activityItem.innerHTML = `
                    <span>${activityText}</span>
                    <span>${timeAgo}</span>
                `;
                recentActivitiesList.appendChild(activityItem);
            });
        }
        
        // --- START WRAPPER/MODULE FUNCTION (Must exist exactly like this in old code for internal functions)
        window.renderDashboard = async function() { 
             updateDashboardSummary();
             renderRecentActivities();
             // NEW: Add Stock/Forecast (functions defined later in separate module block, but called here)
             renderStockAlerts();
             calculateAndRenderForecast();
         }
        // --- END WRAPPER/MODULE FUNCTION ---


        // --- Login and Role Management (Original) ---
        function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            const user = users.find(u => u.username === username && u.password === password);

            if (user) {
                currentUser = user;
                // 2. Session Persistence: Save session on successful login
                try {
                    localStorage.setItem('currentUser', JSON.stringify(user));
                } catch(e) { /* ignore */ }
                
                if (!checkSubscription() && user.role !== 'admin') {
                    showMessage(loginErrorMessage, 'সাবস্ক্রিপশনের মেয়াদ শেষ হয়েছে! অনুগ্রহ করে মেয়াদ বাড়ান।', false);
                    loginContainer.style.display = 'none';
                    appContainer.style.display = 'flex';
                    updateUserProfileDisplay();
                    showSection('settings');
                } else {
                    loginContainer.style.display = 'none';
                    appContainer.style.display = 'flex';
                    updateUserProfileDisplay();
                    renderAppBasedOnRole(user.role);
                    showSection('dashboard');
                    updateShopTitle(shopSettings.name);
                }
            } else {
                showMessage(loginErrorMessage, 'ভুল ইউজারনেম বা পাসওয়ার্ড।', false);
            }
        }

        function renderAppBasedOnRole(role) {
            document.querySelectorAll('nav ul li').forEach(li => li.style.display = 'none');

            document.getElementById('nav-dashboard').style.display = 'list-item';
            document.getElementById('nav-pos').style.display = 'list-item';
            document.getElementById('nav-products').style.display = 'list-item';
            document.getElementById('nav-suppliers').style.display = 'list-item';
            document.getElementById('nav-sales').style.display = 'list-item';
            document.getElementById('nav-dues').style.display = 'list-item';
            document.getElementById('nav-manual-dues').style.display = 'list-item'; 
            document.getElementById('nav-returns').style.display = 'list-item';
            document.getElementById('nav-ledger').style.display = 'list-item'; // Cash Ledger
            document.getElementById('nav-finance').style.display = 'list-item'; // NEW Bank
            document.getElementById('nav-expenses').style.display = 'list-item'; // NEW Expenses
            document.getElementById('nav-customer-data').style.display = 'list-item';
            document.getElementById('nav-customer-management').style.display = 'list-item';
            document.getElementById('nav-granular-reports').style.display = 'list-item'; 
            document.getElementById('nav-daily-transaction').style.display = 'list-item'; // ✅ NEW: Daily Transaction Report
            document.getElementById('nav-settings').style.display = 'list-item';

            if (role === 'admin') {
                document.getElementById('nav-users').style.display = 'list-item';
                document.getElementById('add-product-btn').style.display = 'inline-block';
            } else if (role === 'seller') {
                document.getElementById('nav-users').style.display = 'none';
                document.getElementById('add-product-btn').style.display = 'none';
                 // Hide Manual Due Entry/Bank/Expense for sellers for safety
                 document.getElementById('nav-manual-dues').style.display = 'none';
                 document.getElementById('nav-finance').style.display = 'none';
                 document.getElementById('nav-expenses').style.display = 'none';
                 document.getElementById('nav-ledger').style.display = 'none';
            }
            checkSubscription();
        }

        function updateUserProfileDisplay() {
            if (currentUser) {
                const hour = new Date().getHours();
                let greeting = '';
                if (hour < 12) {
                    greeting = 'শুভ সকাল,';
                } else if (hour < 18) {
                    greeting = 'শুভ বিকাল,';
                } else {
                    greeting = 'শুভ সন্ধ্যা,';
                }
                greetingText.textContent = greeting;
                currentUserDisplayName.textContent = currentUser.displayName || currentUser.username;
                profileImg.src = currentUser.profileImage || 'https://img.icons8.com/officel/80/null/user.png';
            }
        }

        async function handleLogout() {
            currentUser = null;
            // 2. Session Persistence: Clear session on logout
            try {
                 localStorage.removeItem('currentUser');
                 localStorage.removeItem('lastActiveSection');
            } catch(e) { /* ignore */ }
            
            loginContainer.style.display = 'block';
            appContainer.style.display = 'none';
            loginForm.reset();
            loginErrorMessage.textContent = '';
            await initializeData();
            checkSubscription();
        }

        // --- Product Management (Original) ---
        // পণ্য সার্চ ফাংশন আপডেট করা হয়েছে
        function renderProductList(filterText = '', categoryFilter = '') {
            productList.innerHTML = '';
            let filteredProducts = products;

            if (filterText) {
                const lowerFilterText = filterText.toLowerCase();
                filteredProducts = filteredProducts.filter(p =>
                    p.name.toLowerCase().includes(lowerFilterText) || 
                    p.id.toLowerCase().includes(lowerFilterText) ||
                    (p.serialNumber && p.serialNumber.toLowerCase().includes(lowerFilterText)) // SN search
                );
            }

            if (categoryFilter) {
                filteredProducts = filteredProducts.filter(p => p.category === categoryFilter);
            }

            if (filteredProducts.length === 0) {
                productList.innerHTML = '<p>কোনো পণ্য খুঁজে পাওয়া যায়নি।</p>';
                return;
            }

            filteredProducts.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                
                const minStock = product.minStock || window.SALES_FORECAST_CONFIG.PRODUCT_MIN_STOCK_DEFAULT;
                const stockWarning = product.stock <= minStock ? `style="color: #dc3545; font-weight: bold;"` : '';
                
                productCard.innerHTML = `
                    <img src="${product.imageUrl || 'https://via.placeholder.com/150?text=No+Image'}" alt="${product.name}">
                    <h3>${product.name}</h3>
                    <p>ক্যাটাগরি: ${product.category || 'N/A'}</p>
                    <p>S/N: <strong>${product.serialNumber || 'N/A'}</strong></p>
                    <p>সাপ্লায়ার: ${product.supplierName || 'N/A'}</p>
                    <p>ক্রয় মূল্য: ৳ ${product.purchasePrice?.toLocaleString() || 'N/A'}</p>
                    <p>বিক্রয় মূল্য: ৳ ${product.price.toLocaleString()}</p>
                    <p class="stock-info" ${stockWarning}>স্টক: ${product.stock} ${product.unit || ''} (Min: ${minStock})</p>
                    <div class="table-action-buttons">
                        <button data-id="${product.id}" class="edit-product-btn edit-btn"><i class="fas fa-edit"></i> সম্পাদনা</button>
                    </div>
                    <div class="print-actions">
                        <input type="number" value="1" min="1" max="${product.stock || 1}" style="width: 50px;" class="print-qty-input">
                        <button data-id="${product.id}" class="print-label-btn info-btn" title="বারকোড লেবেল প্রিন্ট করুন"><i class="fas fa-barcode"></i> প্রিন্ট</button>
                    </div>
                    <div class="table-action-buttons">
                        <button data-id="${product.id}" class="delete-product-btn danger-btn"><i class="fas fa-trash-alt"></i> মুছুন</button>
                    </div>
                `;
                productList.appendChild(productCard);

                if (!currentUser || currentUser.role !== 'admin') {
                    productCard.querySelector('.delete-product-btn').style.display = 'none';
                    // Allow non-admin to edit, but restricted to certain fields if needed.
                }
            });

            document.querySelectorAll('.edit-product-btn').forEach(button => {
                button.addEventListener('click', (e) => editProduct(e.target.dataset.id));
            });
            document.querySelectorAll('.product-card').forEach(card => {
                const printBtn = card.querySelector('.print-label-btn');
                printBtn.addEventListener('click', (e) => {
                    const productId = e.currentTarget.dataset.id;
                    const quantityInput = e.currentTarget.parentNode.querySelector('.print-qty-input');
                    const quantity = parseInt(quantityInput.value) || 1;
                    printBarcodeLabel(productId, quantity); // Pass quantity
                });
            });
            document.querySelectorAll('.delete-product-btn').forEach(button => {
                button.addEventListener('click', (e) => deleteProduct(e.target.dataset.id));
            });
        }

        function populateCategoryFilter() {
            const categories = [...new Set(products.map(p => p.category).filter(Boolean))];
            productCategoryFilter.innerHTML = '<option value="">সকল ক্যাটাগরি</option>';
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                productCategoryFilter.appendChild(option);
            });
        }

        // ✅ NEW: All Products Stock Report Functions
        const stockReportFromDate = document.getElementById('stock-report-from-date');
        const stockReportToDate = document.getElementById('stock-report-to-date');
        const generateStockReportBtn = document.getElementById('generate-stock-report-btn');
        const printStockSummaryBtn = document.getElementById('print-stock-summary-btn');
        const printStockMovementBtn = document.getElementById('print-stock-movement-btn');
        const clearStockReportBtn = document.getElementById('clear-stock-report-btn');
        const stockReportDisplay = document.getElementById('stock-report-display');
        const stockReportTbody = document.getElementById('stock-report-tbody');

        // Generate Stock Report
        generateStockReportBtn.addEventListener('click', () => {
            const fromDate = stockReportFromDate.value;
            const toDate = stockReportToDate.value;

            if (products.length === 0) {
                alert('কোনো পণ্য পাওয়া যায়নি।');
                return;
            }

            let grandTotalStockIn = 0;
            let grandTotalStockOut = 0;
            let grandTotalCurrentStock = 0;

            // Process each product
            const productData = products.map((product, index) => {
                // Calculate stock in (from purchases/ledger entries)
                let stockIn = 0;
                let stockOut = 0;

                // Get stock movements from ledger entries (product_purchase category)
                const productLedger = ledgerEntries.filter(l => 
                    l.productId === product.id && l.category === 'product_purchase'
                );

                // Filter by date if provided
                let filteredLedger = productLedger;
                if (fromDate) {
                    const fromDateObj = new Date(fromDate);
                    fromDateObj.setHours(0, 0, 0, 0);
                    filteredLedger = filteredLedger.filter(l => new Date(l.timestamp) >= fromDateObj);
                }
                if (toDate) {
                    const toDateObj = new Date(toDate);
                    toDateObj.setHours(23, 59, 59, 999);
                    filteredLedger = filteredLedger.filter(l => new Date(l.timestamp) <= toDateObj);
                }

                // Stock in from purchases
                stockIn = filteredLedger.reduce((sum, l) => sum + (l.quantity || 0), 0);

                // Stock out from sales
                const productSales = sales.filter(s => {
                    const saleDate = new Date(s.timestamp);
                    const matchesDate = (!fromDate || saleDate >= new Date(fromDate).setHours(0,0,0,0)) &&
                                       (!toDate || saleDate <= new Date(toDate).setHours(23,59,59,999));
                    return matchesDate && s.items && s.items.some(item => item.productId === product.id);
                });

                stockOut = productSales.reduce((sum, s) => {
                    const items = s.items.filter(item => item.productId === product.id);
                    return sum + items.reduce((itemSum, item) => itemSum + (item.quantity || 0), 0);
                }, 0);

                const currentStock = product.stock || 0;

                grandTotalStockIn += stockIn;
                grandTotalStockOut += stockOut;
                grandTotalCurrentStock += currentStock;

                return {
                    index: index + 1,
                    name: product.name,
                    category: product.category || 'Uncategorized',
                    stockIn: stockIn,
                    stockOut: stockOut,
                    currentStock: currentStock,
                    minStock: product.minStock || 5
                };
            });

            // Sort by current stock (lowest first - for stock alert priority)
            productData.sort((a, b) => a.currentStock - b.currentStock);

            // Update summary cards
            document.getElementById('stock-report-total-products').textContent = products.length.toLocaleString();
            document.getElementById('stock-report-total-in').textContent = grandTotalStockIn.toLocaleString();
            document.getElementById('stock-report-total-out').textContent = grandTotalStockOut.toLocaleString();
            document.getElementById('stock-report-current-total').textContent = grandTotalCurrentStock.toLocaleString();

            // Update footer totals
            document.getElementById('stock-report-footer-in').textContent = grandTotalStockIn.toLocaleString();
            document.getElementById('stock-report-footer-out').textContent = grandTotalStockOut.toLocaleString();
            document.getElementById('stock-report-footer-current').textContent = grandTotalCurrentStock.toLocaleString();

            // Render table
            stockReportTbody.innerHTML = '';
            if (productData.length === 0) {
                document.getElementById('stock-report-empty').style.display = 'block';
                document.getElementById('stock-report-table').style.display = 'none';
            } else {
                document.getElementById('stock-report-empty').style.display = 'none';
                document.getElementById('stock-report-table').style.display = 'table';

                productData.forEach(data => {
                    const row = stockReportTbody.insertRow();
                    row.insertCell(0).textContent = data.index;
                    row.insertCell(1).textContent = data.name;
                    row.insertCell(2).textContent = data.category;
                    
                    const stockInCell = row.insertCell(3);
                    stockInCell.textContent = data.stockIn.toLocaleString();
                    stockInCell.style.textAlign = 'right';
                    stockInCell.style.color = '#34d399';
                    
                    const stockOutCell = row.insertCell(4);
                    stockOutCell.textContent = data.stockOut.toLocaleString();
                    stockOutCell.style.textAlign = 'right';
                    stockOutCell.style.color = '#fbbf24';
                    
                    const currentStockCell = row.insertCell(5);
                    currentStockCell.textContent = data.currentStock.toLocaleString();
                    currentStockCell.style.textAlign = 'right';
                    currentStockCell.style.fontWeight = 'bold';
                    
                    const statusCell = row.insertCell(6);
                    statusCell.style.textAlign = 'center';
                    if (data.currentStock <= 0) {
                        statusCell.innerHTML = '<span style="background: rgba(239, 68, 68, 0.3); color: #f87171; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold;">স্টক শূন্য</span>';
                        currentStockCell.style.color = '#f87171';
                    } else if (data.currentStock <= data.minStock) {
                        statusCell.innerHTML = '<span style="background: rgba(245, 158, 11, 0.3); color: #fbbf24; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold;">কম স্টক</span>';
                        currentStockCell.style.color = '#fbbf24';
                    } else {
                        statusCell.innerHTML = '<span style="background: rgba(16, 185, 129, 0.3); color: #34d399; padding: 4px 8px; border-radius: 4px; font-size: 12px;">স্বাভাবিক</span>';
                        currentStockCell.style.color = '#34d399';
                    }
                });
            }

            // Show report
            stockReportDisplay.style.display = 'block';
        });

        // Clear Stock Report
        clearStockReportBtn.addEventListener('click', () => {
            stockReportFromDate.value = '';
            stockReportToDate.value = '';
            stockReportDisplay.style.display = 'none';
        });

        // Print Stock Summary
        printStockSummaryBtn.addEventListener('click', () => {
            if (stockReportDisplay.style.display === 'none') {
                alert('অনুগ্রহ করে প্রথমে স্টক রিপোর্ট জেনারেট করুন।');
                return;
            }

            const fromDate = stockReportFromDate.value;
            const toDate = stockReportToDate.value;

            const logoHtml = shopSettings.logoUrl ? `<div style="text-align: center; margin-bottom: 10px;"><img src="${shopSettings.logoUrl}" alt="Logo" style="max-height: 60px; max-width: 150px;"></div>` : '';
            
            let dateRangeText = '';
            if (fromDate && toDate) {
                dateRangeText = `<p style="text-align: center; font-size: 14px; margin: 5px 0;">তারিখ: ${new Date(fromDate).toLocaleDateString('bn-BD')} থেকে ${new Date(toDate).toLocaleDateString('bn-BD')}</p>`;
            } else if (fromDate) {
                dateRangeText = `<p style="text-align: center; font-size: 14px; margin: 5px 0;">তারিখ: ${new Date(fromDate).toLocaleDateString('bn-BD')} থেকে বর্তমান</p>`;
            } else if (toDate) {
                dateRangeText = `<p style="text-align: center; font-size: 14px; margin: 5px 0;">শুরু থেকে ${new Date(toDate).toLocaleDateString('bn-BD')} পর্যন্ত</p>`;
            }

            const printContent = `
                <div style="font-family: 'Noto Sans Bengali', Arial, sans-serif; padding: 20px;">
                    ${logoHtml}
                    <h2 style="text-align: center; margin: 10px 0;">${shopSettings.name || 'দোকান'}</h2>
                    <p style="text-align: center; font-size: 14px; margin: 5px 0;">${shopSettings.address || ''}</p>
                    <hr style="margin: 15px 0; border: 1px solid #ddd;">
                    <h3 style="text-align: center; margin: 10px 0;">স্টক সারাংশ রিপোর্ট</h3>
                    ${dateRangeText}
                    <hr style="margin: 15px 0; border: 1px solid #ddd;">
                    
                    <div style="display: flex; justify-content: space-between; margin-bottom: 20px; text-align: center;">
                        <div style="flex: 1; padding: 10px; border: 2px solid #3b82f6; margin: 0 5px; border-radius: 5px;">
                            <div style="font-size: 12px; color: #666;">মোট পণ্য</div>
                            <div style="font-size: 18px; font-weight: bold; color: #3b82f6;">${document.getElementById('stock-report-total-products').textContent}</div>
                        </div>
                        <div style="flex: 1; padding: 10px; border: 2px solid #10b981; margin: 0 5px; border-radius: 5px;">
                            <div style="font-size: 12px; color: #666;">মোট স্টক ঢুকেছে</div>
                            <div style="font-size: 18px; font-weight: bold; color: #10b981;">${document.getElementById('stock-report-total-in').textContent}</div>
                        </div>
                        <div style="flex: 1; padding: 10px; border: 2px solid #f59e0b; margin: 0 5px; border-radius: 5px;">
                            <div style="font-size: 12px; color: #666;">মোট স্টক বের হয়েছে</div>
                            <div style="font-size: 18px; font-weight: bold; color: #f59e0b;">${document.getElementById('stock-report-total-out').textContent}</div>
                        </div>
                        <div style="flex: 1; padding: 10px; border: 2px solid #8b5cf6; margin: 0 5px; border-radius: 5px;">
                            <div style="font-size: 12px; color: #666;">বর্তমান মোট স্টক</div>
                            <div style="font-size: 18px; font-weight: bold; color: #8b5cf6;">${document.getElementById('stock-report-current-total').textContent}</div>
                        </div>
                    </div>

                    <h4 style="margin: 15px 0 10px 0;">সব পণ্যের স্টক সারাংশ</h4>
                    <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                        <thead>
                            <tr style="background: #f3f4f6;">
                                <th style="padding: 6px; border: 1px solid #ddd; text-align: left;">#</th>
                                <th style="padding: 6px; border: 1px solid #ddd; text-align: left;">পণ্যের নাম</th>
                                <th style="padding: 6px; border: 1px solid #ddd; text-align: left;">ক্যাটাগরি</th>
                                <th style="padding: 6px; border: 1px solid #ddd; text-align: right;">স্টক ঢুকেছে</th>
                                <th style="padding: 6px; border: 1px solid #ddd; text-align: right;">স্টক বের হয়েছে</th>
                                <th style="padding: 6px; border: 1px solid #ddd; text-align: right;">বর্তমান স্টক</th>
                                <th style="padding: 6px; border: 1px solid #ddd; text-align: center;">স্ট্যাটাস</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${stockReportTbody.innerHTML}
                        </tbody>
                        <tfoot style="font-weight: bold; background: #f9fafb;">
                            <tr>
                                <td colspan="3" style="padding: 6px; border: 1px solid #ddd; text-align: right;">সর্বমোট:</td>
                                <td style="padding: 6px; border: 1px solid #ddd; text-align: right; color: #10b981;">${document.getElementById('stock-report-footer-in').textContent}</td>
                                <td style="padding: 6px; border: 1px solid #ddd; text-align: right; color: #f59e0b;">${document.getElementById('stock-report-footer-out').textContent}</td>
                                <td style="padding: 6px; border: 1px solid #ddd; text-align: right; color: #8b5cf6;">${document.getElementById('stock-report-footer-current').textContent}</td>
                                <td style="padding: 6px; border: 1px solid #ddd;"></td>
                            </tr>
                        </tfoot>
                    </table>

                    <div style="margin-top: 30px; text-align: center; font-size: 12px; color: #666;">
                        <p>রিপোর্ট প্রিন্টের সময়: ${new Date().toLocaleString('bn-BD')}</p>
                        <p>সফটওয়্যার: MY POS SOF</p>
                    </div>
                </div>
            `;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>স্টক সারাংশ রিপোর্ট</title>
                        <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@400;500;700&display=swap" rel="stylesheet">
                    </head>
                    <body onload="window.print(); window.close();">
                        ${printContent}
                    </body>
                </html>
            `);
            printWindow.document.close();
        });

        // Print Stock Movement Report
        printStockMovementBtn.addEventListener('click', () => {
            if (stockReportDisplay.style.display === 'none') {
                alert('অনুগ্রহ করে প্রথমে স্টক রিপোর্ট জেনারেট করুন।');
                return;
            }

            const fromDate = stockReportFromDate.value;
            const toDate = stockReportToDate.value;

            // Get stock movement details for each product
            let movementDetails = [];
            products.forEach(product => {
                // Stock in from purchases
                const purchaseEntries = ledgerEntries.filter(l => 
                    l.productId === product.id && 
                    l.category === 'product_purchase' &&
                    (!fromDate || new Date(l.timestamp) >= new Date(fromDate).setHours(0,0,0,0)) &&
                    (!toDate || new Date(l.timestamp) <= new Date(toDate).setHours(23,59,59,999))
                );

                purchaseEntries.forEach(entry => {
                    movementDetails.push({
                        date: new Date(entry.timestamp),
                        productName: product.name,
                        type: 'in',
                        quantity: entry.quantity || 0,
                        description: entry.description || 'ক্রয়'
                    });
                });

                // Stock out from sales
                const productSales = sales.filter(s => {
                    const saleDate = new Date(s.timestamp);
                    return (!fromDate || saleDate >= new Date(fromDate).setHours(0,0,0,0)) &&
                           (!toDate || saleDate <= new Date(toDate).setHours(23,59,59,999)) &&
                           s.items && s.items.some(item => item.productId === product.id);
                });

                productSales.forEach(sale => {
                    sale.items.filter(item => item.productId === product.id).forEach(item => {
                        movementDetails.push({
                            date: new Date(sale.timestamp),
                            productName: product.name,
                            type: 'out',
                            quantity: item.quantity || 0,
                            description: `বিক্রয় - ${sale.id}`
                        });
                    });
                });
            });

            // Sort by date
            movementDetails.sort((a, b) => a.date - b.date);

            const logoHtml = shopSettings.logoUrl ? `<div style="text-align: center; margin-bottom: 10px;"><img src="${shopSettings.logoUrl}" alt="Logo" style="max-height: 60px; max-width: 150px;"></div>` : '';
            
            let dateRangeText = '';
            if (fromDate && toDate) {
                dateRangeText = `<p style="text-align: center; font-size: 14px; margin: 5px 0;">তারিখ: ${new Date(fromDate).toLocaleDateString('bn-BD')} থেকে ${new Date(toDate).toLocaleDateString('bn-BD')}</p>`;
            } else if (fromDate) {
                dateRangeText = `<p style="text-align: center; font-size: 14px; margin: 5px 0;">তারিখ: ${new Date(fromDate).toLocaleDateString('bn-BD')} থেকে বর্তমান</p>`;
            } else if (toDate) {
                dateRangeText = `<p style="text-align: center; font-size: 14px; margin: 5px 0;">শুরু থেকে ${new Date(toDate).toLocaleDateString('bn-BD')} পর্যন্ত</p>`;
            }

            let movementRows = '';
            movementDetails.forEach((m, index) => {
                movementRows += `
                    <tr>
                        <td style="padding: 6px; border: 1px solid #ddd; text-align: center;">${index + 1}</td>
                        <td style="padding: 6px; border: 1px solid #ddd;">${m.date.toLocaleDateString('bn-BD')}</td>
                        <td style="padding: 6px; border: 1px solid #ddd;">${m.productName}</td>
                        <td style="padding: 6px; border: 1px solid #ddd; text-align: center; color: ${m.type === 'in' ? '#10b981' : '#f59e0b'}; font-weight: bold;">
                            ${m.type === 'in' ? 'ঢুকেছে' : 'বের হয়েছে'}
                        </td>
                        <td style="padding: 6px; border: 1px solid #ddd; text-align: right; color: ${m.type === 'in' ? '#10b981' : '#f59e0b'}; font-weight: bold;">
                            ${m.quantity.toLocaleString()}
                        </td>
                        <td style="padding: 6px; border: 1px solid #ddd;">${m.description}</td>
                    </tr>
                `;
            });

            const printContent = `
                <div style="font-family: 'Noto Sans Bengali', Arial, sans-serif; padding: 20px;">
                    ${logoHtml}
                    <h2 style="text-align: center; margin: 10px 0;">${shopSettings.name || 'দোকান'}</h2>
                    <p style="text-align: center; font-size: 14px; margin: 5px 0;">${shopSettings.address || ''}</p>
                    <hr style="margin: 15px 0; border: 1px solid #ddd;">
                    <h3 style="text-align: center; margin: 10px 0;">স্টক মুভমেন্ট রিপোর্ট</h3>
                    ${dateRangeText}
                    <hr style="margin: 15px 0; border: 1px solid #ddd;">
                    
                    <h4 style="margin: 15px 0 10px 0;">বিস্তারিত স্টক মুভমেন্ট</h4>
                    <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                        <thead>
                            <tr style="background: #f3f4f6;">
                                <th style="padding: 6px; border: 1px solid #ddd; text-align: center;">#</th>
                                <th style="padding: 6px; border: 1px solid #ddd; text-align: left;">তারিখ</th>
                                <th style="padding: 6px; border: 1px solid #ddd; text-align: left;">পণ্যের নাম</th>
                                <th style="padding: 6px; border: 1px solid #ddd; text-align: center;">ধরণ</th>
                                <th style="padding: 6px; border: 1px solid #ddd; text-align: right;">পরিমাণ</th>
                                <th style="padding: 6px; border: 1px solid #ddd; text-align: left;">বিবরণ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${movementRows || '<tr><td colspan="6" style="padding: 20px; text-align: center;">কোনো স্টক মুভমেন্ট পাওয়া যায়নি</td></tr>'}
                        </tbody>
                    </table>

                    <div style="margin-top: 30px; text-align: center; font-size: 12px; color: #666;">
                        <p>মোট লেনদেন: ${movementDetails.length} টি</p>
                        <p>রিপোর্ট প্রিন্টের সময়: ${new Date().toLocaleString('bn-BD')}</p>
                        <p>সফটওয়্যার: MY POS SOF</p>
                    </div>
                </div>
            `;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>স্টক মুভমেন্ট রিপোর্ট</title>
                        <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@400;500;700&display=swap" rel="stylesheet">
                    </head>
                    <body onload="window.print(); window.close();">
                        ${printContent}
                    </body>
                </html>
            `);
            printWindow.document.close();
        });

        // ✅ NEW: Daily Transaction Report Functions
        const dailyReportType = document.getElementById('daily-report-type');
        const specificDateContainer = document.getElementById('specific-date-container');
        const fromDateContainer = document.getElementById('from-date-container');
        const toDateContainer = document.getElementById('to-date-container');
        const dailyReportSpecificDate = document.getElementById('daily-report-specific-date');
        const dailyReportFromDate = document.getElementById('daily-report-from-date');
        const dailyReportToDate = document.getElementById('daily-report-to-date');
        const generateDailyReportBtn = document.getElementById('generate-daily-report-btn');
        const printDailyReportBtn = document.getElementById('print-daily-report-btn');
        const clearDailyReportBtn = document.getElementById('clear-daily-report-btn');
        const dailyReportDisplay = document.getElementById('daily-report-display');
        const dailyTransactionsTbody = document.getElementById('daily-transactions-tbody');

        // Report type change handler
        dailyReportType.addEventListener('change', () => {
            const type = dailyReportType.value;
            specificDateContainer.style.display = type === 'specific' ? 'block' : 'none';
            fromDateContainer.style.display = type === 'range' ? 'block' : 'none';
            toDateContainer.style.display = type === 'range' ? 'block' : 'none';
            
            // Set default dates
            if (type === 'today') {
                const today = new Date().toISOString().split('T')[0];
                dailyReportSpecificDate.value = today;
            }
        });

        // Generate Daily Report
        generateDailyReportBtn.addEventListener('click', () => {
            const type = dailyReportType.value;
            let fromDate, toDate, reportTitle, reportDateText;

            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];

            if (type === 'today') {
                fromDate = todayStr;
                toDate = todayStr;
                reportTitle = 'আজকের রিপোর্ট';
                reportDateText = today.toLocaleDateString('bn-BD');
            } else if (type === 'specific') {
                if (!dailyReportSpecificDate.value) {
                    alert('অনুগ্রহ করে একটি তারিখ নির্বাচন করুন।');
                    return;
                }
                fromDate = dailyReportSpecificDate.value;
                toDate = dailyReportSpecificDate.value;
                reportTitle = 'নির্দিষ্ট তারিখের রিপোর্ট';
                reportDateText = new Date(fromDate).toLocaleDateString('bn-BD');
            } else if (type === 'range') {
                if (!dailyReportFromDate.value || !dailyReportToDate.value) {
                    alert('অনুগ্রহ করে শুরু এবং শেষ তারিখ নির্বাচন করুন।');
                    return;
                }
                fromDate = dailyReportFromDate.value;
                toDate = dailyReportToDate.value;
                reportTitle = 'তারিখ রেঞ্জ রিপোর্ট';
                reportDateText = `${new Date(fromDate).toLocaleDateString('bn-BD')} থেকে ${new Date(toDate).toLocaleDateString('bn-BD')}`;
            }

            // Filter sales by date
            const fromDateObj = new Date(fromDate);
            fromDateObj.setHours(0, 0, 0, 0);
            const toDateObj = new Date(toDate);
            toDateObj.setHours(23, 59, 59, 999);

            // Filter sales by date AND exclude deleted bills (status !== 'বাতিল')
            const filteredSales = sales.filter(s => {
                const saleDate = new Date(s.timestamp);
                const isNotDeleted = s.status !== 'বাতিল';
                return saleDate >= fromDateObj && saleDate <= toDateObj && isNotDeleted;
            });

            // Calculate metrics (with backward compatibility for old sales data)
            const totalSales = filteredSales.reduce((sum, s) => sum + (s.totalAmount || 0), 0);
            const totalCash = filteredSales.reduce((sum, s) => {
                // For old data without cashAmount, infer from paymentMethod
                if (s.cashAmount !== undefined) return sum + s.cashAmount;
                if (s.paymentMethod === 'cash' || s.paymentMethod === 'bank') return sum + (s.finalAmount || 0);
                return sum;
            }, 0);
            const totalDue = filteredSales.reduce((sum, s) => {
                // For old data without dueAmount, infer from paymentMethod
                if (s.dueAmount !== undefined) return sum + s.dueAmount;
                if (s.paymentMethod === 'due') return sum + (s.finalAmount || 0);
                return sum;
            }, 0);
            const totalProducts = filteredSales.reduce((sum, s) => {
                return sum + (s.items ? s.items.reduce((itemSum, item) => itemSum + (item.quantity || 0), 0) : 0);
            }, 0);
            const payingCustomers = new Set(filteredSales.map(s => s.customerId).filter(id => id)).size;
            const totalIncome = totalCash + totalDue;

            // Update summary cards
            document.getElementById('daily-report-title').textContent = reportTitle;
            document.getElementById('daily-report-date').textContent = reportDateText;
            document.getElementById('daily-total-sales').textContent = `৳ ${totalSales.toLocaleString()}`;
            document.getElementById('daily-sales-count').textContent = `${filteredSales.length} টি বিল`;
            document.getElementById('daily-cash-received').textContent = `৳ ${totalCash.toLocaleString()}`;
            document.getElementById('daily-cash-count').textContent = `${filteredSales.filter(s => s.cashAmount > 0).length} টি লেনদেন`;
            document.getElementById('daily-due-amount').textContent = `৳ ${totalDue.toLocaleString()}`;
            document.getElementById('daily-due-count').textContent = `${filteredSales.filter(s => s.dueAmount > 0).length} জন কাস্টমার`;
            document.getElementById('daily-paying-customers').textContent = payingCustomers;
            document.getElementById('daily-products-sold').textContent = totalProducts.toLocaleString();
            document.getElementById('daily-total-income').textContent = `৳ ${totalIncome.toLocaleString()}`;

            // Update footer totals
            document.getElementById('daily-footer-total').textContent = `৳ ${totalSales.toLocaleString()}`;
            document.getElementById('daily-footer-cash').textContent = `৳ ${totalCash.toLocaleString()}`;
            document.getElementById('daily-footer-due').textContent = `৳ ${totalDue.toLocaleString()}`;

            // Render transactions table
            dailyTransactionsTbody.innerHTML = '';
            if (filteredSales.length === 0) {
                document.getElementById('daily-report-empty').style.display = 'block';
                document.getElementById('daily-transactions-table').style.display = 'none';
            } else {
                document.getElementById('daily-report-empty').style.display = 'none';
                document.getElementById('daily-transactions-table').style.display = 'table';

                // Sort by time
                filteredSales.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

                // Calculate total payment received (with backward compatibility)
                const totalPaymentReceived = filteredSales.reduce((sum, s) => {
                    if (s.cashAmount !== undefined) return sum + s.cashAmount;
                    if (s.paymentMethod === 'cash' || s.paymentMethod === 'bank') return sum + (s.finalAmount || 0);
                    return sum;
                }, 0);

                filteredSales.forEach((sale, index) => {
                    // Backward compatibility: calculate cash/due for old data
                    let saleCashAmount = sale.cashAmount;
                    let saleDueAmount = sale.dueAmount;
                    if (saleCashAmount === undefined) {
                        if (sale.paymentMethod === 'cash' || sale.paymentMethod === 'bank') {
                            saleCashAmount = sale.finalAmount || 0;
                            saleDueAmount = 0;
                        } else if (sale.paymentMethod === 'due') {
                            saleCashAmount = 0;
                            saleDueAmount = sale.finalAmount || 0;
                        } else {
                            saleCashAmount = 0;
                            saleDueAmount = 0;
                        }
                    }

                    const row = dailyTransactionsTbody.insertRow();
                    row.insertCell(0).textContent = index + 1;
                    row.insertCell(1).textContent = new Date(sale.timestamp).toLocaleTimeString('bn-BD');
                    row.insertCell(2).textContent = sale.id;
                    row.insertCell(3).textContent = sale.customerName || 'Walk-in';
                    
                    const totalCell = row.insertCell(4);
                    totalCell.textContent = `৳ ${(sale.totalAmount || 0).toLocaleString()}`;
                    totalCell.style.textAlign = 'right';
                    totalCell.style.color = '#60a5fa';
                    
                    const cashCell = row.insertCell(5);
                    cashCell.textContent = `৳ ${(saleCashAmount || 0).toLocaleString()}`;
                    cashCell.style.textAlign = 'right';
                    cashCell.style.color = '#34d399';
                    
                    const dueCell = row.insertCell(6);
                    dueCell.textContent = `৳ ${(saleDueAmount || 0).toLocaleString()}`;
                    dueCell.style.textAlign = 'right';
                    dueCell.style.color = '#f87171';
                    
                    // ✅ NEW: Payment column - shows who paid what
                    const paymentCell = row.insertCell(7);
                    paymentCell.textContent = `৳ ${(saleCashAmount || 0).toLocaleString()}`;
                    paymentCell.style.textAlign = 'right';
                    paymentCell.style.color = '#a78bfa';
                    paymentCell.style.fontWeight = 'bold';
                    
                    // ✅ NEW: Customer Due column - shows customer's current due balance
                    const customerDueCell = row.insertCell(8);
                    const customer = customers.find(c => c.id === sale.customerId);
                    const customerDue = customer ? (customer.currentDue || 0) : 0;
                    customerDueCell.textContent = customerDue > 0 ? `৳ ${customerDue.toLocaleString()}` : '-';
                    customerDueCell.style.textAlign = 'right';
                    customerDueCell.style.color = customerDue > 0 ? '#fbbf24' : '#94a3b8';
                    customerDueCell.style.fontWeight = customerDue > 0 ? 'bold' : 'normal';
                    
                    const typeCell = row.insertCell(9);
                    typeCell.style.textAlign = 'center';
                    if (saleDueAmount > 0) {
                        typeCell.innerHTML = '<span style="background: rgba(245, 158, 11, 0.2); color: #fbbf24; padding: 4px 8px; border-radius: 4px; font-size: 12px;">আংশিক</span>';
                    } else if (saleCashAmount > 0) {
                        typeCell.innerHTML = '<span style="background: rgba(16, 185, 129, 0.2); color: #34d399; padding: 4px 8px; border-radius: 4px; font-size: 12px;">নগদ</span>';
                    } else {
                        typeCell.innerHTML = '<span style="background: rgba(239, 68, 68, 0.2); color: #f87171; padding: 4px 8px; border-radius: 4px; font-size: 12px;">বাকি</span>';
                    }
                });
                
                // Update payment footer
                document.getElementById('daily-footer-payment').textContent = `৳ ${totalPaymentReceived.toLocaleString()}`;
                
                // Calculate total customer due for footer
                const totalCustomerDue = filteredSales.reduce((sum, s) => {
                    const cust = customers.find(c => c.id === s.customerId);
                    return sum + (cust ? (cust.currentDue || 0) : 0);
                }, 0);
                document.getElementById('daily-footer-customer-due').textContent = totalCustomerDue > 0 ? `৳ ${totalCustomerDue.toLocaleString()}` : '-';
            }

            // Show report
            dailyReportDisplay.style.display = 'block';
        });

        // Clear Daily Report
        clearDailyReportBtn.addEventListener('click', () => {
            dailyReportType.value = 'today';
            dailyReportSpecificDate.value = '';
            dailyReportFromDate.value = '';
            dailyReportToDate.value = '';
            specificDateContainer.style.display = 'none';
            fromDateContainer.style.display = 'none';
            toDateContainer.style.display = 'none';
            dailyReportDisplay.style.display = 'none';
        });

        // Print Daily Report
        printDailyReportBtn.addEventListener('click', () => {
            if (dailyReportDisplay.style.display === 'none') {
                alert('অনুগ্রহ করে প্রথমে রিপোর্ট জেনারেট করুন।');
                return;
            }

            const logoHtml = shopSettings.logoUrl ? `<div style="text-align: center; margin-bottom: 10px;"><img src="${shopSettings.logoUrl}" alt="Logo" style="max-height: 60px; max-width: 150px;"></div>` : '';

            const printContent = `
                <div style="font-family: 'Noto Sans Bengali', Arial, sans-serif; padding: 20px;">
                    ${logoHtml}
                    <h2 style="text-align: center; margin: 10px 0;">${shopSettings.name || 'দোকান'}</h2>
                    <p style="text-align: center; font-size: 14px; margin: 5px 0;">${shopSettings.address || ''}</p>
                    <hr style="margin: 15px 0; border: 1px solid #ddd;">
                    <h3 style="text-align: center; margin: 10px 0;">${document.getElementById('daily-report-title').textContent}</h3>
                    <p style="text-align: center; font-size: 14px; margin: 5px 0;">${document.getElementById('daily-report-date').textContent}</p>
                    <hr style="margin: 15px 0; border: 1px solid #ddd;">
                    
                    <div style="display: flex; flex-wrap: wrap; justify-content: space-between; margin-bottom: 20px; gap: 10px;">
                        <div style="flex: 1; min-width: 150px; padding: 10px; border: 2px solid #3b82f6; border-radius: 5px; text-align: center;">
                            <div style="font-size: 12px; color: #666;">মোট বিক্রয়</div>
                            <div style="font-size: 16px; font-weight: bold; color: #3b82f6;">${document.getElementById('daily-total-sales').textContent}</div>
                            <div style="font-size: 10px; color: #999;">${document.getElementById('daily-sales-count').textContent}</div>
                        </div>
                        <div style="flex: 1; min-width: 150px; padding: 10px; border: 2px solid #10b981; border-radius: 5px; text-align: center;">
                            <div style="font-size: 12px; color: #666;">ক্যাশ এসেছে</div>
                            <div style="font-size: 16px; font-weight: bold; color: #10b981;">${document.getElementById('daily-cash-received').textContent}</div>
                            <div style="font-size: 10px; color: #999;">${document.getElementById('daily-cash-count').textContent}</div>
                        </div>
                        <div style="flex: 1; min-width: 150px; padding: 10px; border: 2px solid #ef4444; border-radius: 5px; text-align: center;">
                            <div style="font-size: 12px; color: #666;">বাকি হয়েছে</div>
                            <div style="font-size: 16px; font-weight: bold; color: #ef4444;">${document.getElementById('daily-due-amount').textContent}</div>
                            <div style="font-size: 10px; color: #999;">${document.getElementById('daily-due-count').textContent}</div>
                        </div>
                        <div style="flex: 1; min-width: 150px; padding: 10px; border: 2px solid #8b5cf6; border-radius: 5px; text-align: center;">
                            <div style="font-size: 12px; color: #666;">পেমেন্টকারী কাস্টমার</div>
                            <div style="font-size: 16px; font-weight: bold; color: #8b5cf6;">${document.getElementById('daily-paying-customers').textContent} জন</div>
                        </div>
                        <div style="flex: 1; min-width: 150px; padding: 10px; border: 2px solid #f59e0b; border-radius: 5px; text-align: center;">
                            <div style="font-size: 12px; color: #666;">মোট পণ্য বিক্রি</div>
                            <div style="font-size: 16px; font-weight: bold; color: #f59e0b;">${document.getElementById('daily-products-sold').textContent} টি</div>
                        </div>
                        <div style="flex: 1; min-width: 150px; padding: 10px; border: 2px solid #06b6d4; border-radius: 5px; text-align: center;">
                            <div style="font-size: 12px; color: #666;">মোট আয়</div>
                            <div style="font-size: 16px; font-weight: bold; color: #06b6d4;">${document.getElementById('daily-total-income').textContent}</div>
                        </div>
                    </div>

                    <h4 style="margin: 15px 0 10px 0;">বিস্তারিত লেনদেন তালিকা</h4>
                    <table style="width: 100%; border-collapse: collapse; font-size: 10px;">
                        <thead>
                            <tr style="background: #f3f4f6;">
                                <th style="padding: 6px; border: 1px solid #ddd; text-align: center;">#</th>
                                <th style="padding: 6px; border: 1px solid #ddd; text-align: left;">সময়</th>
                                <th style="padding: 6px; border: 1px solid #ddd; text-align: left;">বিল নং</th>
                                <th style="padding: 6px; border: 1px solid #ddd; text-align: left;">কাস্টমার</th>
                                <th style="padding: 6px; border: 1px solid #ddd; text-align: right;">মোট</th>
                                <th style="padding: 6px; border: 1px solid #ddd; text-align: right;">নগদ</th>
                                <th style="padding: 6px; border: 1px solid #ddd; text-align: right;">বাকি</th>
                                <th style="padding: 6px; border: 1px solid #ddd; text-align: right;">পেমেন্ট</th>
                                <th style="padding: 6px; border: 1px solid #ddd; text-align: right;">কাস্টমার বাকি</th>
                                <th style="padding: 6px; border: 1px solid #ddd; text-align: center;">ধরণ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${dailyTransactionsTbody.innerHTML}
                        </tbody>
                        <tfoot style="font-weight: bold; background: #f9fafb;">
                            <tr>
                                <td colspan="4" style="padding: 6px; border: 1px solid #ddd; text-align: right;">সর্বমোট:</td>
                                <td style="padding: 6px; border: 1px solid #ddd; text-align: right; color: #3b82f6;">${document.getElementById('daily-footer-total').textContent}</td>
                                <td style="padding: 6px; border: 1px solid #ddd; text-align: right; color: #10b981;">${document.getElementById('daily-footer-cash').textContent}</td>
                                <td style="padding: 6px; border: 1px solid #ddd; text-align: right; color: #ef4444;">${document.getElementById('daily-footer-due').textContent}</td>
                                <td style="padding: 6px; border: 1px solid #ddd; text-align: right; color: #8b5cf6;">${document.getElementById('daily-footer-payment').textContent}</td>
                                <td style="padding: 6px; border: 1px solid #ddd; text-align: right; color: #f59e0b;">${document.getElementById('daily-footer-customer-due').textContent}</td>
                                <td style="padding: 6px; border: 1px solid #ddd;"></td>
                            </tr>
                        </tfoot>
                    </table>

                    <div style="margin-top: 30px; text-align: center; font-size: 12px; color: #666;">
                        <p>রিপোর্ট প্রিন্টের সময়: ${new Date().toLocaleString('bn-BD')}</p>
                        <p>সফটওয়্যার: MY POS SOF</p>
                    </div>
                </div>
            `;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Daily Transaction Report</title>
                        <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@400;500;700&display=swap" rel="stylesheet">
                    </head>
                    <body onload="window.print(); window.close();">
                        ${printContent}
                    </body>
                </html>
            `);
            printWindow.document.close();
        });

        addProductBtn.addEventListener('click', () => {
            if (currentUser && currentUser.role === 'admin') {
                addProductFormContainer.style.display = 'block';
                addProductForm.reset();
                addProductForm.dataset.editingId = '';
                addProductForm.dataset.originalStock = "0";
                document.getElementById('product-stock').value = 0;
                productPurchasePriceInput.value = 0;
                document.getElementById('product-min-stock').value = window.SALES_FORECAST_CONFIG.PRODUCT_MIN_STOCK_DEFAULT; // NEW: Set default min stock
                document.getElementById('product-serial').value = 'স্বয়ংক্রিয়ভাবে তৈরি হবে'; 
                populateSupplierDatalist();
            } else {
                alert('আপনার নতুন পণ্য যোগ করার অনুমতি নেই।');
            }
        });

        document.querySelectorAll('#add-product-form-container .cancel-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                addProductFormContainer.style.display = 'none';
                addProductForm.reset();
            });
        });

        // --- Product Form Submission (MODIFIED for 2. Stock Alert and Existing Logic Re-wrap) ---
        // Removed original `addProductForm.addEventListener('submit', async (event) => { ... })` and re-add below with updated logic:

        addProductForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const editingId = addProductForm.dataset.editingId;
            const id = editingId || generateUniqueId('P');
            
            const newProductData = {
                name: document.getElementById('product-name').value,
                category: document.getElementById('product-category').value,
                unit: document.getElementById('product-unit').value,
                stock: parseInt(document.getElementById('product-stock').value) || 0,
                minStock: parseInt(productMinStockInput.value) || window.SALES_FORECAST_CONFIG.PRODUCT_MIN_STOCK_DEFAULT, // NEW: Min Stock field
                purchasePrice: parseFloat(productPurchasePriceInput.value) || 0,
                price: parseFloat(document.getElementById('product-price').value) || 0,
                description: document.getElementById('product-description').value,
                imageUrl: document.getElementById('product-image').value,
                supplierName: document.getElementById('product-supplier-name').value.trim(),
                supplierPhone: document.getElementById('product-supplier-phone').value,
                supplierAddress: document.getElementById('product-supplier-address').value,
                purchaseType: document.getElementById('product-purchase-type').value
            };

            if (newProductData.purchasePrice > newProductData.price) {
                alert('ক্রয় মূল্য বিক্রয় মূল্যের চেয়ে বেশি হতে পারে না।');
                return;
            }
            
            // নতুন SN জেনারেশন
            let existingProduct = products.find(p => p.id === id);
            if (!editingId) {
                newProductData.serialNumber = generateProductSN(id);
            } else {
                newProductData.serialNumber = existingProduct ? existingProduct.serialNumber : generateProductSN(id);
            }
            document.getElementById('product-serial').value = newProductData.serialNumber;


            let stockAdded = 0;
            if (editingId) {
                const originalProduct = products.find(p => p.id === id);
                const originalStock = originalProduct ? originalProduct.stock : 0;
                if (newProductData.stock > originalStock) {
                    stockAdded = newProductData.stock - originalStock;
                }
            } else {
                stockAdded = newProductData.stock;
            }

            if (newProductData.supplierName && stockAdded > 0) {
                const purchaseValue = stockAdded * newProductData.purchasePrice;
                let supplier = suppliers.find(s => s.name === newProductData.supplierName);
                if (!supplier) {
                    supplier = { id: generateUniqueId('SUP'), name: newProductData.supplierName, phone: newProductData.supplierPhone, address: newProductData.supplierAddress, totalPurchased: 0, totalPaid: 0, currentDue: 0 };
                    suppliers.push(supplier);
                }

                supplier.totalPurchased = (supplier.totalPurchased || 0) + purchaseValue;
                
                const newPurchaseRecord = {
                    id: generateUniqueId('PH'),
                    timestamp: new Date().toISOString(),
                    supplierId: supplier.id,
                    supplierName: supplier.name,
                    type: 'purchase',
                    paymentType: newProductData.purchaseType,
                    items: [{ productId: id, productName: newProductData.name, quantity: stockAdded, purchasePrice: newProductData.purchasePrice, totalValue: purchaseValue }],
                    totalAmount: purchaseValue
                };
                purchaseHistory.push(newPurchaseRecord);
                await db.put('purchaseHistory', newPurchaseRecord);

                if (newProductData.purchaseType === 'cash') {
                    supplier.totalPaid = (supplier.totalPaid || 0) + purchaseValue;
                    const newLedgerEntry = {
                        id: generateUniqueId('L'), timestamp: new Date().toISOString(), type: 'expense',
                        category: 'product_purchase', description: `${stockAdded} ${newProductData.unit} ${newProductData.name}`,
                        amount: purchaseValue, supplierId: supplier.id, supplierName: supplier.name
                    };
                    ledgerEntries.push(newLedgerEntry);
                    await db.put('ledgerEntries', newLedgerEntry);
                } else {
                    supplier.currentDue = (supplier.currentDue || 0) + purchaseValue;
                }
                await db.put('suppliers', supplier);
                
                // Manually update local suppliers array
                const supplierIndex = suppliers.findIndex(s => s.id === supplier.id);
                if(supplierIndex !== -1) {
                    suppliers[supplierIndex] = supplier;
                }

                renderSupplierList();
            }

            const finalProductData = { id, ...(existingProduct || {}), ...newProductData }; // Ensure merge of existing and new properties
            await db.put('products', finalProductData);
            
             // Manually update local products array
            const productIndex = products.findIndex(p => p.id === id);
            if (productIndex !== -1) {
                products[productIndex] = finalProductData;
            } else {
                products.push(finalProductData);
            }

            alert(editingId ? 'পণ্য সফলভাবে আপডেট করা হয়েছে!' : 'পণ্য সফলভাবে যোগ করা হয়েছে!');

            // Update UI/Cleanup
            renderProductList();
            populateCategoryFilter();
            renderLedger();
            updateDashboardSummary();
            addProductFormContainer.style.display = 'none';
            addProductForm.reset();
        });


        // --- Product Edit (MODIFIED for 2. Stock Alert) ---
        function editProduct(id) {
            const product = products.find(p => p.id === id);
            if (product) {
                addProductFormContainer.style.display = 'block';
                populateSupplierDatalist();
                document.getElementById('product-name').value = product.name;
                document.getElementById('product-category').value = product.category || '';
                document.getElementById('product-serial').value = product.serialNumber || 'N/A'; 
                document.getElementById('product-unit').value = product.unit || '';
                document.getElementById('product-stock').value = product.stock || 0;
                document.getElementById('product-min-stock').value = product.minStock || window.SALES_FORECAST_CONFIG.PRODUCT_MIN_STOCK_DEFAULT; // NEW: Load Min Stock
                productPurchasePriceInput.value = product.purchasePrice || 0;
                document.getElementById('product-price').value = product.price;
                document.getElementById('product-description').value = product.description || '';
                document.getElementById('product-image').value = product.imageUrl || '';
                
                document.getElementById('product-supplier-name').value = product.supplierName || '';
                document.getElementById('product-supplier-phone').value = product.supplierPhone || '';
                document.getElementById('product-supplier-address').value = product.supplierAddress || '';
                document.getElementById('product-purchase-type').value = product.purchaseType || 'cash';

                addProductForm.dataset.editingId = product.id;
                addProductForm.dataset.originalStock = product.stock || '0';

                // Lock core fields for non-admin, especially Purchase Price
                const isAdmin = currentUser && currentUser.role === 'admin';
                document.getElementById('product-name').readOnly = !isAdmin;
                document.getElementById('product-category').readOnly = !isAdmin;
                document.getElementById('product-unit').readOnly = !isAdmin;
                document.getElementById('product-purchase-price').readOnly = !isAdmin;
                document.getElementById('product-price').readOnly = !isAdmin;
            }
        }
        // ... (The rest of the ORIGINAL functions UNMODIFIED, down to DOMContentLoaded) ...
        async function deleteProduct(id) {
            if (!currentUser || currentUser.role !== 'admin') {
                alert('আপনার পণ্য মুছে ফেলার অনুমতি নেই।');
                return;
            }
            if (confirm('আপনি কি নিশ্চিত এই পণ্যটি মুছে ফেলতে চান?')) {
                await db.delete('products', id);
                products = products.filter(p => p.id !== id);
                renderProductList();
                populateCategoryFilter();
                alert('পণ্য সফলভাবে মুছে ফেলা হয়েছে!');
            }
        }

        productSearch.addEventListener('input', (e) => renderProductList(e.target.value, productCategoryFilter.value));
        productCategoryFilter.addEventListener('change', (e) => renderProductList(productSearch.value, e.target.value));
        
        // --- Supplier Management (Original) ---
        function populateSupplierDatalist() {
            const datalist = document.getElementById('supplier-name-list');
            datalist.innerHTML = '';
            suppliers.forEach(s => {
                const option = document.createElement('option');
                option.value = s.name;
                datalist.appendChild(option);
            });
        }

        function renderSupplierList() {
            supplierListTableBody.innerHTML = '';
            if (suppliers.length === 0) {
                supplierListTableBody.innerHTML = '<tr><td colspan="6">কোনো সাপ্লায়ার যোগ করা হয়নি।</td></tr>';
                return;
            }
            suppliers.forEach(supplier => {
                const row = supplierListTableBody.insertRow();
                row.insertCell(0).textContent = supplier.name;
                row.insertCell(1).textContent = supplier.phone || 'N/A';
                row.insertCell(2).textContent = `৳ ${(supplier.totalPurchased || 0).toLocaleString()}`;
                row.insertCell(3).textContent = `৳ ${(supplier.totalPaid || 0).toLocaleString()}`;
                const dueCell = row.insertCell(4)
                dueCell.textContent = `৳ ${(supplier.currentDue || 0).toLocaleString()}`;
                dueCell.style.color = (supplier.currentDue || 0) > 0 ? '#dc3545' : '#22c55e';
                dueCell.style.fontWeight = 'bold';

                const actionCell = row.insertCell(5);
                actionCell.className = 'table-action-buttons';
                
                const ledgerBtn = document.createElement('button');
                ledgerBtn.innerHTML = '<i class="fas fa-book"></i> লেজার দেখুন';
                ledgerBtn.className = 'info-btn';
                ledgerBtn.addEventListener('click', () => showSupplierLedger(supplier));
                actionCell.appendChild(ledgerBtn);

                const returnBtn = document.createElement('button');
                returnBtn.innerHTML = '<i class="fas fa-undo"></i> পণ্য ফেরত দিন';
                returnBtn.className = 'warning-btn';
                returnBtn.addEventListener('click', () => openSupplierReturnModal(supplier));
                actionCell.appendChild(returnBtn);

                const payBtn = document.createElement('button');
                payBtn.innerHTML = '<i class="fas fa-money-bill-wave"></i> পেমেন্ট';
                payBtn.className = 'primary-btn';
                payBtn.style.backgroundColor = '#28a745';
                payBtn.disabled = (supplier.currentDue || 0) <= 0;
                payBtn.addEventListener('click', () => openPaySupplierDueModal(supplier));
                actionCell.appendChild(payBtn);

                const editBtn = document.createElement('button');
                editBtn.innerHTML = '<i class="fas fa-edit"></i> সম্পাদনা';
                editBtn.className = 'edit-btn';
                editBtn.addEventListener('click', () => editSupplier(supplier.id));
                actionCell.appendChild(editBtn);
                
                if (currentUser !== null && currentUser.role !== 'admin') {
                   // Seller can view ledger and do return, but cannot edit/delete/pay due (for security)
                   editBtn.style.display = 'none';
                }
            });
            if (currentUser !== null && currentUser.role !== 'admin') {
                addSupplierBtn.style.display = 'none';
            } else {
                 addSupplierBtn.style.display = 'inline-block';
            }
        }

        addSupplierBtn.addEventListener('click', () => {
            addSupplierForm.reset();
            addSupplierForm.dataset.editingId = '';
            addSupplierFormContainer.style.display = 'block';
        });

        document.querySelector('#add-supplier-form-container .cancel-btn').addEventListener('click', () => {
            addSupplierFormContainer.style.display = 'none';
        });

        addSupplierForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const editingId = addSupplierForm.dataset.editingId;
            const id = editingId || generateUniqueId('SUP');

            const newSupplierData = {
                name: document.getElementById('supplier-name').value,
                phone: document.getElementById('supplier-phone').value,
                address: document.getElementById('supplier-address').value,
                details: document.getElementById('supplier-details').value,
            };

            if (editingId) {
                const index = suppliers.findIndex(s => s.id === id);
                suppliers[index] = { ...suppliers[index], ...newSupplierData };
                await db.put('suppliers', suppliers[index]);
                alert('সাপ্লায়ারের তথ্য আপডেট করা হয়েছে!');
            } else {
                 const newSupplier = {
                    id, ...newSupplierData, totalPurchased: 0, totalPaid: 0, currentDue: 0
                };
                suppliers.push(newSupplier);
                await db.put('suppliers', newSupplier);
                alert('নতুন সাপ্লায়ার যোগ করা হয়েছে!');
            }
            renderSupplierList();
            populateSupplierDatalist();
            addSupplierFormContainer.style.display = 'none';
        });

        function editSupplier(id) {
            const supplier = suppliers.find(s => s.id === id);
            if (supplier) {
                addSupplierFormContainer.style.display = 'block';
                document.getElementById('supplier-name').value = supplier.name;
                document.getElementById('supplier-phone').value = supplier.phone || '';
                document.getElementById('supplier-address').value = supplier.address || '';
                document.getElementById('supplier-details').value = supplier.details || '';
                addSupplierForm.dataset.editingId = id;
            }
        }

        async function deleteSupplier(id) {
            if (confirm('আপনি কি নিশ্চিত এই সাপ্লায়ারকে মুছে ফেলতে চান?')) {
                await db.delete('suppliers', id);
                suppliers = suppliers.filter(s => s.id !== id);
                renderSupplierList();
                populateSupplierDatalist();
                alert('সাপ্লায়ার মুছে ফেলা হয়েছে!');
            }
        }
        
        // --- MODIFIED: openPaySupplierDueModal now includes Bank option ---
        let currentSupplierForPayment = null;

        function openPaySupplierDueModal(supplier) {
            currentSupplierForPayment = supplier;
            document.getElementById('modal-supplier-name').textContent = supplier.name;
            document.getElementById('modal-supplier-total-outstanding').textContent = `৳ ${(supplier.currentDue || 0).toLocaleString()}`;
            const paymentAmountInput = document.getElementById('supplier-payment-amount');
            paymentAmountInput.value = supplier.currentDue || 0;
            paymentAmountInput.max = supplier.currentDue || 0;
            supplierPaymentMethodSelect.value = 'cash';
            supplierDueBankSelectContainer.style.display = 'none';
            updateSupplierModalRemainingDue();
            paySupplierDueModal.style.display = 'flex';
        }
        
        supplierPaymentMethodSelect.addEventListener('change', (e) => {
             supplierDueBankSelectContainer.style.display = e.target.value === 'bank' ? 'block' : 'none';
        });
        
        document.getElementById('supplier-payment-amount').addEventListener('input', updateSupplierModalRemainingDue);
        
        function updateSupplierModalRemainingDue() {
            if (!currentSupplierForPayment) return;
            const paidAmount = parseFloat(document.getElementById('supplier-payment-amount').value) || 0;
            const remaining = (currentSupplierForPayment.currentDue || 0) - paidAmount;
            const remainingSpan = document.getElementById('modal-supplier-due-remaining');
            remainingSpan.textContent = `৳ ${Math.max(0, remaining).toLocaleString()}`;
            remainingSpan.style.color = remaining > 0 ? 'red' : 'green';
        }
        
        processSupplierDuePaymentBtn.addEventListener('click', async () => {
             if (!currentSupplierForPayment) return;

            const paymentAmount = parseFloat(document.getElementById('supplier-payment-amount').value);
            const paymentMethod = supplierPaymentMethodSelect.value;
            const selectedBankId = supplierDueBankSelect.value;
            let selectedBank = null;
            
            if (isNaN(paymentAmount) || paymentAmount <= 0 || paymentAmount > (currentSupplierForPayment.currentDue || 0)) {
                alert('বৈধ পরিমাণ প্রবেশ করান।');
                return;
            }
             if (paymentMethod === 'bank') {
                selectedBank = banks.find(b => b.id === selectedBankId);
                if (!selectedBank) {
                    alert('অনুগ্রহ করে একটি ব্যাংক নির্বাচন করুন।');
                    return;
                }
                if (paymentAmount > selectedBank.currentBalance) {
                     alert(`ব্যাংকে পর্যাপ্ত ব্যালেন্স নেই। (বর্তমান ব্যালেন্স: ৳ ${selectedBank.currentBalance.toLocaleString()})`);
                     return;
                }
             }
            
            const dbPromises = [];

            currentSupplierForPayment.totalPaid = (currentSupplierForPayment.totalPaid || 0) + paymentAmount;
            currentSupplierForPayment.currentDue = (currentSupplierForPayment.currentDue || 0) - paymentAmount;
            dbPromises.push(db.put('suppliers', currentSupplierForPayment));
            
            const newLedgerEntry = {
                id: generateUniqueId('L'), timestamp: new Date().toISOString(), type: 'expense',
                category: 'supplier_payment', description: `বকেয়া পরিশোধ (${paymentMethod === 'cash' ? 'Cash' : selectedBank.name})`,
                amount: paymentAmount, supplierId: currentSupplierForPayment.id, supplierName: currentSupplierForPayment.name
            };

            if (paymentMethod === 'cash') {
                 // Rule 4: Cash transaction goes to Ledger (Cash Out)
                 ledgerEntries.push(newLedgerEntry);
                 dbPromises.push(db.put('ledgerEntries', newLedgerEntry));

            } else if (paymentMethod === 'bank') {
                 // Rule 4: Bank transaction goes to Bank Module (Debit)
                 selectedBank.currentBalance -= paymentAmount;
                 dbPromises.push(db.put('banks', selectedBank)); // <--- FIXED: Persist bank balance
                 
                 const newBankTx = {
                     id: generateUniqueId('BTX'), timestamp: new Date().toISOString(), bankId: selectedBank.id,
                     bankName: selectedBank.name, type: 'debit', amount: paymentAmount,
                     category: 'supplier_payment', description: `সাপ্লায়ার পেমেন্ট: ${currentSupplierForPayment.name}`
                 };
                 bankTransactions.push(newBankTx);
                 dbPromises.push(db.put('bankTransactions', newBankTx));
                 
                 // Manually update local banks array
                 const bankIndex = banks.findIndex(b => b.id === selectedBank.id);
                 if(bankIndex !== -1) banks[bankIndex] = selectedBank; // <--- FIXED: Local array update
                 
                 // Note: newLedgerEntry is NOT added to Ledger
            }

            await Promise.all(dbPromises);
            
            // Manually update local arrays
            const supplierIndex = suppliers.findIndex(s => s.id === currentSupplierForPayment.id);
            if(supplierIndex !== -1) {
                suppliers[supplierIndex] = currentSupplierForPayment;
            }

            alert('সাপ্লায়ার পেমেন্ট সফলভাবে রেকর্ড করা হয়েছে!');
            
            paySupplierDueModal.style.display = 'none';
            renderSupplierList();
            renderLedger();
            renderBankList();
            updateDashboardSummary();
            currentSupplierForPayment = null;
        });
        
        document.querySelectorAll('#pay-supplier-due-modal .close-button').forEach(btn => {
            btn.addEventListener('click', () => {
                paySupplierDueModal.style.display = 'none';
                currentSupplierForPayment = null;
            });
        });
        
        let currentViewingSupplier = null;
        function showSupplierLedger(supplier) {
            currentViewingSupplier = supplier;
            document.getElementById('modal-history-supplier-name').textContent = supplier.name;
            document.getElementById('summary-total-purchased').textContent = `৳ ${(supplier.totalPurchased || 0).toLocaleString()}`;
            document.getElementById('summary-total-paid').textContent = `৳ ${(supplier.totalPaid || 0).toLocaleString()}`;
            document.getElementById('summary-current-due').textContent = `৳ ${(supplier.currentDue || 0).toLocaleString()}`;
            
            document.getElementById('supplier-ledger-from-date').value = '';
            document.getElementById('supplier-ledger-to-date').value = '';

            renderSupplierLedgerTables(supplier.id);
            
            printSupplierHistoryBtn.dataset.supplierId = supplier.id;
            supplierHistoryModal.style.display = 'flex';
        }

        function renderSupplierLedgerTables(supplierId, fromDateStr = '', toDateStr = '') {
            const fromDate = fromDateStr ? moment(fromDateStr).startOf('day') : null;
            const toDate = toDateStr ? moment(toDateStr).endOf('day') : null;

            const filterByDate = (item) => {
                if (!fromDate && !toDate) return true;
                const itemDate = moment(item.timestamp);
                return (!fromDate || itemDate.isSameOrAfter(fromDate)) && (!toDate || itemDate.isSameOrBefore(toDate));
            };

            // Table Body References
            const cashPurchaseBody = document.querySelector('#supplier-cash-purchase-table tbody');
            const duePurchaseBody = document.querySelector('#supplier-due-purchase-table tbody');
            const paymentBody = document.querySelector('#supplier-payment-table tbody');
            const returnBody = document.querySelector('#supplier-return-table-ledger tbody');

            // Clear old data
            cashPurchaseBody.innerHTML = '<tr><td colspan="3">কোনো লেনদেন নেই</td></tr>';
            duePurchaseBody.innerHTML = '<tr><td colspan="3">কোনো লেনদেন নেই</td></tr>';
            paymentBody.innerHTML = '<tr><td colspan="3">কোনো লেনদেন নেই</td></tr>';
            returnBody.innerHTML = '<tr><td colspan="3">কোনো লেনদেন নেই</td></tr>';

            let totalCash = 0, totalDue = 0, totalPayment = 0, totalReturn = 0;

            // Populate Cash Purchases
            const cashPurchases = purchaseHistory.filter(p => p.supplierId === supplierId && p.paymentType === 'cash' && filterByDate(p));
            if(cashPurchases.length > 0) {
                cashPurchaseBody.innerHTML = '';
                cashPurchases.forEach(item => {
                    totalCash += item.totalAmount;
                    const detailsHtml = '<ul>' + item.items.map(p => `<li>${p.productName} - ${p.quantity} x ৳${p.purchasePrice}</li>`).join('') + '</ul>';
                    cashPurchaseBody.innerHTML += `<tr><td>${moment(item.timestamp).format('L')}</td><td>${detailsHtml}</td><td>৳ ${item.totalAmount.toLocaleString()}</td></tr>`;
                });
            }

            // Populate Due Purchases
            const duePurchases = purchaseHistory.filter(p => p.supplierId === supplierId && p.paymentType === 'due' && filterByDate(p));
            if(duePurchases.length > 0) {
                duePurchaseBody.innerHTML = '';
                duePurchases.forEach(item => {
                    totalDue += item.totalAmount;
                    const detailsHtml = '<ul>' + item.items.map(p => `<li>${p.productName} - ${p.quantity} x ৳${p.purchasePrice}</li>`).join('') + '</ul>';
                    duePurchaseBody.innerHTML += `<tr><td>${moment(item.timestamp).format('L')}</td><td>${detailsHtml}</td><td>৳ ${item.totalAmount.toLocaleString()}</td></tr>`;
                });
            }

            // Populate Payments (from Ledger AND Bank Tx)
            const cashPayments = ledgerEntries.filter(e => e.supplierId === supplierId && e.category === 'supplier_payment' && filterByDate(e));
            const bankPayments = bankTransactions.filter(t => t.category === 'supplier_payment' && t.description.includes(currentViewingSupplier.name) && filterByDate(t));

            const allPayments = [...cashPayments, ...bankPayments].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

            if(allPayments.length > 0) {
                paymentBody.innerHTML = '';
                allPayments.forEach(item => {
                    const amount = item.amount || item.totalAmount; // Ensure we get the correct amount
                    const source = item.type === 'debit' ? item.bankName : 'Cash';
                    totalPayment += amount;
                    paymentBody.innerHTML += `<tr><td>${moment(item.timestamp).format('L')}</td><td>${item.description || 'পেমেন্ট'} (${source})</td><td>৳ ${amount.toLocaleString()}</td></tr>`;
                });
            }

            // Populate Returns
            const returns = supplierReturns.filter(r => r.supplierId === supplierId && filterByDate(r));
            if(returns.length > 0){
                returnBody.innerHTML = '';
                returns.forEach(item => {
                    totalReturn += item.totalReturnValue;
                    const detailsHtml = '<ul>' + item.items.map(p => `<li>${p.productName} - ${p.quantity} x ৳${p.purchasePrice}</li>`).join('') + '</ul>';
                    returnBody.innerHTML += `<tr><td>${moment(item.timestamp).format('L')}</td><td>${detailsHtml}</td><td>৳ ${item.totalReturnValue.toLocaleString()}</td></tr>`;
                });
            }

            // Update totals
            document.getElementById('total-cash-purchase').textContent = `মোট: ৳ ${totalCash.toLocaleString()}`;
            document.getElementById('total-due-purchase').textContent = `মোট: ৳ ${totalDue.toLocaleString()}`;
            document.getElementById('total-supplier-payment').textContent = `মোট: ৳ ${totalPayment.toLocaleString()}`;
            document.getElementById('total-supplier-return').textContent = `মোট: ৳ ${totalReturn.toLocaleString()}`;
        }

        filterSupplierLedgerBtn.addEventListener('click', () => {
            if(currentViewingSupplier) {
                const fromDate = document.getElementById('supplier-ledger-from-date').value;
                const toDate = document.getElementById('supplier-ledger-to-date').value;
                renderSupplierLedgerTables(currentViewingSupplier.id, fromDate, toDate);
            }
        });


        document.querySelectorAll('#supplier-history-modal .close-button').forEach(btn => {
            btn.addEventListener('click', () => {
                supplierHistoryModal.style.display = 'none';
                currentViewingSupplier = null;
            });
        });

        printSupplierHistoryBtn.addEventListener('click', (e) => {
            const supplierId = e.target.dataset.supplierId;
            if(supplierId) {
                printSupplierLedger(supplierId);
            }
        });

        function printSupplierLedger(supplierId) {
            const supplier = suppliers.find(s => s.id === supplierId);
            if (!supplier) return;
            const logoHtml = shopSettings.logoUrl ? `<div class="center"><img src="${shopSettings.logoUrl}" alt="Logo" style="max-height: 80px; max-width: 200px; margin-bottom: 10px;"></div>` : '';


            const fromDateStr = document.getElementById('supplier-ledger-from-date').value;
            const toDateStr = document.getElementById('supplier-ledger-to-date').value;

            // Clone the printable area and add totals for printing
            const printAreaNode = document.getElementById('supplier-ledger-print-area').cloneNode(true);
            printAreaNode.querySelectorAll('h4').forEach(h4 => {
                const totalSpan = h4.querySelector('.table-total');
                if (totalSpan) {
                    const totalPrintSpan = document.createElement('span');
                    totalPrintSpan.className = 'table-total-print';
                    totalPrintSpan.textContent = totalSpan.textContent;
                    h4.appendChild(totalPrintSpan);
                }
            });

            const printContent = `
                ${logoHtml}
                <div style="text-align: center;">
                    <h2>${shopSettings.name}</h2>
                    <p>${shopSettings.address}</p>
                    <h3>সাপ্লায়ার লেজার: ${supplier.name}</h3>
                    <p>
                        ${fromDateStr ? `তারিখ: ${moment(fromDateStr).format('LL')} থেকে ` : ''}
                        ${toDateStr ? `${moment(toDateStr).format('LL')} পর্যন্ত` : ''}
                    </p>
                </div>
                <hr>
                <div id="print-content-tables">
                    ${printAreaNode.innerHTML}
                </div>
            `;
            launchPrint(`সাপ্লায়ার লেজার - ${supplier.name}`, printContent);
        }

        // --- Supplier Return Management (Original) ---
        let currentReturningSupplier = null;

        function openSupplierReturnModal(supplier) {
            currentReturningSupplier = supplier;
            document.getElementById('modal-return-supplier-name').textContent = supplier.name;
            const tableBody = document.getElementById('supplier-return-table-body');
            tableBody.innerHTML = '';
            
            const supplierProducts = products.filter(p => p.supplierName === supplier.name && p.stock > 0);

            if (supplierProducts.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4">এই সাপ্লায়ারের কোনো পণ্য স্টকে নেই।</td></tr>';
            } else {
                supplierProducts.forEach(p => {
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td>${p.name}</td>
                        <td>${p.stock} ${p.unit}</td>
                        <td>৳ ${p.purchasePrice || 0}</td>
                        <td>
                            <input type="number" class="supplier-return-qty" min="0" max="${p.stock}" value="0" 
                            data-product-id="${p.id}" data-purchase-price="${p.purchasePrice || 0}" style="width: 80px;">
                        </td>
                    `;
                });
            }
            
            document.querySelectorAll('.supplier-return-qty').forEach(input => {
                input.addEventListener('input', updateTotalReturnValue);
            });

            updateTotalReturnValue();
            supplierReturnModal.style.display = 'flex';
        }

        function updateTotalReturnValue() {
            let total = 0;
            document.querySelectorAll('.supplier-return-qty').forEach(input => {
                const qty = parseInt(input.value) || 0;
                const price = parseFloat(input.dataset.purchasePrice) || 0;
                total += qty * price;
            });
            document.getElementById('total-return-value').textContent = `৳ ${total.toLocaleString()}`;
        }
        
        processSupplierReturnBtn.addEventListener('click', async () => {
            if (!currentReturningSupplier) return;

            const returnItems = [];
            let totalReturnValue = 0;
            let isValid = true;

            document.querySelectorAll('.supplier-return-qty').forEach(input => {
                const qty = parseInt(input.value) || 0;
                if (qty > 0) {
                    const maxQty = parseInt(input.max);
                    if (qty > maxQty) {
                        alert(`ফেরতের পরিমাণ স্টকের চেয়ে বেশি হতে পারে না।`);
                        isValid = false;
                    }
                    const productId = input.dataset.productId;
                    const purchasePrice = parseFloat(input.dataset.purchasePrice);
                    const product = products.find(p => p.id === productId);
                    
                    returnItems.push({
                        productId: productId,
                        productName: product.name,
                        quantity: qty,
                        purchasePrice: purchasePrice
                    });
                    totalReturnValue += qty * purchasePrice;
                }
            });

            if (!isValid || returnItems.length === 0) {
                if(isValid) alert('ফেরত দেওয়ার জন্য কোনো পণ্যের পরিমাণ উল্লেখ করেননি।');
                return;
            }

            if (!confirm(`আপনি কি নিশ্চিত ${currentReturningSupplier.name}-কে ৳ ${totalReturnValue.toLocaleString()} মূল্যের পণ্য ফেরত দিতে চান?`)) {
                return;
            }
            
            const dbPromises = [];

            // 1. Create return record
            const newReturn = {
                id: generateUniqueId('SRET'),
                supplierId: currentReturningSupplier.id,
                supplierName: currentReturningSupplier.name,
                timestamp: new Date().toISOString(),
                items: returnItems,
                totalReturnValue: totalReturnValue
            };
            supplierReturns.push(newReturn);
            dbPromises.push(db.put('supplierReturns', newReturn));

            // 2. Update product stock
            returnItems.forEach(item => {
                const productIndex = products.findIndex(p => p.id === item.productId);
                if (productIndex > -1) {
                    products[productIndex].stock += item.quantity;
                    dbPromises.push(db.put('products', products[productIndex]));
                }
            });

            // 3. Update supplier's account
            currentReturningSupplier.currentDue = (currentReturningSupplier.currentDue || 0) - totalReturnValue;
            // We reduce totalPurchased as well to reflect the net purchase value.
            currentReturningSupplier.totalPurchased = (currentReturningSupplier.totalPurchased || 0) - totalReturnValue;
            dbPromises.push(db.put('suppliers', currentReturningSupplier));
            
            // 4. (Optional but good for accounting) Add a ledger entry for the credit
            const newLedgerEntry = {
                id: generateUniqueId('L'), timestamp: new Date().toISOString(), type: 'income',
                category: 'supplier_return_credit', description: `পণ্য ফেরত`,
                amount: totalReturnValue, supplierId: currentReturningSupplier.id, supplierName: currentReturningSupplier.name
            };
            ledgerEntries.push(newLedgerEntry);
            dbPromises.push(db.put('ledgerEntries', newLedgerEntry));

            await Promise.all(dbPromises);
            
             // Manually update local arrays
            returnItems.forEach(item => {
                const productIndex = products.findIndex(p => p.id === item.productId);
                if (productIndex > -1) {
                    // product is already updated in-place above
                }
            });
            const supplierIndex = suppliers.findIndex(s => s.id === currentReturningSupplier.id);
            if(supplierIndex !== -1) {
                suppliers[supplierIndex] = currentReturningSupplier;
            }

            // Re-fetch everything and update UI 
            await initializeData();
        });


        document.querySelectorAll('#supplier-return-modal .close-button').forEach(btn => {
            btn.addEventListener('click', () => {
                supplierReturnModal.style.display = 'none';
            });
        });



        // --- POS (Point of Sale) Management ---
        
        // NEW: Toggle bank selection based on payment method
        paymentMethodSelect.addEventListener('change', (e) => {
            posBankSelectContainer.style.display = e.target.value === 'bank' ? 'block' : 'none';
            if (e.target.value === 'due') {
                posCustomerNameInput.setAttribute('required', 'required');
                posCustomerPhoneInput.setAttribute('required', 'required');
            } else {
                posCustomerNameInput.removeAttribute('required');
                posCustomerPhoneInput.removeAttribute('required');
            }
        });

        // POS সার্চে স্ক্যানিং যোগ করা হয়েছে
        posProductSearch.addEventListener('keyup', (e) => {
            const searchText = e.target.value.trim();
            if (e.key === 'Enter' && searchText) {
                // If Enter is pressed, try to add to cart immediately
                e.preventDefault();
                const product = products.find(p => 
                    p.id === searchText || 
                    (p.serialNumber && p.serialNumber.toLowerCase() === searchText.toLowerCase())
                );
                
                if (product) {
                    posProductSearch.value = product.name; // Set name for display
                    posAddToCartBtn.click(); // Trigger the click event
                } else {
                    // If not found by ID/SN, continue with regular search list logic for name matching
                    searchResultsContainer.style.display = 'none';
                    posAddToCartBtn.click();
                }
            } else {
                 // Regular search dropdown logic
                 handlePosSearchInput(searchText);
            }
        });

        function handlePosSearchInput(searchText) {
            searchResultsContainer.innerHTML = '';
            const lowerSearchText = searchText.toLowerCase();
            
            if (lowerSearchText.length < 2) {
                searchResultsContainer.style.display = 'none';
                return;
            }

            // SN সার্চ সহ আপডেট
            const filtered = products.filter(p =>
                p.name.toLowerCase().includes(lowerSearchText) || 
                p.id.toLowerCase().includes(lowerSearchText) ||
                (p.serialNumber && p.serialNumber.toLowerCase().includes(lowerSearchText))
            );

            if(filtered.length > 0) {
                searchResultsContainer.style.display = 'block';
                filtered.forEach(p => {
                    const div = document.createElement('div');
                    div.textContent = `${p.name} (SN: ${p.serialNumber || 'N/A'}, ৳ ${p.price}, স্টক: ${p.stock} ${p.unit})`;
                    div.dataset.productId = p.id;
                    div.addEventListener('click', () => {
                        posProductSearch.value = p.name;
                        searchResultsContainer.innerHTML = ''; 
                        searchResultsContainer.style.display = 'none';
                    });
                    searchResultsContainer.appendChild(div);
                });
            } else {
                 searchResultsContainer.style.display = 'none';
            }
        }

        posCustomerPhoneInput.addEventListener('input', (e) => {
            const mobile = e.target.value;
            const existingCustomer = customers.find(c => c.phone === mobile);

            if (existingCustomer) {
                posCustomerNameInput.value = existingCustomer.name;
                posCustomerAddressInput.value = existingCustomer.address;
            } else {
                 posCustomerNameInput.value = '';
                 posCustomerAddressInput.value = '';
            }
        });

        clearCustomerFieldsBtn.addEventListener('click', () => {
            posCustomerPhoneInput.value = '';
            posCustomerNameInput.value = '';
            posCustomerAddressInput.value = '';
        });

        posAddToCartBtn.addEventListener('click', () => {
            const productNameOrId = posProductSearch.value;
            const product = products.find(p => p.name === productNameOrId || p.id === productNameOrId || (p.serialNumber && p.serialNumber.toLowerCase() === productNameOrId.toLowerCase())); // SN দিয়ে সার্চ যোগ

            if (!product) {
                alert('পণ্য খুঁজে পাওয়া যায়নি।');
                return;
            }

            if (product.stock <= 0) {
                alert(`দুঃখিত! ${product.name} স্টকে নেই।`);
                return;
            }

            const existingCartItem = currentCart.find(item => item.productId === product.id);
            const requestedQuantity = existingCartItem ? existingCartItem.quantity + 1 : 1;

            if (product.stock >= requestedQuantity) {
                 if (existingCartItem) {
                    existingCartItem.quantity++;
                } else {
                    currentCart.push({
                        productId: product.id,
                        name: product.name,
                        quantity: 1,
                        unitPrice: product.price,
                        purchasePrice: product.purchasePrice || 0,
                        unit: product.unit 
                    });
                }
            } else {
                alert(`স্টকে ${product.name}-এর পর্যাপ্ত নেই।`);
                return;
            }
            renderCart();
            posProductSearch.value = '';
            searchResultsContainer.style.display = 'none';
        });

        function renderCart() {
            posCartTableBody.innerHTML = '';
            if (currentCart.length === 0) {
                const row = posCartTableBody.insertRow();
                const cell = row.insertCell(0);
                cell.colSpan = 5;
                cell.textContent = 'কার্ট খালি আছে।';
                return;
            }

            currentCart.forEach((item, index) => {
                const row = posCartTableBody.insertRow();
                row.insertCell(0).textContent = item.name;

                const quantityCell = row.insertCell(1);
                const quantityInput = document.createElement('input');
                quantityInput.type = 'number';
                quantityInput.value = item.quantity;
                quantityInput.min = '1';
                quantityInput.style.width = '60px';
                
                // --- Updated Quantity Change Logic (Editable Invoice Enhancement) ---
                quantityInput.addEventListener('change', (e) => {
                    const newQuantity = parseInt(e.target.value);
                    const product = products.find(p => p.id === item.productId);
                    if (newQuantity <= 0) {
                        currentCart.splice(index, 1); // Remove item if quantity is zero
                        renderCart();
                        return;
                    }

                    // Check if new quantity exceeds stock AFTER considering current editing state's adjustment
                    const availableStock = product.stock;
                    let maxAllowed = availableStock;
                    if (currentEditingSale) {
                        const originalItem = currentEditingSale.items.find(i => i.productId === item.productId);
                        // Add back the original quantity to stock to get the theoretical maximum.
                        maxAllowed = availableStock + (originalItem ? originalItem.quantity : 0);
                    }
                    
                    if (maxAllowed >= newQuantity) {
                        item.quantity = newQuantity;
                        updateCartTotal();
                    } else {
                        alert(`স্টকে ${product.name}-এর পর্যাপ্ত নেই। সর্বোচ্চ ${maxAllowed}টি দেওয়া যেতে পারে।`);
                        e.target.value = item.quantity;
                    }
                });
                quantityCell.appendChild(quantityInput);

                const unitPriceCell = row.insertCell(2);
                const unitPriceInput = document.createElement('input');
                unitPriceInput.type = 'number';
                unitPriceInput.step = '0.01';
                unitPriceInput.min = '0';
                unitPriceInput.value = item.unitPrice;
                unitPriceInput.style.width = '80px';
                unitPriceInput.addEventListener('input', (e) => {
                    item.unitPrice = parseFloat(e.target.value) || 0;
                    updateCartTotal();
                });
                unitPriceCell.appendChild(unitPriceInput);

                row.insertCell(3).textContent = `৳ ${(item.quantity * item.unitPrice).toLocaleString()}`;
                const actionCell = row.insertCell(4);
                const removeBtn = document.createElement('button');
                removeBtn.textContent = 'মুছুন';
                removeBtn.className = 'danger-btn';
                removeBtn.addEventListener('click', () => {
                    currentCart.splice(index, 1);
                    renderCart();
                });
                actionCell.appendChild(removeBtn);
            });
            updateCartTotal();
        }

        function updateCartTotal() {
            const subtotal = currentCart.reduce((sum, item) => sum + (item.quantity * item.unitPrice), 0);
            const discount = parseFloat(discountAmountInput.value) || 0;
            const finalTotal = Math.max(0, subtotal - discount);

            cartSubtotalSpan.textContent = `৳ ${subtotal.toLocaleString()}`;
            cartFinalTotalSpan.textContent = `৳ ${finalTotal.toLocaleString()}`;
        }

        discountAmountInput.addEventListener('input', updateCartTotal);
        
        // ✅ NEW: Print Preview Function
        function launchPrint(title, contentHtml, printAreaClass = '') {
            const printWindow = window.open('', '_blank', 'height=800,width=800');
            printWindow.document.write(`<html><head><title>${title}</title>`);
            
            // Print Controls and Styles
            printWindow.document.write(`
                <style>
                    /* General styles for the preview window */
                    body { font-family: 'Noto Sans Bengali', Arial, sans-serif; margin: 0; }
                    #print-controls {
                        position: fixed;
                        top: 10px;
                        right: 10px;
                        background: #f0f0f0;
                        padding: 10px;
                        border: 1px solid #ccc;
                        border-radius: 5px;
                        z-index: 9999;
                        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
                    }
                    #print-controls button {
                        margin: 0 5px;
                        padding: 8px 15px;
                        cursor: pointer;
                        border: 1px solid #999;
                        border-radius: 4px;
                        background-color: #e7e7e7;
                    }
                     #print-controls button.print-btn {
                        background-color: #4CAF50;
                        color: white;
                        border-color: #4CAF50;
                    }

                    /* Styles to hide controls when printing the preview */
                    @media print {
                        #print-controls { display: none; }
                        body * { visibility: hidden; }
                        #print-area, #print-area * { visibility: visible; }
                        #print-area { position: absolute; left: 0; top: 0; width: 100%; }
                    }

                    /* Existing print styles from your original file for consistency */
                    #print-area {
                        padding: 20px;
                        box-sizing: border-box;
                        background: white;
                    }
                    #print-area.barcode-label-print-multiple { padding: 0; width: 100%; height: auto; font-size: 8px; overflow: visible; display: flex; flex-wrap: wrap; justify-content: flex-start; align-items: flex-start; }
                    #print-area.barcode-label-print-multiple .single-barcode-label { width: 40mm !important; height: 25mm !important; box-sizing: border-box; border: 1px solid #000 !important; margin: 1mm; padding: 2px; display: block; page-break-inside: avoid; float: left; color: black !important; background: white !important; }
                    #print-area.barcode-label-print-multiple .single-barcode-label * { visibility: visible; color: black !important; background: white !important; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
                    #print-area.barcode-label-print-multiple .single-barcode-label svg { max-width: 100% !important; height: auto !important; }
                    #print-area h2 { text-align: center; margin-bottom: 5px; font-size: 22px;}
                    #print-area h3 { text-align: center; font-size: 18px; margin-bottom: 10px; }
                    #print-area h4 { border-bottom: 1px solid #ccc; padding-bottom: 5px; margin-top: 15px; font-size: 16px;}
                    #print-area p { margin: 2px 0; font-size: 14px;}
                    #print-area table { border-collapse: collapse; width: 100%; margin-top: 10px; }
                    #print-area th, #print-area td { border: 1px solid black !important; padding: 8px; text-align: left; font-size: 13px; }
                    #print-area .right { text-align: right; }
                    #print-area .center { text-align: center; }
                    #print-area hr { border: 0; border-top: 1px dashed #ccc; margin: 10px 0; }
                </style>
            `);
            
            printWindow.document.write('</head><body>');
            
            // Add Print Controls Div
            printWindow.document.write(`
                <div id="print-controls">
                    <button class="print-btn" onclick="window.print();">Print</button>
                    <button onclick="window.close();">Cancel</button>
                </div>
            `);
            
            // Add the main content area
            printWindow.document.write(`<div id="print-area" class="${printAreaClass}">${contentHtml}</div>`);
            
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.focus();
        }

        // --- ✅ NEW/MODIFIED: POS Payment Logic to support Bank, Editing, and New Invoice ID ---
        posPaymentForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            if (currentCart.length === 0) {
                alert('কার্টে কোনো পণ্য নেই!');
                return;
            }

            const isEditing = completeSaleBtn.dataset.editing === 'true';
            const paymentMethod = paymentMethodSelect.value;
            const finalAmount = parseFloat(cartFinalTotalSpan.textContent.replace('৳ ', '').replace(/,/g, ''));
            const selectedBankId = posBankSelect.value;
            let selectedBank = null;

            if (paymentMethod === 'bank') {
                selectedBank = banks.find(b => b.id === selectedBankId);
                if (!selectedBank) {
                    alert('অনুগ্রহ করে একটি ব্যাংক নির্বাচন করুন।');
                    return;
                }
            }

            if (isEditing && currentEditingSale) {
                // ✅ Handle Sale Edit
                await handleSaleUpdate();
            } else {
                // Handle New Sale
                await handleNewSale();
            }
        });

        // ✅ NEW: Function to handle new sale creation
        async function handleNewSale() {
            // ... (Most of your existing new sale logic goes here) ...
            
            // ✅ NEW: Get new numeric invoice ID
            shopSettings.lastInvoiceNumber++;
            const saleId = shopSettings.lastInvoiceNumber.toString();
            
            const timestamp = new Date().toISOString();
            const sellerId = currentUser.id;
            const totalAmount = parseFloat(cartSubtotalSpan.textContent.replace('৳ ', '').replace(/,/g, ''));
            const discountAmount = parseFloat(discountAmountInput.value) || 0;
            const finalAmount = totalAmount - discountAmount;
            const customerName = posCustomerNameInput.value.trim() || 'ক্যাশ কাস্টমার';
            const customerPhone = posCustomerPhoneInput.value.trim();
            const customerAddress = posCustomerAddressInput.value.trim() || 'N/A';
            const paymentMethod = paymentMethodSelect.value;
            const status = (paymentMethod === 'due') ? 'বাকি' : 'সম্পূর্ণ';

            let totalProfit = 0;
            const productUpdatePromises = [];
            
            for (const item of currentCart) {
                const product = products.find(p => p.id === item.productId);
                if (!product || product.stock < item.quantity) {
                    alert(`দুঃখিত! ${item.name} স্টকে পর্যাপ্ত নেই।`);
                    return;
                }
                const itemProfit = (item.unitPrice - (item.purchasePrice || 0)) * item.quantity;
                totalProfit += itemProfit;
                
                const productIndex = products.findIndex(p => p.id === item.productId);
                if (productIndex !== -1) {
                    products[productIndex].stock -= item.quantity;
                    productUpdatePromises.push(db.put('products', products[productIndex]));
                }
            }
            
            let customerId = null;
            if(customerPhone) {
                let customer = customers.find(c => c.phone === customerPhone);
                if(!customer) {
                    customer = {
                        id: generateUniqueId('C'),
                        name: customerName,
                        phone: customerPhone,
                        address: customerAddress,
                        totalPurchased: 0,
                        totalPaid: 0,
                        currentDue: 0
                    };
                    customers.push(customer);
                }
                customer.totalPurchased += finalAmount;
                if(status !== 'বাকি') {
                    customer.totalPaid += finalAmount;
                } else {
                    customer.currentDue += finalAmount;
                }
                await db.put('customers', customer);
                customerId = customer.id;
            }

            // Calculate cash and due amounts based on payment method
            let cashAmount = 0;
            let dueAmount = 0;
            if (paymentMethod === 'cash') {
                cashAmount = finalAmount;
                dueAmount = 0;
            } else if (paymentMethod === 'due') {
                cashAmount = 0;
                dueAmount = finalAmount;
            } else if (paymentMethod === 'bank') {
                cashAmount = finalAmount;
                dueAmount = 0;
            }

            const newSale = {
                id: saleId, saleId, timestamp, sellerId, customerId, customerName, customerPhone, customerAddress, totalAmount, 
                discountAmount, finalAmount, cashAmount, dueAmount, profit: totalProfit, paymentMethod, status, type: 'sale', items: currentCart, isRevised: false
            };
            
            sales.push(newSale);
            const dbPromises = [...productUpdatePromises, db.put('sales', newSale), db.put('settings', shopSettings)]; // Save updated invoice counter

            if (status === 'বাকি') {
                const newDue = {
                    id: generateUniqueId('D'), dueId: generateUniqueId('D'), saleId: saleId, customerId: customerId, customerName: customerName, customerPhone: customerPhone,
                    originalAmount: finalAmount, remainingAmount: finalAmount, paidAmount: 0, dateIssued: timestamp, description: `Sale #${saleId}`, billType: 'sale', appliesToMonths: []
                };
                dues.push(newDue);
                dbPromises.push(db.put('dues', newDue));
            } else if (paymentMethod === 'cash') {
                const newLedgerEntry = {
                    id: generateUniqueId('L'), timestamp: timestamp, type: 'income', category: 'sales_income',
                    description: `বিক্রয় থেকে আয় - বিল: ${saleId}`, amount: finalAmount, customerId: customerId, customerName: customerName, saleId: saleId,
                };
                ledgerEntries.push(newLedgerEntry);
                dbPromises.push(db.put('ledgerEntries', newLedgerEntry));
            } else if (paymentMethod === 'bank') {
                const selectedBank = banks.find(b => b.id === posBankSelect.value);
                selectedBank.currentBalance = (selectedBank.currentBalance || 0) + finalAmount;
                dbPromises.push(db.put('banks', selectedBank));
                
                const newBankTx = {
                    id: generateUniqueId('BTX'), timestamp: timestamp, bankId: selectedBank.id, bankName: selectedBank.name, type: 'credit', 
                    amount: finalAmount, category: 'customer_bank_payment', description: `বিক্রয় থেকে আয় - বিল: ${saleId}`,
                    customerName: customerName
                };
                bankTransactions.push(newBankTx);
                dbPromises.push(db.put('bankTransactions', newBankTx));
            }

            await Promise.all(dbPromises);
            updateAllUI();

            alert('বিক্রয় সফলভাবে সম্পন্ন হয়েছে!');
            const saleJustCompletedId = newSale.saleId;
            resetPOSPage();
            printBillBtn.style.display = 'block';
            printBillBtn.dataset.saleId = saleJustCompletedId;
        }

        // ✅ NEW: Function to handle sale update logic
        async function handleSaleUpdate() {
            const saleToUpdate = sales.find(s => s.id === currentEditingSale.id);
            if (!saleToUpdate) {
                alert("এডিট করার জন্য মূল বিক্রয় খুঁজে পাওয়া যায়নি।");
                resetPOSPage();
                return;
            }
            
            const dbPromises = [];

            // 1. Revert old stock quantities
            for (const oldItem of currentEditingSale.items) {
                const product = products.find(p => p.id === oldItem.productId);
                if (product) {
                    product.stock += oldItem.quantity;
                }
            }

            // 2. Deduct new stock quantities and calculate new totals
            let newTotalAmount = 0;
            let newTotalProfit = 0;
            for (const newItem of currentCart) {
                const product = products.find(p => p.id === newItem.productId);
                if (!product || product.stock < newItem.quantity) {
                    alert(`দুঃখিত, ${product.name} স্টকে পর্যাপ্ত নেই।`);
                    // Rollback stock changes before returning
                    for (const oldItem of currentEditingSale.items) {
                        const p = products.find(p => p.id === oldItem.productId);
                        if(p) p.stock -= oldItem.quantity;
                    }
                    return;
                }
                product.stock -= newItem.quantity;
                dbPromises.push(db.put('products', product));
                
                newTotalAmount += newItem.quantity * newItem.unitPrice;
                newTotalProfit += (newItem.unitPrice - (newItem.purchasePrice || 0)) * newItem.quantity;
            }
            
            // 3. Update sale object
            const newDiscount = parseFloat(discountAmountInput.value) || 0;
            const newFinalAmount = newTotalAmount - newDiscount;

            // TODO: Financial reversal and update logic needs to be carefully implemented here.
            // For simplicity in this update, we will adjust customer totals. A full system would require reversing ledger entries.
            const customer = customers.find(c => c.id === saleToUpdate.customerId);
            if (customer) {
                // Revert old amounts
                customer.totalPurchased -= saleToUpdate.finalAmount;
                if (saleToUpdate.status !== 'বাকি') customer.totalPaid -= saleToUpdate.finalAmount;
                else customer.currentDue -= saleToUpdate.finalAmount;
                
                // Apply new amounts
                customer.totalPurchased += newFinalAmount;
                if (paymentMethodSelect.value !== 'due') customer.totalPaid += newFinalAmount;
                else customer.currentDue += newFinalAmount;

                dbPromises.push(db.put('customers', customer));
            }
            
            // Calculate cash and due amounts based on payment method
            let newCashAmount = 0;
            let newDueAmount = 0;
            const newPaymentMethod = paymentMethodSelect.value;
            if (newPaymentMethod === 'cash') {
                newCashAmount = newFinalAmount;
                newDueAmount = 0;
            } else if (newPaymentMethod === 'due') {
                newCashAmount = 0;
                newDueAmount = newFinalAmount;
            } else if (newPaymentMethod === 'bank') {
                newCashAmount = newFinalAmount;
                newDueAmount = 0;
            }

            // Update the sale record itself
            saleToUpdate.items = currentCart;
            saleToUpdate.totalAmount = newTotalAmount;
            saleToUpdate.discountAmount = newDiscount;
            saleToUpdate.finalAmount = newFinalAmount;
            saleToUpdate.cashAmount = newCashAmount;
            saleToUpdate.dueAmount = newDueAmount;
            saleToUpdate.profit = newTotalProfit;
            saleToUpdate.paymentMethod = newPaymentMethod;
            saleToUpdate.status = (newPaymentMethod === 'due') ? 'বাকি' : 'সম্পূর্ণ';
            saleToUpdate.isRevised = true;
            saleToUpdate.timestamp = new Date().toISOString(); // Update timestamp to reflect edit time
            
            dbPromises.push(db.put('sales', saleToUpdate));

            await Promise.all(dbPromises);

            alert('বিক্রয় সফলভাবে আপডেট করা হয়েছে!');
            const saleJustCompletedId = saleToUpdate.saleId;
            resetPOSPage();
            
            printBillBtn.style.display = 'block';
            printBillBtn.dataset.saleId = saleJustCompletedId;
            
            // Refresh UI and navigate to sales report
            updateAllUI();
            showSection('sales');
        }

        printBillBtn.addEventListener('click', () => {
            const saleIdToPrint = printBillBtn.dataset.saleId;
            if (saleIdToPrint) {
                printBill(saleIdToPrint);
            } else {
                alert('প্রিন্ট করার জন্য কোনো বিল নেই।');
            }
        });
        
        cancelSaleEditBtn.addEventListener('click', () => {
             if (confirm('আপনি কি বিক্রয় সম্পাদনা বাতিল করতে চান? কোনো পরিবর্তন সেভ হবে না।')) {
                resetPOSPage();
                showSection('sales');
            }
        });
        
        // =================================================================================
        // ======================= 1. BILL DESIGN / LANGUAGE UPDATE START ==================
        // =================================================================================

        /**
         * Converts a number into English words (supports up to trillions).
         * @param {number} n The number to convert.
         * @returns {string} The number in English words.
         */
        const numberToEnglishWords = (function () {
            const units = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine'];
            const teens = ['Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
            const tens = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
            const scales = ['', 'Thousand', 'Million', 'Billion', 'Trillion'];

            function convertBelowThousand(n) {
                let s = '';
                const h = Math.floor(n / 100);
                const t = Math.floor((n % 100) / 10);
                const u = n % 10;

                if (h > 0) {
                    s += units[h] + ' Hundred';
                }

                if (t > 0 || u > 0) {
                    if (h > 0 && (t > 0 || u > 0)) s += ' and '; // Optional: 'and' can be omitted for formal style

                    if (t === 1) {
                        s += teens[u];
                    } else {
                        s += tens[t];
                        if (u > 0) {
                            if (t > 1) s += ' ';
                            s += units[u];
                        }
                    }
                }
                return s;
            }

            return function (n) {
                if (typeof n !== 'number') return '';
                n = Math.round(n * 100) / 100; // Round to 2 decimal places

                const integerPart = Math.floor(n);
                const decimalPart = Math.round((n - integerPart) * 100);

                if (integerPart === 0 && decimalPart === 0) return 'Zero';
                if (integerPart < 0) return 'Negative ' + numberToEnglishWords(-integerPart);

                let words = '';
                let temp = integerPart;
                let scaleIndex = 0;

                while (temp > 0) {
                    const group = temp % 1000;
                    if (group > 0) {
                        const groupWords = convertBelowThousand(group);
                        if (scaleIndex > 0) {
                            words = groupWords + ' ' + scales[scaleIndex] + (words ? ' ' + words : '');
                        } else {
                            words = groupWords;
                        }
                    }
                    temp = Math.floor(temp / 1000);
                    scaleIndex++;
                }

                if (!words) words = 'Zero';

                let decimalWords = '';
                if (decimalPart > 0) {
                    decimalWords = ' and ' + convertBelowThousand(decimalPart) + ' Paisa';
                }

                return words + decimalWords;
            };
        })();


        /**
         * Overrides the existing printBill function with the new English, structured template.
         * @param {string} saleId 
         */
        function printBill(saleId) {
            const sale = sales.find(s => s.saleId === saleId && (s.type === 'sale' || s.type === 'return'));
            if (!sale) {
                alert('Invoice not found.');
                return;
            }

            const totalQty = sale.items.reduce((sum, item) => sum + item.quantity, 0);
            const subtotalAmount = sale.items.reduce((sum, item) => sum + (item.quantity * item.unitPrice), 0);
            const finalAmount = sale.finalAmount;
            const discount = sale.discountAmount;
            const sellerName = users.find(u => u.id === sale.sellerId)?.displayName || 'N/A';
            const customerNameDisplay = sale.customerName !== 'ক্যাশ কাস্টমার' ? sale.customerName : 'CASH CUSTOMER';
            const formattedDate = moment(sale.timestamp).format('DD-MMM-YY h:mm A');
            const amountInWords = numberToEnglishWords(Math.abs(finalAmount)) + ' Only';
            
            const shopPhoneCell = shopSettings.phoneCell || '+88-031-XXXXXXX, Cell: 018XX-XXXXXX';
            const shopVatReg = shopSettings.vatReg || 'VAT Reg. No.: N/A';
            const logoHtml = shopSettings.logoUrl ? `<div class="center"><img src="${shopSettings.logoUrl}" alt="Logo" style="max-height: 80px; max-width: 200px; margin-bottom: 10px;"></div>` : '';

            // Editable Invoice Enhancement: Check for revision
            const isRevised = sale.isRevised === true;
            const invoiceTitle = isRevised ? 'REVISED INVOICE' : (sale.type === 'sale' ? 'CASH MEMO' : 'RETURN MEMO');


            let itemsHtml = ``;
            let itemCounter = 1;
            sale.items.forEach(item => {
                const product = products.find(p => p.id === item.productId);
                const sn = product && product.serialNumber ? ` S/N: ${product.serialNumber}` : '';
                const itemInfo = `${item.name.toUpperCase()}${sn}`;

                itemsHtml += `
                    <tr>
                        <td style="width: 5%; text-align: center; border: 1px solid #000; padding: 5px;">${itemCounter++}</td>
                        <td style="width: 45%; border: 1px solid #000; padding: 5px; font-size: 10px;">${itemInfo}</td>
                        <td style="width: 10%; text-align: right; border: 1px solid #000; padding: 5px;">${item.quantity.toLocaleString()}</td>
                        <td style="width: 20%; text-align: right; border: 1px solid #000; padding: 5px;">${item.unitPrice.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                        <td style="width: 20%; text-align: right; border: 1px solid #000; padding: 5px;">${(item.quantity * item.unitPrice).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    </tr>
                `;
            });

            // Bill Header Structure matching the sample image
            let printContents = `
                <div style="font-family: 'monospace', 'Courier New', Courier, sans-serif; font-size: 12px; line-height: 1.2; color: #000; max-width: 100%;">
                    ${logoHtml}
                    <h2 class="center" style="margin-bottom: 5px; font-size: 18px;">M/S. ${shopSettings.name.toUpperCase()}</h2>
                    <p class="center" style="margin-top: 0; margin-bottom: 2px;">${shopSettings.address}</p>
                    <p class="center" style="margin-top: 0; margin-bottom: 2px;">Tel: ${shopPhoneCell}</p>
                    <p class="center" style="margin-top: 0; margin-bottom: 10px;">${shopVatReg}</p>
                    <hr style="border-top: 1px solid #000;">
                    <h3 class="center" style="font-size: 16px; margin: 10px 0;">${invoiceTitle}</h3>
                    
                    <div style="display: flex; justify-content: space-between; flex-wrap: wrap;">
                         <div style="width: 48%; display: flex; flex-wrap: wrap;">
                            <p style="margin: 2px 0; width: 30%;">Date</p><p style="margin: 2px 0; width: 70%;">: ${moment(sale.timestamp).format('DD-MMM-YY')}</p>
                            <p style="margin: 2px 0; width: 30%;">Sales To</p><p style="margin: 2px 0; width: 70%;">: ${customerNameDisplay.toUpperCase()}</p>
                            <p style="margin: 2px 0; width: 30%;">Remarks</p><p style="margin: 2px 0; width: 70%;">:</p>
                        </div>
                        <div style="width: 48%; text-align: right; display: flex; flex-wrap: wrap; justify-content: flex-end;">
                             <p style="margin: 2px 0; width: 50%; text-align: left;">Invoice No</p><p style="margin: 2px 0; width: 50%; text-align: right;">: ${sale.saleId}</p>
                             <p style="margin: 2px 0; width: 50%; text-align: left;">Time</p><p style="margin: 2px 0; width: 50%; text-align: right;">: ${moment(sale.timestamp).format('h:mm A')}</p>
                             <p style="margin: 2px 0; width: 50%; text-align: left;">Sales Memo No</p><p style="margin: 2px 0; width: 50%; text-align: right;">:</p>
                        </div>
                    </div>
                    <hr style="border-top: 1px solid #000; margin-top: 10px;">
                    
                    <table style="width: 100%; border-collapse: collapse; margin: 10px 0; border: 1px solid #000;">
                        <thead>
                            <tr style="border: 1px solid #000;">
                                <th style="width: 5%; text-align: center; border: 1px solid #000; padding: 5px;">SL</th>
                                <th style="width: 45%; border: 1px solid #000; padding: 5px;">Item Information</th>
                                <th style="width: 10%; text-align: right; border: 1px solid #000; padding: 5px;">Qty</th>
                                <th style="width: 20%; text-align: right; border: 1px solid #000; padding: 5px;">Rate</th>
                                <th style="width: 20%; text-align: right; border: 1px solid #000; padding: 5px;">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsHtml}
                             <!-- Subtotal Row -->
                            <tr style="border: none;">
                                <td colspan="2" style="border: none; padding: 5px 5px 5px 20px; font-weight: bold; text-align: left;">Total Items:</td>
                                <td style="border: 1px solid #000; padding: 5px; font-weight: bold; text-align: right;">${totalQty.toLocaleString()}</td>
                                <td style="border: 1px solid #000; padding: 5px; font-weight: bold; text-align: right;">Total :</td>
                                <td style="border: 1px solid #000; padding: 5px; font-weight: bold; text-align: right;">${subtotalAmount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                            </tr>
                        </tbody>
                    </table>

                    <div style="margin-top: 10px; display: flex; flex-wrap: wrap;">
                        <p style="margin: 0; width: 60%;">In Words : ${amountInWords}</p>
                        <div style="width: 40%; text-align: right; padding-right: 5px; box-sizing: border-box;">
                             <p style="margin: 0;">Discount : ${discount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</p>
                             <p style="margin: 0; border-top: 2px double #000; font-weight: bold; padding-top: 3px;">Net Amount : ${Math.abs(finalAmount).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</p>
                        </div>
                    </div>

                    <div style="margin-top: 50px; display: flex; justify-content: space-around;">
                        <div style="width: 20%; text-align: center; border-top: 1px solid #000; padding-top: 5px;">Prepared By (${sellerName})</div>
                        <div style="width: 20%; text-align: center; border-top: 1px solid #000; padding-top: 5px;">Received By</div>
                        <div style="width: 20%; text-align: center; border-top: 1px solid #000; padding-top: 5px;">Checked By</div>
                        <div style="width: 20%; text-align: center; border-top: 1px solid #000; padding-top: 5px;">Authorized By</div>
                    </div>
                </div>
            `;

            launchPrint('Sales Invoice', printContents);
        }

        // =================================================================================
        // ======================= 1. BILL DESIGN / LANGUAGE UPDATE END ====================
        // =================================================================================


        // --- Sales Report (Original) ---
        function renderSalesReport() {
            const fromDateStr = salesReportFromDateInput.value;
            const toDateStr = salesReportToDateInput.value;
            const filterSellerId = salesReportSellerSelect.value;
            const searchTerm = salesReportSearchInput.value.trim();

            salesReportTableBody.innerHTML = '';
            let filteredTransactions = sales.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));

            if (fromDateStr || toDateStr) {
                const fromDate = fromDateStr ? moment(fromDateStr).startOf('day') : null;
                const toDate = toDateStr ? moment(toDateStr).endOf('day') : null;

                filteredTransactions = filteredTransactions.filter(transaction => {
                    const transactionDate = moment(transaction.timestamp);
                    return (!fromDate || transactionDate.isSameOrAfter(fromDate)) &&
                           (!toDate || transactionDate.isSameOrBefore(toDate));
                });
            }

            if (filterSellerId) {
                filteredTransactions = filteredTransactions.filter(transaction => transaction.sellerId === filterSellerId);
            }

            if (currentUser && currentUser.role === 'seller') {
                filteredTransactions = filteredTransactions.filter(transaction => transaction.sellerId === currentUser.id);
            }

            if (searchTerm) {
                const lowerCaseSearchTerm = searchTerm.toLowerCase();
                filteredTransactions = filteredTransactions.filter(transaction =>
                    transaction.customerName.toLowerCase().includes(lowerCaseSearchTerm) ||
                    (transaction.customerPhone && transaction.customerPhone.toLowerCase().includes(lowerCaseSearchTerm)) ||
                    transaction.saleId.toLowerCase().includes(lowerCaseSearchTerm)
                );
            }

            let netFilteredSalesTotal = 0;
            let netFilteredProfit = 0;
            let totalProductsSold = 0;
            let totalLossFromReturns = 0;

            filteredTransactions.forEach(transaction => {
                // Skip deleted bills in totals
                if (transaction.status === 'বাতিল') {
                    return;
                }
                
                if (transaction.type === 'sale') {
                    netFilteredSalesTotal += transaction.finalAmount;
                    netFilteredProfit += transaction.profit || 0;
                    transaction.items.forEach(item => {
                        totalProductsSold += item.quantity;
                    });
                } else if (transaction.type === 'return') {
                    netFilteredSalesTotal += transaction.finalAmount; 
                    netFilteredProfit += transaction.profit || 0; 
                    totalLossFromReturns += Math.abs(transaction.profit || 0); 
                    transaction.items.forEach(item => {
                        totalProductsSold -= item.quantity; 
                    });
                }
            });

            let totalStockValue = 0;
            products.forEach(p => {
                totalStockValue += p.stock * (p.purchasePrice || 0);
            });


            filteredSalesTotalSpan.textContent = `৳ ${netFilteredSalesTotal.toLocaleString()}`;
            filteredSalesProfitSpan.textContent = `মোট লাভ: ৳ ${netFilteredProfit.toLocaleString()}`;
            filteredProductsSoldSpan.textContent = `মোট বিক্রি হওয়া পণ্য: ${totalProductsSold} পিস`;
            filteredStockValueSpan.textContent = `বর্তমান স্টকের পণ্যের পণ্যের মোট ক্রয় মূল্য: ৳ ${totalStockValue.toLocaleString()}`;
            filteredTotalLossSpan.textContent = `ফেরত পণ্যের মোট ক্ষতি: ৳ ${totalLossFromReturns.toLocaleString()}`;


            if (currentUser && currentUser.role !== 'admin') { 
                 filteredSalesProfitSpan.style.display = 'none';
                 filteredTotalLossSpan.style.display = 'none';
            } else {
                 filteredSalesProfitSpan.style.display = 'block';
                 filteredTotalLossSpan.style.display = 'block';
            }


            if (filteredTransactions.length === 0) {
                const row = salesReportTableBody.insertRow();
                const cell = row.insertCell(0);
                cell.colSpan = 10;
                cell.textContent = 'কোনো লেনদেন খুঁজে পাওয়া যায়নি।';
                return;
            }

            filteredTransactions.forEach(transaction => {
                const row = salesReportTableBody.insertRow();
                const isReturn = transaction.type === 'return';
                const isDeleted = transaction.status === 'বাতিল';
                
                if (isReturn) {
                    row.classList.add('return-row');
                }
                if (isDeleted) {
                    row.style.backgroundColor = '#3a1f1f';
                    row.style.opacity = '0.7';
                    row.style.textDecoration = 'line-through';
                }

                row.insertCell(0).textContent = transaction.saleId + (transaction.isRevised ? ' (সম্পাদিত)' : '') + (isDeleted ? ' [ডিলিট করা হয়েছে]' : '');
                row.insertCell(1).textContent = new Date(transaction.timestamp).toLocaleString();
                row.insertCell(2).textContent = users.find(u => u.id === transaction.sellerId)?.displayName || users.find(u => u.id === transaction.sellerId)?.username || 'N/A';
                row.insertCell(3).textContent = transaction.customerName;
                row.insertCell(4).textContent = `৳ ${transaction.finalAmount.toLocaleString()}`;
                const profitCell = row.insertCell(5);
                if (currentUser && currentUser.role === 'admin') {
                    profitCell.textContent = `৳ ${(transaction.profit || 0).toLocaleString()}`;
                    profitCell.style.color = (transaction.profit || 0) < 0 ? '#dc3545' : '#28a745'; 
                } else {
                    profitCell.textContent = '***';
                }


                row.insertCell(6).textContent = isReturn ? 'ফেরত' : (transaction.paymentMethod === 'cash' ? 'নগদ (Cash)' : transaction.paymentMethod === 'bank' ? 'ব্যাংক' : transaction.status);
                row.insertCell(7).textContent = isReturn ? 'ফেরত' : transaction.status;

                const itemsCell = row.insertCell(8);
                const itemsList = document.createElement('ul');
                itemsList.style.listStyle = 'none';
                itemsList.style.padding = '0';
                transaction.items.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = `${item.name} x ${item.quantity} @ ৳ ${item.unitPrice.toLocaleString()}`;
                    itemsList.appendChild(li);
                });
                itemsCell.appendChild(itemsList);

                const actionCell = row.insertCell(9); 
                actionCell.className = 'table-action-buttons';

                const printBtn = document.createElement('button');
                printBtn.textContent = 'প্রিন্ট বিল';
                printBtn.className = 'primary-btn';
                printBtn.addEventListener('click', () => printBill(transaction.saleId));
                actionCell.appendChild(printBtn);
                
                // ✅ NEW: Enable edit button only for admin on non-returned, non-deleted sales
                if (currentUser && currentUser.role === 'admin' && !isReturn && !isDeleted && transaction.status !== 'বাতিল') {
                    const editBtn = document.createElement('button');
                    editBtn.textContent = 'সম্পাদনা';
                    editBtn.className = 'edit-btn';
                    editBtn.addEventListener('click', () => loadSaleForEditing(transaction.id));
                    actionCell.appendChild(editBtn);
                }
                
                // ✅ NEW: Delete button for admin users (only for non-deleted sales)
                if (currentUser && currentUser.role === 'admin' && transaction.type === 'sale' && !isDeleted) {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'ডিলিট';
                    deleteBtn.className = 'danger-btn';
                    deleteBtn.style.background = '#dc3545';
                    deleteBtn.style.marginLeft = '5px';
                    deleteBtn.addEventListener('click', () => deleteBill(transaction.id));
                    actionCell.appendChild(deleteBtn);
                }
            });
        }

        function populateSellerFilter() {
            salesReportSellerSelect.innerHTML = '<option value="">সকল সেলার</option>';
            const sellers = users.filter(u => u.role === 'seller' || u.role === 'admin');
            sellers.forEach(seller => {
                const option = document.createElement('option');
                option.value = seller.id;
                option.textContent = seller.displayName || seller.username;
                salesReportSellerSelect.appendChild(option);
            });

            if (currentUser && currentUser.role === 'seller') {
                salesReportSellerSelect.value = currentUser.id;
                salesReportSellerSelect.disabled = true;
            } else {
                salesReportSellerSelect.disabled = false;
            }
        }

        filterSalesReportBtn.addEventListener('click', renderSalesReport);
        
        // ✅ NEW: loadSaleForEditing function
        function loadSaleForEditing(saleId) {
            const saleToEdit = sales.find(s => s.id === saleId && s.type === 'sale');
            if (!saleToEdit) {
                alert('বিক্রয় খুঁজে পাওয়া যায়নি!');
                return;
            }

            if (confirm('আপনি কি এই বিক্রয়টি সম্পাদনা করতে চান? এটি আপনাকে বিক্রয় (POS) পৃষ্ঠায় নিয়ে যাবে এবং বর্তমান কার্টটি এই বিলের পণ্য দ্বারা প্রতিস্থাপিত হবে।')) {
                currentEditingSale = JSON.parse(JSON.stringify(saleToEdit));
                currentCart = JSON.parse(JSON.stringify(saleToEdit.items));
                
                showSection('pos');

                posCustomerNameInput.value = saleToEdit.customerName;
                posCustomerPhoneInput.value = saleToEdit.customerPhone;
                posCustomerAddressInput.value = saleToEdit.customerAddress;
                discountAmountInput.value = saleToEdit.discountAmount;
                paymentMethodSelect.value = saleToEdit.paymentMethod;
                
                if (saleToEdit.paymentMethod === 'bank' && saleToEdit.bankId) {
                    posBankSelectContainer.style.display = 'block';
                    posBankSelect.value = saleToEdit.bankId;
                } else {
                    posBankSelectContainer.style.display = 'none';
                }

                renderCart();
                updateCartTotal();
                
                completeSaleBtn.innerHTML = '<i class="fas fa-save"></i> বিক্রয় আপডেট করুন';
                completeSaleBtn.dataset.editing = 'true';
                cancelSaleEditBtn.style.display = 'inline-block';
            }
        }

        // ✅ NEW: Delete Bill Function
        async function deleteBill(saleId) {
            const saleToDelete = sales.find(s => s.id === saleId && s.type === 'sale');
            if (!saleToDelete) {
                alert('বিল খুঁজে পাওয়া যায়নি!');
                return;
            }

            // Confirmation dialog with bill details
            const confirmMessage = 
                `⚠️ সতর্কতা: আপনি এই বিলটি ডিলিট করতে চলেছেন!\n\n` +
                `বিল আইডি: ${saleToDelete.saleId}\n` +
                `কাস্টমার: ${saleToDelete.customerName}\n` +
                `মোট টাকা: ৳ ${saleToDelete.finalAmount.toLocaleString()}\n` +
                `তারিখ: ${moment(saleToDelete.timestamp).format('Do MMMM, YYYY')}\n\n` +
                `ডিলিট করলে:\n` +
                `• বিক্রি হওয়া পণ্য স্টকে ফিরে যাবে\n` +
                `• কাস্টমারের বাকি (যদি থাকে) সমন্বয় হবে\n` +
                `• লেজার এন্ট্রি মুছে যাবে\n` +
                `• ব্যাংক লেনদেন (যদি থাকে) সমন্বয় হবে\n\n` +
                `আপনি কি নিশ্চিত?`;
            
            if (!confirm(confirmMessage)) {
                return;
            }

            // Second confirmation for safety
            if (!confirm(`আবার নিশ্চিত করুন: বিল #${saleToDelete.saleId} ডিলিট করা হবে। এই কাজটি অপরিবর্তনীয়!`)) {
                return;
            }

            try {
                showLoader();
                const dbPromises = [];

                // 1. Restore stock for all items in the sale
                for (const item of saleToDelete.items) {
                    const product = products.find(p => p.id === item.productId);
                    if (product) {
                        product.stock += item.quantity;
                        dbPromises.push(db.put('products', product));
                    }
                }

                // 2. Update customer data if customer exists
                if (saleToDelete.customerId) {
                    const customer = customers.find(c => c.id === saleToDelete.customerId);
                    if (customer) {
                        // Reduce total purchased
                        customer.totalPurchased = Math.max(0, (customer.totalPurchased || 0) - saleToDelete.finalAmount);
                        
                        // If it was a due sale, reduce the due amount
                        if (saleToDelete.status === 'বাকি') {
                            customer.currentDue = Math.max(0, (customer.currentDue || 0) - saleToDelete.finalAmount);
                        } else {
                            // If paid, reduce total paid
                            customer.totalPaid = Math.max(0, (customer.totalPaid || 0) - saleToDelete.finalAmount);
                        }
                        
                        dbPromises.push(db.put('customers', customer));
                    }
                }

                // 3. Handle dues - delete any due entry for this sale
                const dueIndex = dues.findIndex(d => d.saleId === saleToDelete.saleId);
                if (dueIndex !== -1) {
                    const dueToDelete = dues[dueIndex];
                    await db.delete('dues', dueToDelete.id);
                    dues.splice(dueIndex, 1);
                }

                // 4. Handle ledger entries - delete income entries for this sale
                const ledgerEntriesToDelete = ledgerEntries.filter(l => l.saleId === saleToDelete.saleId);
                for (const ledgerEntry of ledgerEntriesToDelete) {
                    await db.delete('ledgerEntries', ledgerEntry.id);
                    const index = ledgerEntries.findIndex(l => l.id === ledgerEntry.id);
                    if (index !== -1) {
                        ledgerEntries.splice(index, 1);
                    }
                }

                // 5. Handle bank transactions - reverse bank credit and delete transaction record
                if (saleToDelete.paymentMethod === 'bank') {
                    // Find the bank transaction for this sale
                    const bankTxToDelete = bankTransactions.find(bt => 
                        bt.description && bt.description.includes(saleToDelete.saleId) && bt.type === 'credit'
                    );
                    
                    if (bankTxToDelete) {
                        // Find the bank and deduct the amount
                        const bank = banks.find(b => b.id === bankTxToDelete.bankId);
                        if (bank) {
                            bank.currentBalance = Math.max(0, (bank.currentBalance || 0) - saleToDelete.finalAmount);
                            dbPromises.push(db.put('banks', bank));
                        }
                        
                        // Delete bank transaction record
                        await db.delete('bankTransactions', bankTxToDelete.id);
                        const index = bankTransactions.findIndex(bt => bt.id === bankTxToDelete.id);
                        if (index !== -1) {
                            bankTransactions.splice(index, 1);
                        }
                    }
                }

                // 6. Mark the sale as deleted (soft delete) instead of actually removing it
                // This preserves data integrity while marking it as deleted
                saleToDelete.status = 'বাতিল';
                saleToDelete.deletedAt = new Date().toISOString();
                saleToDelete.deletedBy = currentUser.id;
                dbPromises.push(db.put('sales', saleToDelete));

                // Execute all database operations
                await Promise.all(dbPromises);

                hideLoader();
                
                alert(`✅ বিল #${saleToDelete.saleId} সফলভাবে ডিলিট করা হয়েছে!\n\n• পণ্য স্টকে ফিরে গেছে\n• কাস্টমার ডেটা আপডেট হয়েছে\n• লেজার/ব্যাংক এন্ট্রি সমন্বয় করা হয়েছে`);
                
                // Refresh the sales report
                renderSalesReport();
                
                // Refresh dashboard if visible
                if (document.getElementById('dashboard-section').classList.contains('active')) {
                    renderDashboard();
                }
                
            } catch (error) {
                hideLoader();
                console.error('Error deleting bill:', error);
                alert('❌ বিল ডিলিট করতে সমস্যা হয়েছে। অনুগ্রহ করে আবার চেষ্টা করুন।');
            }
        }

        printSalesSummaryBtn.addEventListener('click', () => {
             const fromDate = salesReportFromDateInput.value;
            const toDate = salesReportToDateInput.value;
            const summaryHtml = document.getElementById('sales-report-summary').innerHTML;
            const logoHtml = shopSettings.logoUrl ? `<div class="center"><img src="${shopSettings.logoUrl}" alt="Logo" style="max-height: 80px; max-width: 200px; margin-bottom: 10px;"></div>` : '';
            
            let printContent = `
                ${logoHtml}
                <h3 class='center'>বিক্রয় সারাংশ</h3>
                <p class='center'>${shopSettings.name}</p>
                <p class='center'>${fromDate ? moment(fromDate).format('LL') : 'শুরু'} থেকে ${toDate ? moment(toDate).format('LL') : 'আজ'}</p>
                <hr>
                ${summaryHtml.replace(/<button.*<\/button>/g, '')}
            `;
            launchPrint('বিক্রয় সারাংশ', printContent);
        });


        // --- Dues Management ---
        // --- START WRAPPER/MODULE FUNCTION (Must exist exactly like this in old code for internal functions)
        window.renderDuesList = function(searchTerm = '') {
            duesListTableBody.innerHTML = '';
            let filteredDues = dues.filter(d => d.remainingAmount > 0.01);

            if (searchTerm) {
                const lowerCaseSearchTerm = searchTerm.toLowerCase();
                filteredDues = filteredDues.filter(due =>
                    due.customerName.toLowerCase().includes(lowerCaseSearchTerm) ||
                    (due.customerPhone && due.customerPhone.toLowerCase().includes(lowerCaseSearchTerm)) ||
                    (due.saleId && due.saleId.toLowerCase().includes(lowerCaseSearchTerm))
                );
            }

            const totalDues = dues.reduce((sum, due) => sum + due.remainingAmount, 0);
            totalDuesAmountSpan.textContent = `৳ ${totalDues.toLocaleString()}`;


            if (filteredDues.length === 0) {
                const row = duesListTableBody.insertRow();
                const cell = row.insertCell(0);
                // Colspan extended for the new 'Message' column
                cell.colSpan = 8; 
                cell.textContent = 'কোনো বাকি টাকা খুঁজে পাওয়া যায়নি।';
                return;
            }

            // Ensure Header has 'Message' column
            const header = document.querySelector('#dues-list-table thead tr');
            if (header.cells.length === 7) { // If 'Message' is missing
                 const newTh = document.createElement('th');
                 newTh.textContent = 'মেসেজ';
                 header.appendChild(newTh);
            }
            if (header.cells.length === 8 && header.cells[7].textContent !== 'মেসেজ') { // Quick Fix in case of multiple renders
                 header.cells[7].textContent = 'মেসেজ';
            }


            filteredDues.sort((a,b) => new Date(a.dateIssued) - new Date(b.dateIssued)).forEach(due => {
                const row = duesListTableBody.insertRow();
                row.insertCell(0).textContent = due.customerName;
                row.insertCell(1).textContent = due.customerPhone;
                row.insertCell(2).textContent = due.description || due.saleId;
                row.insertCell(3).textContent = `৳ ${due.remainingAmount.toLocaleString()}`;
                row.insertCell(4).textContent = `৳ ${due.originalAmount.toLocaleString()}`;
                row.insertCell(5).textContent = `৳ ${due.paidAmount.toLocaleString()}`; 

                const actionCell = row.insertCell(6);
                actionCell.className = 'table-action-buttons';

                const payBtn = document.createElement('button');
                payBtn.textContent = 'পরিশোধ';
                payBtn.className = 'primary-btn';
                payBtn.addEventListener('click', () => openPayDueModal(due));
                actionCell.appendChild(payBtn);
                
                 // 6. Alert System - Add WhatsApp Link button
                const messageCell = row.insertCell(7);
                 const whatsAppBtn = document.createElement('button');
                 whatsAppBtn.innerHTML = '<i class="fab fa-whatsapp"></i> মেসেজ';
                 whatsAppBtn.className = 'primary-btn info-btn'; 
                 whatsAppBtn.style.padding = '5px 10px';
                 whatsAppBtn.addEventListener('click', () => {
                    const dueAmount = parseFloat(due.remainingAmount);
                    window.sendWhatsAppDueAlert(due.customerPhone, due.customerName, dueAmount);
                 });
                 messageCell.className = 'table-action-buttons';
                 messageCell.appendChild(whatsAppBtn);
            });
        }
        // --- END WRAPPER/MODULE FUNCTION ---

        duesSearchInput.addEventListener('input', (e) => {
            renderDuesList(e.target.value.trim());
        });

        let currentDueForPayment = null;

        // --- NEW/MODIFIED: openPayDueModal now targets the entire customer due and supports Bank payment ---
        function openPayDueModal(due) {
            const customer = customers.find(c => c.id === due.customerId || c.phone === due.customerPhone); 
            
            if (!customer) {
                alert('কাস্টমার ডেটা খুঁজে পাওয়া যায়নি।');
                return;
            }

            currentDueForPayment = due;
            const totalCustomerDue = customer.currentDue;

            modalDueCustomerName.textContent = customer.name;
            modalDueTotalOutstanding.textContent = `৳ ${totalCustomerDue.toLocaleString()}`;
            paymentAmountInput.value = due.remainingAmount;
            paymentAmountInput.max = totalCustomerDue;
            paymentMethodDueSelect.value = 'cash';
            dueBankSelectContainer.style.display = 'none';
            updateModalRemainingDue();
            paymentReceiptSection.style.display = 'none';
            processDuePaymentBtn.disabled = false;
            paymentAmountInput.disabled = false;
            paymentMethodDueSelect.disabled = false;

            payDueModal.style.display = 'flex';
        }
        
        // NEW: Toggle bank selection based on payment method in Due Modal
        paymentMethodDueSelect.addEventListener('change', (e) => {
             dueBankSelectContainer.style.display = e.target.value === 'bank' ? 'block' : 'none';
        });

        document.querySelectorAll('#pay-due-modal .close-button').forEach(btn => {
            btn.addEventListener('click', () => {
                payDueModal.style.display = 'none';
                currentDueForPayment = null;
            });
        });

        paymentAmountInput.addEventListener('input', updateModalRemainingDue);

        function updateModalRemainingDue() {
            if (!currentDueForPayment) return;
            const customer = customers.find(c => c.id === currentDueForPayment.customerId || c.phone === currentDueForPayment.customerPhone);
            if (!customer) return;
            
             const totalCustomerDue = customer.currentDue;
            const paidAmount = parseFloat(paymentAmountInput.value) || 0;
            const remaining = totalCustomerDue - paidAmount;
            modalDueRemaining.textContent = `৳ ${Math.max(0, remaining).toLocaleString()}`;
            modalDueRemaining.style.color = remaining > 0 ? 'red' : 'green';
        }

        processDuePaymentBtn.addEventListener('click', async () => {
            if (!currentDueForPayment) return;

            let paidAmount = parseFloat(paymentAmountInput.value);
            const paymentMethod = paymentMethodDueSelect.value;
            const selectedBankId = dueBankSelect.value;
            let selectedBank = null;

            const customerId = currentDueForPayment.customerId;
            const customer = customers.find(c => c.id === customerId);

            if (!customer) {
                alert('কাস্টমার খুঁজে পাওয়া যায়নি!');
                return;
            }

            if (isNaN(paidAmount) || paidAmount <= 0) {
                alert('বৈধ পরিমাণ প্রবেশ করান।');
                return;
            }
             if (paidAmount > (customer.currentDue || 0)) {
                if(!confirm(`পরিশোধের পরিমাণ (৳ ${paidAmount.toLocaleString()}) মোট বকেয়ার (৳ ${(customer.currentDue || 0).toLocaleString()}) চেয়ে বেশি। আপনি কি অতিরিক্ত পেমেন্ট হিসেবে সেভ করতে চান?`)){
                    return;
                }
            }
            if (paymentMethod === 'bank') {
                selectedBank = banks.find(b => b.id === selectedBankId);
                if (!selectedBank) {
                    alert('অনুগ্রহ করে একটি ব্যাংক নির্বাচন করুন।');
                    return;
                }
            }
            
            const dbPromises = [];
            const updatedDues = [];
            const paidDuesInfo = [];
            
            // FIFO Allocation Logic
            let remainingPaidAmount = paidAmount;
            const unpaidDues = dues
                .filter(d => d.customerId === customerId && d.remainingAmount > 0)
                .sort((a,b) => new Date(a.dateIssued) - new Date(b.dateIssued));

            for (const due of unpaidDues) {
                if (remainingPaidAmount <= 0) break;

                const amountToPay = Math.min(remainingPaidAmount, due.remainingAmount);
                
                due.paidAmount += amountToPay;
                due.remainingAmount -= amountToPay;
                remainingPaidAmount -= amountToPay;
                
                // Ledger/Bank Entry for this specific payment portion
                const descriptionBase = due.description.includes('Manual Due') ? due.description : `বাকি টাকা কালেকশন - ${due.description}`;

                if (paymentMethod === 'cash') {
                    // Rule 4: Cash Due Collection -> Ledger Income
                    const newLedgerEntry = {
                        id: generateUniqueId('L'), timestamp: new Date().toISOString(), type: 'income', category: 'due_collection',
                        description: descriptionBase, amount: amountToPay, customerId: due.customerId, customerName: due.customerName, saleId: due.saleId, appliedMonths: due.appliesToMonths || []
                    };
                    ledgerEntries.push(newLedgerEntry);
                    dbPromises.push(db.put('ledgerEntries', newLedgerEntry));
                } else if (paymentMethod === 'bank') {
                    // Rule 4: Bank Due Collection -> Bank Credit (NO Ledger)
                     selectedBank.currentBalance += amountToPay;
                     dbPromises.push(db.put('banks', selectedBank)); // <--- FIXED: Persist bank balance
                     
                     const newBankTx = {
                        id: generateUniqueId('BTX'), timestamp: new Date().toISOString(), bankId: selectedBank.id,
                        bankName: selectedBank.name, type: 'credit', amount: amountToPay,
                        category: 'customer_bank_payment', description: `বাকি কালেকশন: ${customer.name} - ${due.description}`,
                        customerName: customer.name
                    };
                    bankTransactions.push(newBankTx);
                    dbPromises.push(db.put('bankTransactions', newBankTx));
                }

                updatedDues.push(due);
                paidDuesInfo.push({ description: due.description, amount: amountToPay });
            }
            
            // Handle overpayment to Ledger/Bank
            if (remainingPaidAmount > 0.01) {
                 const overpaymentEntry = {
                    id: generateUniqueId('L'), timestamp: new Date().toISOString(), type: 'income', category: 'others',
                    description: `অতিরিক্ত বকেয়া পরিশোধ (Overpayment)`, amount: remainingPaidAmount, customerId: customer.id, customerName: customer.name
                };

                 if (paymentMethod === 'cash') {
                    ledgerEntries.push(overpaymentEntry);
                    dbPromises.push(db.put('ledgerEntries', overpaymentEntry));
                } else if (paymentMethod === 'bank') {
                     // Bank Credit for overpayment
                     selectedBank.currentBalance += remainingPaidAmount;
                     dbPromises.push(db.put('banks', selectedBank)); // <--- FIXED: Persist bank balance
                     
                     const newBankTx = {
                        id: generateUniqueId('BTX'), timestamp: new Date().toISOString(), bankId: selectedBank.id,
                        bankName: selectedBank.name, type: 'credit', amount: remainingPaidAmount,
                        category: 'customer_bank_payment', description: `অতিরিক্ত বাকি কালেকশন: ${customer.name}`,
                        customerName: customer.name
                    };
                    bankTransactions.push(newBankTx);
                    dbPromises.push(db.put('bankTransactions', newBankTx));
                }
            }


            // --- Customer Total Update ---
            customer.totalPaid = (customer.totalPaid || 0) + paidAmount;
            customer.currentDue = Math.max(0, (customer.currentDue || 0) - paidAmount); // Ensure no negative due in the field
            dbPromises.push(db.put('customers', customer));
            
            const customerIndex = customers.findIndex(c => c.id === customer.id);
            if(customerIndex !== -1) customers[customerIndex] = customer;
            
            // Update local bank array if applicable
            if(selectedBank) {
                const bankIndex = banks.findIndex(b => b.id === selectedBank.id);
                if(bankIndex !== -1) banks[bankIndex] = selectedBank;
            }


            // Update or delete due records in DB
            updatedDues.forEach(updatedDue => {
                 const index = dues.findIndex(d => d.id === updatedDue.id);
                 if (index !== -1) {
                     if (updatedDue.remainingAmount < 0.01) {
                         const originalSale = sales.find(s => s.saleId === updatedDue.saleId);
                         if (originalSale) {
                             originalSale.status = 'সম্পূর্ণ';
                             dbPromises.push(db.put('sales', originalSale));
                             const saleIndex = sales.findIndex(s => s.id === originalSale.id);
                             if(saleIndex !== -1) sales[saleIndex] = originalSale;
                         }
                         dbPromises.push(db.delete('dues', updatedDue.id));
                         dues = dues.filter(d => d.id !== updatedDue.id);
                     } else {
                         dbPromises.push(db.put('dues', updatedDue));
                         const dueIndex = dues.findIndex(d => d.id === updatedDue.id);
                         if(dueIndex !== -1) dues[dueIndex] = updatedDue;
                     }
                 }
            });

            await Promise.all(dbPromises);
            
            updateAllUI();


            alert('পেমেন্ট সফল হয়েছে!');
            
            printPaymentReceiptBtn.dataset.customerName = customer.name;
            printPaymentReceiptBtn.dataset.customerPhone = customer.phone;
            printPaymentReceiptBtn.dataset.paidAmount = paidAmount;
            printPaymentReceiptBtn.dataset.paymentMethod = paymentMethod;
            printPaymentReceiptBtn.dataset.remainingDue = customer.currentDue;
            printPaymentReceiptBtn.dataset.paidDuesInfo = JSON.stringify(paidDuesInfo);
            paymentReceiptSection.style.display = 'block';

            processDuePaymentBtn.disabled = true;
            paymentAmountInput.disabled = true;
            paymentMethodDueSelect.disabled = true;
        });

        printPaymentReceiptBtn.addEventListener('click', (e) => {
            const {customerName, customerPhone, paidAmount, paymentMethod, remainingDue, paidDuesInfo} = e.target.dataset;
            const paidBills = JSON.parse(paidDuesInfo);

            const paymentMethodText = paymentMethod === 'cash' ? 'নগদ' : 'ব্যাংক';
            const logoHtml = shopSettings.logoUrl ? `<div class="center"><img src="${shopSettings.logoUrl}" alt="Logo" style="max-height: 80px; max-width: 200px; margin-bottom: 10px;"></div>` : '';
            
            let paidBillsHtml = '<h4>পরিশোধিত বিলের বিবরণ</h4><table>';
            paidBills.forEach(bill => {
                paidBillsHtml += `<tr><td>${bill.description}</td><td class="right">৳ ${parseFloat(bill.amount).toLocaleString()}</td></tr>`;
            });
            paidBillsHtml += '</table>';

            let receiptContent = `
                ${logoHtml}
                <div class="center">
                    <h3>পরিশোধ রসিদ</h3>
                    <p>${shopSettings.name}</p>
                    <p>তারিখ: ${moment().format('lll')}</p>
                </div>
                <hr>
                <p>কাস্টমার: ${customerName} (${customerPhone})</p>
                <hr>
                ${paidBillsHtml}
                <hr>
                <p><strong>মোট পরিশোধিত: ৳ ${parseFloat(paidAmount).toLocaleString()}</strong></p>
                <p>ধরণ: ${paymentMethodText}</p>
                <p>এখন বাকি থাকবে: ৳ ${parseFloat(remainingDue).toLocaleString()}</p>
                <hr>
                <p class="center">ধন্যবাদ!</p>
            `;
            
            launchPrint('পরিশোধ রসিদ', receiptContent);

            payDueModal.style.display = 'none';
            currentDueForPayment = null;
        });


        // --- Returns Management (Original) ---
        returnSaleSearchInput.addEventListener('input', () => {
            returnSearchResults.style.display = 'none';
            noReturnSearchResults.style.display = 'none';
            returnDetailsContainer.style.display = 'none';
            returnSuccessMessage.style.display = 'none';
        });

        searchSaleForReturnBtn.addEventListener('click', () => {
            const searchTerm = returnSaleSearchInput.value.trim().toLowerCase();
            returnSearchResultsTableBody.innerHTML = '';
            returnSearchResults.style.display = 'none';
            noReturnSearchResults.style.display = 'none';
            returnDetailsContainer.style.display = 'none';
            returnSuccessMessage.style.display = 'none';

            if (!searchTerm) {
                alert('অনুসন্ধানের জন্য বিক্রয় আইডি, কাস্টমার নাম বা নম্বর লিখুন।');
                return;
            }

            const matchedSales = sales.filter(s => s.type === 'sale' &&
                (s.saleId.toLowerCase().includes(searchTerm) ||
                s.customerName.toLowerCase().includes(searchTerm) ||
                (s.customerPhone && s.customerPhone.toLowerCase().includes(searchTerm)))
            );

            if (matchedSales.length > 0) {
                matchedSales.forEach(sale => {
                    const row = returnSearchResultsTableBody.insertRow();
                    row.innerHTML = `
                        <td>${sale.saleId}</td>
                        <td>${new Date(sale.timestamp).toLocaleDateString()}</td>
                        <td>${sale.customerName} (${sale.customerPhone})</td>
                        <td>৳ ${sale.finalAmount.toLocaleString()}</td>
                        <td><button class="primary-btn select-sale-for-return" data-sale-id="${sale.saleId}"><i class="fas fa-arrow-right"></i> নির্বাচন করুন</button></td>
                    `;
                });
                returnSearchResults.style.display = 'block';
            } else {
                noReturnSearchResults.style.display = 'block';
                returnSearchResults.style.display = 'block';
            }
        });

        returnSearchResultsTableBody.addEventListener('click', (event) => {
            if (event.target.classList.contains('select-sale-for-return') || event.target.closest('.select-sale-for-return')) {
                const saleId = event.target.closest('.select-sale-for-return').dataset.saleId;
                const selectedSale = sales.find(s => s.saleId === saleId && s.type === 'sale');

                if (selectedSale) {
                    populateReturnForm(selectedSale);
                }
            }
        });

        let currentReturnOriginalSale = null;

        function populateReturnForm(sale) {
            currentReturnOriginalSale = sale;

            returnDetailsContainer.style.display = 'block';
            returnSaleIdDisplay.textContent = sale.saleId;
            returnCustomerDisplay.textContent = `${sale.customerName} (${sale.customerPhone})`;
            returnSaleTotalDisplay.textContent = `৳ ${sale.finalAmount.toLocaleString()}`;
            returnItemsTableBody.innerHTML = '';

            sale.items.forEach((item, index) => {
                const row = returnItemsTableBody.insertRow();
                row.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.quantity}</td>
                    <td>৳ ${item.unitPrice.toLocaleString()}</td>
                    <td>
                        <input type="number" value="0" min="0" max="${item.quantity}" class="return-item-qty"
                            data-product-id="${item.productId}"
                            data-name="${item.name}"
                            data-unit-price="${item.unitPrice}"
                            data-purchase-price="${item.purchasePrice || 0}"
                        >
                    </td>
                    <td>
                        <select class="return-reason">
                            <option value="">কারণ নির্বাচন করুন</option>
                            <option value="damaged">ক্ষতিগ্রস্ত</option>
                            <option value="wrong_size">ভুল সাইজ</option>
                            <option value="customer_changed_mind">কাস্টমার মন পরিবর্তন করেছে</option>
                            <option value="defective">ত্রুটিপূর্ণ</option>
                            <option value="other">অন্যান্য</option>
                        </select>
                    </td>
                    <td>
                        <select class="return-type">
                            <option value="refund">ফেরত (টাকা)</option>
                            <option value="store_credit">স্টোর ক্রেডিট</option>
                            <option value="exchange">বিনিময়</option>
                        </select>
                    </td>
                `;
                row.querySelector('.return-item-qty').addEventListener('input', updateRefundableAmount);
            });
            updateRefundableAmount();
            returnSearchResults.style.display = 'none';
        }

        function updateRefundableAmount() {
            let total = 0;
            document.querySelectorAll('.return-item-qty').forEach(input => {
                const quantity = parseInt(input.value) || 0;
                const unitPrice = parseFloat(input.dataset.unitPrice);
                total += (quantity * unitPrice);
            });
            refundableAmountSpan.textContent = `৳ ${total.toLocaleString()}`;
        }

        processReturnBtn.addEventListener('click', async () => {
            if (!currentReturnOriginalSale) {
                alert('রিটার্নের জন্য কোনো বিক্রয় নির্বাচিত হয়নি।');
                return;
            }

            const returnedItems = [];
            let totalReturnedValue = 0;
            let totalProfitDeduction = 0;
            let dbPromises = [];
            let validReturn = false;
            let cashRefundAmount = 0; 

            document.querySelectorAll('#return-items-table tbody tr').forEach(row => {
                const qtyInput = row.querySelector('.return-item-qty');
                const reasonSelect = row.querySelector('.return-reason');
                const typeSelect = row.querySelector('.return-type');
                const quantity = parseInt(qtyInput.value) || 0;

                if (quantity > 0) {
                    if (!reasonSelect.value) {
                        alert('ফেরত নেওয়া প্রতিটি পণ্যের জন্য কারণ নির্বাচন করুন।');
                        validReturn = false;
                        return; // Exit forEach loop for this item
                    }
                    validReturn = true;

                    const productId = qtyInput.dataset.productId;
                    const productName = qtyInput.dataset.name;
                    const unitPrice = parseFloat(qtyInput.dataset.unitPrice);
                    const purchasePrice = parseFloat(qtyInput.dataset['purchase-price']); // Correctly access the data attribute
                    const returnType = typeSelect.value;
                    
                    if (returnType === 'refund') {
                        cashRefundAmount += quantity * unitPrice;
                    }

                    returnedItems.push({
                        productId, name: productName, quantity, unitPrice, purchasePrice,
                        reason: reasonSelect.value,
                        type: returnType
                    });
                    totalReturnedValue += quantity * unitPrice;
                    totalProfitDeduction += (unitPrice - purchasePrice) * quantity;
                }
            });

            if (!validReturn || returnedItems.length === 0) {
                if(validReturn) alert('ফেরত দেওয়ার জন্য কোনো পণ্য নির্বাচন করা হয়নি।');
                return;
            }

            if (!confirm(`আপনি কি নিশ্চিত এই ${returnedItems.length} টি পণ্য ফেরত নিতে এবং ৳ ${totalReturnedValue.toLocaleString()} টাকা ফেরত/ক্রেডিট দিতে?`)) {
                return;
            }
            
            // Update stock for returned items
            returnedItems.forEach(returnedItem => {
                const product = products.find(p => p.id === returnedItem.productId);
                if (product) {
                    product.stock = (product.stock || 0) + returnedItem.quantity;
                    dbPromises.push(db.put('products', product));
                }
            });
            
            // ✅ NEW: Use new invoice number for return ID
            shopSettings.lastInvoiceNumber++;
            const returnId = shopSettings.lastInvoiceNumber.toString();

            // Create the return transaction record
            const returnTransaction = {
                id: returnId,
                saleId: returnId,
                originalSaleId: currentReturnOriginalSale.saleId,
                timestamp: new Date().toISOString(),
                sellerId: currentUser.id,
                customerId: currentReturnOriginalSale.customerId,
                customerName: currentReturnOriginalSale.customerName,
                customerPhone: currentReturnOriginalSale.customerPhone,
                customerAddress: currentReturnOriginalSale.customerAddress,
                totalAmount: -totalReturnedValue,
                discountAmount: 0,
                finalAmount: -totalReturnedValue,
                profit: -totalProfitDeduction,
                paymentMethod: returnedItems[0].type === 'refund' ? 'cash_refund' : returnedItems[0].type === 'store_credit_issued' ? 'store_credit' : 'exchange_processed',
                status: 'ফেরত সম্পন্ন',
                type: 'return',
                items: returnedItems
            };
            
            sales.push(returnTransaction);
            dbPromises.push(db.put('sales', returnTransaction));
            dbPromises.push(db.put('settings', shopSettings)); // Save invoice counter update
            
            // Update customer totals
            const customer = customers.find(c => c.id === currentReturnOriginalSale.customerId);
            if (customer) {
                customer.totalPurchased += returnTransaction.finalAmount; // totalAmount is negative
                
                // If the return was a refund, reduce total paid (simplified) or due
                 if (returnedItems[0].type === 'refund') {
                     customer.totalPaid = Math.max(0, (customer.totalPaid || 0) - totalReturnedValue); 
                 } else if (currentReturnOriginalSale.status === 'বাকি') {
                      const dueRecord = dues.find(d => d.saleId === currentReturnOriginalSale.saleId);
                      if(dueRecord) {
                          dueRecord.remainingAmount = Math.max(0, dueRecord.remainingAmount - totalReturnedValue);
                          dueRecord.originalAmount = Math.max(0, dueRecord.originalAmount - totalReturnedValue);
                           if (dueRecord.remainingAmount < 0.01) {
                               dbPromises.push(db.delete('dues', dueRecord.id));
                               dues = dues.filter(d => d.id !== dueRecord.id);
                           } else {
                               dbPromises.push(db.put('dues', dueRecord));
                               const dueIndex = dues.findIndex(d => d.id === dueRecord.id);
                               if(dueIndex !== -1) dues[dueIndex] = dueRecord;
                           }
                      }
                      customer.currentDue = Math.max(0, (customer.currentDue || 0) - totalReturnedValue);
                 }
                dbPromises.push(db.put('customers', customer));
            }


            // *** NEW LOGIC: Add Ledger Entry for Cash Refund (Expense) ***
            if (cashRefundAmount > 0) {
                    const refundLedgerEntry = {
                        id: generateUniqueId('L'),
                        timestamp: returnTransaction.timestamp,
                        type: 'expense',
                        category: 'customer_refund',
                        description: `পণ্য ফেরত - কাস্টমার: ${currentReturnOriginalSale.customerName}, বিল: ${currentReturnOriginalSale.saleId}`,
                        amount: cashRefundAmount,
                        customerId: currentReturnOriginalSale.customerId,
                        customerName: currentReturnOriginalSale.customerName,
                        saleId: currentReturnOriginalSale.saleId
                    };
                    ledgerEntries.push(refundLedgerEntry);
                    dbPromises.push(db.put('ledgerEntries', refundLedgerEntry));
                }
                // *** END OF NEW LOGIC ***
                
                await Promise.all(dbPromises);
                
                const customerIndex = customers.findIndex(c => c.id === customer.id);
                if(customerIndex !== -1) customers[customerIndex] = customer;

                const saleIndex = sales.findIndex(s => s.id === returnTransaction.id);
                if (saleIndex !== -1) {
                    sales[saleIndex] = returnTransaction;
                } else {
                    sales.push(returnTransaction);
                }
                
                updateAllUI();


                alert(`পণ্য সফলভাবে ফেরত নেওয়া হয়েছে এবং ৳ ${totalReturnedValue.toLocaleString()} টাকা ফেরত/ক্রেডিট দেওয়া হয়েছে।`);
                returnDetailsContainer.style.display = 'none';
                returnSaleSearchInput.value = '';
                returnSuccessMessage.style.display = 'block';
                displayReturnId.textContent = returnId;
                printReturnBillBtn.dataset.returnId = returnId;
            });

        printReturnBillBtn.addEventListener('click', (e) => {
            const returnId = e.target.dataset.returnId;
            const returnRecord = sales.find(s => s.saleId === returnId && s.type === 'return');

            if (!returnRecord) {
                alert('ফেরত ডেটা পাওয়া হয়নি!');
                return;
            }
            
            const reasonMap = { 'damaged': 'ক্ষতিগ্রস্ত', 'wrong_size': 'ভুল সাইজ', 'customer_changed_mind': 'মন পরিবর্তন', 'defective': 'ত্রুটিপূর্ণ', 'other': 'অন্যান্য' };
            const typeMap = { 'refund': 'টাকা ফেরত', 'store_credit': 'স্টোর ক্রেডিট', 'exchange': 'বিনিময়' };
            const logoHtml = shopSettings.logoUrl ? `<div class="center"><img src="${shopSettings.logoUrl}" alt="Logo" style="max-height: 80px; max-width: 200px; margin-bottom: 10px;"></div>` : '';

            let itemsHtml = '';
            returnRecord.items.forEach(item => {
                const reasonText = reasonMap[item.reason] || item.reason;
                const typeText = typeMap[item.type] || item.type;
                itemsHtml += `
                    <tr>
                        <td>${item.name} <br> ${item.quantity} x ৳${item.unitPrice.toLocaleString()}</td>
                        <td class="right">৳${(item.quantity * item.unitPrice).toLocaleString()}</td>
                        <td>${reasonText}<br>${typeText}</td>
                    </tr>
                `;
            });


            let billContent = `
                 ${logoHtml}
                <h3 class="center">ফেরত বিল</h3>
                <p class="center">${shopSettings.name}</p>
                <p class="center">তারিখ: ${moment(returnRecord.timestamp).format('lll')}</p>
                <hr>
                <p>রিটার্ন ID: ${returnRecord.saleId}</p>
                <p>মূল বিল ID: ${returnRecord.originalSaleId}</p>
                <p>কাস্টমার: ${returnRecord.customerName}</p>
                <hr>
                <table>
                     <thead><tr><th>বিবরণ</th><th class="right">মোট</th><th>কারণ/ধরণ</th></tr></thead>
                     <tbody>${itemsHtml}</tbody>
                </table>
                <hr>
                <p><strong>মোট ফেরত: ৳ ${(-returnRecord.finalAmount).toLocaleString()}</strong></p>
                <p>ফেরতের ধরণ: ${typeMap[returnRecord.items[0].type]}</p>
                <hr>
                <p class="center">ধন্যবাদ!</p>
            `;

            launchPrint('ফেরত বিল', billContent);
            returnSuccessMessage.style.display = 'none';
            returnSaleSearchInput.value = '';
        });


        // --- Ledger Management (Cash Ledger - Updated for Golden Rules) ---
        function updateLedgerCategoryDropdown() {
             // Only display 'expense' and 'income' categories that are NOT bank-related
            const type = ledgerTypeSelect.value;
            const categories = shopSettings.ledgerCategories[type];
            ledgerCategorySelect.innerHTML = '';

            for (const key in categories) {
                // Filter out system-generated categories that should not be manually added, and bank transfer
                if (['sales_income', 'due_collection', 'customer_refund', 'product_purchase', 'supplier_payment', 'opening_due_entry', 'manual_due_adjustment', 'bank_withdrawal_expense', 'bank_to_cash_transfer'].includes(key)) {
                    // Only allow Bank to Cash transfer entry if it's income and that specific category
                    if (key === 'bank_to_cash_transfer' && type === 'income') {
                        // Allow this one to be manually entered in ledger
                    } else {
                        continue;
                    }
                }
                const option = document.createElement('option');
                option.value = key;
                option.textContent = categories[key];
                ledgerCategorySelect.appendChild(option);
            }
        }

        function populateLedgerCategoryFilter() {
             // Show all categories in the filter for expense/income tracking
            ledgerFilterCategorySelect.innerHTML = '<option value="">সকল ক্যাটাগরি</option>';
            const allCategories = {...shopSettings.ledgerCategories.expense, ...shopSettings.ledgerCategories.income};
            
            for (const key in allCategories) {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = allCategories[key];
                ledgerFilterCategorySelect.appendChild(option);
            }
        }
        
         function populateExpenseReportCategoryFilter() {
            // Filter: only Expense categories
            expenseReportCategorySelect.innerHTML = '<option value="">সকল ক্যাটাগরি</option>';
            const allCategories = shopSettings.ledgerCategories.expense; 
            
            for (const key in allCategories) {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = allCategories[key];
                expenseReportCategorySelect.appendChild(option);
            }
        }

        addLedgerCategoryBtn.addEventListener('click', async () => {
            const type = ledgerTypeSelect.value;
            const typeText = type === 'expense' ? 'Cash Out' : 'Cash In';
            const newCategoryName = prompt(`নতুন ${typeText} ক্যাটাগরির নাম লিখুন:`);

            if (newCategoryName && newCategoryName.trim() !== '') {
                const newCategoryKey = newCategoryName.trim().toLowerCase().replace(/\s+/g, '_');
                // Use custom categories only (no system keys)
                if (['sales_income', 'due_collection', 'customer_refund', 'product_purchase', 'supplier_payment', 'opening_due_entry', 'manual_due_adjustment', 'bank_withdrawal_expense', 'bank_to_cash_transfer'].includes(newCategoryKey)) {
                    alert('এই নামটি সিস্টেমের জন্য সংরক্ষিত।');
                    return;
                }
                if (shopSettings.ledgerCategories[type][newCategoryKey]) {
                    alert('এই ক্যাটাগরিটি আগে থেকেই আছে।');
                    return;
                }
                shopSettings.ledgerCategories[type][newCategoryKey] = newCategoryName.trim();
                await db.put('settings', shopSettings);
                alert('ক্যাটাগরি সফলভাবে যোগ করা হয়েছে!');
                updateLedgerCategoryDropdown();
                populateLedgerCategoryFilter();
                populateExpenseReportCategoryFilter();
            }
        });

        function renderLedger(fromDateStr = '', toDateStr = '', filterType = '', filterCategory = '') {
            ledgerTableBody.innerHTML = '';
            // Only show Cash Ledger entries (excluding bank-related income, but allowing bank-to-cash transfer)
            let filteredLedger = ledgerEntries.filter(e => e.category !== 'customer_bank_payment').filter(e => e.category !== 'bank_withdrawal_expense');

            const fromDate = fromDateStr ? new Date(fromDateStr) : null;
            const toDate = toDateStr ? new Date(toDateStr) : null;

            if (fromDate || toDate) {
                filteredLedger = filteredLedger.filter(entry => {
                    const entryDate = new Date(entry.timestamp);
                    const isAfterFrom = !fromDate || entryDate >= fromDate.setHours(0,0,0,0);
                    const isBeforeTo = !toDate || entryDate <= toDate.setHours(23,59,59,999);
                    return isAfterFrom && isBeforeTo;
                });
            }
            
            if (filterType) {
                filteredLedger = filteredLedger.filter(entry => entry.type === filterType);
            }
            if (filterCategory) {
                filteredLedger = filteredLedger.filter(entry => entry.category === filterCategory);
            }

            let totalIncome = 0;
            let totalExpenses = 0;

            if (filteredLedger.length === 0) {
                const row = ledgerTableBody.insertRow();
                const cell = row.insertCell(0);
                cell.colSpan = 6;
                cell.textContent = 'কোনো Cash লেনদেন খুঁজে পাওয়া যায়নি।';
            } else {
                filteredLedger.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)).forEach(entry => {
                    const row = ledgerTableBody.insertRow();
                    row.insertCell(0).textContent = new Date(entry.timestamp).toLocaleDateString();
                    row.insertCell(1).textContent = entry.type === 'expense' ? 'Cash Out' : 'Cash In';
                    
                    const categoryName = shopSettings.ledgerCategories[entry.type]?.[entry.category] || entry.category || 'N/A';
                    row.insertCell(2).textContent = categoryName;

                    const descriptionCell = row.insertCell(3)
                    let finalDescription = entry.description;
                    if(entry.category === 'bank_to_cash_transfer' && entry.bankName) {
                        finalDescription += ` (ব্যাংক: ${entry.bankName})`;
                    } else if(entry.supplierName) {
                        finalDescription += ` (সাপ্লায়ার: ${entry.supplierName})`;
                    } else if (entry.customerName) {
                        finalDescription += ` (কাস্টমার: ${entry.customerName})`;
                    }
                    descriptionCell.textContent = finalDescription;

                    const amountCell = row.insertCell(4);
                    amountCell.textContent = `৳ ${entry.amount.toLocaleString()}`;
                    amountCell.style.color = entry.type === 'expense' ? '#ef4444' : '#22c55e';

                    if (entry.type === 'expense') {
                        totalExpenses += entry.amount;
                    } else {
                        totalIncome += entry.amount;
                    }

                    const actionCell = row.insertCell(5);
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'মুছুন';
                    deleteBtn.className = 'danger-btn';
                    deleteBtn.addEventListener('click', () => deleteLedgerEntry(entry.id));
                    
                    // Prevent deleting auto-generated ledger entries/bank transfer entries
                    if (['sales_income', 'due_collection', 'customer_refund', 'product_purchase', 'supplier_payment', 'opening_due_entry', 'manual_due_adjustment', 'bank_to_cash_transfer'].includes(entry.category)) {
                        deleteBtn.disabled = true;
                    }
                    actionCell.appendChild(deleteBtn);
                });
            }

            // Update Cash Ledger Summary
            cashLedgerBalanceSpan.textContent = `৳ ${(totalIncome - totalExpenses).toLocaleString()}`;
            totalCashInSpan.textContent = `৳ ${totalIncome.toLocaleString()}`;
            totalCashOutSpan.textContent = `৳ ${totalExpenses.toLocaleString()}`;
            cashLedgerBalanceSpan.style.color = (totalIncome - totalExpenses) < 0 ? '#ef4444' : '#22c55e';


            if (currentUser && currentUser.role !== 'admin') { 
                 addLedgerEntryForm.style.display = 'none';
                 ledgerSection.querySelectorAll('.action-buttons, .danger-btn').forEach(btn => btn.style.display = 'none');
            } else {
                addLedgerEntryForm.style.display = 'block';
            }
        }

        addLedgerEntryForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const type = ledgerTypeSelect.value;
            const category = ledgerCategorySelect.value;
            const description = ledgerDescriptionInput.value.trim();
            const amount = parseFloat(ledgerAmountInput.value);
            const date = ledgerDateInput.value;

            if (isNaN(amount) || amount <= 0) {
                alert('বৈধ পরিমাণ প্রবেশ করান।');
                return;
            }
            if (!date) {
                alert('অনুগ্রহ করে একটি তারিখ নির্বাচন করুন।');
                return;
            }
            
            // Prevent manual adding of restricted categories (excluding bank_to_cash_transfer, which is handled below)
            if (['sales_income', 'due_collection', 'customer_refund', 'product_purchase', 'supplier_payment', 'opening_due_entry', 'manual_due_adjustment', 'bank_withdrawal_expense'].includes(category)) {
                alert('এই ক্যাটাগরিটি ম্যানুয়ালি যোগ করা যায় না।');
                return;
            }
            
            let bankName = null;
            if(category === 'bank_to_cash_transfer') {
                alert('ব্যাংক ট্রান্সফার শুধুমাত্র Bank Module সেকশন থেকে করা যাবে।');
                return;
            }

            const newEntry = {
                id: generateUniqueId('L'),
                timestamp: new Date(date).toISOString(),
                type: type,
                category: category,
                description: description,
                amount: amount,
                bankName: bankName // Null for manual cash entries
            };
            await db.put('ledgerEntries', newEntry);
            ledgerEntries.push(newEntry);
            
            alert('লেনদেন সফলভাবে যোগ করা হয়েছে!');
            addLedgerEntryForm.reset();
            const today = new Date().toISOString().split('T')[0];
            ledgerDateInput.value = today;
            updateLedgerCategoryDropdown();
            updateAllUI(); 
        });

        document.getElementById('cancel-ledger-entry').addEventListener('click', () => {
            addLedgerEntryForm.reset();
             const today = new Date().toISOString().split('T')[0];
            ledgerDateInput.value = today;
            updateLedgerCategoryDropdown();
        });

        filterLedgerBtn.addEventListener('click', () => {
            const fromDate = ledgerFilterFromDateInput.value;
            const toDate = ledgerFilterToDateInput.value;
            const type = ledgerFilterTypeSelect.value;
            const category = ledgerFilterCategorySelect.value;
            renderLedger(fromDate, toDate, type, category);
        });

        printLedgerBtn.addEventListener('click', () => {
            const fromDate = ledgerFilterFromDateInput.value;
            const toDate = ledgerFilterToDateInput.value;
            const type = ledgerFilterTypeSelect.value;
            const category = ledgerFilterCategorySelect.value;
            
            printLedger(fromDate, toDate, type, category);
        });

        // ✅ NEW: Delete All Cash Ledger Entries
        deleteAllLedgerBtn.addEventListener('click', async () => {
            if (currentUser.role !== 'admin') {
                alert('আপনার সব ক্যাশ লেজার মুছার অনুমতি নেই।');
                return;
            }

            // Get all cash ledger entries (excluding bank-related entries)
            const cashLedgerEntries = ledgerEntries.filter(e => 
                e.category !== 'customer_bank_payment' && 
                e.category !== 'bank_withdrawal_expense' &&
                e.category !== 'bank_to_cash_transfer'
            );

            if (cashLedgerEntries.length === 0) {
                alert('কোনো ক্যাশ লেজার এন্ট্রি পাওয়া যায়নি।');
                return;
            }

            const totalIncome = cashLedgerEntries.filter(e => e.type === 'income').reduce((sum, e) => sum + (e.amount || 0), 0);
            const totalExpense = cashLedgerEntries.filter(e => e.type === 'expense').reduce((sum, e) => sum + (e.amount || 0), 0);
            const netBalance = totalIncome - totalExpense;

            // Confirmation dialog
            const confirmMessage = 
                `⚠️ সতর্কতা: আপনি সব ক্যাশ লেজার এন্ট্রি মুছতে চলেছেন!\n\n` +
                `মোট এন্ট্রি: ${cashLedgerEntries.length} টি\n` +
                `মোট Cash In: ৳ ${totalIncome.toLocaleString()}\n` +
                `মোট Cash Out: ৳ ${totalExpense.toLocaleString()}\n` +
                `নেট ব্যালেন্স: ৳ ${netBalance.toLocaleString()}\n\n` +
                `ডিলিট করলে:\n` +
                `• ${cashLedgerEntries.length} টি ক্যাশ লেজার এন্ট্রি চিরতরে মুছে যাবে\n` +
                `• কাস্টমারদের বাকি (যদি due_collection থাকে) বাড়বে\n` +
                `• সব ইনকাম/এক্সপেন্স হিসাব শূন্য হয়ে যাবে\n\n` +
                `আপনি কি নিশ্চিত?`;

            if (!confirm(confirmMessage)) {
                return;
            }

            // Second confirmation with password
            const adminPassword = prompt('নিরাপত্তার জন্য অ্যাডমিন পাসওয়ার্ড দিন:');
            if (adminPassword !== ADMIN_PASSWORD) {
                alert('ভুল পাসওয়ার্ড! ক্যাশ লেজার মুছা যাবে না।');
                return;
            }

            // Third confirmation
            if (!confirm(`আবার নিশ্চিত করুন: ${cashLedgerEntries.length} টি ক্যাশ লেজার এন্ট্রি চিরতরে মুছে ফেলা হবে। এই কাজটি অপরিবর্তনীয়!`)) {
                return;
            }

            try {
                showLoader();
                const dbPromises = [];
                const affectedCustomers = new Map();

                // Process each entry
                for (const entry of cashLedgerEntries) {
                    // Track affected customers for due_collection entries
                    if (entry.category === 'due_collection' && entry.customerId) {
                        const customer = customers.find(c => c.id === entry.customerId);
                        if (customer) {
                            const currentAmount = affectedCustomers.get(customer.id) || 0;
                            affectedCustomers.set(customer.id, currentAmount + (entry.amount || 0));
                        }
                    }

                    // Delete from database
                    await db.delete('ledgerEntries', entry.id);
                    
                    // Remove from local array
                    const index = ledgerEntries.findIndex(e => e.id === entry.id);
                    if (index !== -1) {
                        ledgerEntries.splice(index, 1);
                    }
                }

                // Update affected customers' balances
                for (const [customerId, amount] of affectedCustomers) {
                    const customer = customers.find(c => c.id === customerId);
                    if (customer) {
                        // Increase due (since payment is being removed)
                        customer.currentDue = (customer.currentDue || 0) + amount;
                        // Decrease total paid
                        customer.totalPaid = Math.max(0, (customer.totalPaid || 0) - amount);
                        dbPromises.push(db.put('customers', customer));
                    }
                }

                // Create audit trail entry
                const auditEntry = {
                    id: generateUniqueId('L'),
                    timestamp: new Date().toISOString(),
                    type: 'expense',
                    category: 'manual_due_adjustment',
                    description: `সব ক্যাশ লেজার মুছা হয়েছে: ${cashLedgerEntries.length} টি এন্ট্রি, নেট ব্যালেন্স ৳ ${netBalance.toLocaleString()}`,
                    amount: Math.abs(netBalance),
                    customerId: null,
                    customerName: 'System',
                    saleId: 'DELETE_ALL_CASH_' + generateUniqueId('L')
                };
                ledgerEntries.push(auditEntry);
                dbPromises.push(db.put('ledgerEntries', auditEntry));

                await Promise.all(dbPromises);

                hideLoader();

                alert(`✅ সব ক্যাশ লেজার এন্ট্রি সফলভাবে মুছে ফেলা হয়েছে!\n\n` +
                      `মোট মুছা এন্ট্রি: ${cashLedgerEntries.length} টি\n` +
                      `আপডেট করা কাস্টমার: ${affectedCustomers.size} জন\n\n` +
                      `• ক্যাশ লেজার আপডেট হয়েছে\n` +
                      `• কাস্টমার ব্যালেন্স আপডেট হয়েছে`);

                // Refresh UI
                renderLedger();
                updateAllUI();

            } catch (error) {
                hideLoader();
                console.error('Error deleting all cash ledger:', error);
                alert('❌ ক্যাশ লেজার মুছতে সমস্যা হয়েছে। অনুগ্রহ করে আবার চেষ্টা করুন।');
            }
        });

        function printLedger(fromDateStr = '', toDateStr = '', filterType = '', filterCategory = '') {
            // Filter logic same as renderLedger
            let filteredLedger = ledgerEntries.filter(e => e.category !== 'customer_bank_payment').filter(e => e.category !== 'bank_withdrawal_expense');
            const logoHtml = shopSettings.logoUrl ? `<div class="center"><img src="${shopSettings.logoUrl}" alt="Logo" style="max-height: 80px; max-width: 200px; margin-bottom: 10px;"></div>` : '';


            const fromDate = fromDateStr ? new Date(fromDateStr) : null;
            const toDate = toDateStr ? new Date(toDateStr) : null;

            if (fromDate || toDate) {
                filteredLedger = filteredLedger.filter(entry => {
                    const entryDate = new Date(entry.timestamp);
                    const isAfterFrom = !fromDate || entryDate >= fromDate.setHours(0,0,0,0);
                    const isBeforeTo = !toDate || entryDate <= toDate.setHours(23,59,59,999);
                    return isAfterFrom && isBeforeTo;
                });
            }

            if (filterType) {
                filteredLedger = filteredLedger.filter(entry => entry.type === filterType);
            }
            if (filterCategory) {
                filteredLedger = filteredLedger.filter(entry => entry.category === filterCategory);
            }

            let totalIncome = 0;
            let totalExpenses = 0;

            let tableRows = '';
            filteredLedger.forEach(entry => {
                const categoryName = shopSettings.ledgerCategories[entry.type]?.[entry.category] || entry.category || 'N/A';
                if (entry.type === 'expense') totalExpenses += entry.amount;
                if (entry.type === 'income') totalIncome += entry.amount;
            });

            const netBalance = totalIncome - totalExpenses;

            let printContent = `
                 ${logoHtml}
                <div class="center">
                    <h2>${shopSettings.name}</h2>
                    <p>${shopSettings.address}</p>
                    <h3>Cash Ledger রিপোর্ট</h3>
                    <p>তারিখ: ${fromDateStr ? moment(fromDateStr).format('LL') : 'শুরু'} থেকে ${toDateStr ? moment(toDateStr).format('LL') : 'আজ'}</p>
                </div>
                <hr>
                <table>
                    <thead>
                        <tr>
                            <th>তারিখ</th>
                            <th>বিবরণ (Cash In/Out)</th>
                            <th class="right">পরিমাণ</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredLedger.map(entry => {
                            const categoryName = shopSettings.ledgerCategories[entry.type]?.[entry.category] || entry.category || 'N/A';
                            let finalDescription = `${entry.type === 'expense' ? 'Cash Out' : 'Cash In'} - ${categoryName}`;
                             if(entry.category === 'bank_to_cash_transfer' && entry.bankName) {
                                finalDescription += ` (ব্যাংক: ${entry.bankName})`;
                            } else if(entry.supplierName) {
                                finalDescription += ` (সাপ্লায়ার: ${entry.supplierName})`;
                            } else if (entry.customerName) {
                                finalDescription += ` (কাস্টমার: ${entry.customerName})`;
                            }
                            return `
                            <tr>
                                <td style="vertical-align: top;">${moment(entry.timestamp).format('L')}</td>
                                <td style="vertical-align: top;">
                                    ${finalDescription}
                                    ${entry.description ? `<br><small>${entry.description}</small>` : ''}
                                </td>
                                <td class="right" style="vertical-align: top;">৳ ${entry.amount.toLocaleString()}</td>
                            </tr>
                            `
                        }).join('')}
                    </tbody>
                </table>
                <hr>
                <div class="right">
                    <p>মোট Cash In: ৳ ${totalIncome.toLocaleString()}</p>
                    <p>মোট Cash Out: ৳ ${totalExpenses.toLocaleString()}</p>
                    <p><strong>নিট Cash ব্যালেন্স: ৳ ${netBalance.toLocaleString()}</strong></p>
                </div>
                <hr>
                <p class="center">ধন্যবাদ!</p>
            `;
            launchPrint('Cash Ledger প্রিন্ট', printContent);
        }

        async function deleteLedgerEntry(id) {
            if (currentUser && currentUser.role !== 'admin') {
                alert('আপনার এই লেনদেন মুছে ফেলার অনুমতি নেই।');
                return;
            }
            const entryToDelete = ledgerEntries.find(entry => entry.id === id);
            if (!entryToDelete) {
                alert('লেনদেনটি খুঁজে পাওয়া যায়নি।');
                return;
            }

            // Allow deletion of ALL entries including system-generated ones
            // But show appropriate warning for system entries
            const isSystemEntry = ['sales_income', 'due_collection', 'customer_refund', 'product_purchase', 'supplier_payment', 'opening_due_entry', 'manual_due_adjustment', 'bank_to_cash_transfer'].includes(entryToDelete.category);
            
            let confirmMessage = `আপনি কি নিশ্চিত এই লেনদেনটি মুছে ফেলতে চান?\n\n`;
            confirmMessage += `তারিখ: ${new Date(entryToDelete.timestamp).toLocaleDateString()}\n`;
            confirmMessage += `ধরণ: ${entryToDelete.type === 'expense' ? 'Cash Out' : 'Cash In'}\n`;
            confirmMessage += `পরিমাণ: ৳ ${(entryToDelete.amount || 0).toLocaleString()}\n`;
            confirmMessage += `বিবরণ: ${entryToDelete.description || 'N/A'}\n\n`;
            
            if (isSystemEntry) {
                confirmMessage += `⚠️ সতর্কতা: এটি একটি সিস্টেম জেনারেটেড এন্ট্রি।\n`;
                confirmMessage += `মুছলে শুধু এই লেজার এন্ট্রি মুছবে, কাস্টমার/সাপ্লায়ার বাকি অপরিবর্তিত থাকবে।\n\n`;
            }
            
            confirmMessage += `ডিলিট করলে শুধু এই ক্যাশ লেজার এন্ট্রি মুছবে।`;

            if (!confirm(confirmMessage)) {
                return;
            }

            try {
                showLoader();
                
                // Delete only the ledger entry - do NOT modify customer/supplier data
                await db.delete('ledgerEntries', id);
                
                // Remove from local array
                const index = ledgerEntries.findIndex(entry => entry.id === id);
                if (index !== -1) {
                    ledgerEntries.splice(index, 1);
                }
                
                hideLoader();
                
                alert(`✅ লেনদেন সফলভাবে মুছে ফেলা হয়েছে!\n\n` +
                      `শুধুমাত্র ক্যাশ লেজার এন্ট্রি মুছা হয়েছে।\n` +
                      `কাস্টমার/সাপ্লায়ার বাকি অপরিবর্তিত রয়েছে।`);
                
                updateAllUI();
            } catch (error) {
                hideLoader();
                console.error('Error deleting ledger entry:', error);
                alert('❌ লেনদেন মুছতে সমস্যা হয়েছে। অনুগ্রহ করে আবার চেষ্টা করুন।');
            }
        }
        
        // --- NEW: Bank Module (Section 4) ---

        // Helper to populate all Bank Selectors
        function populateBankSelectors() {
            const selects = [posBankSelect, dueBankSelect, supplierDueBankSelect, withdrawalBankSelect, transferBankSelect, bankTxFilterBankSelect];
            selects.forEach(select => {
                if(select.id !== 'bank-tx-filter-bank') {
                    select.innerHTML = '<option value="" disabled selected>ব্যাংক নির্বাচন করুন</option>';
                } else {
                     select.innerHTML = '<option value="">সকল ব্যাংক</option>';
                }
            });
            
            banks.forEach(bank => {
                selects.forEach(select => {
                    const option = document.createElement('option');
                    option.value = bank.id;
                    option.textContent = `${bank.name} (৳ ${bank.currentBalance.toLocaleString()})`;
                    select.appendChild(option);
                });
            });
            
            // Check if any bank exists for transaction forms
            if (banks.length > 0) {
                 withdrawalBankSelect.disabled = false;
                 transferBankSelect.disabled = false;
            } else {
                 withdrawalBankSelect.innerHTML = '<option value="" disabled selected>কোনো ব্যাংক নেই</option>';
                 transferBankSelect.innerHTML = '<option value="" disabled selected>কোনো ব্যাংক নেই</option>';
                 withdrawalBankSelect.disabled = true;
                 transferBankSelect.disabled = true;
            }

        }


        let currentEditingBank = null;

        function renderBankList() {
            bankListTableBody.innerHTML = '';
            if (banks.length === 0) {
                bankListTableBody.innerHTML = '<tr><td colspan="4">কোনো ব্যাংক যোগ করা হয়নি।</td></tr>';
                return;
            }
            
            banks.forEach(bank => {
                const row = bankListTableBody.insertRow();
                row.insertCell(0).textContent = bank.name;
                row.insertCell(1).textContent = bank.accountNo || 'N/A';
                const balanceCell = row.insertCell(2);
                balanceCell.textContent = `৳ ${bank.currentBalance.toLocaleString()}`;
                balanceCell.style.color = bank.currentBalance < 0 ? '#dc3545' : '#22c55e';
                
                const actionCell = row.insertCell(3);
                actionCell.className = 'table-action-buttons';
                
                const editBtn = document.createElement('button');
                editBtn.innerHTML = '<i class="fas fa-edit"></i> সম্পাদনা';
                editBtn.className = 'edit-btn';
                editBtn.addEventListener('click', () => editBank(bank.id));
                actionCell.appendChild(editBtn);

                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i> মুছুন';
                deleteBtn.className = 'danger-btn';
                deleteBtn.addEventListener('click', () => deleteBank(bank.id));
                actionCell.appendChild(deleteBtn);
            });
        }
        
        cancelBankEntryBtn.addEventListener('click', () => {
             addBankForm.reset();
             addBankForm.dataset.editingId = '';
             currentEditingBank = null;
             bankOpeningBalanceInput.disabled = false;
        });

        addBankForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const editingId = addBankForm.dataset.editingId;
            const id = editingId || generateUniqueId('B');

            const bankName = bankNameInput.value.trim();
            const accountNo = bankAccountNoInput.value.trim();
            const openingBalance = parseFloat(bankOpeningBalanceInput.value) || 0;
            const dbPromises = [];

            if (editingId) {
                const index = banks.findIndex(b => b.id === id);
                if (index !== -1) {
                    const existingBank = banks[index];
                    const balanceDifference = openingBalance - (existingBank.openingBalance || 0); // Difference based on initial balance field
                    
                    // Update the running balance by the difference in opening balance
                    existingBank.currentBalance = (existingBank.currentBalance || 0) + balanceDifference;
                    existingBank.openingBalance = openingBalance;
                    existingBank.name = bankName;
                    existingBank.accountNo = accountNo;
                    
                    dbPromises.push(db.put('banks', existingBank));
                    banks[index] = existingBank; // Update local array
                    alert('ব্যাংক সফলভাবে আপডেট করা হয়েছে!');
                }
            } else {
                 const newBank = {
                    id, name: bankName, accountNo, openingBalance, currentBalance: openingBalance
                };
                banks.push(newBank);
                dbPromises.push(db.put('banks', newBank));
                alert('নতুন ব্যাংক যোগ করা হয়েছে!');
            }
            
            await Promise.all(dbPromises);

            addBankForm.reset();
            addBankForm.dataset.editingId = '';
            currentEditingBank = null;
            bankOpeningBalanceInput.disabled = false;
            updateAllUI();
        });

        function editBank(id) {
             currentEditingBank = banks.find(b => b.id === id);
             if(currentEditingBank) {
                 bankNameInput.value = currentEditingBank.name;
                 bankAccountNoInput.value = currentEditingBank.accountNo;
                 // Set the opening balance value for editing reference
                 bankOpeningBalanceInput.value = currentEditingBank.openingBalance || 0; 
                 addBankForm.dataset.editingId = id;
                 bankOpeningBalanceInput.disabled = true; // Block editing of opening balance after first creation
                 alert('ব্যাংকের প্রাথমিক ব্যালেন্স এডিট করা যাবে না। যদি পরিবর্তন করতে হয়, তবে অ্যাডমিনকে যোগাযোগ করুন।');
             }
        }

        async function deleteBank(id) {
            if (confirm('আপনি কি নিশ্চিত এই ব্যাংকটি মুছে ফেলতে চান? এই ব্যাংকের সাথে সম্পর্কিত সকল লেনদেনও মুছে যাবে।')) {
                const dbPromises = [];
                dbPromises.push(db.delete('banks', id));
                
                // Also delete all related transactions
                const relatedTxs = bankTransactions.filter(t => t.bankId === id);
                dbPromises.push(...relatedTxs.map(t => db.delete('bankTransactions', t.id)));
                
                await Promise.all(dbPromises);

                banks = banks.filter(b => b.id !== id);
                bankTransactions = bankTransactions.filter(t => t.bankId !== id);
                
                updateAllUI();
                alert('ব্যাংক সফলভাবে মুছে ফেলা হয়েছে!');
            }
        }
        
        // --- Bank Transaction Logic (Section 5) ---

        // Option 1: Bank Withdrawal (Expense)
        bankWithdrawalExpenseForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const bankId = withdrawalBankSelect.value;
            const amount = parseFloat(withdrawalAmountInput.value);
            const note = withdrawalNoteInput.value.trim() || 'Bank Withdrawal for Expense';
            const bank = banks.find(b => b.id === bankId);

            if (!bank || isNaN(amount) || amount <= 0) {
                alert('বৈধ পরিমাণ বা ব্যাংক নির্বাচন করুন।');
                return;
            }
            if (amount > bank.currentBalance) {
                alert('ব্যাংকে পর্যাপ্ত ব্যালেন্স নেই।');
                return;
            }
            
            const dbPromises = [];

            // 1. Update Bank Balance
            bank.currentBalance -= amount;
            dbPromises.push(db.put('banks', bank)); // <--- FIXED: Persist bank balance
            const bankIndex = banks.findIndex(b => b.id === bank.id);
            if(bankIndex !== -1) banks[bankIndex] = bank; // <--- FIXED: Local array update

            // 2. Create Bank Transaction (Debit)
            const newBankTx = {
                id: generateUniqueId('BTX'), timestamp: new Date().toISOString(), bankId: bank.id,
                bankName: bank.name, type: 'debit', amount: amount,
                category: 'bank_withdrawal_expense', description: note
            };
            bankTransactions.push(newBankTx);
            dbPromises.push(db.put('bankTransactions', newBankTx));

            // 3. Create Ledger Entry for Expense Module Audit (NO Cash Ledger update - Rule 5)
            // Note: Expense Report pulls from this Bank Transaction + Ledger Expenses
            
            await Promise.all(dbPromises);

            alert('ব্যাংক থেকে টাকা তুলে খরচ সফলভাবে রেকর্ড করা হয়েছে!');
            bankWithdrawalExpenseForm.reset();
            updateAllUI();
        });

        // Option 2: Bank to Ledger Transfer (Cash In)
        bankToCashTransferForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const bankId = transferBankSelect.value;
            const amount = parseFloat(transferAmountInput.value);
            const note = transferNoteInput.value.trim() || 'Bank to Cash Transfer';
            const bank = banks.find(b => b.id === bankId);

            if (!bank || isNaN(amount) || amount <= 0) {
                alert('বৈধ পরিমাণ বা ব্যাংক নির্বাচন করুন।');
                return;
            }
            if (amount > bank.currentBalance) {
                alert('ব্যাংকে পর্যাপ্ত ব্যালেন্স নেই।');
                return;
            }
            
            const dbPromises = [];

            // 1. Update Bank Balance (Debit)
            bank.currentBalance -= amount;
            dbPromises.push(db.put('banks', bank)); // <--- FIXED: Persist bank balance
            const bankIndex = banks.findIndex(b => b.id === bank.id);
            if(bankIndex !== -1) banks[bankIndex] = bank; // <--- FIXED: Local array update


            // 2. Create Bank Transaction (Debit)
            const newBankTx = {
                id: generateUniqueId('BTX'), timestamp: new Date().toISOString(), bankId: bank.id,
                bankName: bank.name, type: 'debit', amount: amount,
                category: 'bank_to_cash_transfer', description: `Transfer to Cash Ledger: ${note}`
            };
            bankTransactions.push(newBankTx);
            dbPromises.push(db.put('bankTransactions', newBankTx));

            // 3. Create Ledger Entry (Cash In - Income)
            const newLedgerEntry = {
                id: generateUniqueId('L'), timestamp: new Date().toISOString(), type: 'income',
                category: 'bank_to_cash_transfer', description: note,
                amount: amount, bankName: bank.name
            };
            ledgerEntries.push(newLedgerEntry);
            dbPromises.push(db.put('ledgerEntries', newLedgerEntry));
            
            await Promise.all(dbPromises);

            alert('ব্যাংক থেকে Cash Ledger-এ টাকা সফলভাবে ট্রান্সফার হয়েছে!');
            bankToCashTransferForm.reset();
            updateAllUI();
        });
        
        // --- Bank Transaction History Rendering ---
        function renderBankTransactions() {
            bankTransactionTableBody.innerHTML = '';
            
            const fromDateStr = bankTxFromDateInput.value;
            const toDateStr = bankTxToDateInput.value;
            const filterBankId = bankTxFilterBankSelect.value;
            const filterType = bankTxFilterTypeSelect.value;
            
            const fromDate = fromDateStr ? moment(fromDateStr).startOf('day') : moment(0);
            const toDate = toDateStr ? moment(toDateStr).endOf('day') : moment();

            let filteredTxs = bankTransactions.filter(tx => {
                 const txDate = moment(tx.timestamp);
                 return txDate.isSameOrAfter(fromDate) && txDate.isSameOrBefore(toDate) &&
                        (!filterBankId || tx.bankId === filterBankId) &&
                        (!filterType || tx.type === filterType);
            }).sort((a, b) => moment(a.timestamp) - moment(b.timestamp)); // Sort Chronologically for running balance

            let runningBalance = {};
            banks.forEach(b => runningBalance[b.id] = b.openingBalance || 0);

            let totalCredit = 0;
            let totalDebit = 0;

            if (filteredTxs.length === 0) {
                 bankTransactionTableBody.innerHTML = '<tr><td colspan="7">কোনো ব্যাংক লেনদেন খুঁজে পাওয়া যায়নি।</td></tr>';
                 // Update Summary even if no transactions are in the period
                 document.getElementById('finance-total-bank-balance').textContent = `৳ ${banks.reduce((sum, b) => sum + (b.currentBalance || 0), 0).toLocaleString()}`;
                 document.getElementById('finance-total-bank-credit').textContent = `৳ ${totalCredit.toLocaleString()}`;
                 document.getElementById('finance-total-bank-debit').textContent = `৳ ${totalDebit.toLocaleString()}`;
                 return;
            }
            
            // Recalculate running balance up to the start of the filter date (if necessary)
            const earliestTxDate = filteredTxs.length > 0 ? moment(filteredTxs[0].timestamp).startOf('day') : moment();
             
             banks.forEach(bank => {
                 const initialBalance = bank.openingBalance || 0;
                 let preFilterBalance = initialBalance;
                 
                 bankTransactions.filter(tx => tx.bankId === bank.id && moment(tx.timestamp).isBefore(earliestTxDate)).sort((a,b) => moment(a.timestamp) - moment(b.timestamp)).forEach(tx => {
                     preFilterBalance += tx.type === 'credit' ? tx.amount : -tx.amount;
                 });
                 runningBalance[bank.id] = preFilterBalance;
             });


            filteredTxs.forEach(tx => {
                const row = bankTransactionTableBody.insertRow();
                const isCredit = tx.type === 'credit';
                
                runningBalance[tx.bankId] += isCredit ? tx.amount : -tx.amount;
                
                row.insertCell(0).textContent = moment(tx.timestamp).format('lll');
                row.insertCell(1).textContent = tx.bankName;
                row.insertCell(2).textContent = isCredit ? 'Credit' : 'Debit';
                
                let description = shopSettings.ledgerCategories[isCredit ? 'income' : 'expense'][tx.category] || tx.description || 'N/A';
                if(tx.customerName) description += ` (কাস্টমার: ${tx.customerName})`;
                row.insertCell(3).textContent = description;
                
                const creditCell = row.insertCell(4);
                creditCell.textContent = isCredit ? `৳ ${tx.amount.toLocaleString()}` : '—';
                creditCell.style.color = isCredit ? '#22c55e' : '#64748b';

                const debitCell = row.insertCell(5);
                debitCell.textContent = isCredit ? '—' : `৳ ${tx.amount.toLocaleString()}`;
                debitCell.style.color = isCredit ? '#64748b' : '#dc3545';
                
                const balanceCell = row.insertCell(6);
                balanceCell.textContent = `৳ ${runningBalance[tx.bankId].toLocaleString()}`;
                balanceCell.style.fontWeight = 'bold';
                
                totalCredit += isCredit ? tx.amount : 0;
                totalDebit += isCredit ? 0 : tx.amount;
            });
            
             // Update Summary
             document.getElementById('finance-total-bank-balance').textContent = `৳ ${banks.reduce((sum, b) => sum + (b.currentBalance || 0), 0).toLocaleString()}`;
             document.getElementById('finance-total-bank-credit').textContent = `৳ ${totalCredit.toLocaleString()}`;
             document.getElementById('finance-total-bank-debit').textContent = `৳ ${totalDebit.toLocaleString()}`;

        }
        
        filterBankTxBtn.addEventListener('click', renderBankTransactions);
        
        printBankTxBtn.addEventListener('click', () => {
             const fromDate = bankTxFromDateInput.value;
             const toDate = bankTxToDateInput.value;
             const filterBankName = bankTxFilterBankSelect.value ? banks.find(b => b.id === bankTxFilterBankSelect.value)?.name : 'সকল ব্যাংক';
             
             const printContent = `
                <h3 class='center'>ব্যাংক লেনদেন রিপোর্ট</h3>
                 <p class='center'>ব্যাংক: ${filterBankName}</p>
                 <p class='center'>${fromDate} থেকে ${toDate}</p>
                 <hr>
                ${document.getElementById('bank-transaction-table').outerHTML}
            `;
            launchPrint('ব্যাংক লেনদেন রিপোর্ট', printContent);
        });
        
        // --- Expense Report (Section 6) ---
        
        function renderExpenseReport() {
            expenseReportTableBody.innerHTML = '';
            
            const fromDateStr = expenseReportFromDateInput.value;
            const toDateStr = expenseReportToDateInput.value;
            const filterCategory = expenseReportCategorySelect.value;

            const fromDate = fromDateStr ? moment(fromDateStr).startOf('day') : moment(0);
            const toDate = toDateStr ? moment(toDateStr).endOf('day') : moment();
            
            let allExpenses = [];
            
            // 1. Get Cash Expenses (from Ledger) - Exclude 'product_purchase' as it's an asset/inventory flow
            const cashExpenses = ledgerEntries.filter(e => e.type === 'expense' && e.category !== 'product_purchase').map(e => ({
                ...e, source: 'Cash Ledger'
            }));
            allExpenses.push(...cashExpenses);
            
            // 2. Get Bank Expenses (from Bank Transactions: only 'bank_withdrawal_expense' and 'supplier_payment' (if paid by bank))
            const bankWithdrawalExpenses = bankTransactions.filter(t => t.type === 'debit' && t.category === 'bank_withdrawal_expense').map(t => ({
                 id: t.id, timestamp: t.timestamp, type: 'expense', category: t.category, description: t.description, amount: t.amount, 
                 source: t.bankName
            }));
             // Also include direct bank supplier payments as expense (rule is ambiguous, treat as expense here)
             const bankSupplierPayments = bankTransactions.filter(t => t.type === 'debit' && t.category === 'supplier_payment').map(t => ({
                 id: t.id, timestamp: t.timestamp, type: 'expense', category: t.category, description: t.description, amount: t.amount, 
                 source: t.bankName
            }));
            allExpenses.push(...bankWithdrawalExpenses, ...bankSupplierPayments);
            
            // Filter by date and category
            let filteredExpenses = allExpenses.filter(e => {
                const txDate = moment(e.timestamp);
                return txDate.isSameOrAfter(fromDate) && txDate.isSameOrBefore(toDate) &&
                       (!filterCategory || e.category === filterCategory);
            }).sort((a, b) => moment(b.timestamp) - moment(a.timestamp)); // Sort by newest first


            let totalCashExpense = 0;
            let totalBankExpense = 0;

            if (filteredExpenses.length === 0) {
                 expenseReportTableBody.innerHTML = '<tr><td colspan="6">কোনো খরচ খুঁজে পাওয়া যায়নি।</td></tr>';
            }
            
            filteredExpenses.forEach(expense => {
                const row = expenseReportTableBody.insertRow();
                const categoryName = shopSettings.ledgerCategories.expense[expense.category] || expense.category;
                
                row.insertCell(0).textContent = moment(expense.timestamp).format('lll');
                row.insertCell(1).textContent = expense.source === 'Cash Ledger' ? 'Cash Out' : 'Bank Debit';
                row.insertCell(2).textContent = categoryName;
                row.insertCell(3).textContent = expense.description;
                row.insertCell(4).textContent = expense.source;
                row.insertCell(5).textContent = `৳ ${expense.amount.toLocaleString()}`;
                
                if (expense.source === 'Cash Ledger') {
                    totalCashExpense += expense.amount;
                } else {
                    totalBankExpense += expense.amount;
                }
            });
            
            // Update Summary
            totalCashExpenseSpan.textContent = `৳ ${totalCashExpense.toLocaleString()}`;
            totalBankExpenseSpan.textContent = `৳ ${totalBankExpense.toLocaleString()}`;
            totalGrandExpenseSpan.textContent = `৳ ${(totalCashExpense + totalBankExpense).toLocaleString()}`;
        }
        
        filterExpenseReportBtn.addEventListener('click', renderExpenseReport);
        
        printExpenseReportBtn.addEventListener('click', () => {
             const fromDate = expenseReportFromDateInput.value;
             const toDate = expenseReportToDateInput.value;
             
             const printContent = `
                <h3 class='center'>Expense Report (Cash & Bank)</h3>
                 <p class='center'>${fromDate} থেকে ${toDate}</p>
                 <hr>
                ${document.getElementById('expense-report-table').outerHTML}
                <hr>
                 <p class="right">মোট Cash Expense: ৳ ${totalCashExpenseSpan.textContent.replace('৳ ', '')}</p>
                 <p class="right">মোট Bank Expense: ৳ ${totalBankExpenseSpan.textContent.replace('৳ ', '')}</p>
                 <p class="right"><strong>Grand Total Expense: ৳ ${totalGrandExpenseSpan.textContent.replace('৳ ', '')}</strong></p>
            `;
            launchPrint('Expense রিপোর্ট', printContent);
        });

        // --- Customer Data Management (Original) ---
        searchCustomerDataBtn.addEventListener('click', () => {
            const searchTerm = customerSearchInput.value.trim().toLowerCase();
            if (!searchTerm) {
                alert('অনুগ্রহ করে কাস্টমার নাম বা মোবাইল নম্বর লিখুন।');
                return;
            }
            // First search for exact phone match or closest name matches
            const customerByPhone = customers.find(c => c.phone === searchTerm);
            const customerByName = customers.filter(c => c.name.toLowerCase().includes(searchTerm));

            // If exact phone match found, show history immediately
            if (customerByPhone) {
                 customerSearchResultsDiv.style.display = 'none';
                 viewCustomerPurchaseHistory(customerByPhone.name, customerByPhone.phone);
                 return;
            } 
            
            // If name matches, show results table
            if (customerByName.length > 0) {
                 customerSearchResultsTableBody.innerHTML = '';
                 customerByName.forEach(c => {
                    const row = customerSearchResultsTableBody.insertRow();
                    const totalPurchased = sales.filter(s => s.customerId === c.id && s.status !== 'বাতিল').reduce((sum, s) => sum + s.finalAmount, 0);
                    const totalProducts = sales.filter(s => s.customerId === c.id && s.status !== 'বাতিল').reduce((sum, s) => sum + s.items.reduce((s, i) => s + i.quantity, 0), 0);
                    row.innerHTML = `
                        <td>${c.name}</td>
                        <td>${c.phone}</td>
                        <td>৳ ${totalPurchased.toLocaleString()}</td>
                        <td>${totalProducts} পিস</td>
                        <td><button class="primary-btn view-customer-history-btn" data-customer-name="${c.name}" data-customer-phone="${c.phone}"><i class="fas fa-eye"></i> দেখুন</button></td>
                    `;
                 });
                 customerSearchResultsDiv.style.display = 'block';
                 noCustomerSearchResults.style.display = 'none';
                 customerPurchaseHistoryDetails.style.display = 'none';

            } else {
                noCustomerSearchResults.style.display = 'block';
                customerSearchResultsDiv.style.display = 'block';
                customerPurchaseHistoryDetails.style.display = 'none';
            }
        });

        customerSearchResultsTableBody.addEventListener('click', (event) => {
            if (event.target.classList.contains('view-customer-history-btn') || event.target.closest('.view-customer-history-btn')) {
                const customerName = event.target.closest('.view-customer-history-btn').dataset.customerName;
                const customerPhone = event.target.closest('.view-customer-history-btn').dataset.customerPhone;
                viewCustomerPurchaseHistory(customerName, customerPhone);
            }
        });

        function viewCustomerPurchaseHistory(customerName, customerPhone) {
            const customer = customers.find(c => c.phone === customerPhone || c.name.toLowerCase() === customerName?.toLowerCase());

            if (!customer) {
                alert('এই ফোন নম্বর বা নামে কোনো গ্রাহক খুঁজে পাওয়া যায়নি।');
                customerPurchaseHistoryDetails.style.display = 'none';
                return;
            }

            customerHistoryTableBody.innerHTML = '';
            customerReturnsHistoryTableBody.innerHTML = '';
            customerReturnsHistoryTable.style.display = 'none';
            customerReturnsHistoryMessage.style.display = 'none';

            let totalSales = 0;
            let totalProducts = 0;

            const customerTransactions = sales.filter(s => s.customerId === customer.id && s.status !== 'বাতিল')
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            customerHistoryName.textContent = customer.name;
            customerHistoryPhone.textContent = customer.phone;

            let returnsCount = 0;

            customerTransactions.forEach(transaction => {
                if (transaction.type === 'sale') {
                    totalSales += transaction.finalAmount;
                    let itemsListHtml = '<ul>';
                    transaction.items.forEach(item => {
                        totalProducts += item.quantity;
                        itemsListHtml += `<li>${item.name} x ${item.quantity} @ ৳ ${item.unitPrice.toLocaleString()}</li>`;
                    });
                    itemsListHtml += '</ul>';

                    const row = customerHistoryTableBody.insertRow();
                    row.innerHTML = `
                        <td>${transaction.saleId}</td>
                        <td>${new Date(transaction.timestamp).toLocaleDateString()}</td>
                        <td>৳ ${transaction.finalAmount.toLocaleString()}</td>
                        <td>${itemsListHtml}</td>
                    `;
                } else if (transaction.type === 'return') {
                    returnsCount++;
                    totalSales += transaction.finalAmount;
                    transaction.items.forEach(item => {
                        totalProducts -= item.quantity;
                    });

                    const row = customerReturnsHistoryTableBody.insertRow();
                    let itemsSummary = transaction.items.map(item => `${item.name} x ${item.quantity}`).join(', ');
                    row.innerHTML = `
                        <td>${transaction.saleId}</td>
                        <td>${new Date(transaction.timestamp).toLocaleDateString()}</td>
                        <td>${itemsSummary}</td>
                        <td>৳ ${Math.abs(transaction.finalAmount).toLocaleString()}</td>
                        <td>${transaction.items[0]?.reason === 'damaged' ? 'ক্ষতিগ্রস্ত' : 'অন্যান্য'}</td>
                    `;
                }
            });

            customerHistoryTotalSales.textContent = `৳ ${totalSales.toLocaleString()}`;
            customerHistoryTotalProducts.textContent = `${totalProducts} পিস`;
            printCustomerHistoryBtn.dataset.customerId = customer.id;

            if (returnsCount > 0) {
                customerReturnsHistoryTable.style.display = 'table';
            } else {
                customerReturnsHistoryMessage.style.display = 'block';
            }

            customerPurchaseHistoryDetails.style.display = 'block';
            customerSearchResultsDiv.style.display = 'none';
        }

        printCustomerHistoryBtn.addEventListener('click', (e) => {
            const customerId = e.target.dataset.customerId;
            const customer = customers.find(c => c.id === customerId);
            if(customer) printCustomerHistory(customer.name, customer.phone);
        });

        function printCustomerHistory(customerName, customerPhone) {
            const customer = customers.find(c => c.phone === customerPhone);
            if (!customer) return;

            const customerTransactions = sales.filter(s => s.customerId === customer.id && s.status !== 'বাতিল')
                .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            const logoHtml = shopSettings.logoUrl ? `<div class="center"><img src="${shopSettings.logoUrl}" alt="Logo" style="max-height: 80px; max-width: 200px; margin-bottom: 10px;"></div>` : '';


            let totalSales = 0;
            let salesHistoryHtml = '';
            let returnsHistoryHtml = '';

            customerTransactions.forEach(transaction => {
                if (transaction.type === 'sale') {
                    totalSales += transaction.finalAmount;
                    let itemsListHtml = transaction.items.map(item => `${item.name}(${item.quantity})`).join(', ');
                    salesHistoryHtml += `<tr><td>${moment(transaction.timestamp).format('L')}</td><td>${transaction.saleId}</td><td>${itemsListHtml}</td><td class="right">৳${transaction.finalAmount.toLocaleString()}</td></tr>`;
                } else if (transaction.type === 'return') {
                    totalSales += transaction.finalAmount; 
                    let itemsListHtml = transaction.items.map(item => `${item.name}(${item.quantity})`).join(', ');
                    returnsHistoryHtml += `<tr><td>${moment(transaction.timestamp).format('L')}</td><td>${transaction.saleId}</td><td>${itemsListHtml}</td><td class="right">৳${transaction.finalAmount.toLocaleString()}</td></tr>`;
                }
            });

            let printContent = `
                ${logoHtml}
                <h3 class="center">কাস্টমার ইতিহাস</h3>
                <p class="center">${shopSettings.name}</p>
                <hr>
                <p><strong>নাম:</strong> ${customerName}</p>
                <p><strong>ফোন:</strong> ${customerPhone}</p>
                <hr>
                <p><strong>বিক্রয়ের তালিকা</strong></p>
                <table><thead><tr><th>তারিখ</th><th>বিল</th><th>পণ্য</th><th class="right">টাকা</th></tr></thead><tbody>${salesHistoryHtml || '<tr><td colspan="4">বিক্রয় নেই</td></tr>'}</tbody></table>
                <br>
                <p><strong>ফেরতের তালিকা</strong></p>
                <table><thead><tr><th>তারিখ</th><th>বিল</th><th>পণ্য</th><th class="right">টাকা</th></tr></thead><tbody>${returnsHistoryHtml || '<tr><td colspan="4">ফেরত নেই</td></tr>'}</tbody></table>
                <hr>
                <p class="right"><strong>মোট কেনা: ৳ ${totalSales.toLocaleString()}</strong></p>
            `;

            launchPrint('কাস্টমার ইতিহাস', printContent);
        }

        // --- Customer Management (New Section) ---
        function renderCustomerList(filterText = '') {
            customerListTableBody.innerHTML = '';
            
            let filteredCustomers = customers.filter(c => !c.customerCategory); // Only show general customers

            if (filterText) {
                const lowerCaseFilter = filterText.toLowerCase();
                filteredCustomers = filteredCustomers.filter(c => 
                    c.name.toLowerCase().includes(lowerCaseFilter) || 
                    c.phone.includes(lowerCaseFilter)
                );
            }

            if (filteredCustomers.length === 0) {
                 customerListTableBody.innerHTML = '<tr><td colspan="7">কোনো কাস্টমার খুঁজে পাওয়া যায়নি।</td></tr>';
                 return;
            }

            filteredCustomers.forEach(customer => {
                const row = customerListTableBody.insertRow();
                row.insertCell(0).textContent = customer.name;
                row.insertCell(1).textContent = customer.phone;
                row.insertCell(2).textContent = customer.type || 'N/A';
                row.insertCell(3).textContent = `৳ ${(customer.totalPurchased || 0).toLocaleString()}`;
                row.insertCell(4).textContent = `৳ ${(customer.totalPaid || 0).toLocaleString()}`;
                const dueCell = row.insertCell(5);
                dueCell.textContent = `৳ ${(customer.currentDue || 0).toLocaleString()}`;
                dueCell.style.color = (customer.currentDue || 0) > 0 ? '#dc3545' : 'green';

                const actionCell = row.insertCell(6);
                actionCell.className = 'table-action-buttons';
                
                const ledgerBtn = document.createElement('button');
                ledgerBtn.innerHTML = '<i class="fas fa-book"></i> লেজার দেখুন';
                ledgerBtn.className = 'info-btn';
                // 3. Customer Ledger System (Use Existing function to trigger modal)
                ledgerBtn.addEventListener('click', () => showCustomerLedger(customer.id));
                actionCell.appendChild(ledgerBtn);

                const editBtn = document.createElement('button');
                editBtn.innerHTML = '<i class="fas fa-edit"></i> সম্পাদনা';
                editBtn.className = 'edit-btn';
                editBtn.addEventListener('click', () => editCustomer(customer.id));
                actionCell.appendChild(editBtn);
                
                // ** NEW: Admin Due Adjustment Button **
                if (currentUser && currentUser.role === 'admin') {
                    const adjustDueBtn = document.createElement('button');
                    adjustDueBtn.innerHTML = '<i class="fas fa-balance-scale"></i> বাকি অ্যাডজাস্ট';
                    adjustDueBtn.className = 'warning-btn';
                    adjustDueBtn.addEventListener('click', () => adjustCustomerDue(customer.id));
                    actionCell.appendChild(adjustDueBtn);
                    
                    // ✅ NEW: Edit Balance Directly Button
                    const editBalanceBtn = document.createElement('button');
                    editBalanceBtn.innerHTML = '<i class="fas fa-money-bill-wave"></i> ব্যালেন্স এডিট';
                    editBalanceBtn.className = 'primary-btn';
                    editBalanceBtn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                    editBalanceBtn.addEventListener('click', () => editCustomerBalanceDirectly(customer.id));
                    actionCell.appendChild(editBalanceBtn);
                    
                    // ✅ NEW: Delete All Cash Ledger Button
                    const deleteCashLedgerBtn = document.createElement('button');
                    deleteCashLedgerBtn.innerHTML = '<i class="fas fa-trash-alt"></i> ক্যাশ লেজার মুছুন';
                    deleteCashLedgerBtn.className = 'danger-btn';
                    deleteCashLedgerBtn.style.background = '#dc3545';
                    deleteCashLedgerBtn.addEventListener('click', () => deleteAllCustomerCashLedger(customer.id));
                    actionCell.appendChild(deleteCashLedgerBtn);
                }

                if (currentUser && currentUser.role !== 'admin') {
                    editBtn.disabled = true;
                }
            });
        }
        
        // NEW: Customer Management Search Event Listener
        customerManagementSearchInput.addEventListener('input', (e) => {
            renderCustomerList(e.target.value.trim());
        });

        // ✅ NEW: Customer Management Report System
        const customerReportSelect = document.getElementById('customer-report-select');
        const customerReportFromDate = document.getElementById('customer-report-from-date');
        const customerReportToDate = document.getElementById('customer-report-to-date');
        const generateCustomerReportBtn = document.getElementById('generate-customer-report-btn');
        const printCustomerReportBtn = document.getElementById('print-customer-report-btn');
        const clearCustomerReportBtn = document.getElementById('clear-customer-report-btn');
        const customerReportDisplay = document.getElementById('customer-report-display');
        const customerLedgerTbody = document.getElementById('customer-ledger-tbody');

        // Populate customer dropdown
        function populateCustomerReportDropdown() {
            customerReportSelect.innerHTML = '<option value="">-- কাস্টমার নির্বাচন করুন --</option>';
            const generalCustomers = customers.filter(c => !c.customerCategory);
            generalCustomers.sort((a, b) => a.name.localeCompare(b.name));
            generalCustomers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.id;
                option.textContent = `${customer.name} (${customer.phone}) - বাকি: ৳ ${(customer.currentDue || 0).toLocaleString()}`;
                customerReportSelect.appendChild(option);
            });
        }

        // Generate Customer Report
        generateCustomerReportBtn.addEventListener('click', () => {
            const customerId = customerReportSelect.value;
            const fromDate = customerReportFromDate.value;
            const toDate = customerReportToDate.value;

            if (!customerId) {
                alert('অনুগ্রহ করে একটি কাস্টমার নির্বাচন করুন।');
                return;
            }

            const customer = customers.find(c => c.id === customerId);
            if (!customer) return;

            // Get all transactions for this customer
            let customerSales = sales.filter(s => s.customerId === customerId);
            let customerLedger = ledgerEntries.filter(l => l.customerId === customerId);

            // Filter by date if provided
            if (fromDate) {
                const fromDateObj = new Date(fromDate);
                fromDateObj.setHours(0, 0, 0, 0);
                customerSales = customerSales.filter(s => new Date(s.timestamp) >= fromDateObj);
                customerLedger = customerLedger.filter(l => new Date(l.timestamp) >= fromDateObj);
            }
            if (toDate) {
                const toDateObj = new Date(toDate);
                toDateObj.setHours(23, 59, 59, 999);
                customerSales = customerSales.filter(s => new Date(s.timestamp) <= toDateObj);
                customerLedger = customerLedger.filter(l => new Date(l.timestamp) <= toDateObj);
            }

            // Calculate totals
            const totalSales = customerSales.reduce((sum, s) => sum + (s.totalAmount || 0), 0);
            const totalPaid = customerLedger
                .filter(l => l.type === 'income' && (l.category === 'due_collection' || l.category === 'sales_income'))
                .reduce((sum, l) => sum + (l.amount || 0), 0);

            // Update summary cards
            document.getElementById('report-customer-name').textContent = customer.name;
            document.getElementById('report-total-sales').textContent = `৳ ${totalSales.toLocaleString()}`;
            document.getElementById('report-total-paid').textContent = `৳ ${totalPaid.toLocaleString()}`;
            document.getElementById('report-current-due').textContent = `৳ ${(customer.currentDue || 0).toLocaleString()}`;

            // Build ledger entries
            const ledgerEntries2 = [];

            // Add sales as debit entries
            customerSales.forEach(sale => {
                ledgerEntries2.push({
                    date: new Date(sale.timestamp),
                    description: `বিক্রয় - ${sale.id}`,
                    debit: sale.totalAmount || 0,
                    credit: 0,
                    type: 'sale'
                });
            });

            // Add payments as credit entries
            customerLedger.forEach(entry => {
                if (entry.type === 'income' && (entry.category === 'due_collection' || entry.category === 'sales_income')) {
                    ledgerEntries2.push({
                        date: new Date(entry.timestamp),
                        description: entry.description || 'পরিশোধ',
                        debit: 0,
                        credit: entry.amount || 0,
                        type: 'payment'
                    });
                }
            });

            // Sort by date
            ledgerEntries2.sort((a, b) => a.date - b.date);

            // Calculate running balance
            let runningBalance = 0;
            ledgerEntries2.forEach(entry => {
                runningBalance += entry.debit - entry.credit;
                entry.balance = runningBalance;
            });

            // Calculate totals for footer
            const totalDebit = ledgerEntries2.reduce((sum, e) => sum + e.debit, 0);
            const totalCredit = ledgerEntries2.reduce((sum, e) => sum + e.credit, 0);
            const totalPayment = totalCredit; // Payment = credit
            const totalDue = totalDebit - totalCredit; // Due = debit - credit
            const finalBalance = runningBalance;

            // Render ledger table
            customerLedgerTbody.innerHTML = '';
            if (ledgerEntries2.length === 0) {
                document.getElementById('customer-ledger-empty').style.display = 'block';
                document.getElementById('customer-ledger-table').style.display = 'none';
            } else {
                document.getElementById('customer-ledger-empty').style.display = 'none';
                document.getElementById('customer-ledger-table').style.display = 'table';

                ledgerEntries2.forEach(entry => {
                    const row = customerLedgerTbody.insertRow();
                    row.insertCell(0).textContent = entry.date.toLocaleDateString('bn-BD');
                    row.insertCell(1).textContent = entry.description;
                    
                    const debitCell = row.insertCell(2);
                    debitCell.textContent = entry.debit > 0 ? `৳ ${entry.debit.toLocaleString()}` : '-';
                    debitCell.style.textAlign = 'right';
                    debitCell.style.color = entry.debit > 0 ? '#f87171' : 'inherit';
                    
                    const creditCell = row.insertCell(3);
                    creditCell.textContent = entry.credit > 0 ? `৳ ${entry.credit.toLocaleString()}` : '-';
                    creditCell.style.textAlign = 'right';
                    creditCell.style.color = entry.credit > 0 ? '#34d399' : 'inherit';
                    
                    // ✅ NEW: Payment column
                    const paymentCell = row.insertCell(4);
                    paymentCell.textContent = entry.credit > 0 ? `৳ ${entry.credit.toLocaleString()}` : '-';
                    paymentCell.style.textAlign = 'right';
                    paymentCell.style.color = entry.credit > 0 ? '#a78bfa' : 'inherit';
                    paymentCell.style.fontWeight = entry.credit > 0 ? 'bold' : 'normal';
                    
                    // ✅ NEW: Due column (for this transaction)
                    const dueCell = row.insertCell(5);
                    const entryDue = entry.debit - entry.credit;
                    dueCell.textContent = entryDue > 0 ? `৳ ${entryDue.toLocaleString()}` : '-';
                    dueCell.style.textAlign = 'right';
                    dueCell.style.color = entryDue > 0 ? '#fbbf24' : 'inherit';
                    
                    const balanceCell = row.insertCell(6);
                    balanceCell.textContent = `৳ ${entry.balance.toLocaleString()}`;
                    balanceCell.style.textAlign = 'right';
                    balanceCell.style.fontWeight = 'bold';
                    balanceCell.style.color = entry.balance > 0 ? '#f87171' : '#34d399';
                });
                
                // Update footer totals
                document.getElementById('customer-footer-debit').textContent = `৳ ${totalDebit.toLocaleString()}`;
                document.getElementById('customer-footer-credit').textContent = `৳ ${totalCredit.toLocaleString()}`;
                document.getElementById('customer-footer-payment').textContent = `৳ ${totalPayment.toLocaleString()}`;
                document.getElementById('customer-footer-due').textContent = `৳ ${totalDue.toLocaleString()}`;
                document.getElementById('customer-footer-balance').textContent = `৳ ${finalBalance.toLocaleString()}`;
            }

            // Show report display
            customerReportDisplay.style.display = 'block';
        });

        // Clear Report
        clearCustomerReportBtn.addEventListener('click', () => {
            customerReportSelect.value = '';
            customerReportFromDate.value = '';
            customerReportToDate.value = '';
            customerReportDisplay.style.display = 'none';
        });

        // ✅ NEW: All Customers Combined Report Functions
        const allCustomersFromDate = document.getElementById('all-customers-from-date');
        const allCustomersToDate = document.getElementById('all-customers-to-date');
        const generateAllCustomersReportBtn = document.getElementById('generate-all-customers-report-btn');
        const printAllCustomersReportBtn = document.getElementById('print-all-customers-report-btn');
        const clearAllCustomersReportBtn = document.getElementById('clear-all-customers-report-btn');
        const allCustomersReportDisplay = document.getElementById('all-customers-report-display');
        const allCustomersSummaryTbody = document.getElementById('all-customers-summary-tbody');

        // Generate All Customers Report
        generateAllCustomersReportBtn.addEventListener('click', () => {
            const fromDate = allCustomersFromDate.value;
            const toDate = allCustomersToDate.value;

            // Get all general customers
            const generalCustomers = customers.filter(c => !c.customerCategory);
            
            if (generalCustomers.length === 0) {
                alert('কোনো কাস্টমার পাওয়া যায়নি।');
                return;
            }

            let grandTotalSales = 0;
            let grandTotalPaid = 0;
            let grandTotalDue = 0;

            // Process each customer
            const customerData = generalCustomers.map((customer, index) => {
                // Get sales for this customer
                let customerSales = sales.filter(s => s.customerId === customer.id);
                let customerLedger = ledgerEntries.filter(l => l.customerId === customer.id);

                // Filter by date if provided
                if (fromDate) {
                    const fromDateObj = new Date(fromDate);
                    fromDateObj.setHours(0, 0, 0, 0);
                    customerSales = customerSales.filter(s => new Date(s.timestamp) >= fromDateObj);
                    customerLedger = customerLedger.filter(l => new Date(l.timestamp) >= fromDateObj);
                }
                if (toDate) {
                    const toDateObj = new Date(toDate);
                    toDateObj.setHours(23, 59, 59, 999);
                    customerSales = customerSales.filter(s => new Date(s.timestamp) <= toDateObj);
                    customerLedger = customerLedger.filter(l => new Date(l.timestamp) <= toDateObj);
                }

                const totalSales = customerSales.reduce((sum, s) => sum + (s.totalAmount || 0), 0);
                const totalPaid = customerLedger
                    .filter(l => l.type === 'income' && (l.category === 'due_collection' || l.category === 'sales_income'))
                    .reduce((sum, l) => sum + (l.amount || 0), 0);
                const currentDue = customer.currentDue || 0;

                grandTotalSales += totalSales;
                grandTotalPaid += totalPaid;
                grandTotalDue += currentDue;

                return {
                    index: index + 1,
                    name: customer.name,
                    phone: customer.phone || 'N/A',
                    totalSales: totalSales,
                    totalPaid: totalPaid,
                    currentDue: currentDue
                };
            });

            // Sort by due amount (highest first)
            customerData.sort((a, b) => b.currentDue - a.currentDue);

            // Update summary cards
            document.getElementById('all-report-total-customers').textContent = generalCustomers.length.toLocaleString();
            document.getElementById('all-report-total-sales').textContent = `৳ ${grandTotalSales.toLocaleString()}`;
            document.getElementById('all-report-total-paid').textContent = `৳ ${grandTotalPaid.toLocaleString()}`;
            document.getElementById('all-report-total-due').textContent = `৳ ${grandTotalDue.toLocaleString()}`;

            // Update footer totals
            document.getElementById('all-report-footer-sales').textContent = `৳ ${grandTotalSales.toLocaleString()}`;
            document.getElementById('all-report-footer-paid').textContent = `৳ ${grandTotalPaid.toLocaleString()}`;
            document.getElementById('all-report-footer-due').textContent = `৳ ${grandTotalDue.toLocaleString()}`;

            // Render table
            allCustomersSummaryTbody.innerHTML = '';
            if (customerData.length === 0) {
                document.getElementById('all-customers-report-empty').style.display = 'block';
                document.getElementById('all-customers-summary-table').style.display = 'none';
            } else {
                document.getElementById('all-customers-report-empty').style.display = 'none';
                document.getElementById('all-customers-summary-table').style.display = 'table';

                customerData.forEach(data => {
                    const row = allCustomersSummaryTbody.insertRow();
                    row.insertCell(0).textContent = data.index;
                    row.insertCell(1).textContent = data.name;
                    row.insertCell(2).textContent = data.phone;
                    
                    const salesCell = row.insertCell(3);
                    salesCell.textContent = `৳ ${data.totalSales.toLocaleString()}`;
                    salesCell.style.textAlign = 'right';
                    salesCell.style.color = '#fbbf24';
                    
                    const paidCell = row.insertCell(4);
                    paidCell.textContent = `৳ ${data.totalPaid.toLocaleString()}`;
                    paidCell.style.textAlign = 'right';
                    paidCell.style.color = '#34d399';
                    
                    const dueCell = row.insertCell(5);
                    dueCell.textContent = `৳ ${data.currentDue.toLocaleString()}`;
                    dueCell.style.textAlign = 'right';
                    dueCell.style.fontWeight = 'bold';
                    dueCell.style.color = data.currentDue > 0 ? '#f87171' : '#34d399';
                    
                    const statusCell = row.insertCell(6);
                    statusCell.style.textAlign = 'center';
                    if (data.currentDue > 0) {
                        statusCell.innerHTML = '<span style="background: rgba(239, 68, 68, 0.2); color: #f87171; padding: 4px 8px; border-radius: 4px; font-size: 12px;">বাকি আছে</span>';
                    } else {
                        statusCell.innerHTML = '<span style="background: rgba(16, 185, 129, 0.2); color: #34d399; padding: 4px 8px; border-radius: 4px; font-size: 12px;">পরিশোধিত</span>';
                    }
                });
            }

            // Show report
            allCustomersReportDisplay.style.display = 'block';
        });

        // Clear All Customers Report
        clearAllCustomersReportBtn.addEventListener('click', () => {
            allCustomersFromDate.value = '';
            allCustomersToDate.value = '';
            allCustomersReportDisplay.style.display = 'none';
        });

        // Print All Customers Report
        printAllCustomersReportBtn.addEventListener('click', () => {
            if (allCustomersReportDisplay.style.display === 'none') {
                alert('অনুগ্রহ করে প্রথমে রিপোর্ট জেনারেট করুন।');
                return;
            }

            const fromDate = allCustomersFromDate.value;
            const toDate = allCustomersToDate.value;

            const logoHtml = shopSettings.logoUrl ? `<div style="text-align: center; margin-bottom: 10px;"><img src="${shopSettings.logoUrl}" alt="Logo" style="max-height: 60px; max-width: 150px;"></div>` : '';
            
            let dateRangeText = '';
            if (fromDate && toDate) {
                dateRangeText = `<p style="text-align: center; font-size: 14px; margin: 5px 0;">তারিখ: ${new Date(fromDate).toLocaleDateString('bn-BD')} থেকে ${new Date(toDate).toLocaleDateString('bn-BD')}</p>`;
            } else if (fromDate) {
                dateRangeText = `<p style="text-align: center; font-size: 14px; margin: 5px 0;">তারিখ: ${new Date(fromDate).toLocaleDateString('bn-BD')} থেকে বর্তমান</p>`;
            } else if (toDate) {
                dateRangeText = `<p style="text-align: center; font-size: 14px; margin: 5px 0;">শুরু থেকে ${new Date(toDate).toLocaleDateString('bn-BD')} পর্যন্ত</p>`;
            }

            const printContent = `
                <div style="font-family: 'Noto Sans Bengali', Arial, sans-serif; padding: 20px;">
                    ${logoHtml}
                    <h2 style="text-align: center; margin: 10px 0;">${shopSettings.name || 'দোকান'}</h2>
                    <p style="text-align: center; font-size: 14px; margin: 5px 0;">${shopSettings.address || ''}</p>
                    <hr style="margin: 15px 0; border: 1px solid #ddd;">
                    <h3 style="text-align: center; margin: 10px 0;">সব কাস্টমারের সম্মিলিত রিপোর্ট</h3>
                    ${dateRangeText}
                    <hr style="margin: 15px 0; border: 1px solid #ddd;">
                    
                    <div style="display: flex; justify-content: space-between; margin-bottom: 20px; text-align: center;">
                        <div style="flex: 1; padding: 10px; border: 2px solid #3b82f6; margin: 0 5px; border-radius: 5px;">
                            <div style="font-size: 12px; color: #666;">মোট কাস্টমার</div>
                            <div style="font-size: 18px; font-weight: bold; color: #3b82f6;">${document.getElementById('all-report-total-customers').textContent}</div>
                        </div>
                        <div style="flex: 1; padding: 10px; border: 2px solid #f59e0b; margin: 0 5px; border-radius: 5px;">
                            <div style="font-size: 12px; color: #666;">মোট বিক্রয়</div>
                            <div style="font-size: 18px; font-weight: bold; color: #f59e0b;">${document.getElementById('all-report-total-sales').textContent}</div>
                        </div>
                        <div style="flex: 1; padding: 10px; border: 2px solid #10b981; margin: 0 5px; border-radius: 5px;">
                            <div style="font-size: 12px; color: #666;">মোট পরিশোধ</div>
                            <div style="font-size: 18px; font-weight: bold; color: #10b981;">${document.getElementById('all-report-total-paid').textContent}</div>
                        </div>
                        <div style="flex: 1; padding: 10px; border: 2px solid #ef4444; margin: 0 5px; border-radius: 5px;">
                            <div style="font-size: 12px; color: #666;">মোট বাকি</div>
                            <div style="font-size: 18px; font-weight: bold; color: #ef4444;">${document.getElementById('all-report-total-due').textContent}</div>
                        </div>
                    </div>

                    <h4 style="margin: 15px 0 10px 0;">সব কাস্টমারের সারাংশ তালিকা</h4>
                    <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                        <thead>
                            <tr style="background: #f3f4f6;">
                                <th style="padding: 6px; border: 1px solid #ddd; text-align: left;">#</th>
                                <th style="padding: 6px; border: 1px solid #ddd; text-align: left;">কাস্টমারের নাম</th>
                                <th style="padding: 6px; border: 1px solid #ddd; text-align: left;">মোবাইল</th>
                                <th style="padding: 6px; border: 1px solid #ddd; text-align: right;">মোট বিক্রয়</th>
                                <th style="padding: 6px; border: 1px solid #ddd; text-align: right;">মোট পরিশোধ</th>
                                <th style="padding: 6px; border: 1px solid #ddd; text-align: right;">বর্তমান বাকি</th>
                                <th style="padding: 6px; border: 1px solid #ddd; text-align: center;">স্ট্যাটাস</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${allCustomersSummaryTbody.innerHTML}
                        </tbody>
                        <tfoot style="font-weight: bold; background: #f9fafb;">
                            <tr>
                                <td colspan="3" style="padding: 6px; border: 1px solid #ddd; text-align: right;">সর্বমোট:</td>
                                <td style="padding: 6px; border: 1px solid #ddd; text-align: right; color: #f59e0b;">${document.getElementById('all-report-footer-sales').textContent}</td>
                                <td style="padding: 6px; border: 1px solid #ddd; text-align: right; color: #10b981;">${document.getElementById('all-report-footer-paid').textContent}</td>
                                <td style="padding: 6px; border: 1px solid #ddd; text-align: right; color: #ef4444;">${document.getElementById('all-report-footer-due').textContent}</td>
                                <td style="padding: 6px; border: 1px solid #ddd;"></td>
                            </tr>
                        </tfoot>
                    </table>

                    <div style="margin-top: 30px; text-align: center; font-size: 12px; color: #666;">
                        <p>রিপোর্ট প্রিন্টের সময়: ${new Date().toLocaleString('bn-BD')}</p>
                        <p>সফটওয়্যার: MY POS SOF</p>
                    </div>
                </div>
            `;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>সব কাস্টমারের রিপোর্ট</title>
                        <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@400;500;700&display=swap" rel="stylesheet">
                    </head>
                    <body onload="window.print(); window.close();">
                        ${printContent}
                    </body>
                </html>
            `);
            printWindow.document.close();
        });

        // Print Customer Report
        printCustomerReportBtn.addEventListener('click', () => {
            if (customerReportDisplay.style.display === 'none') {
                alert('অনুগ্রহ করে প্রথমে রিপোর্ট জেনারেট করুন।');
                return;
            }

            const customerId = customerReportSelect.value;
            const customer = customers.find(c => c.id === customerId);
            const fromDate = customerReportFromDate.value;
            const toDate = customerReportToDate.value;

            const logoHtml = shopSettings.logoUrl ? `<div style="text-align: center; margin-bottom: 10px;"><img src="${shopSettings.logoUrl}" alt="Logo" style="max-height: 60px; max-width: 150px;"></div>` : '';
            
            let dateRangeText = '';
            if (fromDate && toDate) {
                dateRangeText = `<p style="text-align: center; font-size: 14px; margin: 5px 0;">তারিখ: ${new Date(fromDate).toLocaleDateString('bn-BD')} থেকে ${new Date(toDate).toLocaleDateString('bn-BD')}</p>`;
            } else if (fromDate) {
                dateRangeText = `<p style="text-align: center; font-size: 14px; margin: 5px 0;">তারিখ: ${new Date(fromDate).toLocaleDateString('bn-BD')} থেকে বর্তমান</p>`;
            } else if (toDate) {
                dateRangeText = `<p style="text-align: center; font-size: 14px; margin: 5px 0;">শুরু থেকে ${new Date(toDate).toLocaleDateString('bn-BD')} পর্যন্ত</p>`;
            }

            const printContent = `
                <div style="font-family: 'Noto Sans Bengali', Arial, sans-serif; padding: 20px;">
                    ${logoHtml}
                    <h2 style="text-align: center; margin: 10px 0;">${shopSettings.name || 'দোকান'}</h2>
                    <p style="text-align: center; font-size: 14px; margin: 5px 0;">${shopSettings.address || ''}</p>
                    <hr style="margin: 15px 0; border: 1px solid #ddd;">
                    <h3 style="text-align: center; margin: 10px 0;">কাস্টমার স্টেটমেন্ট রিপোর্ট</h3>
                    ${dateRangeText}
                    <hr style="margin: 15px 0; border: 1px solid #ddd;">
                    
                    <div style="margin-bottom: 20px;">
                        <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px;">
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold; width: 30%;">কাস্টমারের নাম:</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${customer.name}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">মোবাইল নম্বর:</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${customer.phone || 'N/A'}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">ঠিকানা:</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${customer.address || 'N/A'}</td>
                            </tr>
                        </table>
                    </div>

                    <div style="display: flex; justify-content: space-between; margin-bottom: 20px; text-align: center;">
                        <div style="flex: 1; padding: 10px; border: 2px solid #f59e0b; margin: 0 5px; border-radius: 5px;">
                            <div style="font-size: 12px; color: #666;">মোট বিক্রয়</div>
                            <div style="font-size: 18px; font-weight: bold; color: #f59e0b;">${document.getElementById('report-total-sales').textContent}</div>
                        </div>
                        <div style="flex: 1; padding: 10px; border: 2px solid #10b981; margin: 0 5px; border-radius: 5px;">
                            <div style="font-size: 12px; color: #666;">মোট পরিশোধ</div>
                            <div style="font-size: 18px; font-weight: bold; color: #10b981;">${document.getElementById('report-total-paid').textContent}</div>
                        </div>
                        <div style="flex: 1; padding: 10px; border: 2px solid #ef4444; margin: 0 5px; border-radius: 5px;">
                            <div style="font-size: 12px; color: #666;">বর্তমান বাকি</div>
                            <div style="font-size: 18px; font-weight: bold; color: #ef4444;">${document.getElementById('report-current-due').textContent}</div>
                        </div>
                    </div>

                    <h4 style="margin: 15px 0 10px 0;">লেনদেনের বিস্তারিত তালিকা</h4>
                    <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                        <thead>
                            <tr style="background: #f3f4f6;">
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">তারিখ</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">বিবরণ</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: right;">ডেবিট (বিক্রয়)</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: right;">ক্রেডিট (পরিশোধ)</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: right;">পেমেন্ট</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: right;">বাকি</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: right;">ব্যালেন্স</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${customerLedgerTbody.innerHTML}
                        </tbody>
                        <tfoot style="font-weight: bold; background: #f9fafb;">
                            <tr>
                                <td colspan="2" style="padding: 8px; border: 1px solid #ddd; text-align: right;">সর্বমোট:</td>
                                <td style="padding: 8px; border: 1px solid #ddd; text-align: right; color: #ef4444;">${document.getElementById('customer-footer-debit').textContent}</td>
                                <td style="padding: 8px; border: 1px solid #ddd; text-align: right; color: #10b981;">${document.getElementById('customer-footer-credit').textContent}</td>
                                <td style="padding: 8px; border: 1px solid #ddd; text-align: right; color: #8b5cf6;">${document.getElementById('customer-footer-payment').textContent}</td>
                                <td style="padding: 8px; border: 1px solid #ddd; text-align: right; color: #f59e0b;">${document.getElementById('customer-footer-due').textContent}</td>
                                <td style="padding: 8px; border: 1px solid #ddd; text-align: right; color: #3b82f6;">${document.getElementById('customer-footer-balance').textContent}</td>
                            </tr>
                        </tfoot>
                    </table>

                    <div style="margin-top: 30px; text-align: center; font-size: 12px; color: #666;">
                        <p>রিপোর্ট প্রিন্টের সময়: ${new Date().toLocaleString('bn-BD')}</p>
                        <p>সফটওয়্যার: MY POS SOF</p>
                    </div>
                </div>
            `;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>কাস্টমার রিপোর্ট - ${customer.name}</title>
                        <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@400;500;700&display=swap" rel="stylesheet">
                    </head>
                    <body onload="window.print(); window.close();">
                        ${printContent}
                    </body>
                </html>
            `);
            printWindow.document.close();
        });

        // Update dropdown when customers change
        function updateCustomerReportDropdown() {
            populateCustomerReportDropdown();
        }

        // ** NEW: Admin Due Adjustment Logic **
        async function adjustCustomerDue(customerId) {
            if (currentUser.role !== 'admin') {
                alert('আপনার বাকি অ্যাডজাস্ট করার অনুমতি নেই।');
                return;
            }
            const customer = customers.find(c => c.id === customerId);
            if (!customer) return;

            const currentDue = customer.currentDue || 0;
            const newDueStr = prompt(`কাস্টমার: ${customer.name}\nবর্তমান বাকি: ৳ ${currentDue.toLocaleString()}\n\nনতুন বাকি টাকার পরিমাণ লিখুন:`);

            if (newDueStr === null) return; // Cancelled
            
            const newDue = parseFloat(newDueStr);
            if (isNaN(newDue) || newDue < 0) {
                alert('অনুগ্রহ করে ০ বা তার বেশি একটি বৈধ সংখ্যা দিন।');
                return;
            }
            
            const difference = newDue - currentDue;
            const adjustmentAmount = Math.abs(difference);

            if (adjustmentAmount < 0.01) {
                alert('বাকি টাকার কোনো পরিবর্তন হয়নি।');
                return;
            }

            const adjustmentType = difference > 0 ? 'income' : 'expense';
            const adjustmentCategory = 'manual_due_adjustment';
            const adjustmentDescription = difference > 0 
                ? `ম্যানুয়াল বাকি যোগ: ${customer.name}` 
                : `ম্যানুয়াল বাকি হ্রাস: ${customer.name}`;
            const actionText = difference > 0 ? 'যোগ' : 'হ্রাস';

            if (!confirm(`আপনি কি নিশ্চিত? কাস্টমারের বাকি ৳ ${currentDue.toLocaleString()} থেকে ৳ ${newDue.toLocaleString()} তে পরিবর্তন হবে।\n\nলেজারে ৳ ${adjustmentAmount.toLocaleString()} ${actionText} হবে।`)) {
                return;
            }

            // 1. Update Customer Totals
            customer.currentDue = newDue;
            customer.totalPurchased = (customer.totalPurchased || 0) + difference; // Adjust totalPurchased to keep accounting balanced
            await db.put('customers', customer);
            const customerIndex = customers.findIndex(c => c.id === customer.id);
            if(customerIndex !== -1) customers[customerIndex] = customer;

            // 2. Adjust Dues list (Clear all old dues and create a new consolidated due if newDue > 0)
            const dbPromises = [];
            
            // Delete old remaining dues for this customer
            dues.filter(d => d.customerId === customerId && d.remainingAmount > 0).forEach(d => {
                dbPromises.push(db.delete('dues', d.id));
            });
            dues = dues.filter(d => d.customerId !== customerId || d.remainingAmount <= 0);

            // Create new consolidated due record if there's remaining due
            if (newDue > 0.01) {
                const dueId = generateUniqueId('D');
                 const newDueRecord = {
                    id: dueId,
                    dueId: dueId,
                    saleId: dueId,
                    customerId: customerId,
                    customerName: customer.name,
                    customerPhone: customer.phone,
                    originalAmount: newDue,
                    remainingAmount: newDue,
                    paidAmount: 0,
                    dateIssued: new Date().toISOString(),
                    description: `ম্যানুয়াল অ্যাডজাস্টমেন্ট`,
                    billType: 'manual_adjustment',
                    appliesToMonths: [] 
                };
                dues.push(newDueRecord);
                dbPromises.push(db.put('dues', newDueRecord));
            }


            // 3. Create Ledger Entry for Audit
            const newLedgerEntry = {
                id: generateUniqueId('L'),
                timestamp: new Date().toISOString(),
                type: adjustmentType,
                category: adjustmentCategory,
                description: adjustmentDescription,
                amount: adjustmentAmount,
                customerId: customerId,
                customerName: customer.name,
                saleId: 'ADJUST_' + generateUniqueId('L') // Unique ID for audit trail
            };
            ledgerEntries.push(newLedgerEntry);
            dbPromises.push(db.put('ledgerEntries', newLedgerEntry));

            await Promise.all(dbPromises);
            
            updateAllUI();

            alert('বাকি টাকা সফলভাবে অ্যাডজাস্ট করা হয়েছে!');
        }

        // ✅ NEW: Delete Customer Payment Function
        async function deleteCustomerPayment(paymentId, paymentType, customerId) {
            if (currentUser.role !== 'admin') {
                alert('আপনার পেমেন্ট ডিলিট করার অনুমতি নেই।');
                return;
            }

            const customer = customers.find(c => c.id === customerId);
            if (!customer) {
                alert('কাস্টমার খুঁজে পাওয়া যায়নি!');
                return;
            }

            let paymentEntry = null;
            let paymentAmount = 0;
            let paymentSource = '';

            // Find the payment entry
            if (paymentType === 'ledger') {
                paymentEntry = ledgerEntries.find(e => e.id === paymentId);
                if (paymentEntry) {
                    paymentAmount = paymentEntry.amount;
                    paymentSource = 'Cash Ledger';
                }
            } else if (paymentType === 'bank') {
                paymentEntry = bankTransactions.find(t => t.id === paymentId);
                if (paymentEntry) {
                    paymentAmount = paymentEntry.amount || paymentEntry.totalAmount;
                    paymentSource = paymentEntry.bankName || 'Bank';
                }
            }

            if (!paymentEntry) {
                alert('পেমেন্ট রেকর্ড খুঁজে পাওয়া যায়নি!');
                return;
            }

            // Confirmation dialog
            const confirmMessage = 
                `⚠️ সতর্কতা: আপনি এই পেমেন্ট ডিলিট করতে চলেছেন!\n\n` +
                `কাস্টমার: ${customer.name}\n` +
                `পেমেন্টের পরিমাণ: ৳ ${paymentAmount.toLocaleString()}\n` +
                `উৎস: ${paymentSource}\n` +
                `তারিখ: ${moment(paymentEntry.timestamp).format('Do MMMM, YYYY')}\n\n` +
                `ডিলিট করলে:\n` +
                `• কাস্টমারের বাকি ৳ ${paymentAmount.toLocaleString()} বাড়বে\n` +
                `• ${paymentSource} থেকে টাকা কাটা যাবে\n\n` +
                `আপনি কি নিশ্চিত?`;

            if (!confirm(confirmMessage)) {
                return;
            }

            // Second confirmation
            if (!confirm(`আবার নিশ্চিত করুন: পেমেন্ট ৳ ${paymentAmount.toLocaleString()} ডিলিট করা হবে। এই কাজটি অপরিবর্তনীয়!`)) {
                return;
            }

            try {
                showLoader();
                const dbPromises = [];

                // 1. Update customer due (increase by payment amount)
                customer.currentDue = (customer.currentDue || 0) + paymentAmount;
                customer.totalPaid = Math.max(0, (customer.totalPaid || 0) - paymentAmount);
                dbPromises.push(db.put('customers', customer));

                // 2. Delete the payment entry based on type
                if (paymentType === 'ledger') {
                    // Delete from ledger entries
                    await db.delete('ledgerEntries', paymentId);
                    const index = ledgerEntries.findIndex(e => e.id === paymentId);
                    if (index !== -1) {
                        ledgerEntries.splice(index, 1);
                    }
                } else if (paymentType === 'bank') {
                    // Reverse bank transaction
                    const bank = banks.find(b => b.id === paymentEntry.bankId);
                    if (bank) {
                        bank.currentBalance = Math.max(0, (bank.currentBalance || 0) - paymentAmount);
                        dbPromises.push(db.put('banks', bank));
                    }
                    
                    // Delete bank transaction record
                    await db.delete('bankTransactions', paymentId);
                    const index = bankTransactions.findIndex(t => t.id === paymentId);
                    if (index !== -1) {
                        bankTransactions.splice(index, 1);
                    }
                }

                // 3. Create a reversal ledger entry for audit trail
                const reversalEntry = {
                    id: generateUniqueId('L'),
                    timestamp: new Date().toISOString(),
                    type: 'expense',
                    category: 'manual_due_adjustment',
                    description: `পেমেন্ট ডিলিট (বাকি বৃদ্ধি): ${customer.name} - ৳ ${paymentAmount.toLocaleString()}`,
                    amount: paymentAmount,
                    customerId: customerId,
                    customerName: customer.name,
                    saleId: 'PAYMENT_DELETE_' + paymentId
                };
                ledgerEntries.push(reversalEntry);
                dbPromises.push(db.put('ledgerEntries', reversalEntry));

                await Promise.all(dbPromises);

                hideLoader();

                alert(`✅ পেমেন্ট সফলভাবে ডিলিট করা হয়েছে!\n\n• কাস্টমারের বাকি ৳ ${paymentAmount.toLocaleString()} বাড়ানো হয়েছে\n• ${paymentSource} আপডেট করা হয়েছে`);

                // Refresh the ledger view
                renderCustomerLedgerTables(customerId);
                
                // Update customer summary
                document.getElementById('summary-total-customer-paid').textContent = `৳ ${(customer.totalPaid || 0).toLocaleString()}`;
                document.getElementById('summary-current-customer-due').textContent = `৳ ${(customer.currentDue || 0).toLocaleString()}`;
                
                // Refresh other UI components
                updateAllUI();

            } catch (error) {
                hideLoader();
                console.error('Error deleting payment:', error);
                alert('❌ পেমেন্ট ডিলিট করতে সমস্যা হয়েছে। অনুগ্রহ করে আবার চেষ্টা করুন।');
            }
        }

        // ✅ NEW: Edit Customer Balance Directly from Customer Management
        async function editCustomerBalanceDirectly(customerId) {
            if (currentUser.role !== 'admin') {
                alert('আপনার ব্যালেন্স এডিট করার অনুমতি নেই।');
                return;
            }

            const customer = customers.find(c => c.id === customerId);
            if (!customer) {
                alert('কাস্টমার খুঁজে পাওয়া যায়নি!');
                return;
            }

            const currentDue = customer.currentDue || 0;
            
            // Show detailed info and prompt for new balance
            const newDueStr = prompt(
                `কাস্টমার: ${customer.name}\n` +
                `ফোন: ${customer.phone}\n\n` +
                `বর্তমান বাকি: ৳ ${currentDue.toLocaleString()}\n` +
                `মোট কেনা: ৳ ${(customer.totalPurchased || 0).toLocaleString()}\n` +
                `মোট পরিশোধ: ৳ ${(customer.totalPaid || 0).toLocaleString()}\n\n` +
                `নতুন বাকি টাকার পরিমাণ লিখুন:`
            );

            if (newDueStr === null) return; // Cancelled

            const newDue = parseFloat(newDueStr);
            if (isNaN(newDue) || newDue < 0) {
                alert('অনুগ্রহ করে ০ বা তার বেশি একটি বৈধ সংখ্যা দিন।');
                return;
            }

            const difference = newDue - currentDue;
            
            if (Math.abs(difference) < 0.01) {
                alert('বাকি টাকার কোনো পরিবর্তন হয়নি।');
                return;
            }

            // Confirmation dialog
            const actionText = difference > 0 ? 'বাড়বে' : 'কমবে';
            const confirmMessage = 
                `⚠️ দয়া করে নিশ্চিত করুন:\n\n` +
                `কাস্টমার: ${customer.name}\n` +
                `বর্তমান বাকি: ৳ ${currentDue.toLocaleString()}\n` +
                `নতুন বাকি: ৳ ${newDue.toLocaleString()}\n` +
                `পরিবর্তন: ৳ ${Math.abs(difference).toLocaleString()} ${actionText}\n\n` +
                `আপনি কি নিশ্চিত?`;

            if (!confirm(confirmMessage)) {
                return;
            }

            try {
                showLoader();

                // Update customer balance
                customer.currentDue = newDue;
                
                // Adjust totalPaid to maintain accounting balance
                // If due increases, it means less was paid
                // If due decreases, it means more was paid
                customer.totalPaid = Math.max(0, (customer.totalPaid || 0) - difference);

                await db.put('customers', customer);

                // Create audit trail ledger entry
                const adjustmentType = difference > 0 ? 'expense' : 'income';
                const auditEntry = {
                    id: generateUniqueId('L'),
                    timestamp: new Date().toISOString(),
                    type: adjustmentType,
                    category: 'manual_due_adjustment',
                    description: `ব্যালেন্স এডিট (${actionText}): ${customer.name} - ৳ ${Math.abs(difference).toLocaleString()}`,
                    amount: Math.abs(difference),
                    customerId: customerId,
                    customerName: customer.name,
                    saleId: 'BALANCE_EDIT_' + generateUniqueId('L')
                };
                ledgerEntries.push(auditEntry);
                await db.put('ledgerEntries', auditEntry);

                hideLoader();

                alert(`✅ ব্যালেন্স সফলভাবে আপডেট হয়েছে!\n\n` +
                      `কাস্টমার: ${customer.name}\n` +
                      `নতুন বাকি: ৳ ${newDue.toLocaleString()}`);

                // Refresh UI
                updateAllUI();
                renderCustomerList();

            } catch (error) {
                hideLoader();
                console.error('Error editing balance:', error);
                alert('❌ ব্যালেন্স এডিট করতে সমস্যা হয়েছে। অনুগ্রহ করে আবার চেষ্টা করুন।');
            }
        }

        // ✅ NEW: Delete All Cash Ledger Entries for a Customer
        async function deleteAllCustomerCashLedger(customerId) {
            if (currentUser.role !== 'admin') {
                alert('আপনার ক্যাশ লেজার মুছার অনুমতি নেই।');
                return;
            }

            const customer = customers.find(c => c.id === customerId);
            if (!customer) {
                alert('কাস্টমার খুঁজে পাওয়া যায়নি!');
                return;
            }

            // Find all cash ledger entries for this customer
            const customerCashEntries = ledgerEntries.filter(e => 
                e.customerId === customerId && 
                e.type === 'income' && 
                (e.category === 'due_collection' || e.category === 'sales_income')
            );

            if (customerCashEntries.length === 0) {
                alert('এই কাস্টমারের কোনো ক্যাশ লেজার এন্ট্রি পাওয়া যায়নি।');
                return;
            }

            const totalCashAmount = customerCashEntries.reduce((sum, e) => sum + (e.amount || 0), 0);

            // Confirmation dialog
            const confirmMessage = 
                `⚠️ সতর্কতা: আপনি এই কাস্টমারের সব ক্যাশ লেজার এন্ট্রি মুছতে চলেছেন!\n\n` +
                `কাস্টমার: ${customer.name}\n` +
                `ফোন: ${customer.phone}\n` +
                `মোট এন্ট্রি: ${customerCashEntries.length} টি\n` +
                `মোট ক্যাশ টাকা: ৳ ${totalCashAmount.toLocaleString()}\n\n` +
                `মুছে ফেলা হবে:\n` +
                `• ক্যাশ লেজার থেকে ${customerCashEntries.length} টি এন্ট্রি\n` +
                `• কাস্টমারের বাকি ৳ ${totalCashAmount.toLocaleString()} বাড়বে\n` +
                `• কাস্টমারের মোট পরিশোধ ৳ ${totalCashAmount.toLocaleString()} কমবে\n\n` +
                `আপনি কি নিশ্চিত?`;

            if (!confirm(confirmMessage)) {
                return;
            }

            // Second confirmation
            if (!confirm(`আবার নিশ্চিত করুন: ${customerCashEntries.length} টি ক্যাশ লেজার এন্ট্রি চিরতরে মুছে ফেলা হবে। এই কাজটি অপরিবর্তনীয়!`)) {
                return;
            }

            try {
                showLoader();
                const dbPromises = [];

                // 1. Delete all cash ledger entries
                for (const entry of customerCashEntries) {
                    await db.delete('ledgerEntries', entry.id);
                    const index = ledgerEntries.findIndex(e => e.id === entry.id);
                    if (index !== -1) {
                        ledgerEntries.splice(index, 1);
                    }
                }

                // 2. Update customer balance
                // Increase due by the total cash amount (since payments are being removed)
                customer.currentDue = (customer.currentDue || 0) + totalCashAmount;
                // Decrease total paid by the same amount
                customer.totalPaid = Math.max(0, (customer.totalPaid || 0) - totalCashAmount);
                
                dbPromises.push(db.put('customers', customer));

                // 3. Create audit trail entry
                const auditEntry = {
                    id: generateUniqueId('L'),
                    timestamp: new Date().toISOString(),
                    type: 'expense',
                    category: 'manual_due_adjustment',
                    description: `সব ক্যাশ লেজার মুছা হয়েছে: ${customer.name} - ${customerCashEntries.length} টি এন্ট্রি, ৳ ${totalCashAmount.toLocaleString()}`,
                    amount: totalCashAmount,
                    customerId: customerId,
                    customerName: customer.name,
                    saleId: 'BULK_DELETE_CASH_' + generateUniqueId('L')
                };
                ledgerEntries.push(auditEntry);
                dbPromises.push(db.put('ledgerEntries', auditEntry));

                await Promise.all(dbPromises);

                hideLoader();

                alert(`✅ সব ক্যাশ লেজার এন্ট্রি সফলভাবে মুছে ফেলা হয়েছে!\n\n` +
                      `কাস্টমার: ${customer.name}\n` +
                      `মোট মুছা এন্ট্রি: ${customerCashEntries.length} টি\n` +
                      `মোট টাকা: ৳ ${totalCashAmount.toLocaleString()}\n\n` +
                      `• কাস্টমারের বাকি আপডেট হয়েছে\n` +
                      `• ক্যাশ লেজার আপডেট হয়েছে`);

                // Refresh UI
                updateAllUI();
                renderCustomerList();

            } catch (error) {
                hideLoader();
                console.error('Error deleting cash ledger:', error);
                alert('❌ ক্যাশ লেজার মুছতে সমস্যা হয়েছে। অনুগ্রহ করে আবার চেষ্টা করুন।');
            }
        }


        addCustomerBtn.addEventListener('click', () => {
            addCustomerForm.reset();
            addCustomerForm.dataset.editingId = '';
            document.getElementById('customer-opening-due').disabled = false;
            addCustomerFormContainer.style.display = 'block';
        });

        document.querySelector('#add-customer-form-container .cancel-btn').addEventListener('click', () => {
            addCustomerFormContainer.style.display = 'none';
        });

        addCustomerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const editingId = addCustomerForm.dataset.editingId;
            const id = editingId || generateUniqueId('C');
            const phone = document.getElementById('customer-phone').value;

            if (!editingId && customers.some(c => c.phone === phone)) {
                alert('এই ফোন নম্বর দিয়ে একজন কাস্টমার আগে থেকেই আছেন।');
                return;
            }

            const customerData = {
                name: document.getElementById('customer-name').value,
                phone: phone,
                address: document.getElementById('customer-address').value,
                type: document.getElementById('customer-type').value,
                openingDue: parseFloat(document.getElementById('customer-opening-due').value) || 0
            };

            if (editingId) {
                const index = customers.findIndex(c => c.id === id);
                customers[index] = { ...customers[index], ...customerData };
                await db.put('customers', customers[index]);
                alert('কাস্টমারের তথ্য আপডেট করা হয়েছে!');
            } else {
                // 3. Customer Ledger System: Initial Due Set here
                const newCustomer = {
                    id, ...customerData,
                    totalPurchased: customerData.openingDue, // Due counts as initial 'purchase' value for the ledger
                    totalPaid: 0,
                    currentDue: customerData.openingDue
                };
                customers.push(newCustomer);
                await db.put('customers', newCustomer);
                alert('নতুন কাস্টমার যোগ করা হয়েছে!');
            }
            // Update UI
            updateAllUI();
            addCustomerFormContainer.style.display = 'none';
        });

        function editCustomer(id) {
            const customer = customers.find(c => c.id === id);
            if (customer) {
                addCustomerFormContainer.style.display = 'block';
                document.getElementById('customer-name').value = customer.name;
                document.getElementById('customer-phone').value = customer.phone;
                document.getElementById('customer-address').value = customer.address || '';
                document.getElementById('customer-type').value = customer.type || '';
                document.getElementById('customer-opening-due').value = customer.openingDue || 0;
                document.getElementById('customer-opening-due').disabled = true; // Cannot edit initial due on edit
                addCustomerForm.dataset.editingId = id;
            }
        }
        
        // --- NEW: Manual Due Entry Logic (MODIFIED for Ledger Rule) ---
        manualDueCustomerPhone.addEventListener('input', () => {
            const mobile = manualDueCustomerPhone.value.trim();
            const existingCustomer = customers.find(c => c.phone === mobile);

            if (existingCustomer) {
                manualDueCustomerName.value = existingCustomer.name;
                manualDueCustomerAddress.value = existingCustomer.address || '';
                manualDueCustomerName.disabled = true;
                manualDueCustomerAddress.disabled = true;
            } else {
                manualDueCustomerName.value = '';
                manualDueCustomerAddress.value = '';
                manualDueCustomerName.disabled = false;
                manualDueCustomerAddress.disabled = false;
            }
            manualDueMessage.textContent = '';
        });

        addManualDueForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const phone = manualDueCustomerPhone.value.trim();
            const name = manualDueCustomerName.value.trim();
            const address = manualDueCustomerAddress.value.trim();
            const amount = parseFloat(manualDueAmount.value);
            const date = manualDueDate.value;
            const note = manualDueNote.value.trim() || 'Manual Due Entry';

            if (!phone || !name || isNaN(amount) || amount <= 0 || !date) {
                showMessage(manualDueMessage, 'অনুগ্রহ করে বৈধ তথ্য দিন।', false);
                return;
            }

            let customer = customers.find(c => c.phone === phone);
            let customerIndex = customers.findIndex(c => c.phone === phone);
            const dbPromises = [];

            if (!customer) {
                // Create new customer
                customer = {
                    id: generateUniqueId('C'),
                    name: name,
                    phone: phone,
                    address: address,
                    totalPurchased: 0,
                    totalPaid: 0,
                    currentDue: 0,
                    type: 'সাধারণ',
                    openingDue: 0 
                };
                customers.push(customer);
                customerIndex = customers.length - 1;
                dbPromises.push(db.put('customers', customer));
            }

            // 1. Update Customer Totals
            customer.totalPurchased = (customer.totalPurchased || 0) + amount;
            customer.currentDue = (customer.currentDue || 0) + amount;
            dbPromises.push(db.put('customers', customer));
            if(customerIndex !== -1) customers[customerIndex] = customer;

            // 2. Create a 'Due' record 
            const dueId = generateUniqueId('D');
            const newDue = {
                id: dueId,
                dueId: dueId,
                saleId: dueId, // Use dueId as saleId for tracking
                customerId: customer.id,
                customerName: customer.name,
                customerPhone: customer.phone,
                originalAmount: amount,
                remainingAmount: amount,
                paidAmount: 0,
                dateIssued: new Date(date).toISOString(),
                description: `${note} (Manual Due)`,
                billType: 'manual_due', // Custom type
                appliesToMonths: []
            };
            dues.push(newDue);
            dbPromises.push(db.put('dues', newDue));
            
            // 3. Ledger Entry: NO direct Ledger 'income' entry (Rule 1/3/4)

            await Promise.all(dbPromises);
            updateAllUI();

            showMessage(manualDueMessage, `৳ ${amount.toLocaleString()} বাকি সফলভাবে যোগ করা হয়েছে!`, true);
            addManualDueForm.reset();
            manualDueDate.value = new Date().toISOString().split('T')[0];
            manualDueCustomerName.disabled = false;
            manualDueCustomerAddress.disabled = false;
        });

        // --- Settings Utilities (Original) ---
        async function saveSettings(message) {
            await db.put('settings', shopSettings);
            updateAllUI();
            showMessage(document.getElementById('backup-status'), message, true);
        }

        // --- User Management (Admin Only) ---
        function renderUserList() {
            if (currentUser && currentUser.role !== 'admin') {
                userListTableBody.innerHTML = '<tr><td colspan="5">আপনার ব্যবহারকারী দেখার অনুমতি নেই।</td></tr>';
                return;
            }

            userListTableBody.innerHTML = '';
            users.forEach(user => {
                const row = userListTableBody.insertRow();
                row.insertCell(0).textContent = user.id;
                row.insertCell(1).textContent = user.username;
                row.insertCell(2).textContent = user.displayName || 'N/A';
                row.insertCell(3).textContent = user.role === 'admin' ? 'অ্যাডমিন' : 'সেলার';
                const actionCell = row.insertCell(4);
                actionCell.className = 'table-action-buttons';

                if (user.id !== (currentUser ? currentUser.id : '')) { 
                    const editBtn = document.createElement('button');
                    editBtn.textContent = 'সম্পাদনা';
                    editBtn.className = 'edit-btn';
                    editBtn.addEventListener('click', () => editUser(user.id));
                    actionCell.appendChild(editBtn);

                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'মুছুন';
                    deleteBtn.className = 'danger-btn';
                    deleteBtn.addEventListener('click', () => deleteUser(user.id));
                    actionCell.appendChild(deleteBtn);
                } else {
                    actionCell.textContent = 'নিজস্ব অ্যাকাউন্ট';
                }
            });
        }

        addUserBtn.addEventListener('click', () => {
            if (currentUser && currentUser.role === 'admin') {
                addUserFormContainer.style.display = 'block';
                addUserForm.reset();
                addUserForm.dataset.editingId = '';
                newUserDisplayNameInput.value = '';
                newUserProfileImageInput.value = '';
                document.getElementById('new-password').setAttribute('required', 'required'); // Ensure password is required for new users
            } else {
                alert('আপনার নতুন ব্যবহারকারী যোগ করার অনুমতি নেই।');
            }
        });

        document.querySelectorAll('#add-user-form-container .cancel-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                addUserFormContainer.style.display = 'none';
                addUserForm.reset();
            });
        });

        addUserForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const id = addUserForm.dataset.editingId || generateUniqueId('U');
            const username = document.getElementById('new-username').value;
            const password = document.getElementById('new-password').value;
            const role = document.getElementById('new-user-role').value;
            const displayName = newUserDisplayNameInput.value.trim();
            const profileImage = newUserProfileImageInput.value.trim();
            const existingUser = users.find(u => u.id === id);
            
            const newUser = { id, 
                                username, 
                                password, // Saved clear text for simple auth logic
                                role, 
                                displayName, 
                                profileImage,
                                phone: existingUser?.phone || '' // Preserve existing phone number (for 6. Alert System)
                             };

            if (addUserForm.dataset.editingId) {
                const index = users.findIndex(u => u.id === id);
                if (index !== -1) {
                    users[index] = newUser;
                    if (id === currentUser.id) { 
                        currentUser = newUser;
                        updateUserProfileDisplay();
                    }
                    alert('ব্যবহারকারী সফলভাবে আপডেট করা হয়েছে!');
                }
            } else {
                if (users.some(u => u.username === username)) {
                    alert('এই ইউজারনেমটি আগে থেকেই বিদ্যমান।');
                    return;
                }
                users.push(newUser);
                alert('ব্যবহারকারী সফলভাবে যোগ করা হয়েছে!');
            }
            
            await db.put('users', newUser);
            updateAllUI();
            addUserFormContainer.style.display = 'none';
            addUserForm.reset();
        });

        function editUser(id) {
            if (currentUser && currentUser.role !== 'admin') {
                alert('আপনার ব্যবহারকারী সম্পাদনার অনুমতি নেই।');
                return;
            }

            const user = users.find(u => u.id === id);
            if (user) {
                addUserFormContainer.style.display = 'block';
                document.getElementById('new-username').value = user.username;
                document.getElementById('new-password').value = user.password;
                document.getElementById('new-user-role').value = user.role;
                newUserDisplayNameInput.value = user.displayName || '';
                newUserProfileImageInput.value = user.profileImage || '';
                document.getElementById('new-password').removeAttribute('required'); // No need to force password entry for update
                // Note: Phone number is missing in UI, but preserved in object if fetched.
                addUserForm.dataset.editingId = user.id;
            }
        }

        async function deleteUser(id) {
            if (currentUser && currentUser.role !== 'admin') {
                alert('আপনার ব্যবহারকারী মুছে ফেলার অনুমতি নেই।');
                return;
            }

            if (id === (currentUser ? currentUser.id : '')) { 
                alert('আপনি নিজের অ্যাকাউন্ট মুছে ফেলতে পারবেন না।');
                return;
            }

            if (confirm('আপনি কি নিশ্চিত এই ব্যবহারকারীকে মুছে ফেলতে চান?')) {
                await db.delete('users', id);
                users = users.filter(u => u.id !== id);
                alert('ব্যবহারকারী সফলভাবে মুছে ফেলা হয়েছে!');
                updateAllUI();
            }
        }


        // --- Settings (Original and Modified) ---
        shopInfoForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            shopSettings.name = document.getElementById('shop-name').value;
            shopSettings.address = document.getElementById('shop-address').value;
            shopSettings.logoUrl = document.getElementById('shop-logo').value;
            // NEW: Save print fields
            shopSettings.phoneCell = shopPhoneCellInput.value;
            shopSettings.vatReg = shopVatRegInput.value;

            await db.put('settings', shopSettings);
            updateShopTitle(shopSettings.name);
            alert('দোকানের তথ্য সফলভাবে আপডেট করা হয়েছে!');
        });
        
        // 1. Offline + Sync System - Manual Sync Button (REMOVED)

        resetAllDataBtn.addEventListener('click', async () => {
            if (currentUser && currentUser.role !== 'admin') {
                alert('আপনার সকল ডেটা রিসেট করার অনুমতি নেই।');
                return;
            }
            if (confirm('আপনি কি নিশ্চিত? সফটওয়্যারের সকল ডেটা (পণ্য, বিক্রয়, ব্যবহারকারী, বাকি টাকা) স্থায়ীভাবে মুছে যাবে। এই কাজটি অপরিবর্তনীয়!')) {
                if (confirm('আপনি কি সত্যিই নিশ্চিত? এটি আপনার সকল ডেটা মুছে দেবে।')) {
                    // Include all stores in clear list
                    const clearPromises = window.OBJECT_STORES.map(store => db.clear(store)); 
                    await Promise.all(clearPromises);
                    await handleLogout();
                    alert('সফটওয়্যারের সকল ডেটা সফলভাবে রিসেট করা হয়েছে। অ্যাপটি রিলোড হচ্ছে।');
                    setTimeout(() => window.location.reload(), 1000);
                }
            }
        });

        // --- Subscription Logic (Original) ---
        function getSubscriptionEndDate() {
            const endDate = shopSettings.subscriptionEndDate;
            return endDate ? moment(endDate) : null;
        }

        async function setSubscriptionEndDate(date) {
            shopSettings.subscriptionEndDate = date.toISOString();
            await db.put('settings', shopSettings);
        }

        function updateSubscriptionDisplay() {
            const endDate = getSubscriptionEndDate();
            if (endDate) {
                subscriptionEndDateDisplay.textContent = endDate.format('Do MMMM, YYYY');
                // Set the date input to current end date for easy modification
                if (subscriptionNewEndDateInput) {
                    subscriptionNewEndDateInput.value = endDate.format('YYYY-MM-DD');
                }
            } else {
                subscriptionEndDateDisplay.textContent = 'সেট করা হয়নি';
                // Default to today + 30 days if no date set
                if (subscriptionNewEndDateInput) {
                    subscriptionNewEndDateInput.value = moment().add(30, 'days').format('YYYY-MM-DD');
                }
            }
        }

        // --- Subscription Level Logic (NEW) ---
        function getSubscriptionLevelDisplayName(level) {
            const levelNames = {
                'basic': 'বেসিক (Basic)',
                'standard': 'স্ট্যান্ডার্ড (Standard)',
                'premium': 'প্রিমিয়াম (Premium)'
            };
            return levelNames[level] || level;
        }

        function updateSubscriptionLevelDisplay() {
            if (currentSubscriptionLevelDisplay) {
                currentSubscriptionLevelDisplay.textContent = getSubscriptionLevelDisplayName(shopSettings.subscriptionLevel);
            }
            if (subscriptionLevelSelect) {
                subscriptionLevelSelect.value = shopSettings.subscriptionLevel;
            }
        }

        async function setSubscriptionLevel(newLevel) {
            shopSettings.subscriptionLevel = newLevel;
            await db.put('settings', shopSettings);
            updateSubscriptionLevelDisplay();
        }

        function checkSubscription() {
            const endDate = getSubscriptionEndDate();
            const now = moment();
            const mainNavItems = document.querySelectorAll('#main-nav-ul li');
            
            updateSubscriptionDisplay();
            updateSubscriptionLevelDisplay(); // Update level display when checking subscription

            if (!endDate || endDate.isBefore(now)) {
                if (subscriptionStatusDisplay) {
                    subscriptionStatusDisplay.textContent = 'সাবস্ক্রিপশনের মেয়াদ শেষ হয়েছে! অনুগ্রহ করে মেয়াদ বাড়ান।';
                    subscriptionStatusDisplay.style.color = 'red';
                }

                if (currentUser && currentUser.role !== 'admin') { 
                    mainNavItems.forEach(li => {
                        const link = li.querySelector('a');
                        if (link && link.dataset.section !== 'settings') {
                            link.style.pointerEvents = 'none';
                            link.style.opacity = '0.5';
                        } else if (link && link.dataset.section === 'settings') {
                            link.style.pointerEvents = 'auto';
                            link.style.opacity = '1';
                        }
                    });
                    document.querySelectorAll('.app-section').forEach(section => {
                        if (section.id !== 'settings-section') {
                            section.style.display = 'none';
                        }
                    });
                    if (!settingsSection.classList.contains('active')) {
                        showSection('settings');
                    }
                } else if (currentUser && currentUser.role === 'admin') {
                     mainNavItems.forEach(li => {
                        const link = li.querySelector('a');
                        if (link) {
                            link.style.pointerEvents = 'auto';
                            link.style.opacity = '1';
                        }
                    });
                } else { 
                    loginContainer.style.display = 'block';
                    appContainer.style.display = 'none';
                }
                return false;
            } else {
                const daysLeft = endDate.diff(now, 'days');
                if (subscriptionStatusDisplay) {
                    if (daysLeft <= 7) {
                        subscriptionStatusDisplay.textContent = `সাবস্ক্রিপশনের মেয়াদ ${daysLeft} দিনের মধ্যে শেষ হচ্ছে!`;
                        subscriptionStatusDisplay.style.color = 'orange';
                    } else {
                        subscriptionStatusDisplay.textContent = 'সাবস্ক্রিপশন সক্রিয় আছে।';
                        subscriptionStatusDisplay.style.color = 'green';
                    }
                }

                mainNavItems.forEach(li => {
                    const link = li.querySelector('a');
                    if (link) {
                        link.style.pointerEvents = 'auto';
                        link.style.opacity = '1';
                    }
                });

                if (currentUser && loginContainer.style.display === 'block') {
                    loginContainer.style.display = 'none';
                    appContainer.style.display = 'flex';
                    renderAppBasedOnRole(currentUser.role);
                    showSection('dashboard');
                }
                return true;
            }
        }

        // --- Data Usage Dashboard Functions ---
        function calculateDataSize(data) {
            const jsonStr = JSON.stringify(data);
            const bytes = new Blob([jsonStr]).size;
            return bytes;
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        async function updateDataUsageDashboard() {
            try {
                const dataSizes = {
                    sales: calculateDataSize(sales),
                    customers: calculateDataSize(customers),
                    products: calculateDataSize(products),
                    ledger: calculateDataSize(ledgerEntries),
                    suppliers: calculateDataSize(suppliers),
                    banks: calculateDataSize(banks)
                };

                const totalBytes = Object.values(dataSizes).reduce((sum, size) => sum + size, 0);

                // Update total usage
                document.getElementById('total-data-usage').textContent = formatBytes(totalBytes);
                
                // Calculate percentage (assuming 100MB as max for visual)
                const maxBytes = 100 * 1024 * 1024; // 100MB
                const percentage = Math.min((totalBytes / maxBytes) * 100, 100);
                document.getElementById('data-usage-percentage').textContent = percentage.toFixed(1) + '% ব্যবহৃত';

                // Update category sizes and bars
                document.getElementById('sales-data-size').textContent = formatBytes(dataSizes.sales);
                document.getElementById('customers-data-size').textContent = formatBytes(dataSizes.customers);
                document.getElementById('products-data-size').textContent = formatBytes(dataSizes.products);
                document.getElementById('ledger-data-size').textContent = formatBytes(dataSizes.ledger);
                document.getElementById('suppliers-data-size').textContent = formatBytes(dataSizes.suppliers);
                document.getElementById('banks-data-size').textContent = formatBytes(dataSizes.banks);

                // Update progress bars
                const maxCategorySize = Math.max(...Object.values(dataSizes), 1);
                document.getElementById('sales-usage-bar').style.width = ((dataSizes.sales / maxCategorySize) * 100) + '%';
                document.getElementById('customers-usage-bar').style.width = ((dataSizes.customers / maxCategorySize) * 100) + '%';
                document.getElementById('products-usage-bar').style.width = ((dataSizes.products / maxCategorySize) * 100) + '%';
                document.getElementById('ledger-usage-bar').style.width = ((dataSizes.ledger / maxCategorySize) * 100) + '%';
                document.getElementById('suppliers-usage-bar').style.width = ((dataSizes.suppliers / maxCategorySize) * 100) + '%';
                document.getElementById('banks-usage-bar').style.width = ((dataSizes.banks / maxCategorySize) * 100) + '%';

                // Update stats
                const totalRecords = sales.length + customers.length + products.length + ledgerEntries.length + suppliers.length + banks.length;
                document.getElementById('total-records-count').textContent = totalRecords.toLocaleString();
                document.getElementById('total-sales-count').textContent = sales.length.toLocaleString();
                document.getElementById('total-customers-count').textContent = customers.length.toLocaleString();

                // Update backup info
                document.getElementById('backup-data-size').textContent = formatBytes(totalBytes);

            } catch (error) {
                console.error('Error updating data usage dashboard:', error);
            }
        }

        // Refresh button event
        document.getElementById('refresh-data-usage-btn').addEventListener('click', () => {
            updateDataUsageDashboard();
            showMessage(document.getElementById('backup-status'), 'ডেটা ইউসেজ রিফ্রেশ হয়েছে!', true);
        });

        // --- Data Backup/Import Logic (Updated for Firebase-only) ---
        backupDataBtn.addEventListener('click', async () => {
            try {
                showLoader();
                
                // Show progress container
                const progressContainer = document.getElementById('backup-progress-container');
                const progressBar = document.getElementById('backup-progress-bar');
                const progressText = document.getElementById('backup-progress-text');
                progressContainer.style.display = 'block';
                
                const backupData = {};
                const totalStores = window.OBJECT_STORES.length;
                let completedStores = 0;
                
                // Include all stores in fetch list with progress
                const fetchPromises = window.OBJECT_STORES.map(async (storeName) => {
                    backupData[storeName] = await db.getAll(storeName);
                    completedStores++;
                    const progress = Math.round((completedStores / totalStores) * 50); // First 50% for fetching
                    progressBar.style.width = progress + '%';
                    progressText.textContent = progress + '%';
                });
                await Promise.all(fetchPromises);
                
                // Calculate data size
                const dataStr = JSON.stringify(backupData, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const dataSize = formatBytes(blob.size);
                
                // Update progress to 75%
                progressBar.style.width = '75%';
                progressText.textContent = '75%';
                
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `fashionflow_backup_${moment().format('YYYY-MM-DD_HH-mm')}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                // Complete progress
                progressBar.style.width = '100%';
                progressText.textContent = '100%';
                
                // Update last backup time
                document.getElementById('last-backup-time').textContent = moment().format('DD/MM/YYYY HH:mm');
                
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                    progressBar.style.width = '0%';
                }, 2000);
                
                hideLoader();
                showMessage(backupStatus, `✅ ডেটা সফলভাবে ব্যাকআপ করা হয়েছে! (${dataSize})`, true);
            } catch (error) {
                hideLoader();
                console.error("Backup failed:", error);
                showMessage(backupStatus, '❌ ডেটা ব্যাকআপ ব্যর্থ হয়েছে।', false);
            }
        });

        importDataInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (confirm('ডেটা ইম্পোর্ট করলে বর্তমান সকল ডেটা মুছে যাবে এবং এই ফাইলের ডেটা দ্বারা প্রতিস্থাপিত হবে। আপনি কি নিশ্চিত?')) {
                            
                            // Clear all collections on Firebase
                            const clearPromises = window.OBJECT_STORES.map(store => db.clear(store));
                            await Promise.all(clearPromises);
                            
                            // Re-insert imported data
                            for (const storeName of window.OBJECT_STORES) {
                                if (importedData[storeName]) {
                                    for (const item of importedData[storeName]) {
                                        await db.put(storeName, item);
                                    }
                                }
                            }
                            
                            showMessage(importStatus, 'ডেটা সফলভাবে ইম্পোর্ট করা হয়েছে! অ্যাপ রিলোড হচ্ছে।', true);
                            setTimeout(() => {
                                window.location.reload();
                            }, 1500);
                        } else {
                            showMessage(importStatus, 'ডেটা ইম্পোর্ট বাতিল করা হয়েছে।', false);
                        }
                    } catch (e) {
                        console.error("Error importing data:", e);
                        showMessage(importStatus, 'ফাইলটি ত্রুটিপূর্ণ অথবা সঠিক ফরম্যাটে নেই।', false);
                    }
                };
                reader.readAsText(file);
            }
        });

        // Update Subscription Date (Increase or Decrease) - NEW
        updateSubscriptionDateBtn.addEventListener('click', async () => {
            const password = subscriptionModifyPasswordInput.value;
            const newDateStr = subscriptionNewEndDateInput.value;

            if (password !== ADMIN_PASSWORD) {
                showMessage(subscriptionMessage, 'ভুল পাসওয়ার্ড! মেয়াদ পরিবর্তন করা যায়নি।', false);
                return;
            }

            if (!newDateStr) {
                showMessage(subscriptionMessage, 'অনুগ্রহ করে একটি তারিখ নির্বাচন করুন।', false);
                return;
            }

            const newEndDate = moment(newDateStr);
            const currentEndDate = getSubscriptionEndDate();
            const now = moment();

            // Check if date is being reduced
            const isReducing = currentEndDate && newEndDate.isBefore(currentEndDate);
            
            // Confirmation for date reduction
            if (isReducing) {
                const daysReduced = currentEndDate.diff(newEndDate, 'days');
                const confirmReduce = confirm(
                    `⚠️ সতর্কতা: আপনি সাবস্ক্রিপশন মেয়াদ কমাচ্ছেন!\n\n` +
                    `বর্তমান মেয়াদ: ${currentEndDate.format('Do MMMM, YYYY')}\n` +
                    `নতুন মেয়াদ: ${newEndDate.format('Do MMMM, YYYY')}\n` +
                    `কমানো হচ্ছে: ${daysReduced} দিন\n\n` +
                    `আপনি কি নিশ্চিত?`
                );
                if (!confirmReduce) {
                    showMessage(subscriptionMessage, 'মেয়াদ পরিবর্তন বাতিল করা হয়েছে।', false);
                    return;
                }
            }

            // Check if new date is in the past
            if (newEndDate.isBefore(now, 'day')) {
                const confirmExpired = confirm(
                    `⚠️ সতর্কতা: আপনি একটি অতীত তারিখ নির্বাচন করেছেন!\n\n` +
                    `এতে সাবস্ক্রিপশন তাৎক্ষণিকভাবে শেষ হয়ে যাবে।\n\n` +
                    `আপনি কি নিশ্চিত?`
                );
                if (!confirmExpired) {
                    showMessage(subscriptionMessage, 'মেয়াদ পরিবর্তন বাতিল করা হয়েছে।', false);
                    return;
                }
            }

            await setSubscriptionEndDate(newEndDate);
            checkSubscription();
            
            const actionText = isReducing ? 'কমানো' : 'বাড়ানো';
            showMessage(subscriptionMessage, `সাবস্ক্রিপশন মেয়াদ সফলভাবে ${actionText} হয়েছে! নতুন মেয়াদ: ${newEndDate.format('Do MMMM, YYYY')}`, true);
            subscriptionModifyPasswordInput.value = '';
            
            // Show success alert
            alert(`✅ সাবস্ক্রিপশন মেয়াদ সফলভাবে আপডেট হয়েছে!\n\nনতুন মেয়াদ: ${newEndDate.format('Do MMMM, YYYY')}`);
        });

        // Quick Extend +30 Days - NEW
        extendSubscriptionQuickBtn.addEventListener('click', async () => {
            const password = subscriptionModifyPasswordInput.value;

            if (password !== ADMIN_PASSWORD) {
                showMessage(subscriptionMessage, 'ভুল পাসওয়ার্ড! মেয়াদ বাড়ানো যায়নি।', false);
                return;
            }

            let currentEndDate = getSubscriptionEndDate();
            if (!currentEndDate || currentEndDate.isBefore(moment())) {
                currentEndDate = moment();
            }
            const newEndDate = currentEndDate.add(30, 'days');
            
            await setSubscriptionEndDate(newEndDate);
            checkSubscription();
            
            showMessage(subscriptionMessage, `৩০ দিনের জন্য সাবস্ক্রিপশন সফলভাবে বাড়ানো হয়েছে! নতুন মেয়াদ: ${newEndDate.format('Do MMMM, YYYY')}`, true);
            subscriptionModifyPasswordInput.value = '';
            
            // Show success alert
            alert(`✅ সাবস্ক্রিপশন মেয়াদ সফলভাবে বাড়ানো হয়েছে!\n\nনতুন মেয়াদ: ${newEndDate.format('Do MMMM, YYYY')}`);
        });

        // Subscription Level Update Event Listener (NEW)
        updateSubscriptionLevelBtn.addEventListener('click', async () => {
            const password = subscriptionLevelPasswordInput.value;
            const newLevel = subscriptionLevelSelect.value;
            const currentLevel = shopSettings.subscriptionLevel;

            if (password !== ADMIN_PASSWORD) {
                showMessage(subscriptionLevelMessage, 'ভুল পাসওয়ার্ড! লেভেল পরিবর্তন করা যায়নি।', false);
                return;
            }

            if (newLevel === currentLevel) {
                showMessage(subscriptionLevelMessage, 'একই লেভেল নির্বাচন করা হয়েছে। কোনো পরিবর্তন প্রয়োজন নেই।', false);
                return;
            }

            // Confirm the change
            const confirmChange = confirm(`আপনি কি নিশ্চিত যে আপনি সাবস্ক্রিপশন লেভেল পরিবর্তন করতে চান?\n\nবর্তমান: ${getSubscriptionLevelDisplayName(currentLevel)}\nনতুন: ${getSubscriptionLevelDisplayName(newLevel)}`);
            
            if (confirmChange) {
                await setSubscriptionLevel(newLevel);
                showMessage(subscriptionLevelMessage, `সাবস্ক্রিপশন লেভেল সফলভাবে পরিবর্তন করা হয়েছে! নতুন লেভেল: ${getSubscriptionLevelDisplayName(newLevel)}`, true);
                subscriptionLevelPasswordInput.value = '';
                
                // Optional: Show a success alert
                alert(`✅ সাবস্ক্রিপশন লেভেল সফলভাবে আপডেট হয়েছে!\n\nনতুন লেভেল: ${getSubscriptionLevelDisplayName(newLevel)}`);
            } else {
                showMessage(subscriptionLevelMessage, 'লেভেল পরিবর্তন বাতিল করা হয়েছে।', false);
                // Reset the select to current level
                subscriptionLevelSelect.value = currentLevel;
            }
        });
        
        let currentViewingCustomer = null;
        function showCustomerLedger(customerId) {
            currentViewingCustomer = customers.find(c => c.id === customerId);
            if (!currentViewingCustomer) {
                alert('কাস্টমার খুঁজে পাওয়া যায়নি।');
                return;
            }

            document.getElementById('modal-ledger-customer-name').textContent = currentViewingCustomer.name;
            document.getElementById('summary-total-customer-purchased').textContent = `৳ ${(currentViewingCustomer.totalPurchased || 0).toLocaleString()}`;
            document.getElementById('summary-total-customer-paid').textContent = `৳ ${(currentViewingCustomer.totalPaid || 0).toLocaleString()}`;
            document.getElementById('summary-current-customer-due').textContent = `৳ ${(currentViewingCustomer.currentDue || 0).toLocaleString()}`;

            document.getElementById('customer-ledger-from-date').value = '';
            document.getElementById('customer-ledger-to-date').value = '';

            renderCustomerLedgerTables(customerId);

            printCustomerLedgerBtn.dataset.customerId = customerId;
            customerLedgerModal.style.display = 'flex';
        }

        // 3. Customer Ledger System - Detailed View/Report
        function renderCustomerLedgerTables(customerId, fromDateStr = '', toDateStr = '') {
            const fromDate = fromDateStr ? moment(fromDateStr).startOf('day') : null;
            const toDate = toDateStr ? moment(toDateStr).endOf('day') : null;

            const filterByDate = (item) => {
                if (!fromDate && !toDate) return true;
                const itemDate = moment(item.timestamp);
                return (!fromDate || itemDate.isSameOrAfter(fromDate)) && (!toDate || itemDate.isSameOrBefore(toDate));
            };

            const salesBody = document.querySelector('#customer-sales-table tbody');
            const paymentsBody = document.querySelector('#customer-payment-table tbody');
            const returnsBody = document.querySelector('#customer-returns-table tbody');

            salesBody.innerHTML = '<tr><td colspan="4">কোনো বিক্রয় নেই</td></tr>';
            paymentsBody.innerHTML = '<tr><td colspan="5">কোনো পেমেন্ট নেই</td></tr>'; // Increased colspan for action column
            returnsBody.innerHTML = '<tr><td colspan="3">কোনো ফেরত নেই</td></tr>';

            let totalSales = 0, totalPayments = 0, totalReturns = 0;

            const customerTransactions = sales.filter(s => s.customerId === customerId && s.status !== 'বাতিল' && filterByDate(s));
            
            const customerSales = customerTransactions.filter(s => s.type === 'sale');
            if(customerSales.length > 0) {
                salesBody.innerHTML = '';
                customerSales.forEach(item => {
                    totalSales += item.finalAmount;
                    const detailsHtml = '<ul>' + item.items.map(p => `<li>${p.name} - ${p.quantity} x ৳${p.unitPrice}</li>`).join('') + '</ul>';
                    salesBody.innerHTML += `<tr><td>${moment(item.timestamp).format('L')}</td><td>${item.status === 'বাকি' ? 'বাকি' : item.paymentMethod === 'bank' ? 'ব্যাংক' : 'নগদ'}</td><td>${detailsHtml}</td><td>৳ ${item.finalAmount.toLocaleString()}</td></tr>`;
                });
            }
            
            // Filter ledger for due_collection, manual_due_adjustment 
            const ledgerPayments = ledgerEntries.filter(e => e.customerId === customerId && (e.category === 'due_collection' || e.category === 'manual_due_adjustment') && filterByDate(e));
            // Filter bank transactions for customer payments (due collection, sales, adjustment)
            const bankPayments = bankTransactions.filter(t => t.customerName === currentViewingCustomer.name && t.type === 'credit' && filterByDate(t));
            
            const allPayments = [...ledgerPayments, ...bankPayments].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

             if(allPayments.length > 0) {
                paymentsBody.innerHTML = '';
                allPayments.forEach(item => {
                    const amount = item.amount || item.totalAmount;
                    const source = item.bankName || 'Cash';
                    const isLedgerEntry = item.hasOwnProperty('category'); // Check if it's a ledger entry
                    const isBankTransaction = item.hasOwnProperty('bankId') || item.bankName;
                    
                    let rowHtml = '';
                    if (item.type === 'income' || item.type === 'credit') {
                         totalPayments += amount;
                         rowHtml = `<tr><td>${moment(item.timestamp).format('L')}</td><td>${source}</td><td>${item.description || 'পেমেন্ট'}</td><td>৳ ${amount.toLocaleString()}</td>`;
                    } else if (item.type === 'expense') { // Negative Adjustment
                         totalPayments -= amount;
                         rowHtml = `<tr style="color: #dc3545;"><td>${moment(item.timestamp).format('L')}</td><td>${source}</td><td>${item.description || 'নেগেটিভ অ্যাডজাস্টমেন্ট'}</td><td>- ৳ ${amount.toLocaleString()}</td>`;
                    }
                    
                    // Add delete button for admin users (only for ledger entries and bank transactions, not manual adjustments)
                    if (currentUser && currentUser.role === 'admin' && item.category !== 'manual_due_adjustment') {
                        const deleteBtn = `<button class="danger-btn delete-payment-btn" data-payment-id="${item.id}" data-payment-type="${isLedgerEntry ? 'ledger' : 'bank'}" style="padding: 2px 8px; font-size: 12px;"><i class="fas fa-trash"></i></button>`;
                        rowHtml += `<td>${deleteBtn}</td></tr>`;
                    } else {
                        rowHtml += `<td>-</td></tr>`;
                    }
                    
                    paymentsBody.innerHTML += rowHtml;
                });
                
                // Add event listeners to delete buttons
                document.querySelectorAll('.delete-payment-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const paymentId = e.target.closest('.delete-payment-btn').dataset.paymentId;
                        const paymentType = e.target.closest('.delete-payment-btn').dataset.paymentType;
                        deleteCustomerPayment(paymentId, paymentType, customerId);
                    });
                });
            }

            const customerReturns = customerTransactions.filter(s => s.type === 'return');
            if(customerReturns.length > 0) {
                returnsBody.innerHTML = '';
                customerReturns.forEach(item => {
                    totalReturns += Math.abs(item.finalAmount);
                    const detailsHtml = '<ul>' + item.items.map(p => `<li>${p.name} - ${p.quantity} (ফেরত)</li>`).join('') + '</ul>';
                    returnsBody.innerHTML += `<tr><td>${moment(item.timestamp).format('L')}</td><td>${detailsHtml}</td><td>৳ ${Math.abs(item.finalAmount).toLocaleString()}</td></tr>`;
                });
            }

            document.getElementById('total-customer-sales').textContent = `মোট: ৳ ${totalSales.toLocaleString()}`;
            document.getElementById('total-customer-payment').textContent = `মোট: ৳ ${totalPayments.toLocaleString()}`;
            document.getElementById('total-customer-returns').textContent = `মোট: ৳ ${totalReturns.toLocaleString()}`;
        }


        filterCustomerLedgerBtn.addEventListener('click', () => {
             if(currentViewingCustomer) {
                const fromDate = document.getElementById('customer-ledger-from-date').value;
                const toDate = document.getElementById('customer-ledger-to-date').value;
                renderCustomerLedgerTables(currentViewingCustomer.id, fromDate, toDate);
            }
        });


        document.querySelectorAll('#customer-ledger-modal .close-button').forEach(btn => {
            btn.addEventListener('click', () => {
                customerLedgerModal.style.display = 'none';
                currentViewingCustomer = null;
            });
        });

        printCustomerLedgerBtn.addEventListener('click', (e) => {
            const customerId = e.target.dataset.customerId;
            if(customerId) {
                printCustomerLedger(customerId);
            }
        });
        
        function printCustomerLedger(customerId) {
            const customer = customers.find(c => c.id === customerId);
            if (!customer) return;
            const logoHtml = shopSettings.logoUrl ? `<div class="center"><img src="${shopSettings.logoUrl}" alt="Logo" style="max-height: 80px; max-width: 200px; margin-bottom: 10px;"></div>` : '';


            const fromDateStr = document.getElementById('customer-ledger-from-date').value;
            const toDateStr = document.getElementById('customer-ledger-to-date').value;

            // Clone the printable area and add totals for printing
            const printAreaNode = document.getElementById('customer-ledger-print-area').cloneNode(true);
            printAreaNode.querySelectorAll('h4').forEach(h4 => {
                const totalSpan = h4.querySelector('.table-total');
                if (totalSpan) {
                    const totalPrintSpan = document.createElement('span');
                    totalPrintSpan.className = 'table-total-print';
                    totalPrintSpan.textContent = totalSpan.textContent;
                    h4.appendChild(totalPrintSpan);
                }
            });

            const printContent = `
                ${logoHtml}
                <div style="text-align: center;">
                    <h2>${shopSettings.name}</h2>
                    <p>${shopSettings.address}</p>
                    <h3>কাস্টমার লেজার: ${customer.name}</h3>
                    <p>ফোন: ${customer.phone || 'N/A'}</p>
                     <p>
                        ${fromDateStr ? `তারিখ: ${moment(fromDateStr).format('LL')} থেকে ` : ''}
                        ${toDateStr ? `${moment(toDateStr).format('LL')} পর্যন্ত` : ''}
                    </p>
                </div>
                <hr>
                <div id="print-content-tables">
                    ${printAreaNode.innerHTML}
                </div>
            `;
            launchPrint(`কাস্টমার লেজার - ${customer.name}`, printContent);
        }

        // =================================================================================
        // ========================= NEW ADD-ON MODULES ====================================
        // =================================================================================


        // ===================================
        // 6. FORECAST + WHATSAPP / SMS ALERT ADD-ON
        // (notify.js conceptual file, exposed to window)
        // ===================================
        
        function generateAlertMessage(type, recipient, data) {
             const shopName = shopSettings.name || 'MY POS SOF';
             let message = `*${shopName}* থেকে মেসেজ:*\n`;
            
            if (type === 'STOCK_LOW') {
                 message += `⚠ সতর্কবার্তা! নিম্নোক্ত পণ্যগুলির স্টক কমে গেছে: \n`;
                 data.forEach(p => {
                    message += `— ${p.name}: মাত্র ${p.stock}টি!\n`;
                 });
                 message += `অবিলম্বে নতুন অর্ডার দিন।`;
                 
            } else if (type === 'CUSTOMER_DUE' && data.due) {
                 message += `প্রিয় ${data.name}, \nআপনার মোট বকেয়া ৳ ${data.due.toLocaleString()}। অনুগ্রহ করে দ্রুত পরিশোধ করুন।\n\n`;
                 message += `ধন্যবাদান্তে,\n${shopName}`;

            } else if (type === 'FORECAST_READY') {
                 message += `📈 ${moment().add(1, 'month').format('MMMM')}-এর বিক্রয় পূর্বাভাস তৈরি!\n`;
                 message += `মোট বিক্রয় (অনুমানিত): ৳ ${data.sale.toLocaleString()}\n`;
                 message += `মোট লাভ (অনুমানিত): ৳ ${data.profit.toLocaleString()}\n`;
                 message += `শীর্ষ পণ্য (অনুমানিত): ${data.topProduct || 'N/A'}\n`;
                 message += `ব্যবসা বৃদ্ধির প্রবণতা: ${data.trend}`;
            }

             return encodeURIComponent(message);
        }

        // Exposed Function for 6: Due Payment Trigger (WhatsApp Link)
        window.sendWhatsAppDueAlert = (phone, name, due) => {
            if (!phone || !due || phone.length < 5) {
                alert('কাস্টমার ফোন নম্বর বা বাকি টাকার পরিমাণ নেই।');
                return;
            }
             // Phone number preprocessing for international format (assumes BD or valid digits)
             const finalPhone = phone.replace(/[^\d]/g, '').slice(-11);
             const alertMessage = generateAlertMessage('CUSTOMER_DUE', name, { name, due });
             const whatsappLink = `https://wa.me/+88${finalPhone}?text=${alertMessage}`; 
             window.open(whatsappLink, '_blank');
        }

        // Exposed Function for 6: Quick Message Prompt for Dashboard/UI
         window.promptForCustomerAlert = () => {
             const phone = prompt('কাস্টমার মোবাইল নম্বর লিখুন (Due বাদে অন্যান্য মেসেজের জন্য):');
             if (phone) {
                 const message = prompt('মেসেজটি লিখুন:');
                 if (message) {
                    const encodedMessage = encodeURIComponent(`*${shopSettings.name}* থেকে মেসেজ: ${message}`);
                    const finalPhone = phone.replace(/[^\d]/g, '').slice(-11);
                    const whatsappLink = `https://wa.me/+88${finalPhone}?text=${encodedMessage}`;
                    window.open(whatsappLink, '_blank');
                 }
             }
         }

         // Function for 6: Stock Low Owner Alert
        window.sendStockAlertToOwner = (productName = 'Multiple', stock = 0) => {
            const owner = users.find(u => u.role === 'admin');
            if(!owner || !owner.phone || owner.phone.length < 5) { 
                 alert('অ্যাডমিন ইউজারের ফোন নম্বর সেট করা নেই।');
                 return;
            }
            
            let data = [];
            if (productName === 'Multiple') {
                const lowStockProducts = products.filter(p => p.stock <= (p.minStock || window.SALES_FORECAST_CONFIG.PRODUCT_MIN_STOCK_DEFAULT));
                data = lowStockProducts;
            } else {
                 data.push({ name: productName, stock: stock });
            }

            const alertMessage = generateAlertMessage('STOCK_LOW', owner.displayName, data);
            const finalPhone = owner.phone.replace(/[^\d]/g, '').slice(-11);
            const whatsappLink = `https://wa.me/+88${finalPhone}?text=${alertMessage}`; 
            window.open(whatsappLink, '_blank');
        }

        
        // ===================================
        // 2. STOCK ALERT ADD-ON (stockAlert.js conceptual file)
        // ===================================
         function renderStockAlerts() {
            // Use the product data from global array which is reloaded by initializeData
            const lowStockProducts = products.filter(p => p.stock <= (p.minStock || window.SALES_FORECAST_CONFIG.PRODUCT_MIN_STOCK_DEFAULT));
            const alertsList = document.getElementById('stock-alerts-list');
            alertsList.innerHTML = '';
            document.getElementById('low-stock-count').textContent = lowStockProducts.length;

            if (lowStockProducts.length === 0) {
                 alertsList.innerHTML = '<p>সব পণ্য পর্যাপ্ত পরিমাণে স্টকে আছে।</p>';
                 return;
            }
            
            alertsList.innerHTML += `<h4 style="color: #fca5a5; margin: 0;"><i class="fas fa-box-open"></i> কম স্টক পণ্যের তালিকা:</h4>`;

            const ul = document.createElement('ul');
            lowStockProducts.forEach(p => {
                const minStock = p.minStock || window.SALES_FORECAST_CONFIG.PRODUCT_MIN_STOCK_DEFAULT;
                const li = document.createElement('li');
                li.innerHTML = `⚠️ <span class="low-stock-product-name">${p.name}</span>: স্টক: ${p.stock} ${p.unit} | মিনিমাম: ${minStock}
                    <button class="info-btn" style="float: right; padding: 4px 8px; margin: 0; font-size: 13px;" 
                     onclick="window.sendStockAlertToOwner('${p.name}', ${p.stock});">অ্যাডমিনকে মেসেজ</button>`;
                ul.appendChild(li);
            });
            alertsList.appendChild(ul);
        }
        
        // ===================================
        // 5. SALES FORECAST ADD-ON (forecast.js conceptual file)
        // ===================================
        function calculateAndRenderForecast() {
            const today = moment();
            const lastCompleteMonthStart = moment(today).startOf('month').subtract(1, 'month');

            const monthData = [];
            
            // Get data for the last 3 complete months for forecast base
            for (let i = 0; i < 3; i++) {
                const start = moment(lastCompleteMonthStart).subtract(i, 'month').startOf('month');
                const end = moment(lastCompleteMonthStart).subtract(i, 'month').endOf('month');

                // Filter sales for this month range (exclude deleted bills)
                const monthSales = sales.filter(s => 
                     moment(s.timestamp).isSameOrAfter(start) && 
                     moment(s.timestamp).isSameOrBefore(end) && 
                     s.type === 'sale' &&
                     s.status !== 'বাতিল'
                );
                
                if (monthSales.length > 0) { 
                     const totalSales = monthSales.reduce((sum, s) => sum + s.finalAmount, 0);
                     // Assuming 'profit' is stored with the sale transaction
                     const totalProfit = monthSales.reduce((sum, s) => sum + s.profit, 0);

                    monthData.push({
                        month: start.format('YYYY-MM'),
                        totalSales: totalSales,
                        totalProfit: totalProfit
                    });
                }
            }
            
            if (monthData.length < window.SALES_FORECAST_CONFIG.MIN_FORECAST_SALES) {
                document.getElementById('forecast-basis').textContent = `(ডেটা অপ্রতুল: মাত্র ${monthData.length} মাস)`;
                document.getElementById('forecast-next-month-sale').textContent = `৳ N/A`;
                document.getElementById('forecast-next-month-profit').textContent = `৳ N/A`;
                document.getElementById('forecast-top-product').textContent = `N/A`;
                document.getElementById('forecast-trend-display').textContent = `N/A`;
                return;
            }
            
            // Sort to ensure reverse chronological (Month 1 is newest, Month 3 is oldest)
            monthData.sort((a,b) => moment(b.month).unix() - moment(a.month).unix()); 

            // Get average of last 3 months
            const salesSum = monthData.reduce((sum, m) => sum + m.totalSales, 0);
            const profitSum = monthData.reduce((sum, m) => sum + m.totalProfit, 0);
            const avgSale = salesSum / 3;
            const avgProfit = profitSum / 3;

            // Calculate overall trend from the average change between two 3-month blocks (simple change: M1 vs Avg of M2/M3)
            const latestMonthSale = monthData[0].totalSales;
            const oldMonthsAvgSale = (monthData[1].totalSales + monthData[2].totalSales) / 2;
            const trendAbsolute = latestMonthSale - oldMonthsAvgSale;
            
            let trendFactor = 0;
            // Only apply a trend if the last month's deviation is significant (5%) of the average sales
            if (avgSale > 0 && Math.abs(trendAbsolute / avgSale) > window.SALES_FORECAST_CONFIG.TREND_THRESHOLD) {
                trendFactor = trendAbsolute;
            } 
            
            // Add or subtract the simple monthly trend plus the overall predefined safety modifier 
            const trendChangeRate = trendFactor / avgSale; // E.g. +0.10 for a 10% upward trend
            
            const nextMonthForecastSale = Math.max(0, avgSale + (avgSale * trendChangeRate) + (avgSale * window.SALES_FORECAST_CONFIG.TREND_MODIFIER * (trendChangeRate >= 0 ? 1 : -1)));

            const salesChangeRatio = nextMonthForecastSale / avgSale;
            const nextMonthForecastProfit = avgProfit * salesChangeRatio;

            // Find estimated Top Product
            const topMonth = monthData[0].month;
            const topMonthSales = sales.filter(s => moment(s.timestamp).format('YYYY-MM') === topMonth && s.type === 'sale' && s.status !== 'বাতিল');
            const productCounts = {};
            topMonthSales.forEach(s => s.items.forEach(item => {
                 productCounts[item.name] = (productCounts[item.name] || 0) + item.quantity;
            }));
            const topProduct = Object.entries(productCounts).sort(([, a], [, b]) => b - a)[0];
            
            // Render UI
            const trendDisplayValue = ((nextMonthForecastSale - avgSale) / avgSale * 100).toFixed(1);

            document.getElementById('forecast-basis').textContent = `(গত ${monthData.length} মাসের গড়)`
            document.getElementById('forecast-next-month-sale').textContent = `৳ ${Math.round(nextMonthForecastSale).toLocaleString()}`;
            document.getElementById('forecast-next-month-profit').textContent = `৳ ${Math.round(nextMonthForecastProfit).toLocaleString()}`;
            document.getElementById('forecast-top-product').textContent = topProduct ? topProduct[0] : 'N/A';
            document.getElementById('forecast-trend-display').textContent = trendDisplayValue > 0 ? `+${trendDisplayValue}%` : `${trendDisplayValue}%`;
            document.getElementById('forecast-trend-display-hidden').textContent = trendDisplayValue > 0 ? `+${trendDisplayValue}%` : `${trendDisplayValue}%`;
            document.getElementById('forecast-trend-display').style.color = nextMonthForecastSale >= avgSale ? '#22c55e' : '#dc3545';
            
             // 6. Alert System: Trigger for owner
             const owner = users.find(u => u.role === 'admin');
             if(owner && owner.phone) {
                 const alertData = { 
                    sale: Math.round(nextMonthForecastSale), 
                    profit: Math.round(nextMonthForecastProfit),
                    topProduct: topProduct ? topProduct[0] : 'N/A',
                    trend: trendDisplayValue + '%'
                 };
                 // Note: Ideally, this notification should be sent *once* per month. Since this is in the main loop, it will only log:
                 console.log(`Forecast Ready - Owner Alert (Needs Monthly Trigger): ${generateAlertMessage('FORECAST_READY', owner.displayName, alertData)}`);
             }
        }

        
         // ===================================
         // 4. SALES & PROFIT REPORT ADD-ON (report.js conceptual file)
         // (Includes Product Wise Report & Granular Report)
         // ===================================
         
        // 4. Product Wise Report Listener
        productWiseReportBtn.addEventListener('click', () => {
             // Sync the dates with the main Sales Report dates by default
             const today = salesReportFromDateInput.value; 
             document.getElementById('product-report-from-date').value = today;
             document.getElementById('product-report-to-date').value = salesReportToDateInput.value;
             populateProductReportCategoryFilter();
             renderProductWiseReport();
             document.getElementById('product-wise-report-modal').style.display = 'flex';
        });

         document.querySelector('#product-wise-report-modal .close-button').addEventListener('click', () => {
             document.getElementById('product-wise-report-modal').style.display = 'none';
        });

        document.getElementById('filter-product-wise-report').addEventListener('click', renderProductWiseReport);

        function populateProductReportCategoryFilter() {
            // Get categories from live product list
            const categories = [...new Set(products.map(p => p.category).filter(Boolean))];
            const filterEl = document.getElementById('product-report-category-filter');
            filterEl.innerHTML = '<option value="">সকল ক্যাটাগরি</option>';
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                filterEl.appendChild(option);
            });
        }

        function renderProductWiseReport() {
            // Check if admin to show profit data (already done in main sales report but check again)
             if (currentUser && currentUser.role !== 'admin') { 
                 alert('লাভ/ক্ষতির রিপোর্ট দেখার অনুমতি আপনার নেই।');
                 document.getElementById('product-wise-report-modal').style.display = 'none';
                 return;
            }

            const fromDateStr = document.getElementById('product-report-from-date').value;
            const toDateStr = document.getElementById('product-report-to-date').value;
            const categoryFilter = document.getElementById('product-report-category-filter').value;
            const tableBody = document.querySelector('#product-wise-report-table tbody');
            tableBody.innerHTML = '';
            
            const fromDate = fromDateStr ? moment(fromDateStr).startOf('day') : null;
            const toDate = toDateStr ? moment(toDateStr).endOf('day') : null;

            const productSummary = {};
            let totalNetSale = 0;
            let totalNetProfit = 0;
            let totalNetQty = 0;

            sales.filter(s => s.type === 'sale' && s.status !== 'বাতিল').forEach(sale => {
                 const saleDate = moment(sale.timestamp);
                 if ((fromDate && saleDate.isBefore(fromDate)) || (toDate && saleDate.isAfter(toDate))) return;

                 sale.items.forEach(item => {
                    const product = products.find(p => p.id === item.productId);
                    if (!product) return; 

                     if (categoryFilter && product.category !== categoryFilter) return;

                    if (!productSummary[product.id]) {
                        productSummary[product.id] = {
                            name: product.name,
                            category: product.category,
                            qty: 0,
                            totalSale: 0,
                            totalCost: 0,
                            profit: 0
                        };
                    }
                    // Profit is based on unitPrice and item.purchasePrice which is logged with the sale/cart item
                    const saleValue = item.quantity * item.unitPrice;
                    const costValue = item.quantity * (item.purchasePrice || 0);

                    productSummary[product.id].qty += item.quantity;
                    productSummary[product.id].totalSale += saleValue;
                    productSummary[product.id].totalCost += costValue;
                    productSummary[product.id].profit += (saleValue - costValue);
                 });
            });

            // Convert summary to array and render
            Object.values(productSummary).forEach(summary => {
                const row = tableBody.insertRow();
                
                row.insertCell(0).textContent = summary.name;
                row.insertCell(1).textContent = summary.category;
                row.insertCell(2).textContent = summary.qty;
                row.insertCell(3).textContent = `৳ ${summary.totalSale.toLocaleString()}`;
                row.insertCell(4).textContent = `৳ ${summary.totalCost.toLocaleString()}`;
                const profitCell = row.insertCell(5);
                profitCell.textContent = `৳ ${summary.profit.toLocaleString()}`;
                profitCell.style.color = summary.profit < 0 ? '#dc3545' : '#22c55e';
                
                totalNetSale += summary.totalSale;
                totalNetProfit += summary.profit;
                totalNetQty += summary.qty;
            });
            
             if (Object.keys(productSummary).length === 0) {
                 const row = tableBody.insertRow();
                 row.insertCell(0).colSpan = 6;
                 row.insertCell(0).textContent = 'এই সময়সীমার মধ্যে কোনো পণ্য বিক্রি হয়নি।';
             }

            // Update Summary
            document.getElementById('prod-report-total-sale').textContent = `৳ ${totalNetSale.toLocaleString()}`;
            document.getElementById('prod-report-total-profit').textContent = `৳ ${totalNetProfit.toLocaleString()}`;
            document.getElementById('prod-report-total-qty').textContent = `${totalNetQty.toLocaleString()} পিস`;
            document.getElementById('prod-report-total-profit').style.color = totalNetProfit < 0 ? '#dc3545' : '#22c55e';
        }
        
        // Product Wise Print Handler
        document.getElementById('print-product-wise-report').addEventListener('click', () => {
             const fromDate = document.getElementById('product-report-from-date').value;
             const toDate = document.getElementById('product-report-to-date').value;
             
             const printContent = `
                <h3 class='center'>পণ্য-ভিত্তিক বিক্রয় ও লাভ রিপোর্ট</h3>
                 <p class='center'>${fromDate} থেকে ${toDate}</p>
                 <hr>
                ${document.getElementById('product-report-summary').outerHTML.replace('৳ 0', document.getElementById('prod-report-total-sale').textContent)}
                 <hr>
                ${document.getElementById('product-wise-report-table').outerHTML}
            `;
            launchPrint('পণ্য-ভিত্তিক রিপোর্ট', printContent);
        });

         // 4. Granular Report - New UI/Function for Daily/Monthly/Yearly
        document.getElementById('filter-granular-report').addEventListener('click', renderGranularReport);

        function renderGranularReport() {
            // Check if admin to show profit data (already done in main sales report but check again)
             if (currentUser && currentUser.role !== 'admin') { 
                 alert('লাভ/ক্ষতির রিপোর্ট দেখার অনুমতি আপনার নেই।');
                 return;
            }
             
            const fromDateStr = granularReportFromDateInput.value;
            const toDateStr = granularReportToDateInput.value;
            const reportType = document.getElementById('granular-report-type').value;
            const tableBody = document.querySelector('#granular-report-table tbody');
            const summaryDiv = document.getElementById('granular-report-summary');
            tableBody.innerHTML = '';
            summaryDiv.innerHTML = '';
            document.getElementById('granular-report-title').textContent = `${fromDateStr} থেকে ${toDateStr}`;
            
            const fromDate = fromDateStr ? moment(fromDateStr).startOf('day') : moment(0);
            const toDate = toDateStr ? moment(toDateStr).endOf('day') : moment();

            const groupedReports = {};
            let totalAllSale = 0;
            let totalAllCost = 0;
            let totalAllProfit = 0;

             // 1. Group sales based on Report Type (daily/monthly/yearly) - exclude deleted bills
            sales.filter(s => (s.type === 'sale' || s.type === 'return') && s.status !== 'বাতিল').forEach(transaction => {
                const isSale = transaction.type === 'sale';
                const modifier = isSale ? 1 : -1;

                const saleDate = moment(transaction.timestamp);
                if (saleDate.isBefore(fromDate) || saleDate.isAfter(toDate)) return;

                let groupKey = '';
                if (reportType === 'daily') {
                    groupKey = saleDate.format('YYYY-MM-DD');
                } else if (reportType === 'monthly') {
                    groupKey = saleDate.format('YYYY-MM');
                } else if (reportType === 'yearly') {
                    groupKey = saleDate.format('YYYY');
                }

                if (!groupedReports[groupKey]) {
                    groupedReports[groupKey] = { sales: 0, cost: 0, profit: 0 };
                }

                // Cost and Profit calculated from sale metadata
                const saleCost = transaction.items.reduce((sum, item) => sum + (item.quantity * (item.purchasePrice || 0)), 0);
                const netProfit = transaction.finalAmount - saleCost;
                
                groupedReports[groupKey].sales += (transaction.finalAmount * modifier);
                groupedReports[groupKey].cost += (saleCost * modifier);
                groupedReports[groupKey].profit += (transaction.profit || netProfit) * modifier; // Should use recorded profit for accuracy
                
                totalAllSale += (transaction.finalAmount * modifier);
                totalAllCost += (saleCost * modifier);
                totalAllProfit += (transaction.profit || netProfit) * modifier; // Should use recorded profit for accuracy
            });
            
             // 2. Render and Sort
            Object.entries(groupedReports).sort(([keyA], [keyB]) => moment(keyB) - moment(keyA)).forEach(([key, data]) => {
                const profitMargin = data.sales > 0 ? ((data.profit / data.sales) * 100).toFixed(2) : '0.00';
                
                 // Localize the group key for rendering
                let keyDisplay = key;
                if (reportType === 'daily') keyDisplay = moment(key).format('LL');
                if (reportType === 'monthly') keyDisplay = moment(key).format('MMMM, YYYY');
                if (reportType === 'yearly') keyDisplay = key;
                
                const row = tableBody.insertRow();
                row.insertCell(0).textContent = keyDisplay;
                row.insertCell(1).textContent = `৳ ${data.sales.toLocaleString()}`;
                row.insertCell(2).textContent = `৳ ${data.cost.toLocaleString()}`;
                const profitCell = row.insertCell(3);
                profitCell.textContent = `৳ ${data.profit.toLocaleString()}`;
                profitCell.style.color = data.profit < 0 ? '#dc3545' : '#22c55e';
                row.insertCell(4).textContent = `${profitMargin} %`;
            });
            
             // 3. Render Grand Summary
            const totalProfitMargin = totalAllSale > 0 ? ((totalAllProfit / totalAllSale) * 100).toFixed(2) : '0.00';
             summaryDiv.innerHTML = `
                 <p style="font-size: 1.1em; font-weight: bold; margin-bottom: 5px;">
                    মোট নিট বিক্রয়: ৳ ${totalAllSale.toLocaleString()} |
                    মোট নিট ক্রয় মূল্য: ৳ ${totalAllCost.toLocaleString()} |
                    মোট লাভ: <span style="color: ${totalAllProfit < 0 ? '#dc3545' : '#22c55e'};">৳ ${totalAllProfit.toLocaleString()}</span>
                 </p>
                 <p style="font-size: 1.1em;">মোট লাভ শতাংশ: ${totalProfitMargin} %</p>
            `;

            if (Object.keys(groupedReports).length === 0) {
                 const row = tableBody.insertRow();
                 row.insertCell(0).colSpan = 5;
                 row.insertCell(0).textContent = 'এই সময়সীমার মধ্যে কোনো লেনদেন হয়নি।';
             }
        }

        document.getElementById('print-granular-report-btn').addEventListener('click', () => {
             // Clones the table, adds totals, and calls the launchPrint utility
             const logoHtml = shopSettings.logoUrl ? `<div class="center"><img src="${shopSettings.logoUrl}" alt="Logo" style="max-height: 80px; max-width: 200px; margin-bottom: 10px;"></div>` : '';

            const printContent = `
                ${logoHtml}
                <h3 class='center'>উন্নত বিক্রয় ও লাভ রিপোর্ট (${document.getElementById('granular-report-title').textContent})</h3>
                 <p class='center'>${document.getElementById('granular-report-summary').innerHTML.replace(/<span.*span>/g, '')}</p>
                 <hr>
                ${document.getElementById('granular-report-table').outerHTML}
            `;
            launchPrint('উন্নত বিক্রয় রিপোর্ট', printContent);
        });
        
        // --- End of ADD-ON MODULES ---

        // --- Main Event Listeners (Original) ---
        loginForm.addEventListener('submit', handleLogin);
        logoutBtn.addEventListener('click', handleLogout);

        mainNavUl.addEventListener('click', (event) => {
            if (event.target.tagName === 'A') {
                event.preventDefault();
                const section = event.target.dataset.section;
                if (checkSubscription() || section === 'settings') {
                    showSection(section);
                } else {
                    showMessage(loginErrorMessage, 'সাবস্ক্রিপশনের মেয়াদ শেষ হয়েছে! অনুগ্রহ করে সেটিংস থেকে মেয়াদ বাড়ান।', false);
                    showSection('settings');
                }
            }
        });

        userAvatarDisplay.addEventListener('click', () => {
            showSection('users');
            if (currentUser) {
                editUser(currentUser.id);
            }
        });

        ledgerTypeSelect.addEventListener('change', updateLedgerCategoryDropdown);
        
        // ✅ NEW: Event listeners for POS Customer search
        posCustomerPhoneInput.addEventListener('input', () => handlePosCustomerSearch('phone', posCustomerPhoneInput.value));
        posCustomerNameInput.addEventListener('input', () => handlePosCustomerSearch('name', posCustomerNameInput.value));
        
        // ✅ NEW: POS Customer Search handler function
        function handlePosCustomerSearch(type, query) {
            const resultsContainer = type === 'phone' ? posCustomerPhoneSearchResults : posCustomerNameSearchResults;
            resultsContainer.innerHTML = '';
            if (query.length < 2) {
                resultsContainer.style.display = 'none';
                return;
            }

            const lowerQuery = query.toLowerCase();
            const filteredCustomers = customers.filter(c => {
                if (type === 'phone') {
                    return c.phone.includes(lowerQuery);
                } else {
                    return c.name.toLowerCase().includes(lowerQuery);
                }
            });

            if (filteredCustomers.length > 0) {
                filteredCustomers.slice(0, 5).forEach(c => { // Show max 5 results
                    const div = document.createElement('div');
                    div.textContent = `${c.name} (${c.phone})`;
                    div.addEventListener('click', () => {
                        posCustomerPhoneInput.value = c.phone;
                        posCustomerNameInput.value = c.name;
                        posCustomerAddressInput.value = c.address || '';
                        resultsContainer.style.display = 'none';
                    });
                    resultsContainer.appendChild(div);
                });
                resultsContainer.style.display = 'block';
            } else {
                resultsContainer.style.display = 'none';
            }
        }
        
        // Hide search results when clicking outside
        document.addEventListener('click', (event) => {
            if (!posCustomerPhoneInput.contains(event.target)) {
                posCustomerPhoneSearchResults.style.display = 'none';
            }
             if (!posCustomerNameInput.contains(event.target)) {
                posCustomerNameSearchResults.style.display = 'none';
            }
        });



        document.addEventListener('DOMContentLoaded', async () => {
             showLoader(); // 1. Loading System: Show initial loader
             
             // Run existing initializeData (This re-loads all data into arrays, refreshes UI, and ensures initial users)
            await initializeData();
            
            // 2. Session Persistence: Check for saved session (NEW)
            try {
                const savedUser = localStorage.getItem('currentUser');
                const lastActiveSection = localStorage.getItem('lastActiveSection') || 'dashboard';

                if (savedUser) {
                    const parsedUser = JSON.parse(savedUser);
                    // Check if the user exists in the reloaded `users` array (simple check)
                    const validUser = users.find(u => u.id === parsedUser.id && u.username === parsedUser.username);
                    
                    if (validUser) {
                        currentUser = validUser;
                        checkSubscription(); // Check subscription status first

                        if (currentUser && (checkSubscription() || currentUser.role === 'admin')) {
                            loginContainer.style.display = 'none';
                            appContainer.style.display = 'flex';
                            updateUserProfileDisplay();
                            renderAppBasedOnRole(currentUser.role);
                            showSection(lastActiveSection); // Restore last active section
                        } else {
                            // User is logged in but subscription expired (and is not admin), redirect to settings
                            loginContainer.style.display = 'none';
                            appContainer.style.display = 'flex';
                            updateUserProfileDisplay();
                            renderAppBasedOnRole(currentUser.role);
                            showSection('settings');
                        }
                    } else {
                        // Saved user data not found in DB after reload (security/data loss issue)
                        await handleLogout();
                        hideLoader(); // Hide loader if we are stuck at login
                    }
                } else {
                     // No saved session, show login
                     loginContainer.style.display = 'block';
                     appContainer.style.display = 'none';
                     hideLoader();
                }

            } catch (e) {
                 console.error("Session restoration failed:", e);
                 loginContainer.style.display = 'block';
                 appContainer.style.display = 'none';
                 hideLoader();
            }
            
            // The existing logic at the end of DOMContentLoaded is mostly handled by the new Session Persistence block. 
            // We keep the time/date initializations.

            const hour = new Date().getHours();
            if (hour < 12) {
                greetingText.textContent = 'শুভ সকাল,';
            } else if (hour < 18) {
                greetingText.textContent = 'শুভ বিকাল,';
            } else {
                greetingText.textContent = 'শুভ সন্ধ্যা,';
            }

            const today = new Date().toISOString().split('T')[0];
            salesReportFromDateInput.value = today;
            salesReportToDateInput.value = today;
            ledgerDateInput.value = today;
             // Set default granular dates
             granularReportFromDateInput.value = moment().startOf('month').format('YYYY-MM-DD');
             granularReportToDateInput.value = today;
             // Set default manual due date
             manualDueDate.value = today;
             
             // NEW: Set initial date for Bank and Expense reports
             bankTxFromDateInput.value = moment().startOf('month').format('YYYY-MM-DD');
             bankTxToDateInput.value = today;
             expenseReportFromDateInput.value = moment().startOf('month').format('YYYY-MM-DD');
             expenseReportToDateInput.value = today;
             
             // Initial checkSubscription call at the end of data load/session restore to ensure UI state is correct
             checkSubscription();
             
             // Hide loader one last time in case there was a delay in the promises above
             hideLoader();
        });

    </script>
</body>
</html>
